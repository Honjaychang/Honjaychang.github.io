<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.4">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="HonjayChang Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="HonjayChang Blog Atom Feed"><title data-react-helmet="true">Browser | HonjayChang</title><meta data-react-helmet="true" property="og:url" content="https://honjaychang.github.io//docs/extension/browser"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="Browser | HonjayChang"><meta data-react-helmet="true" name="description" content="运行环境"><meta data-react-helmet="true" property="og:description" content="运行环境"><link data-react-helmet="true" rel="shortcut icon" href="/img/photo.ico"><link data-react-helmet="true" rel="canonical" href="https://honjaychang.github.io//docs/extension/browser"><link data-react-helmet="true" rel="alternate" href="https://honjaychang.github.io//docs/extension/browser" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://honjaychang.github.io//docs/extension/browser" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.bd38899b.css">
<link rel="preload" href="/assets/js/runtime~main.571898a5.js" as="script">
<link rel="preload" href="/assets/js/main.9dc5cbc4.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_1oUP">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a href="https://honjaychang.github.io/docs/home" target="_blank" rel="noopener noreferrer" class="navbar__brand"><img src="/img/photo.jpg" alt="My Site Logo" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/img/photo.jpg" alt="My Site Logo" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"></a><a class="navbar__item navbar__link navbar__link--active" href="/docs/Home">Docs</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/Honjaychang" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="react-toggle toggle_3Zt9 react-toggle--disabled"><div class="react-toggle-track" role="button" tabindex="-1"><div class="react-toggle-track-check"><span class="toggle_71bT">🌜</span></div><div class="react-toggle-track-x"><span class="toggle_71bT">🌞</span></div><div class="react-toggle-thumb"></div></div><input type="checkbox" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper doc-page"><div class="docPage_31aa"><button class="clean-btn backToTopButton_35hR" type="button" title="Scroll to top"><svg viewBox="0 0 24 24" width="28"><path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z" fill="currentColor"></path></svg></button><aside class="docSidebarContainer_3Kbt"><div class="sidebar_15mo"><nav class="menu thin-scrollbar menu_Bmed menuWithAnnouncementBar_2WvA"><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/docs/Home">Home</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">HC</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">JS</a></li><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#">Extension</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/extension/web-api">Web-API</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active active" tabindex="0" href="/docs/extension/browser">Browser</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">TS</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">React</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">ReactCore</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Dev</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Network</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Algo</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Interview</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Vue</a></li></ul></nav><button type="button" title="Collapse sidebar" aria-label="Collapse sidebar" class="button button--secondary button--outline collapseSidebarButton_1CGd"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_3E-R"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></aside><main class="docMainContainer_3ufF"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_3FnS"><div class="docItemContainer_33ec"><article><div class="tocCollapsible_1PrD tocMobile_3Hoh"><button type="button" class="clean-btn tocCollapsibleButton_2O1e">On this page</button></div><div class="markdown"><header><h1 class="h1Heading_27L5">Browser</h1></header><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="运行环境"></a>运行环境<a class="hash-link" href="#运行环境" title="Direct link to heading">#</a></h2><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="页面渲染"></a>页面渲染<a class="hash-link" href="#页面渲染" title="Direct link to heading">#</a></h3><div class="admonition admonition-note alert alert--secondary"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>Ref</h5></div><div class="admonition-content"><ul><li><a href="https://wangdoc.com/javascript/bom/engine.html" target="_blank" rel="noopener noreferrer">浏览器环境概述</a></li><li><a href="https://segmentfault.com/a/1190000018130499" target="_blank" rel="noopener noreferrer">css 加载会造成阻塞吗</a></li><li><a href="https://juejin.cn/post/6844903661139656718" target="_blank" rel="noopener noreferrer">JS脚本异步加载浅析</a></li></ul></div></div><p><img src="https://cdn.jsdelivr.net/gh/honjaychang/bp/fe/webkitflow.png" alt="Webkit渲染流程图"></p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="构建dom树"></a>构建DOM树<a class="hash-link" href="#构建dom树" title="Direct link to heading">#</a></h4><ul><li>根据 <code>HTML</code> 代码生成 <code>DOM Tree</code></li></ul><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><pre tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">Bytes</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">字节</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> -</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> Characters</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">字符</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> -</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> Tokens</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">词</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> -</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> Nodes</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">节点</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> -</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> DOM</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">DOM树</span><span class="token punctuation" style="color:#393A34">)</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="构建cssom树"></a>构建CSSOM树<a class="hash-link" href="#构建cssom树" title="Direct link to heading">#</a></h4><ul><li>根据 <code>CSS</code> 代码生成 <code>CSSOM</code><ul><li><code>css</code> 不会阻塞<code>DOM</code>树的解析</li><li><code>css</code> 加载会阻塞<code>DOM</code>树渲染</li></ul></li></ul><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><pre tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">Bytes</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">字节</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> -</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> Characters</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">字符</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> -</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> Tokens</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">词</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> -</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> Nodes</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">节点</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> -</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> CSSOM</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">CSSOM树</span><span class="token punctuation" style="color:#393A34">)</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><blockquote><p>为什么要将 <code>CSS &lt;link href=&quot;#&quot;&gt;</code> 放在 head 中</p></blockquote><ul><li>在<code>DOM</code>树生成前就将<code>CSS</code>规则加载完</li><li>在<code>DOM</code>生成完成后直接和所有的<code>CSS</code>规则整合 =&gt; 一步渲染完成 <code>Render Tree</code></li></ul><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="解析js脚本"></a>解析JS脚本<a class="hash-link" href="#解析js脚本" title="Direct link to heading">#</a></h4><ul><li>遇到 <code>&lt;script&gt;</code> 则暂停渲染，优先加载并执行<code>JS</code>代码，完成再继续</li></ul><blockquote><p>为何建议将<code>JS</code>放在<code>body</code>最后</p></blockquote><ul><li>不放在最后的话，<code>JS</code> 代码会阻塞 <code>render tree</code> 的渲染，可能会导致页面渲染时间比较长</li></ul><h5><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="defer"></a><code>defer</code><a class="hash-link" href="#defer" title="Direct link to heading">#</a></h5><ul><li><code>&lt;script src=&quot;a.js&quot; defer&gt;&lt;/script&gt;</code></li><li><code>defer</code>的作用是延迟脚本的执行，等到 DOM 加载生成后，再执行脚本</li><li>浏览器发现带有<code>defer</code>属性的<code>script</code>会继续往下解析 HTML 网页，同时并行下载<code>script</code>的外部脚本，等待网页解析完成再去执行脚本</li></ul><h5><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="async"></a><code>async</code><a class="hash-link" href="#async" title="Direct link to heading">#</a></h5><ul><li><code>&lt;script src=&quot;a.js&quot; async&gt;&lt;/script&gt;</code></li><li><code>async</code>的作用是使用另一个进程下载脚本，下载时不会阻塞渲染</li><li>浏览器发现带有<code>async</code>属性的<code>script</code>会继续往下解析 HTML 网页，同时并行下载<code>script</code>的外部脚本。当脚本下载完成会暂停 HTML 解析，先去执行脚本，执行完再来解析 HTML。 这与<code>defer</code>有点差异</li><li><code>async</code>会无视脚本顺序，优先执行先下载完成的</li><li>当同时存在<code>defer async</code>的时候 <code>defer</code>将会失效</li></ul><blockquote><p><code>window.onload</code> 和 <code>DOMContentLoaded</code>的区别</p></blockquote><ul><li>建议使用<code>document.addEventListener(&#x27;DOMContentLoaded&#x27;, fn(){...})</code></li></ul><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly js"><pre tabindex="0" class="prism-code language-js codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token dom variable" style="color:#36acaa">window</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">addEventListener</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;load&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// 页面的全部资源加载完成后才会执行，包括图片、视频等</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token dom variable" style="color:#36acaa">document</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">addEventListener</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;DOMContentLoaded&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// DOM 渲染完成即可执行，此时图片、视频可能还没有加载完</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="构建渲染树"></a>构建渲染树<a class="hash-link" href="#构建渲染树" title="Direct link to heading">#</a></h4><ul><li><p>将 <code>DOM Tree</code> 和 <code>CSSOM</code> 整合形成 <code>Render Tree</code></p></li><li><p>根据 <code>Render Tree</code> 渲染页面</p></li><li><p>直至把 <code>Render Tree</code> 渲染完成</p></li></ul><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="回流-重绘"></a>回流 重绘<a class="hash-link" href="#回流-重绘" title="Direct link to heading">#</a></h4><ul><li>回流<code>reflow</code>：<code>render</code>树中一部分或全部元素需要改变尺寸、布局、或着需要隐藏而需要重新构建</li><li>重绘<code>repaint</code>：<code>render</code>树中一部分元素改变，而不影响布局的，只影响外观的，比如颜色</li><li>回流必将引起重绘</li></ul><blockquote><p>优化方案</p></blockquote><ul><li>缓存 DOM 操作 多次 DOM 变成插入一个<code>createDocumentFragment</code></li><li>使用<code>window.requestAnimationFrame()</code>，因为它可以把代码推迟到下一次重绘之前执行，而不是立即要求页面重绘。</li><li>使用虚拟 DOM</li></ul><h5><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="raf"></a>RAF<a class="hash-link" href="#raf" title="Direct link to heading">#</a></h5><ul><li><p><strong><code>window.requestAnimationFrame()</code></strong> 告诉浏览器：你希望执行一个动画，并且要求浏览器在下次重绘之前调用指定的回调函数更新动画。</p></li><li><p>要想动画流畅，更新频率要 60 帧/s，即 16.67ms 更新一次视图</p></li><li><p><code>setTimeout</code> 要手动控制频率，而 RAF 浏览器会自动控制</p></li></ul><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly js"><pre tabindex="0" class="prism-code language-js codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">后台标签或者隐藏在iframe中， </span><span class="token constant" style="color:#36acaa">RAF</span><span class="token plain"> 会暂停，而setTimeout 依然执行</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 3s 把宽度 从100px -&gt; 640px 增加 540px</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 60帧/s 3s 180帧 每次变化 3px</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 而且当页面切换的时候会暂停执行</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> div1 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token dom variable" style="color:#36acaa">document</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">getElementById</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;div1&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> curWidth </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">100</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> maxWidth </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">640</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// setTimeout</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">animate</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  curWidth </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> curWidth </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  div1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">style</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">width</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> curWidth </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;px&#x27;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token console class-name">console</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">log</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">curWidth</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> div1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">style</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">width</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">curWidth </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> maxWidth</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">setTimeout</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">animate</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">16.7</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 这里的animate 没加括号</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// RAF</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">animate</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  curWidth </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> curWidth </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  div1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">style</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">width</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> curWidth </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;px&#x27;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token console class-name">console</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">log</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">curWidth</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> div1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">style</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">width</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">curWidth </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> maxWidth</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token dom variable" style="color:#36acaa">window</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">requestAnimationFrame</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">animate</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 时间不用自己控制</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">animate</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="总结"></a>总结<a class="hash-link" href="#总结" title="Direct link to heading">#</a></h4><ul><li>调用 <code>GUI</code> 渲染线程 解析 <code>HTML CSS </code></li><li>调用 <code>JS</code> 引擎 解析 <code>JS</code></li></ul><ul><li>解析代码：解析 <code>HTML</code> 构建 <code>DOM</code> 树 解析 <code>CSS</code> 构建 <code>CSSOM</code> 树<ul><li>解析过程中碰到 <code>js</code> 代码会停止解析去请求</li></ul></li><li>对象合成：根据 <code>DOM CSSOM</code> 生成 <code>Render Tree</code></li><li>布局：计算出 <code>Render Tree</code> 的布局</li><li>绘制：将 <code>Render Tree</code> 绘制到屏幕</li></ul><ul><li><code>CSS</code> 的加载与解析不会阻塞 <code>HTML</code> 的解析，他们是并行的。<ul><li>但会阻塞渲染树 <code>RenderTree</code> 的生成，也会阻塞界面的渲染！</li></ul></li><li>媒体资源 (如:图片音视频等) 的加载不会阻塞HTML的解析 所以他们可以并行加载</li></ul><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="性能优化"></a>性能优化<a class="hash-link" href="#性能优化" title="Direct link to heading">#</a></h2><div class="admonition admonition-note alert alert--secondary"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>Ref</h5></div><div class="admonition-content"><ul><li><a href="https://juejin.cn/post/6844904031240863758" target="_blank" rel="noopener noreferrer">2020 年了,再不会 webpack 敲得代码就不香了(近万字实战)</a></li><li><a href="https://juejin.cn/post/6854573213171580941" target="_blank" rel="noopener noreferrer">你可能不知道的 9 条 Webpack 优化策略</a></li></ul></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="性能优化原则"></a>性能优化原则<a class="hash-link" href="#性能优化原则" title="Direct link to heading">#</a></h3><ul><li>多使用内存、缓存或其他方法</li><li>减少 CPU 计算量，减少网络请求，减少网络加载耗时</li><li>空间换时间</li></ul><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="从何入手"></a>从何入手<a class="hash-link" href="#从何入手" title="Direct link to heading">#</a></h4><h5><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="让加载更快"></a>让加载更快<a class="hash-link" href="#让加载更快" title="Direct link to heading">#</a></h5><ul><li>减少资源体积：压缩代码</li><li>减少访问次数：合并代码，SSR 服务器端渲染，缓存</li><li>使用更快的网络： CDN</li></ul><h5><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="让渲染更快"></a>让渲染更快<a class="hash-link" href="#让渲染更快" title="Direct link to heading">#</a></h5><ul><li><code>CSS</code> 放在<code>head</code> ，<code>JS</code>放在<code>body</code>最下面</li><li>尽早开始执行<code>JS</code>，用<code>DOMContentLoaded</code></li><li>触发懒加载（图片懒加载，上滑加载更多）</li><li>对 DOM 查询进行缓存</li><li>频繁 DOM 操作，合并到一起插入 DOM 结构</li><li>节流<code>throttle</code>防抖<code>debounce</code></li></ul><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="实例"></a>实例<a class="hash-link" href="#实例" title="Direct link to heading">#</a></h4><ul><li><p>资源合并 ==&gt; 请求三次 3kb 和请求一次 9kb 3 次网络请求--&gt; 1 次</p></li><li><p>缓存 ==&gt; webpack 生成的<code>bundle.[contenthash].js </code></p><ul><li>如果生成的内容没有发生变化即哈希值没有发生改变 则不需要重新进行请求</li><li>静态资源加<code>hash</code>后缀，根据文件内容计算<code>hash</code>。如果文件内容不变，则<code>hash</code>不变，则<code>url</code>不变。既然 url 和文件不变，则会自动触发 HTTP 缓存机制，返回 304</li></ul></li><li><p><code>CDN</code> ==&gt; 根据地域做网络服务。静态文件 满足 304 机制</p></li><li><p><code>SSR</code> ==&gt; 服务器端渲染：网页和数据一起加载，一起渲染</p></li><li><p>非 <code>SSR</code> ==&gt; （前后端分离）：先加载网页，再加载数据，再渲染数据 (早先的<code>JSP ASP PHP</code> ，现在的<code>vue React </code></p></li><li><p>懒加载</p><ul><li>加载<code>loading</code>图片</li><li>判断哪些图片要加载</li><li>隐形加载图片</li><li>替换真图片</li></ul></li></ul><p>一张图片就是一个<code>&lt;img&gt;</code>标签，浏览器是否发起请求图片是根据<code>&lt;img&gt;</code>的<code>src</code>属性，所以实现懒加载的关键就是，在图片没有进入可视区域时，先不给<code>&lt;img&gt;</code>的<code>src</code>赋值，这样浏览器就不会发送请求了，等到图片进入可视区域再给<code>src</code>赋值</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly js"><pre tabindex="0" class="prism-code language-js codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// 可以给img标签统-自定义属性data=src=&#x27;default.png&#x27;，当检测到图片出现在窗口之后再补充src属性，此时才会进行图片资源加载</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">lazyload</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> imgs </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token dom variable" style="color:#36acaa">document</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">getElementsByTagName</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;img&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> len </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> imgs</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">length</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// 视口高度</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> viewHeight </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token dom variable" style="color:#36acaa">document</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">documentElement</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">clientHeight</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">//滚动务高度</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> scrollHeight </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token dom variable" style="color:#36acaa">document</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">documentElement</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">scrolltop</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">||</span><span class="token plain"> </span><span class="token dom variable" style="color:#36acaa">document</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">body</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">scrollTop</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> len</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i</span><span class="token operator" style="color:#393A34">++</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> offsetHeight </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> imgs</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">offsetTop</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">offsetHeight </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> viewHeight </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> scrollHeight</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> src </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> imgs</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">dataset</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">src</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      imgs</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">src</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> src</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">//可以使用节流优化一下</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token dom variable" style="color:#36acaa">window</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">addEventlListener</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;scroll&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> lazyload</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><div class="admonition admonition-note alert alert--secondary"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>Ref</h5></div><div class="admonition-content"><ul><li><a href="https://blog.csdn.net/w1418899532/article/details/90515969" target="_blank" rel="noopener noreferrer">js 实现图片懒加载原理</a></li></ul></div></div><ul><li>缓存 DOM 查询</li></ul><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly js"><pre tabindex="0" class="prism-code language-js codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// 不缓存 DOM 查询结果</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword control-flow" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token dom variable" style="color:#36acaa">document</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">getElementsByTagName</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;p&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i</span><span class="token operator" style="color:#393A34">++</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// 每次循环 都会计算length 频繁进行DOM查询</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 缓存 DOM 查询结果</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> pList </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token dom variable" style="color:#36acaa">document</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">getElementsByTagName</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;p&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> length </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> pList</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">length</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword control-flow" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> length</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i</span><span class="token operator" style="color:#393A34">++</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// 缓存length 只进行一次 DOM 查询</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><ul><li>多个 DOM 操作一起插入到 DOM 结构：<ul><li><code>document.createDocumentFragment()</code></li></ul></li><li>尽早开始<code>JS</code>执行</li><li><code>document.addEventListener(&#x27;DOMContentLoaded&#x27;, function () {}</code></li><li>防抖节流</li></ul><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="首屏优化"></a>首屏优化<a class="hash-link" href="#首屏优化" title="Direct link to heading">#</a></h3><ul><li>尽可能的缩小 webpack 或者其他打包工具生成的包的大小</li><li>路由懒加载</li><li>组件按需加载</li><li>图片懒加载</li><li>服务端渲染 SSR</li><li>gzip</li></ul><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="csr-ssr"></a>CSR SSR<a class="hash-link" href="#csr-ssr" title="Direct link to heading">#</a></h4><ul><li><code>CSR</code> 客户端渲染</li><li><code>SSR</code> 服务端渲染<ul><li>由服务端把渲染的完整的页面返回给客户端，减少了一次客户端到服务端的一次 http 请求</li><li>返回完整页面 就利于 SEO 优化</li><li>SSR 强在首屏渲染。而 CSR 强在用户和页面多交互的场景</li></ul></li></ul><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="安全"></a>安全<a class="hash-link" href="#安全" title="Direct link to heading">#</a></h2><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="xss-跨站脚本攻击"></a><code>XSS</code> 跨站脚本攻击<a class="hash-link" href="#xss-跨站脚本攻击" title="Direct link to heading">#</a></h3><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="攻击"></a>攻击<a class="hash-link" href="#攻击" title="Direct link to heading">#</a></h4><blockquote><p>反射型<code>XSS</code></p></blockquote><ul><li>反射型<code>XSS</code>，非持久化，需要欺骗用户自己去点击链接才能触发<code>XSS</code>代码（服务器中没有这样的页面和内容），一般容易出现在搜索页面。</li></ul><blockquote><p>存储型<code>XSS</code></p></blockquote><p>一个博客网站，我发表一篇博客，其中嵌入<code>&lt;script&gt;</code>脚本，脚本内容：获取<code>cookie</code>，发送到我的服务器（服务器配合跨域）。发布这篇博客，有人查看它，我轻松收割访问者的<code>cookie</code>。</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="预防"></a>预防<a class="hash-link" href="#预防" title="Direct link to heading">#</a></h4><blockquote><p>转译字符</p></blockquote><ul><li>前端要替换，后端也要替换，都做总不会有错</li><li><code>https://www.npmjs.com/package/xss</code></li></ul><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly js"><pre tabindex="0" class="prism-code language-js codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">escape</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">str</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  str </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> str</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">replace</span><span class="token punctuation" style="color:#393A34">(</span><span class="token regex regex-delimiter" style="color:#36acaa">/</span><span class="token regex regex-source language-regex" style="color:#36acaa">&amp;</span><span class="token regex regex-delimiter" style="color:#36acaa">/</span><span class="token regex regex-flags" style="color:#36acaa">g</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;&amp;amp;&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  str </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> str</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">replace</span><span class="token punctuation" style="color:#393A34">(</span><span class="token regex regex-delimiter" style="color:#36acaa">/</span><span class="token regex regex-source language-regex" style="color:#36acaa">&lt;</span><span class="token regex regex-delimiter" style="color:#36acaa">/</span><span class="token regex regex-flags" style="color:#36acaa">g</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;&amp;lt;&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  str </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> str</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">replace</span><span class="token punctuation" style="color:#393A34">(</span><span class="token regex regex-delimiter" style="color:#36acaa">/</span><span class="token regex regex-source language-regex" style="color:#36acaa">&gt;</span><span class="token regex regex-delimiter" style="color:#36acaa">/</span><span class="token regex regex-flags" style="color:#36acaa">g</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;&amp;gt;&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  str </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> str</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">replace</span><span class="token punctuation" style="color:#393A34">(</span><span class="token regex regex-delimiter" style="color:#36acaa">/</span><span class="token regex regex-source language-regex" style="color:#36acaa">&quot;</span><span class="token regex regex-delimiter" style="color:#36acaa">/</span><span class="token regex regex-flags" style="color:#36acaa">g</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;&amp;quto;&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  str </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> str</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">replace</span><span class="token punctuation" style="color:#393A34">(</span><span class="token regex regex-delimiter" style="color:#36acaa">/</span><span class="token regex regex-source language-regex" style="color:#36acaa">&#x27;</span><span class="token regex regex-delimiter" style="color:#36acaa">/</span><span class="token regex regex-flags" style="color:#36acaa">g</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;&amp;#39;&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  str </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> str</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">replace</span><span class="token punctuation" style="color:#393A34">(</span><span class="token regex regex-delimiter" style="color:#36acaa">/</span><span class="token regex regex-source language-regex" style="color:#36acaa">`</span><span class="token regex regex-delimiter" style="color:#36acaa">/</span><span class="token regex regex-flags" style="color:#36acaa">g</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;&amp;#96;&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  str </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> str</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">replace</span><span class="token punctuation" style="color:#393A34">(</span><span class="token regex regex-delimiter" style="color:#36acaa">/</span><span class="token regex regex-source language-regex" style="color:#36acaa">\/</span><span class="token regex regex-delimiter" style="color:#36acaa">/</span><span class="token regex regex-flags" style="color:#36acaa">g</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;&amp;#x2F;&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">return</span><span class="token plain"> str</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><blockquote><p><code>HttpOnly</code></p></blockquote><ul><li>禁止通过<code>document.cookie</code>的方式获取<code>cookies</code></li></ul><blockquote><p>设置白名单或者黑名单</p></blockquote><ul><li>对于富文本编辑器 建议使用 白名单</li></ul><blockquote><p><code>csp</code></p></blockquote><ul><li><code>Content Security Policy</code> 内容安全策略</li><li>实质：白名单制度，开发者明确告诉客户端，哪些外部资源可以加载和执行</li></ul><p>如何启用<code>CSP</code></p><ul><li>通过 HTTP 头信息的<code>Content-Security-Policy</code>的字段</li></ul><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly js"><pre tabindex="0" class="prism-code language-js codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token maybe-class-name">Content</span><span class="token operator" style="color:#393A34">-</span><span class="token maybe-class-name">Security</span><span class="token operator" style="color:#393A34">-</span><span class="token maybe-class-name">Policy</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> script</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">src </span><span class="token string" style="color:#e3116c">&#x27;self&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> object</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">src </span><span class="token string" style="color:#e3116c">&#x27;none&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">style</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">src cdn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">example</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">org</span><span class="token plain"> third</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">party</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">org</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> child</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">src https</span><span class="token operator" style="color:#393A34">:</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><ul><li>通过网页的<code>&lt;meta&gt;</code>标签</li></ul><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly js"><pre tabindex="0" class="prism-code language-js codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">meta http</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">equiv</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;Content-Security-Policy&quot;</span><span class="token plain"> content</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;script-src &#x27;self&#x27;; object-src &#x27;none&#x27;; style-src cdn.example.org third-party.org; child-src https:&quot;</span><span class="token operator" style="color:#393A34">&gt;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><ul><li>如上设置<ul><li>脚本：只信任当前域名</li><li><code>&lt;object&gt;</code>标签：不信任任何 URL，即不加载任何资源</li><li>样式表：只信任<code>cdn.example.org</code>和<code>third-party.org</code></li><li>框架 <code>(frame)</code>：必须使用<code>HTTPS</code>协议加载</li><li>其他资源：没有限制</li></ul></li></ul><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="csrf-跨站请求伪造"></a><code>CSRF</code> 跨站请求伪造<a class="hash-link" href="#csrf-跨站请求伪造" title="Direct link to heading">#</a></h3><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="攻击-1"></a>攻击<a class="hash-link" href="#攻击-1" title="Direct link to heading">#</a></h4><p>原理： 诱导用户打开黑客的网站，在黑客的网站中，利用用户登录状态发起跨站点请求。</p><ol><li>浏览器向网站 A 发起通信请求</li><li>网站 A 验证通过，建立了通信连接，在浏览器存了 A 的 cookie</li><li>浏览器在未关闭 A 的连接下访问网站 B</li><li>网站 B 含有恶意请求代码，向网站 A 发起请求</li><li>浏览器根据 B 发起的请求并且携带 A 的 cookie 访问 A</li><li>网站 A 验证 cookie 并且响应了这个请求</li></ol><p>网站 B 就通过盗用保存在客户端的 cookie，以客户端的身份来访问网站 A，以客户端身份进行一些非法操作。</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly js"><pre tabindex="0" class="prism-code language-js codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">你正在购物，看中了某个商品，商品id是</span><span class="token number" style="color:#36acaa">100</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">付费接口是xxx</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">com</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">pay</span><span class="token operator" style="color:#393A34">?</span><span class="token plain">id</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">100</span><span class="token plain">，但没有任何验证</span></span><span class="token-line" style="color:#393A34"><span class="token plain">我是攻击者，我看中了一个商品，id是</span><span class="token number" style="color:#36acaa">200</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">我向你发送一封电子邮件，邮件标题很吸引人</span></span><span class="token-line" style="color:#393A34"><span class="token plain">但邮件正文隐藏着</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">img src</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">xxx</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">com</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">pay</span><span class="token operator" style="color:#393A34">?</span><span class="token plain">id</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">200</span><span class="token operator" style="color:#393A34">/</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">你一查看邮件，就帮我购买了id是</span><span class="token number" style="color:#36acaa">200</span><span class="token plain">的商品</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="预防-1"></a>预防<a class="hash-link" href="#预防-1" title="Direct link to heading">#</a></h4><blockquote><p><code>SameSite</code></p></blockquote><ul><li><p>对 <code>Cookie</code> 设置 <code>SameSite</code> 属性。表示 <code>Cookie</code> 不随着跨域请求发送，可以很大程度减少 <code>CSRF</code> 的攻击，但是存在兼容性问题。</p><ul><li><p><code>Strict</code>：所有从当前域发送出来的非同域请求都不会带上<code>cookie</code></p></li><li><p><code>Lax</code>：就是在 GET 方式提交表单时会携带<code>cookie，post、iframe/img</code>等标签加载时不会携带<code>cookie</code>。</p></li><li><p><code>None</code>：关闭<code>SameSite</code>，不过，前提是必须同时设置<code>Secure</code>属性<code>(Cookie 只能通过 HTTPS 协议发送)</code>，否则无效。</p></li></ul></li></ul><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly js"><pre tabindex="0" class="prism-code language-js codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token known-class-name class-name">Set</span><span class="token operator" style="color:#393A34">-</span><span class="token maybe-class-name">Cookie</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token maybe-class-name">CookieName</span><span class="token operator" style="color:#393A34">=</span><span class="token maybe-class-name">CookieValue</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token maybe-class-name">SameSite</span><span class="token operator" style="color:#393A34">=</span><span class="token maybe-class-name">Strict</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">//这个规则过于严格，可能造成非常不好的用户体验。</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">//比如，当前网页有一个 GitHub 链接，用户点击跳转就不会带有 GitHub 的 Cookie，跳转过去总是未登陆状态。</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token known-class-name class-name">Set</span><span class="token operator" style="color:#393A34">-</span><span class="token maybe-class-name">Cookie</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token maybe-class-name">CookieName</span><span class="token operator" style="color:#393A34">=</span><span class="token maybe-class-name">CookieValue</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token maybe-class-name">SameSite</span><span class="token operator" style="color:#393A34">=</span><span class="token maybe-class-name">Lax</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">//Lax规则稍稍放宽，大多数情况也是不发送第三方 Cookie，但是导航到目标网址的 Get 请求除外。</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token known-class-name class-name">Set</span><span class="token operator" style="color:#393A34">-</span><span class="token maybe-class-name">Cookie</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> widget_session</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">abc123</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token maybe-class-name">SameSite</span><span class="token operator" style="color:#393A34">=</span><span class="token maybe-class-name">None</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token maybe-class-name">Secure</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><blockquote><p>验证 <code>HTTP Referer</code> 字段</p></blockquote><ul><li><code>HTTP Referer</code>是<code>header</code>的一部分，当浏览器向 web 服务器发送请求时，一般会带上<code>Referer</code>信息告诉服务器是从哪个页面链接过来的，服务器籍此可以获得一些信息用于处理。可以通过检查请求的来源来防御<code>CSRF</code>攻击。正常请求的<code>referer</code>具有一定规律，如在提交表单的<code>referer</code>必定是在该页面发起的请求。所以通过检查<code>http</code>包头<code>referer</code>的值是不是这个页面，来判断是不是<code>CSRF</code>攻击。</li><li><code>Refer</code> 可能被伪造</li></ul><blockquote><p>在请求地址中添加 <code>token</code> 并验证</p></blockquote><ul><li><p><code>token</code> 请求拦截 验证是否合法</p></li><li><p>使用 <code>post</code> 接口</p></li><li><p>增加验证，例如密码、短信验证码、指纹等</p></li></ul><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="sql-注入"></a><code>sql</code> 注入<a class="hash-link" href="#sql-注入" title="Direct link to heading">#</a></h3><blockquote><p>权限最小化</p></blockquote><ul><li>严格限制 Web 应用的数据库的操作权限，给此用户提供仅仅能够满足其工作的最低权限，从而最大限度的减少注入攻击对数据库的危害。</li></ul><blockquote><p>正则匹配 字符转义</p></blockquote><ul><li><code>const reg = /select|update|delete|exec|count|&#x27;|&quot;|=|;|&gt;|&lt;|%/i;</code></li></ul><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="点击劫持"></a>点击劫持<a class="hash-link" href="#点击劫持" title="Direct link to heading">#</a></h3><ul><li>通过覆盖不可见的框架误导受害者点击<ul><li>使用一个透明的<code>iframe</code>，覆盖在一个网页上，诱使用户在该页面上进行操作</li><li>使用一张图片覆盖在网页，遮挡网页原有位置的含义</li></ul></li></ul><p>使用 HTTP 头 <code>X-Frame-Options</code> 进行攻击防御这个</p><ul><li><code>deny</code>：表示该页面不允许在 <code>frame</code> 中展示，即便是在相同域名的页面中嵌套也不允许</li><li><code>sameorigin</code>：表示该页面可以在相同域名页面的 <code>frame</code> 中展示</li><li><code>allow-form url</code>：表示该页面可以在指定来源的 <code>frame</code> 中展示</li></ul><div class="admonition admonition-note alert alert--secondary"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>Ref</h5></div><div class="admonition-content"><ul><li><a href="https://zhuanlan.zhihu.com/p/83865185" target="_blank" rel="noopener noreferrer">前端安全</a></li><li><a href="http://www.ruanyifeng.com/blog/2016/09/csp.html" target="_blank" rel="noopener noreferrer">Content Security Policy 入门教程</a></li><li><a href="https://juejin.cn/post/6951571103953190925" target="_blank" rel="noopener noreferrer">一、web 安全（xss/csrf）简单攻击原理和防御方案（理论篇）</a></li></ul></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="存储"></a>存储<a class="hash-link" href="#存储" title="Direct link to heading">#</a></h2><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="cookie-localstorage-sessionstorage-区别"></a><code>cookie localStorage sessionStorage</code> 区别<a class="hash-link" href="#cookie-localstorage-sessionstorage-区别" title="Direct link to heading">#</a></h3><ul><li>容量</li><li>API 易用性</li><li>是否跟随<code>http</code>请求发送出去</li></ul><h5><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="比较cookielocalstoragesessionstorage"></a>比较<code>cookie、localStorage、sessionStorage</code><a class="hash-link" href="#比较cookielocalstoragesessionstorage" title="Direct link to heading">#</a></h5><p>相同点：都是存储数据，存储在 web 端，并且都是同源</p><p>不同点：</p><ul><li><code>cookie</code> 只有 4K 并且每一次 http 请求都会带上<code>cookie</code> ，增加请求数据量，浪费带宽</li><li><code>sessionStorage</code>和<code>localStorage</code>直接存储在本地，请求不会携带，并且容量比<code>cookie</code>要大的多（5M？）</li><li>生命周期：<ul><li><code>sessionStorage</code> 是临时会话，当前窗口被关闭的时候就清除掉</li><li><code>localStorage</code> 永久存在，除非手动删除或用代码删除，一般用<code>localStorage</code> 会更多一些</li><li><code>cookie</code> 有过期时间</li></ul></li><li><code>cookie</code> 和<code>localStorage</code>都可以支持多窗口共享(同源策略)，而<code>session</code>不支持多窗口共享。但是都支持 a 链接跳转的新窗口</li></ul><h5><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="api"></a>API<a class="hash-link" href="#api" title="Direct link to heading">#</a></h5><ul><li><code>cookie:</code> 可用<code>document.cookie = &#x27;...&#x27;</code>来修改，但一次只能赋值一个且同一个 key 会覆盖，不同的 key 是追加的过程。</li><li><code>localStorage sessionStorage:</code> API 简易使用<code>setItem getItem</code></li></ul><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="方法详解"></a>方法详解<a class="hash-link" href="#方法详解" title="Direct link to heading">#</a></h4><ul><li><p><code>setItem(key, value)</code>设置存储内容</p></li><li><p><code>getItem(key)</code>读取存储内容</p></li><li><p><code>removeItem(key)</code>删除键值为<code>key</code>的存储内容</p></li><li><p><code>clear()</code>清空所有存储内容</p></li><li><p><code>key(n)</code> 以索引值来获取键名</p></li><li><p><code>length</code>存储的数据的个数</p></li></ul><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="关于cookie"></a>关于<code>cookie</code><a class="hash-link" href="#关于cookie" title="Direct link to heading">#</a></h4><ul><li><code>cookie</code>的编码方式：<code>encodeURI()</code></li></ul><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="cookie-有哪些字段可以设置"></a>cookie 有哪些字段可以设置<a class="hash-link" href="#cookie-有哪些字段可以设置" title="Direct link to heading">#</a></h4><ul><li><a href="https://www.kancloud.cn/kancloud/http-cookies-explained/48333" target="_blank" rel="noopener noreferrer">HTTP cookies 详解</a></li><li><code>Set-Cookie: value[; expires=date][; domain=domain][; path=path][; secure]</code></li><li><code>Set-Cookie: name=Nicholas; expires=Sat, 02 May 2021 23:38:25 GMT domain=nczonline.net; path=/blog; secure</code><ul><li><code>secure</code>：只允许在 https 下传输</li><li><code>Max-age</code>: cookie 生成后失效的秒数</li><li><code>expire</code>: cookie 的最长有效时间，若不设置则 cookie 生命期与会话期相同</li></ul></li><li><code>document.cookie=&quot;name=Nicholas;domain=nczonline.net;path=/&quot;;</code></li><li>通过给<code>cookie</code>设置<code>http-only</code>属性，使得不能被客户端更改访问，无法通过<code>js</code>脚本读取到该<code>cookie</code>的信息。但还是能通过 <code>Application</code>中手动修改<code>cookie</code>，所以只是在一定程度上可以防止<code>xss</code>攻击，并不是绝对的安全。</li><li><code>cookie</code>数据有路径<code>path</code>的概念，可以限制当前<code>cookie</code>只属于某个路径下</li></ul><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="cookie-与-session"></a>cookie 与 session<a class="hash-link" href="#cookie-与-session" title="Direct link to heading">#</a></h4><ul><li><code>cookie</code>数据存放在客户的浏览器上，<code>session</code>数据放在服务器上</li><li><code>cookie</code>在<code>http</code>下是明文传输的，不是很安全。别人可以分析存放在本地的<code>cookie</code>并进行<code>cookie</code>欺骗
考虑到安全应当使用<code>session</code>。</li><li><code>session</code>的运行依赖<code>sessionId</code>，而<code>sessionId</code>又保存在<code>cookie</code>中，所以如果禁用的<code>cookie</code>，<code>session</code>也是不能用的，不过硬要用也可以，可以把<code>sessionId</code>保存在<code>url</code>中</li><li><code>session</code>会在一定时间内保存在服务器上。当访问增多，会比较占用你服务器的性能，考虑到减轻服务器性能方面，应当使用<code>cookie</code></li><li>单个<code>cookie</code>保存的数据不能超过 4K，很多浏览器都限制一个站点最多保存 20 个<code>cookie</code></li></ul><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="localstorage-存满了怎么办"></a>localstorage 存满了怎么办？<a class="hash-link" href="#localstorage-存满了怎么办" title="Direct link to heading">#</a></h4><ul><li><p>划分域名：各域名下的存储空间由各业务组统一规划使用</p></li><li><p>跨页面传数据：考虑单页应用、优先采用 url 传输数据</p></li><li><p>最后兜底方案：清掉别人的存储</p></li><li><p><code>cookie</code> 的跨域问题</p><ul><li>存在，<code>cookie</code>是跟域名绑定的；可以通过二级域名来解决跨域问题</li></ul></li></ul></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/docs/extension/web-api"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">« Web-API</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/docs/ts/basic"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">basic »</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_35-E thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#运行环境" class="table-of-contents__link">运行环境</a><ul><li><a href="#页面渲染" class="table-of-contents__link">页面渲染</a></li></ul></li><li><a href="#性能优化" class="table-of-contents__link">性能优化</a><ul><li><a href="#性能优化原则" class="table-of-contents__link">性能优化原则</a></li><li><a href="#首屏优化" class="table-of-contents__link">首屏优化</a></li></ul></li><li><a href="#安全" class="table-of-contents__link">安全</a><ul><li><a href="#xss-跨站脚本攻击" class="table-of-contents__link"><code>XSS</code> 跨站脚本攻击</a></li><li><a href="#csrf-跨站请求伪造" class="table-of-contents__link"><code>CSRF</code> 跨站请求伪造</a></li><li><a href="#sql-注入" class="table-of-contents__link"><code>sql</code> 注入</a></li><li><a href="#点击劫持" class="table-of-contents__link">点击劫持</a></li></ul></li><li><a href="#存储" class="table-of-contents__link">存储</a><ul><li><a href="#cookie-localstorage-sessionstorage-区别" class="table-of-contents__link"><code>cookie localStorage sessionStorage</code> 区别</a></li></ul></li></ul></div></div></div></div></main></div></div></div>
<script src="/assets/js/runtime~main.571898a5.js"></script>
<script src="/assets/js/main.9dc5cbc4.js"></script>
</body>
</html>