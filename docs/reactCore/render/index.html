<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.4">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="HonjayChang Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="HonjayChang Blog Atom Feed"><title data-react-helmet="true">render阶段 | HonjayChang</title><meta data-react-helmet="true" property="og:url" content="https://honjaychang.github.io//docs/reactCore/render"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="render阶段 | HonjayChang"><meta data-react-helmet="true" name="description" content="render 阶段"><meta data-react-helmet="true" property="og:description" content="render 阶段"><link data-react-helmet="true" rel="shortcut icon" href="/img/photo.ico"><link data-react-helmet="true" rel="canonical" href="https://honjaychang.github.io//docs/reactCore/render"><link data-react-helmet="true" rel="alternate" href="https://honjaychang.github.io//docs/reactCore/render" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://honjaychang.github.io//docs/reactCore/render" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.6b743985.css">
<link rel="preload" href="/assets/js/runtime~main.e861e66d.js" as="script">
<link rel="preload" href="/assets/js/main.6b6955fb.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_1oUP">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a href="https://honjaychang.github.io/docs/home" target="_blank" rel="noopener noreferrer" class="navbar__brand"><img src="/img/photo.jpg" alt="My Site Logo" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/img/photo.jpg" alt="My Site Logo" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"></a><a class="navbar__item navbar__link navbar__link--active" href="/docs/Home">Docs</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/Honjaychang" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="react-toggle toggle_3Zt9 react-toggle--disabled"><div class="react-toggle-track" role="button" tabindex="-1"><div class="react-toggle-track-check"><span class="toggle_71bT">🌜</span></div><div class="react-toggle-track-x"><span class="toggle_71bT">🌞</span></div><div class="react-toggle-thumb"></div></div><input type="checkbox" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper doc-page"><div class="docPage_31aa"><button class="clean-btn backToTopButton_35hR" type="button" title="Scroll to top"><svg viewBox="0 0 24 24" width="28"><path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z" fill="currentColor"></path></svg></button><aside class="docSidebarContainer_3Kbt"><div class="sidebar_15mo"><nav class="menu thin-scrollbar menu_Bmed menuWithAnnouncementBar_2WvA"><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/docs/Home">Home</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">HC</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">JS</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Extension</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">TS</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">React</a></li><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#">ReactCore</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/reactCore/basic">一些概念</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/reactCore/ds">数据结构定义</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/reactCore/createUpdate">更新</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/reactCore/schedule">任务调度</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active active" tabindex="0" href="/docs/reactCore/render">render阶段</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/reactCore/diff">diff</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Dev</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Network</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Algo</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Interview</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Vue</a></li></ul></nav><button type="button" title="Collapse sidebar" aria-label="Collapse sidebar" class="button button--secondary button--outline collapseSidebarButton_1CGd"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_3E-R"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></aside><main class="docMainContainer_3ufF"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_3FnS"><div class="docItemContainer_33ec"><article><div class="tocCollapsible_1PrD tocMobile_3Hoh"><button type="button" class="clean-btn tocCollapsibleButton_2O1e">On this page</button></div><div class="markdown"><header><h1 class="h1Heading_27L5">render阶段</h1></header><p><code>render</code> 阶段</p><blockquote><p>应用程序渲染时在 <code>render</code> 阶段的一个重要工作就是构建 <code>workInProgress</code> 树，构建 <code>workInProgress</code> 树的过程中 <code>React</code> 也会完成更新计算、调用生命周期函数以及收集副作用列表等工作</p><p>在这个过程中 React 也会完成结点 <code>diff</code> 的逻辑，最终会得到用于更新到屏幕的副作用列表</p><p>React 应用程序首次渲染时构建 <code>workInProgress</code> 树的过程也是将 <code>React</code> 元素树转化为 <code>Fiber</code> 树的过程， <code>workInProgress</code> 树构建完成后会在该「树」上面完成更新计算、调用生命周期函数以及收集副作用列表等工作。</p><p>收集好的副作用列表会在 <code>commit</code> 阶段统一映射到屏幕上。</p></blockquote><p><code>beginWork</code></p><p><code>completeWork</code></p><p><code>commit</code> 阶段</p><p>在 <code>Diff</code> 之后，<code>workInProgress</code>节点就会进入<code>complete</code>阶段</p><p>这个时候拿到的<code>workInProgress</code>节点都是经过<code>diff</code>算法调和过的，也就意味着对于某个节点来说它<code>fiber</code>的形态已经基本确定了，但除此之外还有两点：</p><ul><li>目前只有<code>fiber</code>形态变了，对于原生DOM组件 <code>HostComponent</code> 和文本节点 <code>HostText</code> 的<code>fiber</code>来说，对应的DOM节点 <code>fiber.stateNode</code> 并未变化</li><li>经过<code>Diff</code>生成的新的<code>workInProgress</code>节点持有了<code>flag</code> 即<code>effectTag</code></li></ul><p>基于这两个特点，<code>completeWork</code>的工作主要有：</p><ul><li>构建或更新DOM节点<ul><li>构建过程中，会自下而上将子节点的第一层第一层插入到当前节点。</li><li>更新过程中，会计算DOM节点的属性，一旦属性需要更新，会为DOM节点对应的<code>workInProgress</code> 节点标记<code>Update</code> 的 <code>effectTag</code></li></ul></li><li>自下而上收集 <code>effectList</code>，最终收集到 <code>root</code>上</li><li>错误处理</li></ul><p><img src="https://cdn.jsdelivr.net/gh/honjaychang/bp/fe/20211002152401.png" alt="image-20211002152401431"></p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="render阶段-1"></a>render阶段<a class="hash-link" href="#render阶段-1" title="Direct link to heading">#</a></h2><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="构建-wip-树"></a>构建 <code>wIP</code> 树<a class="hash-link" href="#构建-wip-树" title="Direct link to heading">#</a></h3><blockquote><p>此阶段 <code>React</code> 将元素逐个转换为对应类型的 <code>Fiber</code> 结点，最终形成 <code>workInProgress</code> 树</p></blockquote><p>应用程序首次渲染过程刚进入 <code>render</code> 阶段时 <code>fiberRoot</code> 对象上面只有 <code>current</code> 树，此时的 <code>current</code> 树只有一个类型为 <code>HostRoot</code> 的 <code>Fiber</code> 结点，该 <code>Fiber</code> 结点的更新队列中只有一个更新对象，内容是应用程序的根组件元素。紧接着 <code>React</code> 要做的就是初始化 <code>workInProgress</code> 对象。</p><p><img src="https://cdn.jsdelivr.net/gh/honjaychang/bp/fe/20211001131338.png" alt="image-20211001131338587"></p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="初始化-wip-对象"></a>初始化 <code>wIP</code> 对象<a class="hash-link" href="#初始化-wip-对象" title="Direct link to heading">#</a></h4><ul><li><code>renderRoot</code> 调用 <code>createWorkInProgress</code> 为 <code>workInProgress</code> 对象赋初始值</li><li>函数调用后 <code>wIP</code> 对象上有了第一个<code>Fiber</code>结点，结点的<code>tag</code>为<code>HostRoot</code> 是整个<code>wIP</code>树的根节点</li></ul><p><img src="https://cdn.jsdelivr.net/gh/honjaychang/bp/fe/20211001132001.png" alt="image-20211001132001247"></p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="完善-wip-对象"></a>完善 <code>wIP</code> 对象<a class="hash-link" href="#完善-wip-对象" title="Direct link to heading">#</a></h4><ul><li>要想把组件元素描述的页面结构映射到屏幕上必须先将元素转换为 <code>Fiber</code> 结点</li><li>完善<code>wIP</code> 对象的过程就是 将 <code>React</code> 元素树转化为 <code>Fiber</code> 树的过程</li></ul><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="工作循环"></a>工作循环<a class="hash-link" href="#工作循环" title="Direct link to heading">#</a></h3><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="循环解析工作单元"></a>循环解析工作单元<a class="hash-link" href="#循环解析工作单元" title="Direct link to heading">#</a></h4><ul><li>工作循环主要是执行 <code>workLoop</code> 函数来循环解析工作单元。每次循环解析的工作单元就是上一次 <code>Fiber</code> 结点的 <code>child</code>。</li><li>第一次循环解析的是 <code>HostRoot</code> 类型的结点，该结点也就是所有结点的祖先</li><li>工作单元具体的解析逻辑在 <code>performUnitOfWork</code> 中调用</li></ul><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="解析工作单元"></a>解析工作单元<a class="hash-link" href="#解析工作单元" title="Direct link to heading">#</a></h4><p>在 <code>beginWork</code> 函数内部通过匹配 <code>Fiber</code> 结点的 <code>tag</code> 值调用 <code>updateHostRoot、updateClassComponent、updateHostComponent、updateHostText</code> 等函数，分别解析 <code>HostRoot、ClassComponent、HostComponent、HostText</code>等类型的Fiber 结点。</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="完成工作单元"></a>完成工作单元<a class="hash-link" href="#完成工作单元" title="Direct link to heading">#</a></h4><p>工作单元解析执行到 <code>workInProgress</code> 树的叶子结点时，会完成当前工作单元。完成工作单元的主要工作是收集副作用，同时处理 <code>HostComponent</code> 类型的结点，创建对应的 <code>DOM</code> 元素并将他们 <code>append</code> 到父结点上</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly js"><pre tabindex="0" class="prism-code language-js codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">构建 workInProgress 树的过程也是执行「协调算法」过程，通过循环解析工作单元获取下一个 </span><span class="token maybe-class-name">Fiber</span><span class="token plain"> 结点，同时 父子结点和兄弟结点也会被串联起来。这个过程从整体上可以分为两步，分别是 初始化 workInProgress 对象和 完善 workInProgress 对象。首先，我们先看一下应用程序执行过程刚进入 render 阶段时的 fiberRoot 对象。</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">从初始化 workInProgress 对象到形成 workInProgress 树，应用程序会执行多次循环，每一次循环都是在解析 </span><span class="token maybe-class-name">Fiber</span><span class="token plain"> 结点并返回下一个要解析的结点。这 个过程中会使用重要的「协调」算法，同时也会进行结点的 diff 操作。</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">通过工作循环来构建workInProgress 两个关键环节 解析工作单元 完成工作单元</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="解析不同类型fiber结点"></a>解析不同类型<code>Fiber</code>结点<a class="hash-link" href="#解析不同类型fiber结点" title="Direct link to heading">#</a></h3><p>应用程序首次渲染时，将根组件元素转换为多个层级的 <code>Fiber</code> 结点过程中，第一步要做的就是解析 <code>wIP</code> 树的根结点 <code>HostRoot</code></p><p><img src="https://cdn.jsdelivr.net/gh/honjaychang/bp/fe/20211001140433.png" alt="image-20211001140433792"></p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="hostroot-类型"></a><code>HostRoot</code> 类型<a class="hash-link" href="#hostroot-类型" title="Direct link to heading">#</a></h4><ul><li><code>updateHostRoot -&gt; processUpdateQueue</code></li><li>解析 <code>HostRoot</code>类型结点的关键是处理更新队列 <code>processUpdateQueue</code> 获取根组件元素 <code>element</code>，<code>element </code>就是要传入到协调算法中进行解析的<code>nextChildren</code></li></ul><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly js"><pre tabindex="0" class="prism-code language-js codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">updateHostRoot</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">current$$</span><span class="token parameter number" style="color:#36acaa">1</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"> workInProgress</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"> renderExpirationTime</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">pushHostRootContext</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">workInProgress</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> updateQueue </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> workInProgress</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">updateQueue</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> nextProps </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> workInProgress</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">pendingProps</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> prevState </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> workInProgress</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">memoizedState</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> prevChildren </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> prevState </span><span class="token operator" style="color:#393A34">!==</span><span class="token plain"> </span><span class="token keyword null nil" style="color:#00009f">null</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">?</span><span class="token plain"> prevState</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">element</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword null nil" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">processUpdateQueue</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">workInProgress</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> updateQueue</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> nextProps</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword null nil" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> renderExpirationTime</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> nextState </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> workInProgress</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">memoizedState</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// Caution: React DevTools currently depends on this property</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// being called &quot;element&quot;.</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> nextChildren </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> nextState</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">element</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">nextChildren </span><span class="token operator" style="color:#393A34">===</span><span class="token plain"> prevChildren</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// If the state is the same as before, that&#x27;s a bailout because we had</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// no work that expires at this time.</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">resetHydrationState</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword control-flow" style="color:#00009f">return</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">bailoutOnAlreadyFinishedWork</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">current$$</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> workInProgress</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> renderExpirationTime</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> root </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> workInProgress</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">stateNode</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">current$$</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">===</span><span class="token plain"> </span><span class="token keyword null nil" style="color:#00009f">null</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">||</span><span class="token plain"> current$$</span><span class="token number" style="color:#36acaa">1.</span><span class="token plain">child </span><span class="token operator" style="color:#393A34">===</span><span class="token plain"> </span><span class="token keyword null nil" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> root</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">hydrate</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">enterHydrationState</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">workInProgress</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// If we don&#x27;t have any current children this might be the first pass.</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// We always try to hydrate. If this isn&#x27;t a hydration pass there won&#x27;t</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// be any children to hydrate which is effectively the same thing as</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// not hydrating.</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// This is a bit of a hack. We track the host root as a placement to</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// know that we&#x27;re currently in a mounting state. That way isMounted</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// works as expected. We must reset this before committing.</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// TODO: Delete this when we delete isMounted and findDOMNode.</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    workInProgress</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">effectTag</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|=</span><span class="token plain"> </span><span class="token maybe-class-name">Placement</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Ensure that children mount into this root without tracking</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// side-effects. This ensures that we don&#x27;t store Placement effects on</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// nodes that will be hydrated.</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    workInProgress</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">child</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">mountChildFibers</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">workInProgress</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword null nil" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> nextChildren</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> renderExpirationTime</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#00009f">else</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Otherwise reset hydration state in case we aborted and resumed another</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// root.</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">reconcileChildren</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">current$$</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> workInProgress</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> nextChildren</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> renderExpirationTime</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">resetHydrationState</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">return</span><span class="token plain"> workInProgress</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">child</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="classcomponent-类型"></a><code>ClassComponent</code> 类型<a class="hash-link" href="#classcomponent-类型" title="Direct link to heading">#</a></h4><ul><li>应用程序首次渲染时解析 <code>HostRoot</code> 类型结点完成后返回的一般是 <code>ClassComponent</code> 类型的结点，这种类型的 <code>Fiber</code> 结点解析过程中是要进行组件实例化的</li><li>解析<code>ClassComponent</code>类型的结点时，先从当前 <code>Fiber</code> 结点的 <code>stateNode</code> 属性上面取组件实例<code>instance</code>，如果 <code>instance</code> 的值为 <code>null</code> 则说明是首次渲染，组件还没有被实例化。React 使用 <code>constructClassInstance</code> 函数完成组件实例化，同时为组件实例添加更新器（然后就可以调用 <code>setState</code> </li><li>组件实例生成后，它的核心作用之一就是在  <code>finishClassComponent</code>  函数内部执行 <code>instance.render() </code>获取要传入到协调算法中进行解析的 <code>nextChildren</code></li></ul><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly js"><pre tabindex="0" class="prism-code language-js codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">updateClassComponent</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">current$$</span><span class="token parameter number" style="color:#36acaa">1</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"> workInProgress</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"> Component</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"> nextProps</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"> renderExpirationTime</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// ...</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> instance </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> workInProgress</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">stateNode</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> shouldUpdate </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">instance </span><span class="token operator" style="color:#393A34">===</span><span class="token plain"> </span><span class="token keyword null nil" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">current$$</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!==</span><span class="token plain"> </span><span class="token keyword null nil" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic">// An class component without an instance only mounts if it suspended</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic">// inside a non- concurrent tree, in an inconsistent state. We want to</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic">// tree it like a new mount, even though an empty version of it already</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic">// committed. Disconnect the alternate pointers.</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      current$$</span><span class="token number" style="color:#36acaa">1.</span><span class="token plain">alternate </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword null nil" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      workInProgress</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">alternate</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword null nil" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic">// Since this is conceptually a new fiber, schedule a Placement effect</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      workInProgress</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">effectTag</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|=</span><span class="token plain"> </span><span class="token maybe-class-name">Placement</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// In the initial pass we might need to construct the instance.</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">constructClassInstance</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">workInProgress</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token maybe-class-name">Component</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> nextProps</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> renderExpirationTime</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">mountClassInstance</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">workInProgress</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token maybe-class-name">Component</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> nextProps</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> renderExpirationTime</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    shouldUpdate </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#00009f">else</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">current$$</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">===</span><span class="token plain"> </span><span class="token keyword null nil" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// In a resume, we&#x27;ll already have an instance we can reuse.</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    shouldUpdate </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">resumeMountClassInstance</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">workInProgress</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token maybe-class-name">Component</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> nextProps</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> renderExpirationTime</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#00009f">else</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    shouldUpdate </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">updateClassInstance</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">current$$</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> workInProgress</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token maybe-class-name">Component</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> nextProps</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> renderExpirationTime</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> nextUnitOfWork </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">finishClassComponent</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">current$$</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> workInProgress</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token maybe-class-name">Component</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> shouldUpdate</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> hasContext</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> renderExpirationTime</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">return</span><span class="token plain"> nextUnitOfWork</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">finishClassComponent</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">current$$</span><span class="token parameter number" style="color:#36acaa">1</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"> workInProgress</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"> Component</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"> shouldUpdate</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"> hasContext</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"> renderExpirationTime</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// ...</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">return</span><span class="token plain"> workInProgress</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">child</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="hostcomponent-类型"></a><code>HostComponent</code> 类型<a class="hash-link" href="#hostcomponent-类型" title="Direct link to heading">#</a></h4><ul><li>解析 <code>ClassComponent</code> 类型结点完成后返回的一般是 <code>HostComponent</code> 类型<code>tag</code>的结点，这种结点的具体类型 <code>elementType</code>对应的是真实的 <code>DOM</code> 标签 (如 <code>div  span ...</code> </li><li>解析 <code>HostComponent</code> 类型结点，可从当前结点对应的元素 <code>props</code> 中获取要传入到协调算法中进行解析的 <code>nextChildren</code></li><li>这里要强调一下，无论是解析 HostRoot 类型的结点，还是解析 <code>HostComponent</code> 类型的结点，这个过程中获取的 <code>nextChildren</code> 均为 <code>React 元素</code>。在执行协调算法的过程中，<code>React</code> 将该元素转换成对应的 <code>Fiber </code>结点并返回。</li></ul><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="hosttext-类型"></a><code>HostText</code> 类型<a class="hash-link" href="#hosttext-类型" title="Direct link to heading">#</a></h4><ul><li>当解析到元素的叶子元素时，此时对应的 <code>Fiber</code> 结点类型为 <code>HostText</code> 。<code>React</code> 认为文本类型的 <code>Fiber </code>结点已经是终点，不会再有孩子结点，直接返回 <code>null</code></li></ul><p><img src="https://cdn.jsdelivr.net/gh/honjaychang/bp/fe/20211001145029.png" alt="image-20211001145029076"></p><p>在工作循环的过程中，<code>React</code> 总是先从外部根节点开始解析，当解析到叶子结点时就要开始完成工作单元。完成工作单元时如果有兄弟结点时则需要继续解析兄弟结点，然后完成兄弟结点后会逐层向上完成工作单元。</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="完成工作单元的时机"></a>完成工作单元的时机<a class="hash-link" href="#完成工作单元的时机" title="Direct link to heading">#</a></h3><ul><li>检查当前结点是否有兄弟结点，如果没有兄弟结点就检查父结点有没有兄弟结点</li><li>为 <code>HostComponent</code> 类型的结点创建 <code>DOM</code> 元素实例</li><li>收集副作用 <code>Effect List</code></li></ul><p>入口函数<code>completeUnitOfWork -&gt; completeWork</code></p><p>在 <code>completeUnitOfWork</code> 函数中执行了一个遍历，这个遍历的方向是由子结点向父结点层层返回</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="创建或更新-dom-元素"></a>创建或更新 DOM 元素<a class="hash-link" href="#创建或更新-dom-元素" title="Direct link to heading">#</a></h4><p><code>completeWork</code> 函数负责对不同类型的工作单元 <code>Fiber 结点</code>分别处理</p><h5><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="hostcomponent"></a><code>HostComponent</code><a class="hash-link" href="#hostcomponent" title="Direct link to heading">#</a></h5><h5><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="hosttext"></a><code>HostText</code><a class="hash-link" href="#hosttext" title="Direct link to heading">#</a></h5><p><code>HostComponent</code> 和<code>HostText</code>类型的 <code>Fiber </code>结点是有对应的真实 <code>DOM</code> 元素，因此在完成工作单元阶段 <code>React</code>要为它们创建自己的 <code>DOM</code> 实例</p><p>在完成工作单元的过程中分为了两种情况，分别是首次渲染和更新渲染。</p><ul><li>应用程序首次渲染时：<code>React</code> 为 <code>HostComponent</code> 和 <code>HostText</code> 类型的 <code>Fiber</code> 结点创建对应的 <code>DOM</code> 实例并将其赋值到结点上的 <code>stateNode</code> 属性上</li><li>应用程序更新渲染时： <code>React</code> 不需要为它们重新创建 <code>DOM</code> 实例，而是把新的值更新到 <code>DOM</code> 元素中</li></ul><p><code>updateHostComponent</code> 函数和 <code>updateHostText</code> 函数分别用于更新 DOM 元素</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="收集副作用"></a>收集副作用<a class="hash-link" href="#收集副作用" title="Direct link to heading">#</a></h4><p>在收集副作用的过程中主要有两种情况</p><ul><li>第一种情况就是将子树上面的副作用列表连到父结点上面</li><li>第二种情况就是如果当前结点也有副作用标识，则将当前结点也连接到父结点的副作用列表中</li></ul><p>事实上，应用程序首次渲染时的副作用列表就是整个 <code>workInProgress</code> 树，因为整个 <code>workInProgress</code> 树的结点中携带的内容都需要更新到屏幕，而在应用程序更新渲染时副作用列表将会是 <code>workInProgress</code> 树的子集</p><p>下图便为应用程序首次渲染完成工作循环后的 <code>wIP</code>树  <code>firstEffect lastEffect</code> 便为副作用链表</p><p>在收集好的副作用列表中每个 <code>HostComponent</code> 类型 <code>Fiber</code> 结点的 <code>stateNode</code> 属性中存储了当前结点对应的 <code>DOM</code> 实例。那么，<code>React</code> 下一步要做的就是将副作用列表中的所有 <code>DOM</code> 实例更新到屏幕中</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="commit-阶段"></a><code>commit</code> 阶段<a class="hash-link" href="#commit-阶段" title="Direct link to heading">#</a></h2><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="何时进入commit阶段"></a>何时进入<code>commit</code>阶段<a class="hash-link" href="#何时进入commit阶段" title="Direct link to heading">#</a></h4><p>工作循环执行结束，标志着应用程序渲染过程中 <code>render</code> 阶段工作的完成。此时 <code>fiberRoot</code> 对象上面的 <code>workInProgress</code> 树存储在 <code>root.current.alternate</code> 指向的内存单元。<code>React</code> 会将 <code>workInProgress</code> 树赋值到 <code>fiberRoot</code> 对象上的 <code>finishedWork</code> 属性中。然后，检查 <code>workInProgressRootExitStatus</code> 的状态，如果是正常结束，则应用程序渲染任务进入 <code>commit</code> 阶段。</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="如何将副作用更新到屏幕"></a>如何将副作用更新到屏幕<a class="hash-link" href="#如何将副作用更新到屏幕" title="Direct link to heading">#</a></h4><p>在 render 阶段结束时 fiberRoot 对象上面将会得到一个副作用列表(Effect List)，这个副作用列表中携带的 更新内容就是要更新到屏幕中的信息</p><p><img src="https://cdn.jsdelivr.net/gh/honjaychang/bp/fe/20211002112616.png" alt="image-20211002112616662"></p><p>应用程序执行在 <code>commit</code> 阶段时，<code>React</code> 将这个过程又分为三个步，分别是 <code>before commit、commit 和 after commit</code>。</p><p>在这三个步分别调用 <code>commitBeforeMutationLifecycles</code> <code>commitMutationEffects</code>???? 和 <code>commitLayoutEffects</code> 三个函数来执行具体的工作。<code>commitRoot</code> 函数内部调用commitRootImpl函数实现 commit 阶段的具体逻辑</p><p>提交阶段的主要任务也就是把之前记录好的更新操作反映到真实的dom上，并且这个过程是不能中断的。</p><p><code>commitRoot</code></p><ul><li>检查 <code>finishedWork</code> 是否也有 <code>effect</code> ，如有插入  <code>effect</code> 链表中</li><li>第一次遍历 <code>effect</code>链，更新<code>class</code>组件实例上的<code>state props</code>，执行<code>getSnapshotBeforeUpdate</code>生命周期</li><li>第二次遍历 <code>effect</code>链，不同的<code>effectTag</code>，执行不同的操作，比如重置文本节点，执行 插入、更新、删除等的  <code>effect</code> 操作，真正的对 <code>dom</code> 进行修改。</li><li>第三次遍历 <code>effect</code>链，这次遍历就是做一些收尾工作。执行<code>componentDidMount、componentDidUpdate</code>，更新的回调函数等。</li><li>做一些 还原变量 等的收尾工作。</li></ul><p><img src="https://cdn.jsdelivr.net/gh/honjaychang/bp/fe/20211002112429.png" alt="image-20211002112429071"></p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="三次链表操作"></a>三次链表操作<a class="hash-link" href="#三次链表操作" title="Direct link to heading">#</a></h4><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly js"><pre tabindex="0" class="prism-code language-js codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">commitRoot</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">root</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"> finishedWork</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  isWorking </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  isCommitting$</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// 检查 finishedWork 是否也有 effect ，如有插入 effect 链表中</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> firstEffect </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">finishedWork</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">effectTag</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token maybe-class-name">PerformedWork</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// A fiber&#x27;s effect list consists only of its children, not itself. So if</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// the root has an effect, we need to add it to the end of the list. The</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// resulting list is the set that would belong to the root&#x27;s parent, if</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// it had one; that is, all the effects in the tree including the root.</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">finishedWork</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">lastEffect</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!==</span><span class="token plain"> </span><span class="token keyword null nil" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      finishedWork</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">lastEffect</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">nextEffect</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> finishedWork</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      firstEffect </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> finishedWork</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">firstEffect</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#00009f">else</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      firstEffect </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> finishedWork</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#00009f">else</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// There is no effect on the root.</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    firstEffect </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> finishedWork</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">firstEffect</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">prepareForCommit</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">root</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">containerInfo</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// Invoke instances of getSnapshotBeforeUpdate before mutation.</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  nextEffect </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> firstEffect</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">startCommitSnapshotEffectsTimer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// 第一次遍历</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">while</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">nextEffect </span><span class="token operator" style="color:#393A34">!==</span><span class="token plain"> </span><span class="token keyword null nil" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">invokeGuardedCallback</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword null nil" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> commitBeforeMutationLifecycles</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword null nil" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">stopCommitSnapshotEffectsTimer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// Commit all the side-effects within a tree. We&#x27;ll do this in two passes.</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// The first pass performs all the host insertions, updates, deletions and</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// ref unmounts.</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  nextEffect </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> firstEffect</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">startCommitHostEffectsTimer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// 第二次遍历</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">while</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">nextEffect </span><span class="token operator" style="color:#393A34">!==</span><span class="token plain"> </span><span class="token keyword null nil" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">invokeGuardedCallback</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword null nil" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> commitAllHostEffects</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword null nil" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">stopCommitHostEffectsTimer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">resetAfterCommit</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">root</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">containerInfo</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// The work-in-progress tree is now the current tree. This must come after</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// the first pass of the commit phase, so that the previous tree is still</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// current during componentWillUnmount, but before the second pass, so that</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// the finished work is current during componentDidMount/Update.</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  root</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">current</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> finishedWork</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// In the second pass we&#x27;ll perform all life-cycles and ref callbacks.</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// Life-cycles happen as a separate pass so that all placements, updates,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// and deletions in the entire tree have already been invoked.</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// This pass also triggers any renderer-specific initial effects.</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  nextEffect </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> firstEffect</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">startCommitLifeCyclesTimer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// 第三次遍历</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">while</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">nextEffect </span><span class="token operator" style="color:#393A34">!==</span><span class="token plain"> </span><span class="token keyword null nil" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">invokeGuardedCallback</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword null nil" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> commitAllLifeCycles</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword null nil" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> root</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> committedExpirationTime</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 下面做一些 还原变量 等的收尾工作</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  isCommitting$</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  isWorking </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">stopCommitLifeCyclesTimer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">stopCommitTimer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">onCommitRoot</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">finishedWork</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">stateNode</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token boolean" style="color:#36acaa">true</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> </span><span class="token maybe-class-name">ReactFiberInstrumentation_1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">debugTool</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token maybe-class-name">ReactFiberInstrumentation_1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">debugTool</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">onCommitWork</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">finishedWork</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> updateExpirationTimeAfterCommit </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> finishedWork</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">expirationTime</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> childExpirationTimeAfterCommit </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> finishedWork</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">childExpirationTime</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> earliestRemainingTimeAfterCommit </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> childExpirationTimeAfterCommit </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> updateExpirationTimeAfterCommit </span><span class="token operator" style="color:#393A34">?</span><span class="token plain"> childExpirationTimeAfterCommit </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> updateExpirationTimeAfterCommit</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">earliestRemainingTimeAfterCommit </span><span class="token operator" style="color:#393A34">===</span><span class="token plain"> </span><span class="token maybe-class-name">NoWork</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// If there&#x27;s no remaining work, we can clear the set of already failed</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// error boundaries.</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    legacyErrorBoundariesThatAlreadyFailed </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword null nil" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">onCommit</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">root</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> earliestRemainingTimeAfterCommit</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// ...</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="commitbeforemutationlifecycles"></a><code>commitBeforeMutationLifecycles</code><a class="hash-link" href="#commitbeforemutationlifecycles" title="Direct link to heading">#</a></h4><ul><li>遍历effect链，在这个循环中，组件的state已经更新，但是节点还没有更新。</li><li>通过 <code>getSnapshotBeforeUpdate</code> 获取<code>prevProps, prevState</code>状态快照，用于 <code>componentDidUpdate</code> 生命周期参数传递</li></ul><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly js"><pre tabindex="0" class="prism-code language-js codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">commitBeforeMutationLifecycles</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">while</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">nextEffect </span><span class="token operator" style="color:#393A34">!==</span><span class="token plain"> </span><span class="token keyword null nil" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> effectTag </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> nextEffect</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">effectTag</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">effectTag </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain"> </span><span class="token maybe-class-name">Snapshot</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token function" style="color:#d73a49">recordEffect</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> current$$</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> nextEffect</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">alternate</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic">// 调用 getSnapshotBeforeUpdate</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token function" style="color:#d73a49">commitBeforeMutationLifeCycles</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">current$$</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> nextEffect</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Don&#x27;t cleanup effects yet;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// This will be done by commitAllLifeCycles()</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    nextEffect </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> nextEffect</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">nextEffect</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="commitallhosteffects"></a><code>commitAllHostEffects</code><a class="hash-link" href="#commitallhosteffects" title="Direct link to heading">#</a></h4><ul><li>遍历 <code>effect</code> 链</li><li>会根据不同的 <code>effectTag</code>，执行不同的操作，比如重置文本节点，执行 插入、更新、删除等的 <code>effect</code> 操作，真正的对 dom 进行修改。</li><li>此阶段正式 commit 副作用，将副作用更新到屏幕。</li><li>应用首次渲染时副作用类型会匹配到 <code>PlacementAndUpdate</code>，具体处理逻辑在 <code>commitPlacement</code> 函数中，该函数主要负责插入 DOM 元素到屏幕</li></ul><p><code>HostComponent</code> 类型的 <code>Fiber</code> 结点在完成工作单元时会创建当前结点对应的 <code>DOM</code> 元素实例，并将其赋值到该结点的 <code>stateNode</code> 属性上。 <code>commitPlacement</code> 函数中的 <code>node.stateNode</code> 指向的就是当前结点对应的 DOM 元素实例。执行完 <code>appendChildToContainer(parent, stateNode) </code>后应用程序中的副作用就会渲染到屏幕上。</p><p>应用程序中的副作用就会渲染到屏幕上后 <code>React</code> 还需要做一些收尾工作，如将当前的 <code>workInProgress</code> 树赋值给 <code>current</code> 树，调用更新完成后的生命周期函数等。</p><p><code>commitMutationEffects</code>函数执行完成后，需要更新的内容已经绘制到了屏幕上，此时的 <code>workInProgress</code> 树也就成了应用程序最新的状态树。因此 <code>React</code> 将 <code>fiberRoot.current</code> 指向最新的 <code>workInProgress</code> 树</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly js"><pre tabindex="0" class="prism-code language-js codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// 这里的finishedWork引用的是workInProgress树</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">root</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">current</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> finishedWork</span><span class="token punctuation" style="color:#393A34">;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly jsx"><pre tabindex="0" class="prism-code language-jsx codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">commitAllHostEffects</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">while</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">nextEffect </span><span class="token operator" style="color:#393A34">!==</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> effectTag </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> nextEffect</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">effectTag</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">effectTag </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain"> ContentReset</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token function" style="color:#d73a49">commitResetTextContent</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">nextEffect</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">effectTag </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain"> Ref</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> current$$</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> nextEffect</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">alternate</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">current$$</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!==</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">commitDetachRef</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">current$$</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// The following switch statement is only concerned about placement,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// updates, and deletions. To avoid needing to add a case for every</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// possible bitmap value, we remove the secondary effects from the</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// effect tag and switch on that value.</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> primaryEffectTag </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> effectTag </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Placement </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Update </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Deletion</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">switch</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">primaryEffectTag</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> Placement</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token function" style="color:#d73a49">commitPlacement</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">nextEffect</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token comment" style="color:#999988;font-style:italic">// Clear the &quot;placement&quot; from effect tag so that we know that this is inserted, before</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token comment" style="color:#999988;font-style:italic">// any life-cycles like componentDidMount gets called.</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token comment" style="color:#999988;font-style:italic">// TODO: findDOMNode doesn&#x27;t rely on this any more but isMounted</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token comment" style="color:#999988;font-style:italic">// does and isMounted is deprecated anyway so we should be able</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token comment" style="color:#999988;font-style:italic">// to kill this.</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token comment" style="color:#999988;font-style:italic">// 删除effectTag</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">          nextEffect</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">effectTag </span><span class="token operator" style="color:#393A34">&amp;=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">~</span><span class="token plain">Placement</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token keyword" style="color:#00009f">break</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> PlacementAndUpdate</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token comment" style="color:#999988;font-style:italic">// Placement</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token function" style="color:#d73a49">commitPlacement</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">nextEffect</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token comment" style="color:#999988;font-style:italic">// Clear the &quot;placement&quot; from effect tag so that we know that this is inserted, before</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token comment" style="color:#999988;font-style:italic">// any life-cycles like componentDidMount gets called.</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">          nextEffect</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">effectTag </span><span class="token operator" style="color:#393A34">&amp;=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">~</span><span class="token plain">Placement</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token comment" style="color:#999988;font-style:italic">// Update</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> _current </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> nextEffect</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">alternate</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token function" style="color:#d73a49">commitWork</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">_current</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> nextEffect</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token keyword" style="color:#00009f">break</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> Update</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> _current2 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> nextEffect</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">alternate</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token function" style="color:#d73a49">commitWork</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">_current2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> nextEffect</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token keyword" style="color:#00009f">break</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> Deletion</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token function" style="color:#d73a49">commitDeletion</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">nextEffect</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token keyword" style="color:#00009f">break</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    nextEffect </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> nextEffect</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">nextEffect</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="commitalllifecycles"></a><code>commitAllLifeCycles</code><a class="hash-link" href="#commitalllifecycles" title="Direct link to heading">#</a></h4><p>函数在更新内容 <code>commit</code> 到屏幕之后执行，这次遍历主要负责 <code>commit</code> 阶段的一些收尾工作</p><p>应用程序的副作用更新到屏幕后，对于 <code>ClassComponent</code> 类型的结点，<code>React</code> 会调用该结点的生命周期函数，如 <code>componentDidMount</code> 和 <code>componentDidUpdate</code> </p><ul><li>首次渲染执行 <code>componentDidMount</code></li><li>更新渲染执行 <code>componentDidUpdate</code></li><li>执行 <code>setState</code> 的 <code>callback</code> 回调函数</li><li>清空 <code>commitUpdateQueue</code></li></ul><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly js"><pre tabindex="0" class="prism-code language-js codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">commitAllLifeCycles</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">finishedRoot</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"> committedExpirationTime</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">while</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">nextEffect </span><span class="token operator" style="color:#393A34">!==</span><span class="token plain"> </span><span class="token keyword null nil" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> effectTag </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> nextEffect</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">effectTag</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">effectTag </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token maybe-class-name">Update</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token maybe-class-name">Callback</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token function" style="color:#d73a49">recordEffect</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> current$$</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> nextEffect</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">alternate</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token function" style="color:#d73a49">commitLifeCycles</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">finishedRoot</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> current$$</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> nextEffect</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> committedExpirationTime</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">effectTag </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain"> </span><span class="token maybe-class-name">Ref</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token function" style="color:#d73a49">recordEffect</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token function" style="color:#d73a49">commitAttachRef</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">nextEffect</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">effectTag </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain"> </span><span class="token maybe-class-name">Passive</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      rootWithPendingPassiveEffects </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> finishedRoot</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    nextEffect </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> nextEffect</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">nextEffect</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly js"><pre tabindex="0" class="prism-code language-js codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">renderRoot </span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">performWorkOnRoot </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> completeRoot </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">  commitRoot</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="首次渲染"></a>首次渲染<a class="hash-link" href="#首次渲染" title="Direct link to heading">#</a></h2><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly js"><pre tabindex="0" class="prism-code language-js codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token maybe-class-name">React</span><span class="token plain"> 应用程序首次渲染时，在 prerender 阶段主要做一些 render 前的准备工作，在 render 阶段做最重要的更新 计算，然后在 commit 阶段将上一阶段计算得到的更新内容映射到屏幕。</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token maybe-class-name">React</span><span class="token plain"> 为什么要这样设计闭环呢</span><span class="token operator" style="color:#393A34">?</span><span class="token plain">个人认为主要是方便找到 </span><span class="token maybe-class-name">Fiber</span><span class="token plain"> 树根结点的 stateNode 属性中的值。</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token maybe-class-name">Fiber</span><span class="token plain"> 结点的stateNode属性存储的当前结点的最终产物，如果是 </span><span class="token maybe-class-name">ClassComponent</span><span class="token plain"> 类型的结点则该属性指向 的是当前 </span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> 组件的实例，如果是 </span><span class="token maybe-class-name">HostComponent</span><span class="token plain"> 类型的结点则该属性指向的是当前结点的 </span><span class="token constant" style="color:#36acaa">DOM</span><span class="token plain"> 实例， 如果是 </span><span class="token maybe-class-name">HostRoot</span><span class="token plain"> 类型的结点则该属性指向的是 fiberRoot 对象。</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="更新渲染"></a>更新渲染<a class="hash-link" href="#更新渲染" title="Direct link to heading">#</a></h2><ul><li>在更新渲染时 <code>React</code> 更加关心的是结点前后 <code>state props</code> 的变化</li></ul><p>在更新渲染时 如何构建<code>wIP</code>树</p><ul><li>首次渲染完成后 <code>fiberRoot</code> 对象上面的 <code>current</code> 属性会指向 <code>workInProgress</code> 树，而原有的 <code>workInProgress</code> 树将会被置为 <code>null</code> ，新的 <code>workInProgress</code> 树只有一个 <code>HostRoot</code> 类型的根结点。</li><li>即此时 <code>fiberRoot</code> 对象中的<code>current</code>属性指向的是上一次(首次)渲染结束后的 <code>workInProgress</code> 树</li></ul><ul><li>从 <code>current</code> 树上面获取 <code>workInProgress</code> 对象</li><li>有了 <code>workInProgress</code> 对象后，下一步就是通过工作循环完善该对象，这个过程依然是要进行解析工作单元以及完成工作单元</li></ul><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="解析工作单元-1"></a>解析工作单元<a class="hash-link" href="#解析工作单元-1" title="Direct link to heading">#</a></h4><p>在应用程序更新渲染时，<code>React</code> 解析工作单元 <code>(Fiber结点)</code> 的主要关注点是 <code>ClassComponent</code>类型的<code>Fiber</code>结点</p><h5><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="处理结点的更新队列"></a>处理结点的更新队列<a class="hash-link" href="#处理结点的更新队列" title="Direct link to heading">#</a></h5><ul><li>应用程序执行到 <code>render</code> 阶段，在解析工作单元时 <code>React</code> 会处理该结点的更新队列，目的就是获取更新对象中最新的 <code>payload</code> 信息</li><li>在 <code>processUpdateQueue</code> 函数中会处理当前 <code>Fiber</code> 结点的更新队列并将最终的 <code>state</code> 赋值到当前 <code>Fiber</code> 结点的 <code>memoizedState</code> 属性中</li></ul><h5><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="检查结点是否需要更新"></a>检查结点是否需要更新<a class="hash-link" href="#检查结点是否需要更新" title="Direct link to heading">#</a></h5><ul><li>处理完该结点的 <code>updateQueue</code> 后就可以得到最新的 <code>state</code> ，然后 <code>React</code> 需要对比前后 <code>state</code> 以决定当前结点是否需要更新</li><li>检查工作单元是否需要更新首先根据该结点是否有<code>shouldComponentUpdate</code>生命周期函数，有则调用该函数并取其执行结果 没有则进行结点的<code>props</code>和<code>state</code>前后对比</li><li><code>React</code>定义了<code>shallowEqual</code>方法来进行对象是否相等的比较</li></ul><h5><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="协调reconcile与结点diff的过程"></a>协调<code>reconcile</code>与结点<code>diff</code>的过程<a class="hash-link" href="#协调reconcile与结点diff的过程" title="Direct link to heading">#</a></h5><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly js"><pre tabindex="0" class="prism-code language-js codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// 执行「协调算法」，获取下一个Fiber结点</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">reconcileChildren</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">current</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> workInProgress</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> nextChildren</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> renderExpirationTime</span><span class="token punctuation" style="color:#393A34">)</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>当检测到 <code>class</code> 组件对应的 <code>Fiber</code> 结点需要更新后，<code>React</code> 会通过 <code>instance.render()</code> 获取组件元素，将该组件元素传入到「协调算法」中，然后获得下一个 <code>Fiber</code> 结点。获得下一个 <code>Fiber</code> 结点的过程也是 <code>React</code> 进行(新的)元素与现有 <code>Fiber</code> 结点进行 <code>diff</code> 处理的过程。</p><h5><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="为结点标记-effecttag"></a>为结点标记 effectTag<a class="hash-link" href="#为结点标记-effecttag" title="Direct link to heading">#</a></h5><blockquote><p>标记插入 <code>Placement</code></p></blockquote><ul><li>在「协调」获取下一个 <code>Fiber</code> 结点的过程中调用 <code>placeChild</code> 函数为下一个结点标记 <code>Placement</code></li></ul><blockquote><p>标记更新 <code>Update</code></p></blockquote><ul><li>在完成工作单元时，使用 <code>updateHostComponent</code> 函数完成 <code>HostComponent</code> 类型的工作单元(Fiber 结点</li><li>这时 <code>React</code> 使用 <code>prepareUpdate</code> 方法对比结点对应 <code>DOM</code> 实例的属性及内容是否发生变化，如果有变化则为该结点标记 <code>Update</code> </li></ul><blockquote><p>标记插入并更新 <code>PlacementAndUpdate</code></p></blockquote><ul><li>如果一个结点既被标记了<code>Placement</code>也被标记了<code>Update</code>，那么该结点的 <code>effectTag</code> 的二进制对应的就是 <code>PlacementAndUpdate</code> </li></ul><blockquote><p>标记删除 <code>Deletion</code></p></blockquote><ul><li>在「协调」数组元素时，如果新的数组元素比此处 <code>Fiber</code> 树的结点数量少时，那么丢下的那个结点将会被调用 <code>deleteChild</code> 函数标记为 <code>Deletion</code> 。还有一种情况就是程序中控制元素显示的条件值变为 <code>false</code> 也会导致当前结点被标记为 <code>Deletion</code> 。</li></ul><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="完成工作单元-1"></a>完成工作单元<a class="hash-link" href="#完成工作单元-1" title="Direct link to heading">#</a></h4><blockquote><p>计算现有 DOM 实例与新的结点之间的属性变化</p></blockquote><ul><li>应用程序更新渲染时，在完成工作单元阶段相对于首次渲染 <code>React</code> 需要重点计算现有的 DOM 实例与新的结点之间的属性变化，此处逻辑主要在 <code>diffProperties</code> 函数中执行</li><li><code>diffProperties</code>函数主要用于计算<code>(HostComponet类型的)</code>结点更新前后所有的 <code>style</code> 属性是否发生变化，并将所有发生变化的属性以及对应的值收集起来。这些属性变化的数据在 <code>commit</code> 结点被统一更新到 DOM。</li></ul><p>应用程序更新渲染构建 <code>workInProgress</code> 树的整体流程与首次渲染时基本相同。不同的地方就是对于 <code>ClassComponent</code> 类型的结点，<code>React</code> 会先处理该结点的更新队列并获取最新的 <code>state</code>，然后判断该结点是否需要执行后续的更新逻辑。如果类型的结点需要执行更新，则通过执行「协调」逻辑获取下一个 <code>Fiber</code> 结点，这个过程中也会进行新元素与当前 <code>Fiber</code> 结点 <code>diff</code> 操作。结点 <code>diff </code>处理的过程中 <code>React</code> 会为结点标记对应的 <code>effectTag</code>，最常用的几种 <code>effectTag</code> 包括 <code>Placement Update PlacementAndUpdate Deletion</code></p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly js"><pre tabindex="0" class="prism-code language-js codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token maybe-class-name">React</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">元素类型</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">type</span><span class="token punctuation" style="color:#393A34">)</span><span class="token function" style="color:#d73a49">主要包括宿主元素</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">div，span</span><span class="token punctuation" style="color:#393A34">)</span><span class="token function" style="color:#d73a49">和组件元素</span><span class="token punctuation" style="color:#393A34">(</span><span class="token maybe-class-name">UpdateCounter</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">，这两种类型元素转换 为 </span><span class="token maybe-class-name">Fiber</span><span class="token plain"> 结点后对应的类型分别是HostComponent和ClassComponent。当然，Fiber 结点还有更多的类型</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token maybe-class-name">HostRoot</span><span class="token plain"> 根结点</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token maybe-class-name">HostText</span><span class="token plain"> 文本元素</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token maybe-class-name">HostComponent</span><span class="token plain"> 宿主元素</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/docs/reactCore/schedule"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">« 任务调度</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/docs/reactCore/diff"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">diff »</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_35-E thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#render阶段-1" class="table-of-contents__link">render阶段</a><ul><li><a href="#构建-wip-树" class="table-of-contents__link">构建 <code>wIP</code> 树</a></li><li><a href="#工作循环" class="table-of-contents__link">工作循环</a></li><li><a href="#解析不同类型fiber结点" class="table-of-contents__link">解析不同类型<code>Fiber</code>结点</a></li><li><a href="#完成工作单元的时机" class="table-of-contents__link">完成工作单元的时机</a></li></ul></li><li><a href="#commit-阶段" class="table-of-contents__link"><code>commit</code> 阶段</a></li><li><a href="#首次渲染" class="table-of-contents__link">首次渲染</a></li><li><a href="#更新渲染" class="table-of-contents__link">更新渲染</a></li></ul></div></div></div></div></main></div></div></div>
<script src="/assets/js/runtime~main.e861e66d.js"></script>
<script src="/assets/js/main.6b6955fb.js"></script>
</body>
</html>