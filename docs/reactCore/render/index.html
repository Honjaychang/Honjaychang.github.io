<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.4">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="HonjayChang Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="HonjayChang Blog Atom Feed"><title data-react-helmet="true">renderé˜¶æ®µ | HonjayChang</title><meta data-react-helmet="true" property="og:url" content="https://honjaychang.github.io//docs/reactCore/render"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="renderé˜¶æ®µ | HonjayChang"><meta data-react-helmet="true" name="description" content="render é˜¶æ®µ"><meta data-react-helmet="true" property="og:description" content="render é˜¶æ®µ"><link data-react-helmet="true" rel="shortcut icon" href="/img/photo.ico"><link data-react-helmet="true" rel="canonical" href="https://honjaychang.github.io//docs/reactCore/render"><link data-react-helmet="true" rel="alternate" href="https://honjaychang.github.io//docs/reactCore/render" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://honjaychang.github.io//docs/reactCore/render" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.6b743985.css">
<link rel="preload" href="/assets/js/runtime~main.e861e66d.js" as="script">
<link rel="preload" href="/assets/js/main.6b6955fb.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_1oUP">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a href="https://honjaychang.github.io/docs/home" target="_blank" rel="noopener noreferrer" class="navbar__brand"><img src="/img/photo.jpg" alt="My Site Logo" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/img/photo.jpg" alt="My Site Logo" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"></a><a class="navbar__item navbar__link navbar__link--active" href="/docs/Home">Docs</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/Honjaychang" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="react-toggle toggle_3Zt9 react-toggle--disabled"><div class="react-toggle-track" role="button" tabindex="-1"><div class="react-toggle-track-check"><span class="toggle_71bT">ğŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_71bT">ğŸŒ</span></div><div class="react-toggle-thumb"></div></div><input type="checkbox" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper doc-page"><div class="docPage_31aa"><button class="clean-btn backToTopButton_35hR" type="button" title="Scroll to top"><svg viewBox="0 0 24 24" width="28"><path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z" fill="currentColor"></path></svg></button><aside class="docSidebarContainer_3Kbt"><div class="sidebar_15mo"><nav class="menu thin-scrollbar menu_Bmed menuWithAnnouncementBar_2WvA"><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/docs/Home">Home</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">HC</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">JS</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Extension</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">TS</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">React</a></li><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#">ReactCore</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/reactCore/basic">ä¸€äº›æ¦‚å¿µ</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/reactCore/ds">æ•°æ®ç»“æ„å®šä¹‰</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/reactCore/createUpdate">æ›´æ–°</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/reactCore/schedule">ä»»åŠ¡è°ƒåº¦</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active active" tabindex="0" href="/docs/reactCore/render">renderé˜¶æ®µ</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/reactCore/diff">diff</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Dev</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Network</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Algo</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Interview</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Vue</a></li></ul></nav><button type="button" title="Collapse sidebar" aria-label="Collapse sidebar" class="button button--secondary button--outline collapseSidebarButton_1CGd"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_3E-R"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></aside><main class="docMainContainer_3ufF"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_3FnS"><div class="docItemContainer_33ec"><article><div class="tocCollapsible_1PrD tocMobile_3Hoh"><button type="button" class="clean-btn tocCollapsibleButton_2O1e">On this page</button></div><div class="markdown"><header><h1 class="h1Heading_27L5">renderé˜¶æ®µ</h1></header><p><code>render</code> é˜¶æ®µ</p><blockquote><p>åº”ç”¨ç¨‹åºæ¸²æŸ“æ—¶åœ¨ <code>render</code> é˜¶æ®µçš„ä¸€ä¸ªé‡è¦å·¥ä½œå°±æ˜¯æ„å»º <code>workInProgress</code> æ ‘ï¼Œæ„å»º <code>workInProgress</code> æ ‘çš„è¿‡ç¨‹ä¸­ <code>React</code> ä¹Ÿä¼šå®Œæˆæ›´æ–°è®¡ç®—ã€è°ƒç”¨ç”Ÿå‘½å‘¨æœŸå‡½æ•°ä»¥åŠæ”¶é›†å‰¯ä½œç”¨åˆ—è¡¨ç­‰å·¥ä½œ</p><p>åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ React ä¹Ÿä¼šå®Œæˆç»“ç‚¹ <code>diff</code> çš„é€»è¾‘ï¼Œæœ€ç»ˆä¼šå¾—åˆ°ç”¨äºæ›´æ–°åˆ°å±å¹•çš„å‰¯ä½œç”¨åˆ—è¡¨</p><p>React åº”ç”¨ç¨‹åºé¦–æ¬¡æ¸²æŸ“æ—¶æ„å»º <code>workInProgress</code> æ ‘çš„è¿‡ç¨‹ä¹Ÿæ˜¯å°† <code>React</code> å…ƒç´ æ ‘è½¬åŒ–ä¸º <code>Fiber</code> æ ‘çš„è¿‡ç¨‹ï¼Œ <code>workInProgress</code> æ ‘æ„å»ºå®Œæˆåä¼šåœ¨è¯¥ã€Œæ ‘ã€ä¸Šé¢å®Œæˆæ›´æ–°è®¡ç®—ã€è°ƒç”¨ç”Ÿå‘½å‘¨æœŸå‡½æ•°ä»¥åŠæ”¶é›†å‰¯ä½œç”¨åˆ—è¡¨ç­‰å·¥ä½œã€‚</p><p>æ”¶é›†å¥½çš„å‰¯ä½œç”¨åˆ—è¡¨ä¼šåœ¨ <code>commit</code> é˜¶æ®µç»Ÿä¸€æ˜ å°„åˆ°å±å¹•ä¸Šã€‚</p></blockquote><p><code>beginWork</code></p><p><code>completeWork</code></p><p><code>commit</code> é˜¶æ®µ</p><p>åœ¨ <code>Diff</code> ä¹‹åï¼Œ<code>workInProgress</code>èŠ‚ç‚¹å°±ä¼šè¿›å…¥<code>complete</code>é˜¶æ®µ</p><p>è¿™ä¸ªæ—¶å€™æ‹¿åˆ°çš„<code>workInProgress</code>èŠ‚ç‚¹éƒ½æ˜¯ç»è¿‡<code>diff</code>ç®—æ³•è°ƒå’Œè¿‡çš„ï¼Œä¹Ÿå°±æ„å‘³ç€å¯¹äºæŸä¸ªèŠ‚ç‚¹æ¥è¯´å®ƒ<code>fiber</code>çš„å½¢æ€å·²ç»åŸºæœ¬ç¡®å®šäº†ï¼Œä½†é™¤æ­¤ä¹‹å¤–è¿˜æœ‰ä¸¤ç‚¹ï¼š</p><ul><li>ç›®å‰åªæœ‰<code>fiber</code>å½¢æ€å˜äº†ï¼Œå¯¹äºåŸç”ŸDOMç»„ä»¶ <code>HostComponent</code> å’Œæ–‡æœ¬èŠ‚ç‚¹ <code>HostText</code> çš„<code>fiber</code>æ¥è¯´ï¼Œå¯¹åº”çš„DOMèŠ‚ç‚¹ <code>fiber.stateNode</code> å¹¶æœªå˜åŒ–</li><li>ç»è¿‡<code>Diff</code>ç”Ÿæˆçš„æ–°çš„<code>workInProgress</code>èŠ‚ç‚¹æŒæœ‰äº†<code>flag</code> å³<code>effectTag</code></li></ul><p>åŸºäºè¿™ä¸¤ä¸ªç‰¹ç‚¹ï¼Œ<code>completeWork</code>çš„å·¥ä½œä¸»è¦æœ‰ï¼š</p><ul><li>æ„å»ºæˆ–æ›´æ–°DOMèŠ‚ç‚¹<ul><li>æ„å»ºè¿‡ç¨‹ä¸­ï¼Œä¼šè‡ªä¸‹è€Œä¸Šå°†å­èŠ‚ç‚¹çš„ç¬¬ä¸€å±‚ç¬¬ä¸€å±‚æ’å…¥åˆ°å½“å‰èŠ‚ç‚¹ã€‚</li><li>æ›´æ–°è¿‡ç¨‹ä¸­ï¼Œä¼šè®¡ç®—DOMèŠ‚ç‚¹çš„å±æ€§ï¼Œä¸€æ—¦å±æ€§éœ€è¦æ›´æ–°ï¼Œä¼šä¸ºDOMèŠ‚ç‚¹å¯¹åº”çš„<code>workInProgress</code> èŠ‚ç‚¹æ ‡è®°<code>Update</code> çš„ <code>effectTag</code></li></ul></li><li>è‡ªä¸‹è€Œä¸Šæ”¶é›† <code>effectList</code>ï¼Œæœ€ç»ˆæ”¶é›†åˆ° <code>root</code>ä¸Š</li><li>é”™è¯¯å¤„ç†</li></ul><p><img src="https://cdn.jsdelivr.net/gh/honjaychang/bp/fe/20211002152401.png" alt="image-20211002152401431"></p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="renderé˜¶æ®µ-1"></a>renderé˜¶æ®µ<a class="hash-link" href="#renderé˜¶æ®µ-1" title="Direct link to heading">#</a></h2><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="æ„å»º-wip-æ ‘"></a>æ„å»º <code>wIP</code> æ ‘<a class="hash-link" href="#æ„å»º-wip-æ ‘" title="Direct link to heading">#</a></h3><blockquote><p>æ­¤é˜¶æ®µ <code>React</code> å°†å…ƒç´ é€ä¸ªè½¬æ¢ä¸ºå¯¹åº”ç±»å‹çš„ <code>Fiber</code> ç»“ç‚¹ï¼Œæœ€ç»ˆå½¢æˆ <code>workInProgress</code> æ ‘</p></blockquote><p>åº”ç”¨ç¨‹åºé¦–æ¬¡æ¸²æŸ“è¿‡ç¨‹åˆšè¿›å…¥ <code>render</code> é˜¶æ®µæ—¶ <code>fiberRoot</code> å¯¹è±¡ä¸Šé¢åªæœ‰ <code>current</code> æ ‘ï¼Œæ­¤æ—¶çš„ <code>current</code> æ ‘åªæœ‰ä¸€ä¸ªç±»å‹ä¸º <code>HostRoot</code> çš„ <code>Fiber</code> ç»“ç‚¹ï¼Œè¯¥ <code>Fiber</code> ç»“ç‚¹çš„æ›´æ–°é˜Ÿåˆ—ä¸­åªæœ‰ä¸€ä¸ªæ›´æ–°å¯¹è±¡ï¼Œå†…å®¹æ˜¯åº”ç”¨ç¨‹åºçš„æ ¹ç»„ä»¶å…ƒç´ ã€‚ç´§æ¥ç€ <code>React</code> è¦åšçš„å°±æ˜¯åˆå§‹åŒ– <code>workInProgress</code> å¯¹è±¡ã€‚</p><p><img src="https://cdn.jsdelivr.net/gh/honjaychang/bp/fe/20211001131338.png" alt="image-20211001131338587"></p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="åˆå§‹åŒ–-wip-å¯¹è±¡"></a>åˆå§‹åŒ– <code>wIP</code> å¯¹è±¡<a class="hash-link" href="#åˆå§‹åŒ–-wip-å¯¹è±¡" title="Direct link to heading">#</a></h4><ul><li><code>renderRoot</code> è°ƒç”¨ <code>createWorkInProgress</code> ä¸º <code>workInProgress</code> å¯¹è±¡èµ‹åˆå§‹å€¼</li><li>å‡½æ•°è°ƒç”¨å <code>wIP</code> å¯¹è±¡ä¸Šæœ‰äº†ç¬¬ä¸€ä¸ª<code>Fiber</code>ç»“ç‚¹ï¼Œç»“ç‚¹çš„<code>tag</code>ä¸º<code>HostRoot</code> æ˜¯æ•´ä¸ª<code>wIP</code>æ ‘çš„æ ¹èŠ‚ç‚¹</li></ul><p><img src="https://cdn.jsdelivr.net/gh/honjaychang/bp/fe/20211001132001.png" alt="image-20211001132001247"></p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="å®Œå–„-wip-å¯¹è±¡"></a>å®Œå–„ <code>wIP</code> å¯¹è±¡<a class="hash-link" href="#å®Œå–„-wip-å¯¹è±¡" title="Direct link to heading">#</a></h4><ul><li>è¦æƒ³æŠŠç»„ä»¶å…ƒç´ æè¿°çš„é¡µé¢ç»“æ„æ˜ å°„åˆ°å±å¹•ä¸Šå¿…é¡»å…ˆå°†å…ƒç´ è½¬æ¢ä¸º <code>Fiber</code> ç»“ç‚¹</li><li>å®Œå–„<code>wIP</code> å¯¹è±¡çš„è¿‡ç¨‹å°±æ˜¯ å°† <code>React</code> å…ƒç´ æ ‘è½¬åŒ–ä¸º <code>Fiber</code> æ ‘çš„è¿‡ç¨‹</li></ul><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="å·¥ä½œå¾ªç¯"></a>å·¥ä½œå¾ªç¯<a class="hash-link" href="#å·¥ä½œå¾ªç¯" title="Direct link to heading">#</a></h3><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="å¾ªç¯è§£æå·¥ä½œå•å…ƒ"></a>å¾ªç¯è§£æå·¥ä½œå•å…ƒ<a class="hash-link" href="#å¾ªç¯è§£æå·¥ä½œå•å…ƒ" title="Direct link to heading">#</a></h4><ul><li>å·¥ä½œå¾ªç¯ä¸»è¦æ˜¯æ‰§è¡Œ <code>workLoop</code> å‡½æ•°æ¥å¾ªç¯è§£æå·¥ä½œå•å…ƒã€‚æ¯æ¬¡å¾ªç¯è§£æçš„å·¥ä½œå•å…ƒå°±æ˜¯ä¸Šä¸€æ¬¡ <code>Fiber</code> ç»“ç‚¹çš„ <code>child</code>ã€‚</li><li>ç¬¬ä¸€æ¬¡å¾ªç¯è§£æçš„æ˜¯ <code>HostRoot</code> ç±»å‹çš„ç»“ç‚¹ï¼Œè¯¥ç»“ç‚¹ä¹Ÿå°±æ˜¯æ‰€æœ‰ç»“ç‚¹çš„ç¥–å…ˆ</li><li>å·¥ä½œå•å…ƒå…·ä½“çš„è§£æé€»è¾‘åœ¨ <code>performUnitOfWork</code> ä¸­è°ƒç”¨</li></ul><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="è§£æå·¥ä½œå•å…ƒ"></a>è§£æå·¥ä½œå•å…ƒ<a class="hash-link" href="#è§£æå·¥ä½œå•å…ƒ" title="Direct link to heading">#</a></h4><p>åœ¨ <code>beginWork</code> å‡½æ•°å†…éƒ¨é€šè¿‡åŒ¹é… <code>Fiber</code> ç»“ç‚¹çš„ <code>tag</code> å€¼è°ƒç”¨ <code>updateHostRootã€updateClassComponentã€updateHostComponentã€updateHostText</code> ç­‰å‡½æ•°ï¼Œåˆ†åˆ«è§£æ <code>HostRootã€ClassComponentã€HostComponentã€HostText</code>ç­‰ç±»å‹çš„Fiber ç»“ç‚¹ã€‚</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="å®Œæˆå·¥ä½œå•å…ƒ"></a>å®Œæˆå·¥ä½œå•å…ƒ<a class="hash-link" href="#å®Œæˆå·¥ä½œå•å…ƒ" title="Direct link to heading">#</a></h4><p>å·¥ä½œå•å…ƒè§£ææ‰§è¡Œåˆ° <code>workInProgress</code> æ ‘çš„å¶å­ç»“ç‚¹æ—¶ï¼Œä¼šå®Œæˆå½“å‰å·¥ä½œå•å…ƒã€‚å®Œæˆå·¥ä½œå•å…ƒçš„ä¸»è¦å·¥ä½œæ˜¯æ”¶é›†å‰¯ä½œç”¨ï¼ŒåŒæ—¶å¤„ç† <code>HostComponent</code> ç±»å‹çš„ç»“ç‚¹ï¼Œåˆ›å»ºå¯¹åº”çš„ <code>DOM</code> å…ƒç´ å¹¶å°†ä»–ä»¬ <code>append</code> åˆ°çˆ¶ç»“ç‚¹ä¸Š</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly js"><pre tabindex="0" class="prism-code language-js codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">æ„å»º workInProgress æ ‘çš„è¿‡ç¨‹ä¹Ÿæ˜¯æ‰§è¡Œã€Œåè°ƒç®—æ³•ã€è¿‡ç¨‹ï¼Œé€šè¿‡å¾ªç¯è§£æå·¥ä½œå•å…ƒè·å–ä¸‹ä¸€ä¸ª </span><span class="token maybe-class-name">Fiber</span><span class="token plain"> ç»“ç‚¹ï¼ŒåŒæ—¶ çˆ¶å­ç»“ç‚¹å’Œå…„å¼Ÿç»“ç‚¹ä¹Ÿä¼šè¢«ä¸²è”èµ·æ¥ã€‚è¿™ä¸ªè¿‡ç¨‹ä»æ•´ä½“ä¸Šå¯ä»¥åˆ†ä¸ºä¸¤æ­¥ï¼Œåˆ†åˆ«æ˜¯ åˆå§‹åŒ– workInProgress å¯¹è±¡å’Œ å®Œå–„ workInProgress å¯¹è±¡ã€‚é¦–å…ˆï¼Œæˆ‘ä»¬å…ˆçœ‹ä¸€ä¸‹åº”ç”¨ç¨‹åºæ‰§è¡Œè¿‡ç¨‹åˆšè¿›å…¥ render é˜¶æ®µæ—¶çš„ fiberRoot å¯¹è±¡ã€‚</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">ä»åˆå§‹åŒ– workInProgress å¯¹è±¡åˆ°å½¢æˆ workInProgress æ ‘ï¼Œåº”ç”¨ç¨‹åºä¼šæ‰§è¡Œå¤šæ¬¡å¾ªç¯ï¼Œæ¯ä¸€æ¬¡å¾ªç¯éƒ½æ˜¯åœ¨è§£æ </span><span class="token maybe-class-name">Fiber</span><span class="token plain"> ç»“ç‚¹å¹¶è¿”å›ä¸‹ä¸€ä¸ªè¦è§£æçš„ç»“ç‚¹ã€‚è¿™ ä¸ªè¿‡ç¨‹ä¸­ä¼šä½¿ç”¨é‡è¦çš„ã€Œåè°ƒã€ç®—æ³•ï¼ŒåŒæ—¶ä¹Ÿä¼šè¿›è¡Œç»“ç‚¹çš„ diff æ“ä½œã€‚</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">é€šè¿‡å·¥ä½œå¾ªç¯æ¥æ„å»ºworkInProgress ä¸¤ä¸ªå…³é”®ç¯èŠ‚ è§£æå·¥ä½œå•å…ƒ å®Œæˆå·¥ä½œå•å…ƒ</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="è§£æä¸åŒç±»å‹fiberç»“ç‚¹"></a>è§£æä¸åŒç±»å‹<code>Fiber</code>ç»“ç‚¹<a class="hash-link" href="#è§£æä¸åŒç±»å‹fiberç»“ç‚¹" title="Direct link to heading">#</a></h3><p>åº”ç”¨ç¨‹åºé¦–æ¬¡æ¸²æŸ“æ—¶ï¼Œå°†æ ¹ç»„ä»¶å…ƒç´ è½¬æ¢ä¸ºå¤šä¸ªå±‚çº§çš„ <code>Fiber</code> ç»“ç‚¹è¿‡ç¨‹ä¸­ï¼Œç¬¬ä¸€æ­¥è¦åšçš„å°±æ˜¯è§£æ <code>wIP</code> æ ‘çš„æ ¹ç»“ç‚¹ <code>HostRoot</code></p><p><img src="https://cdn.jsdelivr.net/gh/honjaychang/bp/fe/20211001140433.png" alt="image-20211001140433792"></p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="hostroot-ç±»å‹"></a><code>HostRoot</code> ç±»å‹<a class="hash-link" href="#hostroot-ç±»å‹" title="Direct link to heading">#</a></h4><ul><li><code>updateHostRoot -&gt; processUpdateQueue</code></li><li>è§£æ <code>HostRoot</code>ç±»å‹ç»“ç‚¹çš„å…³é”®æ˜¯å¤„ç†æ›´æ–°é˜Ÿåˆ— <code>processUpdateQueue</code> è·å–æ ¹ç»„ä»¶å…ƒç´  <code>element</code>ï¼Œ<code>element </code>å°±æ˜¯è¦ä¼ å…¥åˆ°åè°ƒç®—æ³•ä¸­è¿›è¡Œè§£æçš„<code>nextChildren</code></li></ul><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly js"><pre tabindex="0" class="prism-code language-js codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">updateHostRoot</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">current$$</span><span class="token parameter number" style="color:#36acaa">1</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"> workInProgress</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"> renderExpirationTime</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">pushHostRootContext</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">workInProgress</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> updateQueue </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> workInProgress</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">updateQueue</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> nextProps </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> workInProgress</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">pendingProps</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> prevState </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> workInProgress</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">memoizedState</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> prevChildren </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> prevState </span><span class="token operator" style="color:#393A34">!==</span><span class="token plain"> </span><span class="token keyword null nil" style="color:#00009f">null</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">?</span><span class="token plain"> prevState</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">element</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword null nil" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">processUpdateQueue</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">workInProgress</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> updateQueue</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> nextProps</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword null nil" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> renderExpirationTime</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> nextState </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> workInProgress</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">memoizedState</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// Caution: React DevTools currently depends on this property</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// being called &quot;element&quot;.</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> nextChildren </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> nextState</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">element</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">nextChildren </span><span class="token operator" style="color:#393A34">===</span><span class="token plain"> prevChildren</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// If the state is the same as before, that&#x27;s a bailout because we had</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// no work that expires at this time.</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">resetHydrationState</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword control-flow" style="color:#00009f">return</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">bailoutOnAlreadyFinishedWork</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">current$$</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> workInProgress</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> renderExpirationTime</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> root </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> workInProgress</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">stateNode</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">current$$</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">===</span><span class="token plain"> </span><span class="token keyword null nil" style="color:#00009f">null</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">||</span><span class="token plain"> current$$</span><span class="token number" style="color:#36acaa">1.</span><span class="token plain">child </span><span class="token operator" style="color:#393A34">===</span><span class="token plain"> </span><span class="token keyword null nil" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> root</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">hydrate</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">enterHydrationState</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">workInProgress</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// If we don&#x27;t have any current children this might be the first pass.</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// We always try to hydrate. If this isn&#x27;t a hydration pass there won&#x27;t</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// be any children to hydrate which is effectively the same thing as</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// not hydrating.</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// This is a bit of a hack. We track the host root as a placement to</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// know that we&#x27;re currently in a mounting state. That way isMounted</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// works as expected. We must reset this before committing.</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// TODO: Delete this when we delete isMounted and findDOMNode.</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    workInProgress</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">effectTag</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|=</span><span class="token plain"> </span><span class="token maybe-class-name">Placement</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Ensure that children mount into this root without tracking</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// side-effects. This ensures that we don&#x27;t store Placement effects on</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// nodes that will be hydrated.</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    workInProgress</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">child</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">mountChildFibers</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">workInProgress</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword null nil" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> nextChildren</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> renderExpirationTime</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#00009f">else</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Otherwise reset hydration state in case we aborted and resumed another</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// root.</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">reconcileChildren</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">current$$</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> workInProgress</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> nextChildren</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> renderExpirationTime</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">resetHydrationState</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">return</span><span class="token plain"> workInProgress</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">child</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="classcomponent-ç±»å‹"></a><code>ClassComponent</code> ç±»å‹<a class="hash-link" href="#classcomponent-ç±»å‹" title="Direct link to heading">#</a></h4><ul><li>åº”ç”¨ç¨‹åºé¦–æ¬¡æ¸²æŸ“æ—¶è§£æ <code>HostRoot</code> ç±»å‹ç»“ç‚¹å®Œæˆåè¿”å›çš„ä¸€èˆ¬æ˜¯ <code>ClassComponent</code> ç±»å‹çš„ç»“ç‚¹ï¼Œè¿™ç§ç±»å‹çš„ <code>Fiber</code> ç»“ç‚¹è§£æè¿‡ç¨‹ä¸­æ˜¯è¦è¿›è¡Œç»„ä»¶å®ä¾‹åŒ–çš„</li><li>è§£æ<code>ClassComponent</code>ç±»å‹çš„ç»“ç‚¹æ—¶ï¼Œå…ˆä»å½“å‰ <code>Fiber</code> ç»“ç‚¹çš„ <code>stateNode</code> å±æ€§ä¸Šé¢å–ç»„ä»¶å®ä¾‹<code>instance</code>ï¼Œå¦‚æœ <code>instance</code> çš„å€¼ä¸º <code>null</code> åˆ™è¯´æ˜æ˜¯é¦–æ¬¡æ¸²æŸ“ï¼Œç»„ä»¶è¿˜æ²¡æœ‰è¢«å®ä¾‹åŒ–ã€‚React ä½¿ç”¨ <code>constructClassInstance</code> å‡½æ•°å®Œæˆç»„ä»¶å®ä¾‹åŒ–ï¼ŒåŒæ—¶ä¸ºç»„ä»¶å®ä¾‹æ·»åŠ æ›´æ–°å™¨ï¼ˆç„¶åå°±å¯ä»¥è°ƒç”¨ <code>setState</code> </li><li>ç»„ä»¶å®ä¾‹ç”Ÿæˆåï¼Œå®ƒçš„æ ¸å¿ƒä½œç”¨ä¹‹ä¸€å°±æ˜¯åœ¨  <code>finishClassComponent</code>  å‡½æ•°å†…éƒ¨æ‰§è¡Œ <code>instance.render() </code>è·å–è¦ä¼ å…¥åˆ°åè°ƒç®—æ³•ä¸­è¿›è¡Œè§£æçš„ <code>nextChildren</code></li></ul><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly js"><pre tabindex="0" class="prism-code language-js codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">updateClassComponent</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">current$$</span><span class="token parameter number" style="color:#36acaa">1</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"> workInProgress</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"> Component</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"> nextProps</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"> renderExpirationTime</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// ...</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> instance </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> workInProgress</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">stateNode</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> shouldUpdate </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">instance </span><span class="token operator" style="color:#393A34">===</span><span class="token plain"> </span><span class="token keyword null nil" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">current$$</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!==</span><span class="token plain"> </span><span class="token keyword null nil" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic">// An class component without an instance only mounts if it suspended</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic">// inside a non- concurrent tree, in an inconsistent state. We want to</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic">// tree it like a new mount, even though an empty version of it already</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic">// committed. Disconnect the alternate pointers.</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      current$$</span><span class="token number" style="color:#36acaa">1.</span><span class="token plain">alternate </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword null nil" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      workInProgress</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">alternate</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword null nil" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic">// Since this is conceptually a new fiber, schedule a Placement effect</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      workInProgress</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">effectTag</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|=</span><span class="token plain"> </span><span class="token maybe-class-name">Placement</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// In the initial pass we might need to construct the instance.</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">constructClassInstance</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">workInProgress</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token maybe-class-name">Component</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> nextProps</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> renderExpirationTime</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">mountClassInstance</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">workInProgress</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token maybe-class-name">Component</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> nextProps</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> renderExpirationTime</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    shouldUpdate </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#00009f">else</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">current$$</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">===</span><span class="token plain"> </span><span class="token keyword null nil" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// In a resume, we&#x27;ll already have an instance we can reuse.</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    shouldUpdate </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">resumeMountClassInstance</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">workInProgress</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token maybe-class-name">Component</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> nextProps</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> renderExpirationTime</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#00009f">else</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    shouldUpdate </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">updateClassInstance</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">current$$</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> workInProgress</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token maybe-class-name">Component</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> nextProps</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> renderExpirationTime</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> nextUnitOfWork </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">finishClassComponent</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">current$$</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> workInProgress</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token maybe-class-name">Component</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> shouldUpdate</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> hasContext</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> renderExpirationTime</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">return</span><span class="token plain"> nextUnitOfWork</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">finishClassComponent</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">current$$</span><span class="token parameter number" style="color:#36acaa">1</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"> workInProgress</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"> Component</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"> shouldUpdate</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"> hasContext</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"> renderExpirationTime</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// ...</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">return</span><span class="token plain"> workInProgress</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">child</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="hostcomponent-ç±»å‹"></a><code>HostComponent</code> ç±»å‹<a class="hash-link" href="#hostcomponent-ç±»å‹" title="Direct link to heading">#</a></h4><ul><li>è§£æ <code>ClassComponent</code> ç±»å‹ç»“ç‚¹å®Œæˆåè¿”å›çš„ä¸€èˆ¬æ˜¯ <code>HostComponent</code> ç±»å‹<code>tag</code>çš„ç»“ç‚¹ï¼Œè¿™ç§ç»“ç‚¹çš„å…·ä½“ç±»å‹ <code>elementType</code>å¯¹åº”çš„æ˜¯çœŸå®çš„ <code>DOM</code> æ ‡ç­¾ (å¦‚ <code>div  span ...</code> </li><li>è§£æ <code>HostComponent</code> ç±»å‹ç»“ç‚¹ï¼Œå¯ä»å½“å‰ç»“ç‚¹å¯¹åº”çš„å…ƒç´  <code>props</code> ä¸­è·å–è¦ä¼ å…¥åˆ°åè°ƒç®—æ³•ä¸­è¿›è¡Œè§£æçš„ <code>nextChildren</code></li><li>è¿™é‡Œè¦å¼ºè°ƒä¸€ä¸‹ï¼Œæ— è®ºæ˜¯è§£æ HostRoot ç±»å‹çš„ç»“ç‚¹ï¼Œè¿˜æ˜¯è§£æ <code>HostComponent</code> ç±»å‹çš„ç»“ç‚¹ï¼Œè¿™ä¸ªè¿‡ç¨‹ä¸­è·å–çš„ <code>nextChildren</code> å‡ä¸º <code>React å…ƒç´ </code>ã€‚åœ¨æ‰§è¡Œåè°ƒç®—æ³•çš„è¿‡ç¨‹ä¸­ï¼Œ<code>React</code> å°†è¯¥å…ƒç´ è½¬æ¢æˆå¯¹åº”çš„ <code>Fiber </code>ç»“ç‚¹å¹¶è¿”å›ã€‚</li></ul><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="hosttext-ç±»å‹"></a><code>HostText</code> ç±»å‹<a class="hash-link" href="#hosttext-ç±»å‹" title="Direct link to heading">#</a></h4><ul><li>å½“è§£æåˆ°å…ƒç´ çš„å¶å­å…ƒç´ æ—¶ï¼Œæ­¤æ—¶å¯¹åº”çš„ <code>Fiber</code> ç»“ç‚¹ç±»å‹ä¸º <code>HostText</code> ã€‚<code>React</code> è®¤ä¸ºæ–‡æœ¬ç±»å‹çš„ <code>Fiber </code>ç»“ç‚¹å·²ç»æ˜¯ç»ˆç‚¹ï¼Œä¸ä¼šå†æœ‰å­©å­ç»“ç‚¹ï¼Œç›´æ¥è¿”å› <code>null</code></li></ul><p><img src="https://cdn.jsdelivr.net/gh/honjaychang/bp/fe/20211001145029.png" alt="image-20211001145029076"></p><p>åœ¨å·¥ä½œå¾ªç¯çš„è¿‡ç¨‹ä¸­ï¼Œ<code>React</code> æ€»æ˜¯å…ˆä»å¤–éƒ¨æ ¹èŠ‚ç‚¹å¼€å§‹è§£æï¼Œå½“è§£æåˆ°å¶å­ç»“ç‚¹æ—¶å°±è¦å¼€å§‹å®Œæˆå·¥ä½œå•å…ƒã€‚å®Œæˆå·¥ä½œå•å…ƒæ—¶å¦‚æœæœ‰å…„å¼Ÿç»“ç‚¹æ—¶åˆ™éœ€è¦ç»§ç»­è§£æå…„å¼Ÿç»“ç‚¹ï¼Œç„¶åå®Œæˆå…„å¼Ÿç»“ç‚¹åä¼šé€å±‚å‘ä¸Šå®Œæˆå·¥ä½œå•å…ƒã€‚</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="å®Œæˆå·¥ä½œå•å…ƒçš„æ—¶æœº"></a>å®Œæˆå·¥ä½œå•å…ƒçš„æ—¶æœº<a class="hash-link" href="#å®Œæˆå·¥ä½œå•å…ƒçš„æ—¶æœº" title="Direct link to heading">#</a></h3><ul><li>æ£€æŸ¥å½“å‰ç»“ç‚¹æ˜¯å¦æœ‰å…„å¼Ÿç»“ç‚¹ï¼Œå¦‚æœæ²¡æœ‰å…„å¼Ÿç»“ç‚¹å°±æ£€æŸ¥çˆ¶ç»“ç‚¹æœ‰æ²¡æœ‰å…„å¼Ÿç»“ç‚¹</li><li>ä¸º <code>HostComponent</code> ç±»å‹çš„ç»“ç‚¹åˆ›å»º <code>DOM</code> å…ƒç´ å®ä¾‹</li><li>æ”¶é›†å‰¯ä½œç”¨ <code>Effect List</code></li></ul><p>å…¥å£å‡½æ•°<code>completeUnitOfWork -&gt; completeWork</code></p><p>åœ¨ <code>completeUnitOfWork</code> å‡½æ•°ä¸­æ‰§è¡Œäº†ä¸€ä¸ªéå†ï¼Œè¿™ä¸ªéå†çš„æ–¹å‘æ˜¯ç”±å­ç»“ç‚¹å‘çˆ¶ç»“ç‚¹å±‚å±‚è¿”å›</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="åˆ›å»ºæˆ–æ›´æ–°-dom-å…ƒç´ "></a>åˆ›å»ºæˆ–æ›´æ–° DOM å…ƒç´ <a class="hash-link" href="#åˆ›å»ºæˆ–æ›´æ–°-dom-å…ƒç´ " title="Direct link to heading">#</a></h4><p><code>completeWork</code> å‡½æ•°è´Ÿè´£å¯¹ä¸åŒç±»å‹çš„å·¥ä½œå•å…ƒ <code>Fiber ç»“ç‚¹</code>åˆ†åˆ«å¤„ç†</p><h5><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="hostcomponent"></a><code>HostComponent</code><a class="hash-link" href="#hostcomponent" title="Direct link to heading">#</a></h5><h5><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="hosttext"></a><code>HostText</code><a class="hash-link" href="#hosttext" title="Direct link to heading">#</a></h5><p><code>HostComponent</code> å’Œ<code>HostText</code>ç±»å‹çš„ <code>Fiber </code>ç»“ç‚¹æ˜¯æœ‰å¯¹åº”çš„çœŸå® <code>DOM</code> å…ƒç´ ï¼Œå› æ­¤åœ¨å®Œæˆå·¥ä½œå•å…ƒé˜¶æ®µ <code>React</code>è¦ä¸ºå®ƒä»¬åˆ›å»ºè‡ªå·±çš„ <code>DOM</code> å®ä¾‹</p><p>åœ¨å®Œæˆå·¥ä½œå•å…ƒçš„è¿‡ç¨‹ä¸­åˆ†ä¸ºäº†ä¸¤ç§æƒ…å†µï¼Œåˆ†åˆ«æ˜¯é¦–æ¬¡æ¸²æŸ“å’Œæ›´æ–°æ¸²æŸ“ã€‚</p><ul><li>åº”ç”¨ç¨‹åºé¦–æ¬¡æ¸²æŸ“æ—¶ï¼š<code>React</code> ä¸º <code>HostComponent</code> å’Œ <code>HostText</code> ç±»å‹çš„ <code>Fiber</code> ç»“ç‚¹åˆ›å»ºå¯¹åº”çš„ <code>DOM</code> å®ä¾‹å¹¶å°†å…¶èµ‹å€¼åˆ°ç»“ç‚¹ä¸Šçš„ <code>stateNode</code> å±æ€§ä¸Š</li><li>åº”ç”¨ç¨‹åºæ›´æ–°æ¸²æŸ“æ—¶ï¼š <code>React</code> ä¸éœ€è¦ä¸ºå®ƒä»¬é‡æ–°åˆ›å»º <code>DOM</code> å®ä¾‹ï¼Œè€Œæ˜¯æŠŠæ–°çš„å€¼æ›´æ–°åˆ° <code>DOM</code> å…ƒç´ ä¸­</li></ul><p><code>updateHostComponent</code> å‡½æ•°å’Œ <code>updateHostText</code> å‡½æ•°åˆ†åˆ«ç”¨äºæ›´æ–° DOM å…ƒç´ </p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="æ”¶é›†å‰¯ä½œç”¨"></a>æ”¶é›†å‰¯ä½œç”¨<a class="hash-link" href="#æ”¶é›†å‰¯ä½œç”¨" title="Direct link to heading">#</a></h4><p>åœ¨æ”¶é›†å‰¯ä½œç”¨çš„è¿‡ç¨‹ä¸­ä¸»è¦æœ‰ä¸¤ç§æƒ…å†µ</p><ul><li>ç¬¬ä¸€ç§æƒ…å†µå°±æ˜¯å°†å­æ ‘ä¸Šé¢çš„å‰¯ä½œç”¨åˆ—è¡¨è¿åˆ°çˆ¶ç»“ç‚¹ä¸Šé¢</li><li>ç¬¬äºŒç§æƒ…å†µå°±æ˜¯å¦‚æœå½“å‰ç»“ç‚¹ä¹Ÿæœ‰å‰¯ä½œç”¨æ ‡è¯†ï¼Œåˆ™å°†å½“å‰ç»“ç‚¹ä¹Ÿè¿æ¥åˆ°çˆ¶ç»“ç‚¹çš„å‰¯ä½œç”¨åˆ—è¡¨ä¸­</li></ul><p>äº‹å®ä¸Šï¼Œåº”ç”¨ç¨‹åºé¦–æ¬¡æ¸²æŸ“æ—¶çš„å‰¯ä½œç”¨åˆ—è¡¨å°±æ˜¯æ•´ä¸ª <code>workInProgress</code> æ ‘ï¼Œå› ä¸ºæ•´ä¸ª <code>workInProgress</code> æ ‘çš„ç»“ç‚¹ä¸­æºå¸¦çš„å†…å®¹éƒ½éœ€è¦æ›´æ–°åˆ°å±å¹•ï¼Œè€Œåœ¨åº”ç”¨ç¨‹åºæ›´æ–°æ¸²æŸ“æ—¶å‰¯ä½œç”¨åˆ—è¡¨å°†ä¼šæ˜¯ <code>workInProgress</code> æ ‘çš„å­é›†</p><p>ä¸‹å›¾ä¾¿ä¸ºåº”ç”¨ç¨‹åºé¦–æ¬¡æ¸²æŸ“å®Œæˆå·¥ä½œå¾ªç¯åçš„ <code>wIP</code>æ ‘  <code>firstEffect lastEffect</code> ä¾¿ä¸ºå‰¯ä½œç”¨é“¾è¡¨</p><p>åœ¨æ”¶é›†å¥½çš„å‰¯ä½œç”¨åˆ—è¡¨ä¸­æ¯ä¸ª <code>HostComponent</code> ç±»å‹ <code>Fiber</code> ç»“ç‚¹çš„ <code>stateNode</code> å±æ€§ä¸­å­˜å‚¨äº†å½“å‰ç»“ç‚¹å¯¹åº”çš„ <code>DOM</code> å®ä¾‹ã€‚é‚£ä¹ˆï¼Œ<code>React</code> ä¸‹ä¸€æ­¥è¦åšçš„å°±æ˜¯å°†å‰¯ä½œç”¨åˆ—è¡¨ä¸­çš„æ‰€æœ‰ <code>DOM</code> å®ä¾‹æ›´æ–°åˆ°å±å¹•ä¸­</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="commit-é˜¶æ®µ"></a><code>commit</code> é˜¶æ®µ<a class="hash-link" href="#commit-é˜¶æ®µ" title="Direct link to heading">#</a></h2><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="ä½•æ—¶è¿›å…¥commité˜¶æ®µ"></a>ä½•æ—¶è¿›å…¥<code>commit</code>é˜¶æ®µ<a class="hash-link" href="#ä½•æ—¶è¿›å…¥commité˜¶æ®µ" title="Direct link to heading">#</a></h4><p>å·¥ä½œå¾ªç¯æ‰§è¡Œç»“æŸï¼Œæ ‡å¿—ç€åº”ç”¨ç¨‹åºæ¸²æŸ“è¿‡ç¨‹ä¸­ <code>render</code> é˜¶æ®µå·¥ä½œçš„å®Œæˆã€‚æ­¤æ—¶ <code>fiberRoot</code> å¯¹è±¡ä¸Šé¢çš„ <code>workInProgress</code> æ ‘å­˜å‚¨åœ¨ <code>root.current.alternate</code> æŒ‡å‘çš„å†…å­˜å•å…ƒã€‚<code>React</code> ä¼šå°† <code>workInProgress</code> æ ‘èµ‹å€¼åˆ° <code>fiberRoot</code> å¯¹è±¡ä¸Šçš„ <code>finishedWork</code> å±æ€§ä¸­ã€‚ç„¶åï¼Œæ£€æŸ¥ <code>workInProgressRootExitStatus</code> çš„çŠ¶æ€ï¼Œå¦‚æœæ˜¯æ­£å¸¸ç»“æŸï¼Œåˆ™åº”ç”¨ç¨‹åºæ¸²æŸ“ä»»åŠ¡è¿›å…¥ <code>commit</code> é˜¶æ®µã€‚</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="å¦‚ä½•å°†å‰¯ä½œç”¨æ›´æ–°åˆ°å±å¹•"></a>å¦‚ä½•å°†å‰¯ä½œç”¨æ›´æ–°åˆ°å±å¹•<a class="hash-link" href="#å¦‚ä½•å°†å‰¯ä½œç”¨æ›´æ–°åˆ°å±å¹•" title="Direct link to heading">#</a></h4><p>åœ¨ render é˜¶æ®µç»“æŸæ—¶ fiberRoot å¯¹è±¡ä¸Šé¢å°†ä¼šå¾—åˆ°ä¸€ä¸ªå‰¯ä½œç”¨åˆ—è¡¨(Effect List)ï¼Œè¿™ä¸ªå‰¯ä½œç”¨åˆ—è¡¨ä¸­æºå¸¦çš„ æ›´æ–°å†…å®¹å°±æ˜¯è¦æ›´æ–°åˆ°å±å¹•ä¸­çš„ä¿¡æ¯</p><p><img src="https://cdn.jsdelivr.net/gh/honjaychang/bp/fe/20211002112616.png" alt="image-20211002112616662"></p><p>åº”ç”¨ç¨‹åºæ‰§è¡Œåœ¨ <code>commit</code> é˜¶æ®µæ—¶ï¼Œ<code>React</code> å°†è¿™ä¸ªè¿‡ç¨‹åˆåˆ†ä¸ºä¸‰ä¸ªæ­¥ï¼Œåˆ†åˆ«æ˜¯ <code>before commitã€commit å’Œ after commit</code>ã€‚</p><p>åœ¨è¿™ä¸‰ä¸ªæ­¥åˆ†åˆ«è°ƒç”¨ <code>commitBeforeMutationLifecycles</code> <code>commitMutationEffects</code>???? å’Œ <code>commitLayoutEffects</code> ä¸‰ä¸ªå‡½æ•°æ¥æ‰§è¡Œå…·ä½“çš„å·¥ä½œã€‚<code>commitRoot</code> å‡½æ•°å†…éƒ¨è°ƒç”¨commitRootImplå‡½æ•°å®ç° commit é˜¶æ®µçš„å…·ä½“é€»è¾‘</p><p>æäº¤é˜¶æ®µçš„ä¸»è¦ä»»åŠ¡ä¹Ÿå°±æ˜¯æŠŠä¹‹å‰è®°å½•å¥½çš„æ›´æ–°æ“ä½œåæ˜ åˆ°çœŸå®çš„domä¸Šï¼Œå¹¶ä¸”è¿™ä¸ªè¿‡ç¨‹æ˜¯ä¸èƒ½ä¸­æ–­çš„ã€‚</p><p><code>commitRoot</code></p><ul><li>æ£€æŸ¥ <code>finishedWork</code> æ˜¯å¦ä¹Ÿæœ‰ <code>effect</code> ï¼Œå¦‚æœ‰æ’å…¥  <code>effect</code> é“¾è¡¨ä¸­</li><li>ç¬¬ä¸€æ¬¡éå† <code>effect</code>é“¾ï¼Œæ›´æ–°<code>class</code>ç»„ä»¶å®ä¾‹ä¸Šçš„<code>state props</code>ï¼Œæ‰§è¡Œ<code>getSnapshotBeforeUpdate</code>ç”Ÿå‘½å‘¨æœŸ</li><li>ç¬¬äºŒæ¬¡éå† <code>effect</code>é“¾ï¼Œä¸åŒçš„<code>effectTag</code>ï¼Œæ‰§è¡Œä¸åŒçš„æ“ä½œï¼Œæ¯”å¦‚é‡ç½®æ–‡æœ¬èŠ‚ç‚¹ï¼Œæ‰§è¡Œ æ’å…¥ã€æ›´æ–°ã€åˆ é™¤ç­‰çš„  <code>effect</code> æ“ä½œï¼ŒçœŸæ­£çš„å¯¹ <code>dom</code> è¿›è¡Œä¿®æ”¹ã€‚</li><li>ç¬¬ä¸‰æ¬¡éå† <code>effect</code>é“¾ï¼Œè¿™æ¬¡éå†å°±æ˜¯åšä¸€äº›æ”¶å°¾å·¥ä½œã€‚æ‰§è¡Œ<code>componentDidMountã€componentDidUpdate</code>ï¼Œæ›´æ–°çš„å›è°ƒå‡½æ•°ç­‰ã€‚</li><li>åšä¸€äº› è¿˜åŸå˜é‡ ç­‰çš„æ”¶å°¾å·¥ä½œã€‚</li></ul><p><img src="https://cdn.jsdelivr.net/gh/honjaychang/bp/fe/20211002112429.png" alt="image-20211002112429071"></p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="ä¸‰æ¬¡é“¾è¡¨æ“ä½œ"></a>ä¸‰æ¬¡é“¾è¡¨æ“ä½œ<a class="hash-link" href="#ä¸‰æ¬¡é“¾è¡¨æ“ä½œ" title="Direct link to heading">#</a></h4><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly js"><pre tabindex="0" class="prism-code language-js codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">commitRoot</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">root</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"> finishedWork</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  isWorking </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  isCommitting$</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// æ£€æŸ¥ finishedWork æ˜¯å¦ä¹Ÿæœ‰ effect ï¼Œå¦‚æœ‰æ’å…¥ effect é“¾è¡¨ä¸­</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> firstEffect </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">finishedWork</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">effectTag</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token maybe-class-name">PerformedWork</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// A fiber&#x27;s effect list consists only of its children, not itself. So if</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// the root has an effect, we need to add it to the end of the list. The</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// resulting list is the set that would belong to the root&#x27;s parent, if</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// it had one; that is, all the effects in the tree including the root.</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">finishedWork</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">lastEffect</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!==</span><span class="token plain"> </span><span class="token keyword null nil" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      finishedWork</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">lastEffect</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">nextEffect</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> finishedWork</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      firstEffect </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> finishedWork</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">firstEffect</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#00009f">else</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      firstEffect </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> finishedWork</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#00009f">else</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// There is no effect on the root.</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    firstEffect </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> finishedWork</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">firstEffect</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">prepareForCommit</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">root</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">containerInfo</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// Invoke instances of getSnapshotBeforeUpdate before mutation.</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  nextEffect </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> firstEffect</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">startCommitSnapshotEffectsTimer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// ç¬¬ä¸€æ¬¡éå†</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">while</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">nextEffect </span><span class="token operator" style="color:#393A34">!==</span><span class="token plain"> </span><span class="token keyword null nil" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">invokeGuardedCallback</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword null nil" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> commitBeforeMutationLifecycles</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword null nil" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">stopCommitSnapshotEffectsTimer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// Commit all the side-effects within a tree. We&#x27;ll do this in two passes.</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// The first pass performs all the host insertions, updates, deletions and</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// ref unmounts.</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  nextEffect </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> firstEffect</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">startCommitHostEffectsTimer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// ç¬¬äºŒæ¬¡éå†</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">while</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">nextEffect </span><span class="token operator" style="color:#393A34">!==</span><span class="token plain"> </span><span class="token keyword null nil" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">invokeGuardedCallback</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword null nil" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> commitAllHostEffects</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword null nil" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">stopCommitHostEffectsTimer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">resetAfterCommit</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">root</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">containerInfo</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// The work-in-progress tree is now the current tree. This must come after</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// the first pass of the commit phase, so that the previous tree is still</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// current during componentWillUnmount, but before the second pass, so that</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// the finished work is current during componentDidMount/Update.</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  root</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">current</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> finishedWork</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// In the second pass we&#x27;ll perform all life-cycles and ref callbacks.</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// Life-cycles happen as a separate pass so that all placements, updates,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// and deletions in the entire tree have already been invoked.</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// This pass also triggers any renderer-specific initial effects.</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  nextEffect </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> firstEffect</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">startCommitLifeCyclesTimer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// ç¬¬ä¸‰æ¬¡éå†</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">while</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">nextEffect </span><span class="token operator" style="color:#393A34">!==</span><span class="token plain"> </span><span class="token keyword null nil" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">invokeGuardedCallback</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword null nil" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> commitAllLifeCycles</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword null nil" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> root</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> committedExpirationTime</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// ä¸‹é¢åšä¸€äº› è¿˜åŸå˜é‡ ç­‰çš„æ”¶å°¾å·¥ä½œ</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  isCommitting$</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  isWorking </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">stopCommitLifeCyclesTimer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">stopCommitTimer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">onCommitRoot</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">finishedWork</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">stateNode</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token boolean" style="color:#36acaa">true</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> </span><span class="token maybe-class-name">ReactFiberInstrumentation_1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">debugTool</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token maybe-class-name">ReactFiberInstrumentation_1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">debugTool</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">onCommitWork</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">finishedWork</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> updateExpirationTimeAfterCommit </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> finishedWork</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">expirationTime</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> childExpirationTimeAfterCommit </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> finishedWork</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">childExpirationTime</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> earliestRemainingTimeAfterCommit </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> childExpirationTimeAfterCommit </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> updateExpirationTimeAfterCommit </span><span class="token operator" style="color:#393A34">?</span><span class="token plain"> childExpirationTimeAfterCommit </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> updateExpirationTimeAfterCommit</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">earliestRemainingTimeAfterCommit </span><span class="token operator" style="color:#393A34">===</span><span class="token plain"> </span><span class="token maybe-class-name">NoWork</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// If there&#x27;s no remaining work, we can clear the set of already failed</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// error boundaries.</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    legacyErrorBoundariesThatAlreadyFailed </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword null nil" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">onCommit</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">root</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> earliestRemainingTimeAfterCommit</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// ...</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="commitbeforemutationlifecycles"></a><code>commitBeforeMutationLifecycles</code><a class="hash-link" href="#commitbeforemutationlifecycles" title="Direct link to heading">#</a></h4><ul><li>éå†effecté“¾ï¼Œåœ¨è¿™ä¸ªå¾ªç¯ä¸­ï¼Œç»„ä»¶çš„stateå·²ç»æ›´æ–°ï¼Œä½†æ˜¯èŠ‚ç‚¹è¿˜æ²¡æœ‰æ›´æ–°ã€‚</li><li>é€šè¿‡ <code>getSnapshotBeforeUpdate</code> è·å–<code>prevProps, prevState</code>çŠ¶æ€å¿«ç…§ï¼Œç”¨äº <code>componentDidUpdate</code> ç”Ÿå‘½å‘¨æœŸå‚æ•°ä¼ é€’</li></ul><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly js"><pre tabindex="0" class="prism-code language-js codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">commitBeforeMutationLifecycles</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">while</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">nextEffect </span><span class="token operator" style="color:#393A34">!==</span><span class="token plain"> </span><span class="token keyword null nil" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> effectTag </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> nextEffect</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">effectTag</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">effectTag </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain"> </span><span class="token maybe-class-name">Snapshot</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token function" style="color:#d73a49">recordEffect</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> current$$</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> nextEffect</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">alternate</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic">// è°ƒç”¨ getSnapshotBeforeUpdate</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token function" style="color:#d73a49">commitBeforeMutationLifeCycles</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">current$$</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> nextEffect</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Don&#x27;t cleanup effects yet;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// This will be done by commitAllLifeCycles()</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    nextEffect </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> nextEffect</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">nextEffect</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="commitallhosteffects"></a><code>commitAllHostEffects</code><a class="hash-link" href="#commitallhosteffects" title="Direct link to heading">#</a></h4><ul><li>éå† <code>effect</code> é“¾</li><li>ä¼šæ ¹æ®ä¸åŒçš„ <code>effectTag</code>ï¼Œæ‰§è¡Œä¸åŒçš„æ“ä½œï¼Œæ¯”å¦‚é‡ç½®æ–‡æœ¬èŠ‚ç‚¹ï¼Œæ‰§è¡Œ æ’å…¥ã€æ›´æ–°ã€åˆ é™¤ç­‰çš„ <code>effect</code> æ“ä½œï¼ŒçœŸæ­£çš„å¯¹ dom è¿›è¡Œä¿®æ”¹ã€‚</li><li>æ­¤é˜¶æ®µæ­£å¼ commit å‰¯ä½œç”¨ï¼Œå°†å‰¯ä½œç”¨æ›´æ–°åˆ°å±å¹•ã€‚</li><li>åº”ç”¨é¦–æ¬¡æ¸²æŸ“æ—¶å‰¯ä½œç”¨ç±»å‹ä¼šåŒ¹é…åˆ° <code>PlacementAndUpdate</code>ï¼Œå…·ä½“å¤„ç†é€»è¾‘åœ¨ <code>commitPlacement</code> å‡½æ•°ä¸­ï¼Œè¯¥å‡½æ•°ä¸»è¦è´Ÿè´£æ’å…¥ DOM å…ƒç´ åˆ°å±å¹•</li></ul><p><code>HostComponent</code> ç±»å‹çš„ <code>Fiber</code> ç»“ç‚¹åœ¨å®Œæˆå·¥ä½œå•å…ƒæ—¶ä¼šåˆ›å»ºå½“å‰ç»“ç‚¹å¯¹åº”çš„ <code>DOM</code> å…ƒç´ å®ä¾‹ï¼Œå¹¶å°†å…¶èµ‹å€¼åˆ°è¯¥ç»“ç‚¹çš„ <code>stateNode</code> å±æ€§ä¸Šã€‚ <code>commitPlacement</code> å‡½æ•°ä¸­çš„ <code>node.stateNode</code> æŒ‡å‘çš„å°±æ˜¯å½“å‰ç»“ç‚¹å¯¹åº”çš„ DOM å…ƒç´ å®ä¾‹ã€‚æ‰§è¡Œå®Œ <code>appendChildToContainer(parent, stateNode) </code>ååº”ç”¨ç¨‹åºä¸­çš„å‰¯ä½œç”¨å°±ä¼šæ¸²æŸ“åˆ°å±å¹•ä¸Šã€‚</p><p>åº”ç”¨ç¨‹åºä¸­çš„å‰¯ä½œç”¨å°±ä¼šæ¸²æŸ“åˆ°å±å¹•ä¸Šå <code>React</code> è¿˜éœ€è¦åšä¸€äº›æ”¶å°¾å·¥ä½œï¼Œå¦‚å°†å½“å‰çš„ <code>workInProgress</code> æ ‘èµ‹å€¼ç»™ <code>current</code> æ ‘ï¼Œè°ƒç”¨æ›´æ–°å®Œæˆåçš„ç”Ÿå‘½å‘¨æœŸå‡½æ•°ç­‰ã€‚</p><p><code>commitMutationEffects</code>å‡½æ•°æ‰§è¡Œå®Œæˆåï¼Œéœ€è¦æ›´æ–°çš„å†…å®¹å·²ç»ç»˜åˆ¶åˆ°äº†å±å¹•ä¸Šï¼Œæ­¤æ—¶çš„ <code>workInProgress</code> æ ‘ä¹Ÿå°±æˆäº†åº”ç”¨ç¨‹åºæœ€æ–°çš„çŠ¶æ€æ ‘ã€‚å› æ­¤ <code>React</code> å°† <code>fiberRoot.current</code> æŒ‡å‘æœ€æ–°çš„ <code>workInProgress</code> æ ‘</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly js"><pre tabindex="0" class="prism-code language-js codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// è¿™é‡Œçš„finishedWorkå¼•ç”¨çš„æ˜¯workInProgressæ ‘</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">root</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">current</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> finishedWork</span><span class="token punctuation" style="color:#393A34">;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly jsx"><pre tabindex="0" class="prism-code language-jsx codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">commitAllHostEffects</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">while</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">nextEffect </span><span class="token operator" style="color:#393A34">!==</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> effectTag </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> nextEffect</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">effectTag</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">effectTag </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain"> ContentReset</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token function" style="color:#d73a49">commitResetTextContent</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">nextEffect</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">effectTag </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain"> Ref</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> current$$</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> nextEffect</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">alternate</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">current$$</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!==</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">commitDetachRef</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">current$$</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// The following switch statement is only concerned about placement,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// updates, and deletions. To avoid needing to add a case for every</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// possible bitmap value, we remove the secondary effects from the</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// effect tag and switch on that value.</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> primaryEffectTag </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> effectTag </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Placement </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Update </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Deletion</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">switch</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">primaryEffectTag</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> Placement</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token function" style="color:#d73a49">commitPlacement</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">nextEffect</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token comment" style="color:#999988;font-style:italic">// Clear the &quot;placement&quot; from effect tag so that we know that this is inserted, before</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token comment" style="color:#999988;font-style:italic">// any life-cycles like componentDidMount gets called.</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token comment" style="color:#999988;font-style:italic">// TODO: findDOMNode doesn&#x27;t rely on this any more but isMounted</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token comment" style="color:#999988;font-style:italic">// does and isMounted is deprecated anyway so we should be able</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token comment" style="color:#999988;font-style:italic">// to kill this.</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token comment" style="color:#999988;font-style:italic">// åˆ é™¤effectTag</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">          nextEffect</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">effectTag </span><span class="token operator" style="color:#393A34">&amp;=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">~</span><span class="token plain">Placement</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token keyword" style="color:#00009f">break</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> PlacementAndUpdate</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token comment" style="color:#999988;font-style:italic">// Placement</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token function" style="color:#d73a49">commitPlacement</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">nextEffect</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token comment" style="color:#999988;font-style:italic">// Clear the &quot;placement&quot; from effect tag so that we know that this is inserted, before</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token comment" style="color:#999988;font-style:italic">// any life-cycles like componentDidMount gets called.</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">          nextEffect</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">effectTag </span><span class="token operator" style="color:#393A34">&amp;=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">~</span><span class="token plain">Placement</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token comment" style="color:#999988;font-style:italic">// Update</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> _current </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> nextEffect</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">alternate</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token function" style="color:#d73a49">commitWork</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">_current</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> nextEffect</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token keyword" style="color:#00009f">break</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> Update</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> _current2 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> nextEffect</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">alternate</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token function" style="color:#d73a49">commitWork</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">_current2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> nextEffect</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token keyword" style="color:#00009f">break</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> Deletion</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token function" style="color:#d73a49">commitDeletion</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">nextEffect</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token keyword" style="color:#00009f">break</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    nextEffect </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> nextEffect</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">nextEffect</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="commitalllifecycles"></a><code>commitAllLifeCycles</code><a class="hash-link" href="#commitalllifecycles" title="Direct link to heading">#</a></h4><p>å‡½æ•°åœ¨æ›´æ–°å†…å®¹ <code>commit</code> åˆ°å±å¹•ä¹‹åæ‰§è¡Œï¼Œè¿™æ¬¡éå†ä¸»è¦è´Ÿè´£ <code>commit</code> é˜¶æ®µçš„ä¸€äº›æ”¶å°¾å·¥ä½œ</p><p>åº”ç”¨ç¨‹åºçš„å‰¯ä½œç”¨æ›´æ–°åˆ°å±å¹•åï¼Œå¯¹äº <code>ClassComponent</code> ç±»å‹çš„ç»“ç‚¹ï¼Œ<code>React</code> ä¼šè°ƒç”¨è¯¥ç»“ç‚¹çš„ç”Ÿå‘½å‘¨æœŸå‡½æ•°ï¼Œå¦‚ <code>componentDidMount</code> å’Œ <code>componentDidUpdate</code> </p><ul><li>é¦–æ¬¡æ¸²æŸ“æ‰§è¡Œ <code>componentDidMount</code></li><li>æ›´æ–°æ¸²æŸ“æ‰§è¡Œ <code>componentDidUpdate</code></li><li>æ‰§è¡Œ <code>setState</code> çš„ <code>callback</code> å›è°ƒå‡½æ•°</li><li>æ¸…ç©º <code>commitUpdateQueue</code></li></ul><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly js"><pre tabindex="0" class="prism-code language-js codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">commitAllLifeCycles</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">finishedRoot</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"> committedExpirationTime</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">while</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">nextEffect </span><span class="token operator" style="color:#393A34">!==</span><span class="token plain"> </span><span class="token keyword null nil" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> effectTag </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> nextEffect</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">effectTag</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">effectTag </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token maybe-class-name">Update</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token maybe-class-name">Callback</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token function" style="color:#d73a49">recordEffect</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> current$$</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> nextEffect</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">alternate</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token function" style="color:#d73a49">commitLifeCycles</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">finishedRoot</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> current$$</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> nextEffect</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> committedExpirationTime</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">effectTag </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain"> </span><span class="token maybe-class-name">Ref</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token function" style="color:#d73a49">recordEffect</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token function" style="color:#d73a49">commitAttachRef</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">nextEffect</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">effectTag </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain"> </span><span class="token maybe-class-name">Passive</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      rootWithPendingPassiveEffects </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> finishedRoot</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    nextEffect </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> nextEffect</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">nextEffect</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly js"><pre tabindex="0" class="prism-code language-js codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">renderRoot </span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">performWorkOnRoot </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> completeRoot </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">  commitRoot</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="é¦–æ¬¡æ¸²æŸ“"></a>é¦–æ¬¡æ¸²æŸ“<a class="hash-link" href="#é¦–æ¬¡æ¸²æŸ“" title="Direct link to heading">#</a></h2><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly js"><pre tabindex="0" class="prism-code language-js codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token maybe-class-name">React</span><span class="token plain"> åº”ç”¨ç¨‹åºé¦–æ¬¡æ¸²æŸ“æ—¶ï¼Œåœ¨ prerender é˜¶æ®µä¸»è¦åšä¸€äº› render å‰çš„å‡†å¤‡å·¥ä½œï¼Œåœ¨ render é˜¶æ®µåšæœ€é‡è¦çš„æ›´æ–° è®¡ç®—ï¼Œç„¶ååœ¨ commit é˜¶æ®µå°†ä¸Šä¸€é˜¶æ®µè®¡ç®—å¾—åˆ°çš„æ›´æ–°å†…å®¹æ˜ å°„åˆ°å±å¹•ã€‚</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token maybe-class-name">React</span><span class="token plain"> ä¸ºä»€ä¹ˆè¦è¿™æ ·è®¾è®¡é—­ç¯å‘¢</span><span class="token operator" style="color:#393A34">?</span><span class="token plain">ä¸ªäººè®¤ä¸ºä¸»è¦æ˜¯æ–¹ä¾¿æ‰¾åˆ° </span><span class="token maybe-class-name">Fiber</span><span class="token plain"> æ ‘æ ¹ç»“ç‚¹çš„ stateNode å±æ€§ä¸­çš„å€¼ã€‚</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token maybe-class-name">Fiber</span><span class="token plain"> ç»“ç‚¹çš„stateNodeå±æ€§å­˜å‚¨çš„å½“å‰ç»“ç‚¹çš„æœ€ç»ˆäº§ç‰©ï¼Œå¦‚æœæ˜¯ </span><span class="token maybe-class-name">ClassComponent</span><span class="token plain"> ç±»å‹çš„ç»“ç‚¹åˆ™è¯¥å±æ€§æŒ‡å‘ çš„æ˜¯å½“å‰ </span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> ç»„ä»¶çš„å®ä¾‹ï¼Œå¦‚æœæ˜¯ </span><span class="token maybe-class-name">HostComponent</span><span class="token plain"> ç±»å‹çš„ç»“ç‚¹åˆ™è¯¥å±æ€§æŒ‡å‘çš„æ˜¯å½“å‰ç»“ç‚¹çš„ </span><span class="token constant" style="color:#36acaa">DOM</span><span class="token plain"> å®ä¾‹ï¼Œ å¦‚æœæ˜¯ </span><span class="token maybe-class-name">HostRoot</span><span class="token plain"> ç±»å‹çš„ç»“ç‚¹åˆ™è¯¥å±æ€§æŒ‡å‘çš„æ˜¯ fiberRoot å¯¹è±¡ã€‚</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="æ›´æ–°æ¸²æŸ“"></a>æ›´æ–°æ¸²æŸ“<a class="hash-link" href="#æ›´æ–°æ¸²æŸ“" title="Direct link to heading">#</a></h2><ul><li>åœ¨æ›´æ–°æ¸²æŸ“æ—¶ <code>React</code> æ›´åŠ å…³å¿ƒçš„æ˜¯ç»“ç‚¹å‰å <code>state props</code> çš„å˜åŒ–</li></ul><p>åœ¨æ›´æ–°æ¸²æŸ“æ—¶ å¦‚ä½•æ„å»º<code>wIP</code>æ ‘</p><ul><li>é¦–æ¬¡æ¸²æŸ“å®Œæˆå <code>fiberRoot</code> å¯¹è±¡ä¸Šé¢çš„ <code>current</code> å±æ€§ä¼šæŒ‡å‘ <code>workInProgress</code> æ ‘ï¼Œè€ŒåŸæœ‰çš„ <code>workInProgress</code> æ ‘å°†ä¼šè¢«ç½®ä¸º <code>null</code> ï¼Œæ–°çš„ <code>workInProgress</code> æ ‘åªæœ‰ä¸€ä¸ª <code>HostRoot</code> ç±»å‹çš„æ ¹ç»“ç‚¹ã€‚</li><li>å³æ­¤æ—¶ <code>fiberRoot</code> å¯¹è±¡ä¸­çš„<code>current</code>å±æ€§æŒ‡å‘çš„æ˜¯ä¸Šä¸€æ¬¡(é¦–æ¬¡)æ¸²æŸ“ç»“æŸåçš„ <code>workInProgress</code> æ ‘</li></ul><ul><li>ä» <code>current</code> æ ‘ä¸Šé¢è·å– <code>workInProgress</code> å¯¹è±¡</li><li>æœ‰äº† <code>workInProgress</code> å¯¹è±¡åï¼Œä¸‹ä¸€æ­¥å°±æ˜¯é€šè¿‡å·¥ä½œå¾ªç¯å®Œå–„è¯¥å¯¹è±¡ï¼Œè¿™ä¸ªè¿‡ç¨‹ä¾ç„¶æ˜¯è¦è¿›è¡Œè§£æå·¥ä½œå•å…ƒä»¥åŠå®Œæˆå·¥ä½œå•å…ƒ</li></ul><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="è§£æå·¥ä½œå•å…ƒ-1"></a>è§£æå·¥ä½œå•å…ƒ<a class="hash-link" href="#è§£æå·¥ä½œå•å…ƒ-1" title="Direct link to heading">#</a></h4><p>åœ¨åº”ç”¨ç¨‹åºæ›´æ–°æ¸²æŸ“æ—¶ï¼Œ<code>React</code> è§£æå·¥ä½œå•å…ƒ <code>(Fiberç»“ç‚¹)</code> çš„ä¸»è¦å…³æ³¨ç‚¹æ˜¯ <code>ClassComponent</code>ç±»å‹çš„<code>Fiber</code>ç»“ç‚¹</p><h5><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="å¤„ç†ç»“ç‚¹çš„æ›´æ–°é˜Ÿåˆ—"></a>å¤„ç†ç»“ç‚¹çš„æ›´æ–°é˜Ÿåˆ—<a class="hash-link" href="#å¤„ç†ç»“ç‚¹çš„æ›´æ–°é˜Ÿåˆ—" title="Direct link to heading">#</a></h5><ul><li>åº”ç”¨ç¨‹åºæ‰§è¡Œåˆ° <code>render</code> é˜¶æ®µï¼Œåœ¨è§£æå·¥ä½œå•å…ƒæ—¶ <code>React</code> ä¼šå¤„ç†è¯¥ç»“ç‚¹çš„æ›´æ–°é˜Ÿåˆ—ï¼Œç›®çš„å°±æ˜¯è·å–æ›´æ–°å¯¹è±¡ä¸­æœ€æ–°çš„ <code>payload</code> ä¿¡æ¯</li><li>åœ¨ <code>processUpdateQueue</code> å‡½æ•°ä¸­ä¼šå¤„ç†å½“å‰ <code>Fiber</code> ç»“ç‚¹çš„æ›´æ–°é˜Ÿåˆ—å¹¶å°†æœ€ç»ˆçš„ <code>state</code> èµ‹å€¼åˆ°å½“å‰ <code>Fiber</code> ç»“ç‚¹çš„ <code>memoizedState</code> å±æ€§ä¸­</li></ul><h5><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="æ£€æŸ¥ç»“ç‚¹æ˜¯å¦éœ€è¦æ›´æ–°"></a>æ£€æŸ¥ç»“ç‚¹æ˜¯å¦éœ€è¦æ›´æ–°<a class="hash-link" href="#æ£€æŸ¥ç»“ç‚¹æ˜¯å¦éœ€è¦æ›´æ–°" title="Direct link to heading">#</a></h5><ul><li>å¤„ç†å®Œè¯¥ç»“ç‚¹çš„ <code>updateQueue</code> åå°±å¯ä»¥å¾—åˆ°æœ€æ–°çš„ <code>state</code> ï¼Œç„¶å <code>React</code> éœ€è¦å¯¹æ¯”å‰å <code>state</code> ä»¥å†³å®šå½“å‰ç»“ç‚¹æ˜¯å¦éœ€è¦æ›´æ–°</li><li>æ£€æŸ¥å·¥ä½œå•å…ƒæ˜¯å¦éœ€è¦æ›´æ–°é¦–å…ˆæ ¹æ®è¯¥ç»“ç‚¹æ˜¯å¦æœ‰<code>shouldComponentUpdate</code>ç”Ÿå‘½å‘¨æœŸå‡½æ•°ï¼Œæœ‰åˆ™è°ƒç”¨è¯¥å‡½æ•°å¹¶å–å…¶æ‰§è¡Œç»“æœ æ²¡æœ‰åˆ™è¿›è¡Œç»“ç‚¹çš„<code>props</code>å’Œ<code>state</code>å‰åå¯¹æ¯”</li><li><code>React</code>å®šä¹‰äº†<code>shallowEqual</code>æ–¹æ³•æ¥è¿›è¡Œå¯¹è±¡æ˜¯å¦ç›¸ç­‰çš„æ¯”è¾ƒ</li></ul><h5><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="åè°ƒreconcileä¸ç»“ç‚¹diffçš„è¿‡ç¨‹"></a>åè°ƒ<code>reconcile</code>ä¸ç»“ç‚¹<code>diff</code>çš„è¿‡ç¨‹<a class="hash-link" href="#åè°ƒreconcileä¸ç»“ç‚¹diffçš„è¿‡ç¨‹" title="Direct link to heading">#</a></h5><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly js"><pre tabindex="0" class="prism-code language-js codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// æ‰§è¡Œã€Œåè°ƒç®—æ³•ã€ï¼Œè·å–ä¸‹ä¸€ä¸ªFiberç»“ç‚¹</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">reconcileChildren</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">current</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> workInProgress</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> nextChildren</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> renderExpirationTime</span><span class="token punctuation" style="color:#393A34">)</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>å½“æ£€æµ‹åˆ° <code>class</code> ç»„ä»¶å¯¹åº”çš„ <code>Fiber</code> ç»“ç‚¹éœ€è¦æ›´æ–°åï¼Œ<code>React</code> ä¼šé€šè¿‡ <code>instance.render()</code> è·å–ç»„ä»¶å…ƒç´ ï¼Œå°†è¯¥ç»„ä»¶å…ƒç´ ä¼ å…¥åˆ°ã€Œåè°ƒç®—æ³•ã€ä¸­ï¼Œç„¶åè·å¾—ä¸‹ä¸€ä¸ª <code>Fiber</code> ç»“ç‚¹ã€‚è·å¾—ä¸‹ä¸€ä¸ª <code>Fiber</code> ç»“ç‚¹çš„è¿‡ç¨‹ä¹Ÿæ˜¯ <code>React</code> è¿›è¡Œ(æ–°çš„)å…ƒç´ ä¸ç°æœ‰ <code>Fiber</code> ç»“ç‚¹è¿›è¡Œ <code>diff</code> å¤„ç†çš„è¿‡ç¨‹ã€‚</p><h5><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="ä¸ºç»“ç‚¹æ ‡è®°-effecttag"></a>ä¸ºç»“ç‚¹æ ‡è®° effectTag<a class="hash-link" href="#ä¸ºç»“ç‚¹æ ‡è®°-effecttag" title="Direct link to heading">#</a></h5><blockquote><p>æ ‡è®°æ’å…¥ <code>Placement</code></p></blockquote><ul><li>åœ¨ã€Œåè°ƒã€è·å–ä¸‹ä¸€ä¸ª <code>Fiber</code> ç»“ç‚¹çš„è¿‡ç¨‹ä¸­è°ƒç”¨ <code>placeChild</code> å‡½æ•°ä¸ºä¸‹ä¸€ä¸ªç»“ç‚¹æ ‡è®° <code>Placement</code></li></ul><blockquote><p>æ ‡è®°æ›´æ–° <code>Update</code></p></blockquote><ul><li>åœ¨å®Œæˆå·¥ä½œå•å…ƒæ—¶ï¼Œä½¿ç”¨ <code>updateHostComponent</code> å‡½æ•°å®Œæˆ <code>HostComponent</code> ç±»å‹çš„å·¥ä½œå•å…ƒ(Fiber ç»“ç‚¹</li><li>è¿™æ—¶ <code>React</code> ä½¿ç”¨ <code>prepareUpdate</code> æ–¹æ³•å¯¹æ¯”ç»“ç‚¹å¯¹åº” <code>DOM</code> å®ä¾‹çš„å±æ€§åŠå†…å®¹æ˜¯å¦å‘ç”Ÿå˜åŒ–ï¼Œå¦‚æœæœ‰å˜åŒ–åˆ™ä¸ºè¯¥ç»“ç‚¹æ ‡è®° <code>Update</code> </li></ul><blockquote><p>æ ‡è®°æ’å…¥å¹¶æ›´æ–° <code>PlacementAndUpdate</code></p></blockquote><ul><li>å¦‚æœä¸€ä¸ªç»“ç‚¹æ—¢è¢«æ ‡è®°äº†<code>Placement</code>ä¹Ÿè¢«æ ‡è®°äº†<code>Update</code>ï¼Œé‚£ä¹ˆè¯¥ç»“ç‚¹çš„ <code>effectTag</code> çš„äºŒè¿›åˆ¶å¯¹åº”çš„å°±æ˜¯ <code>PlacementAndUpdate</code> </li></ul><blockquote><p>æ ‡è®°åˆ é™¤ <code>Deletion</code></p></blockquote><ul><li>åœ¨ã€Œåè°ƒã€æ•°ç»„å…ƒç´ æ—¶ï¼Œå¦‚æœæ–°çš„æ•°ç»„å…ƒç´ æ¯”æ­¤å¤„ <code>Fiber</code> æ ‘çš„ç»“ç‚¹æ•°é‡å°‘æ—¶ï¼Œé‚£ä¹ˆä¸¢ä¸‹çš„é‚£ä¸ªç»“ç‚¹å°†ä¼šè¢«è°ƒç”¨ <code>deleteChild</code> å‡½æ•°æ ‡è®°ä¸º <code>Deletion</code> ã€‚è¿˜æœ‰ä¸€ç§æƒ…å†µå°±æ˜¯ç¨‹åºä¸­æ§åˆ¶å…ƒç´ æ˜¾ç¤ºçš„æ¡ä»¶å€¼å˜ä¸º <code>false</code> ä¹Ÿä¼šå¯¼è‡´å½“å‰ç»“ç‚¹è¢«æ ‡è®°ä¸º <code>Deletion</code> ã€‚</li></ul><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="å®Œæˆå·¥ä½œå•å…ƒ-1"></a>å®Œæˆå·¥ä½œå•å…ƒ<a class="hash-link" href="#å®Œæˆå·¥ä½œå•å…ƒ-1" title="Direct link to heading">#</a></h4><blockquote><p>è®¡ç®—ç°æœ‰ DOM å®ä¾‹ä¸æ–°çš„ç»“ç‚¹ä¹‹é—´çš„å±æ€§å˜åŒ–</p></blockquote><ul><li>åº”ç”¨ç¨‹åºæ›´æ–°æ¸²æŸ“æ—¶ï¼Œåœ¨å®Œæˆå·¥ä½œå•å…ƒé˜¶æ®µç›¸å¯¹äºé¦–æ¬¡æ¸²æŸ“ <code>React</code> éœ€è¦é‡ç‚¹è®¡ç®—ç°æœ‰çš„ DOM å®ä¾‹ä¸æ–°çš„ç»“ç‚¹ä¹‹é—´çš„å±æ€§å˜åŒ–ï¼Œæ­¤å¤„é€»è¾‘ä¸»è¦åœ¨ <code>diffProperties</code> å‡½æ•°ä¸­æ‰§è¡Œ</li><li><code>diffProperties</code>å‡½æ•°ä¸»è¦ç”¨äºè®¡ç®—<code>(HostComponetç±»å‹çš„)</code>ç»“ç‚¹æ›´æ–°å‰åæ‰€æœ‰çš„ <code>style</code> å±æ€§æ˜¯å¦å‘ç”Ÿå˜åŒ–ï¼Œå¹¶å°†æ‰€æœ‰å‘ç”Ÿå˜åŒ–çš„å±æ€§ä»¥åŠå¯¹åº”çš„å€¼æ”¶é›†èµ·æ¥ã€‚è¿™äº›å±æ€§å˜åŒ–çš„æ•°æ®åœ¨ <code>commit</code> ç»“ç‚¹è¢«ç»Ÿä¸€æ›´æ–°åˆ° DOMã€‚</li></ul><p>åº”ç”¨ç¨‹åºæ›´æ–°æ¸²æŸ“æ„å»º <code>workInProgress</code> æ ‘çš„æ•´ä½“æµç¨‹ä¸é¦–æ¬¡æ¸²æŸ“æ—¶åŸºæœ¬ç›¸åŒã€‚ä¸åŒçš„åœ°æ–¹å°±æ˜¯å¯¹äº <code>ClassComponent</code> ç±»å‹çš„ç»“ç‚¹ï¼Œ<code>React</code> ä¼šå…ˆå¤„ç†è¯¥ç»“ç‚¹çš„æ›´æ–°é˜Ÿåˆ—å¹¶è·å–æœ€æ–°çš„ <code>state</code>ï¼Œç„¶ååˆ¤æ–­è¯¥ç»“ç‚¹æ˜¯å¦éœ€è¦æ‰§è¡Œåç»­çš„æ›´æ–°é€»è¾‘ã€‚å¦‚æœç±»å‹çš„ç»“ç‚¹éœ€è¦æ‰§è¡Œæ›´æ–°ï¼Œåˆ™é€šè¿‡æ‰§è¡Œã€Œåè°ƒã€é€»è¾‘è·å–ä¸‹ä¸€ä¸ª <code>Fiber</code> ç»“ç‚¹ï¼Œè¿™ä¸ªè¿‡ç¨‹ä¸­ä¹Ÿä¼šè¿›è¡Œæ–°å…ƒç´ ä¸å½“å‰ <code>Fiber</code> ç»“ç‚¹ <code>diff</code> æ“ä½œã€‚ç»“ç‚¹ <code>diff </code>å¤„ç†çš„è¿‡ç¨‹ä¸­ <code>React</code> ä¼šä¸ºç»“ç‚¹æ ‡è®°å¯¹åº”çš„ <code>effectTag</code>ï¼Œæœ€å¸¸ç”¨çš„å‡ ç§ <code>effectTag</code> åŒ…æ‹¬ <code>Placement Update PlacementAndUpdate Deletion</code></p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly js"><pre tabindex="0" class="prism-code language-js codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token maybe-class-name">React</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">å…ƒç´ ç±»å‹</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">type</span><span class="token punctuation" style="color:#393A34">)</span><span class="token function" style="color:#d73a49">ä¸»è¦åŒ…æ‹¬å®¿ä¸»å…ƒç´ </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">divï¼Œspan</span><span class="token punctuation" style="color:#393A34">)</span><span class="token function" style="color:#d73a49">å’Œç»„ä»¶å…ƒç´ </span><span class="token punctuation" style="color:#393A34">(</span><span class="token maybe-class-name">UpdateCounter</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">ï¼Œè¿™ä¸¤ç§ç±»å‹å…ƒç´ è½¬æ¢ ä¸º </span><span class="token maybe-class-name">Fiber</span><span class="token plain"> ç»“ç‚¹åå¯¹åº”çš„ç±»å‹åˆ†åˆ«æ˜¯HostComponentå’ŒClassComponentã€‚å½“ç„¶ï¼ŒFiber ç»“ç‚¹è¿˜æœ‰æ›´å¤šçš„ç±»å‹</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token maybe-class-name">HostRoot</span><span class="token plain"> æ ¹ç»“ç‚¹</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token maybe-class-name">HostText</span><span class="token plain"> æ–‡æœ¬å…ƒç´ </span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token maybe-class-name">HostComponent</span><span class="token plain"> å®¿ä¸»å…ƒç´ </span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/docs/reactCore/schedule"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Â« ä»»åŠ¡è°ƒåº¦</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/docs/reactCore/diff"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">diff Â»</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_35-E thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#renderé˜¶æ®µ-1" class="table-of-contents__link">renderé˜¶æ®µ</a><ul><li><a href="#æ„å»º-wip-æ ‘" class="table-of-contents__link">æ„å»º <code>wIP</code> æ ‘</a></li><li><a href="#å·¥ä½œå¾ªç¯" class="table-of-contents__link">å·¥ä½œå¾ªç¯</a></li><li><a href="#è§£æä¸åŒç±»å‹fiberç»“ç‚¹" class="table-of-contents__link">è§£æä¸åŒç±»å‹<code>Fiber</code>ç»“ç‚¹</a></li><li><a href="#å®Œæˆå·¥ä½œå•å…ƒçš„æ—¶æœº" class="table-of-contents__link">å®Œæˆå·¥ä½œå•å…ƒçš„æ—¶æœº</a></li></ul></li><li><a href="#commit-é˜¶æ®µ" class="table-of-contents__link"><code>commit</code> é˜¶æ®µ</a></li><li><a href="#é¦–æ¬¡æ¸²æŸ“" class="table-of-contents__link">é¦–æ¬¡æ¸²æŸ“</a></li><li><a href="#æ›´æ–°æ¸²æŸ“" class="table-of-contents__link">æ›´æ–°æ¸²æŸ“</a></li></ul></div></div></div></div></main></div></div></div>
<script src="/assets/js/runtime~main.e861e66d.js"></script>
<script src="/assets/js/main.6b6955fb.js"></script>
</body>
</html>