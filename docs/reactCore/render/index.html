<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.4">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="HonjayChang Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="HonjayChang Blog Atom Feed"><title data-react-helmet="true">render阶段 | HonjayChang</title><meta data-react-helmet="true" property="og:url" content="https://honjaychang.github.io//docs/reactCore/render"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="render阶段 | HonjayChang"><meta data-react-helmet="true" name="description" content="image-20211002152401431"><meta data-react-helmet="true" property="og:description" content="image-20211002152401431"><link data-react-helmet="true" rel="shortcut icon" href="/img/photo.ico"><link data-react-helmet="true" rel="canonical" href="https://honjaychang.github.io//docs/reactCore/render"><link data-react-helmet="true" rel="alternate" href="https://honjaychang.github.io//docs/reactCore/render" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://honjaychang.github.io//docs/reactCore/render" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.6b743985.css">
<link rel="preload" href="/assets/js/runtime~main.7bae2b1a.js" as="script">
<link rel="preload" href="/assets/js/main.df3858a9.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_1oUP">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a href="https://honjaychang.github.io/docs/home" target="_blank" rel="noopener noreferrer" class="navbar__brand"><img src="/img/photo.jpg" alt="My Site Logo" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/img/photo.jpg" alt="My Site Logo" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"></a><a class="navbar__item navbar__link navbar__link--active" href="/docs/Home">Docs</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/Honjaychang" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="react-toggle toggle_3Zt9 react-toggle--disabled"><div class="react-toggle-track" role="button" tabindex="-1"><div class="react-toggle-track-check"><span class="toggle_71bT">🌜</span></div><div class="react-toggle-track-x"><span class="toggle_71bT">🌞</span></div><div class="react-toggle-thumb"></div></div><input type="checkbox" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper doc-page"><div class="docPage_31aa"><button class="clean-btn backToTopButton_35hR" type="button" title="Scroll to top"><svg viewBox="0 0 24 24" width="28"><path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z" fill="currentColor"></path></svg></button><aside class="docSidebarContainer_3Kbt"><div class="sidebar_15mo"><nav class="menu thin-scrollbar menu_Bmed menuWithAnnouncementBar_2WvA"><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/docs/Home">Home</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">HC</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">JS</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Extension</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">TS</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">React</a></li><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#">ReactCore</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/reactCore/basic">一些概念</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/reactCore/ds">数据结构定义</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/reactCore/createUpdate">更新流程</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active active" tabindex="0" href="/docs/reactCore/render">render阶段</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/reactCore/commit">commit阶段</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/reactCore/scheduler">调度器</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/reactCore/reconciler">协调器</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/reactCore/event">React事件机制</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Dev</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Algo</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Interview</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Vue</a></li></ul></nav><button type="button" title="Collapse sidebar" aria-label="Collapse sidebar" class="button button--secondary button--outline collapseSidebarButton_1CGd"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_3E-R"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></aside><main class="docMainContainer_3ufF"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_3FnS"><div class="docItemContainer_33ec"><article><div class="tocCollapsible_1PrD tocMobile_3Hoh"><button type="button" class="clean-btn tocCollapsibleButton_2O1e">On this page</button></div><div class="markdown"><header><h1 class="h1Heading_27L5">render阶段</h1></header><p><img src="https://cdn.jsdelivr.net/gh/honjaychang/bp/fe/20211002152401.png" alt="image-20211002152401431"></p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="概述"></a>概述<a class="hash-link" href="#概述" title="Direct link to heading">#</a></h2><p><code>render</code> 阶段</p><blockquote><p>React 应用程序首次渲染时构建 <code>workInProgress</code> 树的过程也是将 <code>React</code> 元素树转化为 <code>Fiber</code> 树的过程， <code>workInProgress</code> 树构建完成后会在该「树」上面完成更新计算、调用生命周期函数以及收集副作用列表等工作。</p><p>应用程序渲染时在 <code>render</code> 阶段的一个重要工作就是构建 <code>workInProgress</code> 树，构建 <code>workInProgress</code> 树的过程中 <code>React</code> 也会完成更新计算、调用生命周期函数以及收集副作用列表等工作</p><p>React的更新任务主要是调用<code>workLoop</code>的工作循环去构建<code>workInProgress</code>树， 构建过程分为两个阶段：向下遍历和向上回溯，向下和向上的过程中会对途径的每个节点进行<code>beginWork</code> 和<code>completeWork</code></p></blockquote><p><code>beginWork</code></p><ul><li>是处理节点更新的入口，它会依据<code>fiber</code> 节点的类型去调用不同的处理函数</li><li>React对<code>current</code>树的每个节点进行<code>beginWork</code> 操作，进入<code>beginWork</code> 后，首先判断节点及其子树是否有更新，若有更新，则会在计算新状态和<code>diff</code>之后生成新的<code>fiber</code>， 然后在新的<code>fiber</code>上标记<code>effectTag</code>，最后<code>return</code>它的子节点，以便继续针对子节点进行<code>beginWork</code>。若它没有子节点，则返回<code>null</code>，这样说明这个节点是末端节点， 可以进行向上回溯，进入<code>completeWork</code>阶段。</li><li>计算新状态 <code>update</code> <code>updateQueue</code> <code>processUpdateQueue</code><ul><li>准备阶段 - 整理<code>updateQueue</code> 上次遗留的 本次新增的</li><li>处理阶段 - 循环处理上一步整理好的更新队列 优先级</li><li>完成阶段 - 主要是做一些赋值和优先级标记的工作</li></ul></li><li><code>Diff</code>算法<ul><li>经过状态计算后 已经获取到了新的 <code>fiber</code> 在<code>render</code>之前 需要<code>diff</code> 操作 打上 <code>effectTag</code>  (可以标识这个<code>fiber</code>发生了怎样的变化，例如：新增<code>Placement</code> ，这些被打上<code>flag</code> 的<code>fiber</code>会在<code>complete</code>阶段被收集起来，形成一个<code>effectList</code>链表，只包含这些需要操作的<code>fiber</code>，最后在<code>commit</code>阶段被更新掉)</li><li><code>diff</code> 的主体是 <code>oldFiber (current.child)</code> 和 <code>new React Element (nextChildren)</code></li><li><code>diff</code> 的原则  直接销毁重建  以及 依据<code>key tag</code>复用</li><li>在 <code>diff</code> 过后，<code>workInProgress</code>节点的<code>beginWork</code>节点就完成了。接下来会进入<code>completeWork</code>阶段</li></ul></li></ul><p><code>completeWork</code></p><ul><li>进入<code>completeWork</code> 后的<code>workInProgress</code> 节点都是经过<code>diff</code>算法调和过的，节点的<code>fiber</code>的形态已经基本确定了，但对于原生DOM组件和文本节点的 <code>fiber</code> 来说，对应的DOM节点并未变化</li><li>这个阶段主要就是两个工作<ul><li>构建或更新DOM节点</li><li>自下而上收集<code>effectList</code>，最终收集到<code>root</code>上</li></ul></li><li>依据<code>fiber</code>的<code>tag</code>做不同处理。DOM节点的更新实则是属性的更新</li></ul><p>收集好的副作用列表会在 <code>commit</code> 阶段统一映射到屏幕上</p><ul><li>创建<code>wIP</code> 树</li><li>计算新状态</li><li>进行<code>diff</code> 标记<code>effectTag</code></li><li>构建或更新DOM节点</li><li>收集形成 <code>effect List</code></li></ul><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="beginwork"></a><code>beginWork</code><a class="hash-link" href="#beginwork" title="Direct link to heading">#</a></h2><blockquote><p>从初始化 <code>workInProgress</code> 对象到形成 <code>workInProgress</code> 树，应用程序会执行多次循环，每一次循环都是在解析 <code>Fiber</code> 结点并返回下一个要解析的结点。这 个过程中会使用重要的「协调」算法，对结点进行 <code>diff</code> 操作</p></blockquote><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="构建-wip-树"></a>构建 <code>wIP</code> 树<a class="hash-link" href="#构建-wip-树" title="Direct link to heading">#</a></h3><blockquote><p>此阶段 <code>React</code> 将元素逐个转换为对应类型的 <code>Fiber</code> 结点，最终形成 <code>workInProgress</code> 树</p></blockquote><p>应用程序首次渲染过程刚进入 <code>render</code> 阶段时 <code>fiberRoot</code> 对象上面只有 <code>current</code> 树，此时的 <code>current</code> 树只有一个类型为 <code>HostRoot</code> 的 <code>Fiber</code> 结点，该 <code>Fiber</code> 结点的更新队列中只有一个更新对象，内容是应用程序的根组件元素。紧接着 <code>React</code> 要做的就是初始化 <code>workInProgress</code> 对象。</p><p><img src="https://cdn.jsdelivr.net/gh/honjaychang/bp/fe/20211001131338.png" alt="image-20211001131338587"></p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="初始化-wip-对象"></a>初始化 <code>wIP</code> 对象<a class="hash-link" href="#初始化-wip-对象" title="Direct link to heading">#</a></h4><ul><li><code>renderRoot</code> 调用 <code>createWorkInProgress</code> 为 <code>workInProgress</code> 对象赋初始值</li><li>函数调用后 <code>wIP</code> 对象上有了第一个<code>Fiber</code>结点，结点的<code>tag</code>为<code>HostRoot</code> 是整个<code>wIP</code>树的根节点</li></ul><p><img src="https://cdn.jsdelivr.net/gh/honjaychang/bp/fe/20211001132001.png" alt="image-20211001132001247"></p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="完善-wip-对象"></a>完善 <code>wIP</code> 对象<a class="hash-link" href="#完善-wip-对象" title="Direct link to heading">#</a></h4><ul><li>要想把组件元素描述的页面结构映射到屏幕上必须先将元素转换为 <code>Fiber</code> 结点</li><li>完善<code>wIP</code> 对象的过程就是 将 <code>React</code> 元素树转化为 <code>Fiber</code> 树的过程</li></ul><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="工作循环"></a>工作循环<a class="hash-link" href="#工作循环" title="Direct link to heading">#</a></h3><blockquote><p>React 通过工作循环来构建<code>workInProgress</code> </p><p>两个关键环节 解析工作单元 完成工作单元</p></blockquote><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="循环解析工作单元"></a>循环解析工作单元<a class="hash-link" href="#循环解析工作单元" title="Direct link to heading">#</a></h4><ul><li>工作循环主要是执行 <code>workLoop</code> 函数来循环解析工作单元。每次循环解析的工作单元就是上一次 <code>Fiber</code> 结点的 <code>child</code>。</li><li>第一次循环解析的是 <code>HostRoot</code> 类型的结点，该结点也就是所有结点的祖先</li><li>工作单元具体的解析逻辑在 <code>performUnitOfWork</code> 中调用</li></ul><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="解析工作单元"></a>解析工作单元<a class="hash-link" href="#解析工作单元" title="Direct link to heading">#</a></h4><p>在 <code>beginWork</code> 函数内部通过匹配 <code>Fiber</code> 结点的 <code>tag</code> 值调用 <code>updateHostRoot、updateClassComponent、updateHostComponent、updateHostText</code> 等函数，分别解析 <code>HostRoot、ClassComponent、HostComponent、HostText</code>等类型的Fiber 结点。</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="完成工作单元"></a>完成工作单元<a class="hash-link" href="#完成工作单元" title="Direct link to heading">#</a></h4><p>即<code>completeWork</code></p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="解析不同类型fiber结点"></a>解析不同类型<code>Fiber</code>结点<a class="hash-link" href="#解析不同类型fiber结点" title="Direct link to heading">#</a></h3><p>应用程序首次渲染时，将根组件元素转换为多个层级的 <code>Fiber</code> 结点过程中，第一步要做的就是解析 <code>wIP</code> 树的根结点 <code>HostRoot</code></p><p><img src="https://cdn.jsdelivr.net/gh/honjaychang/bp/fe/20211001140433.png" alt="image-20211001140433792"></p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="hostroot-类型"></a><code>HostRoot</code> 类型<a class="hash-link" href="#hostroot-类型" title="Direct link to heading">#</a></h4><ul><li><code>updateHostRoot -&gt; processUpdateQueue</code></li><li>解析 <code>HostRoot</code>类型结点的关键是处理更新队列 <code>processUpdateQueue</code> 获取根组件元素 <code>element</code>，<code>element </code>就是要传入到协调算法中进行解析的<code>nextChildren</code></li></ul><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly js"><pre tabindex="0" class="prism-code language-js codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">updateHostRoot</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">current$$</span><span class="token parameter number" style="color:#36acaa">1</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"> workInProgress</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"> renderExpirationTime</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">pushHostRootContext</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">workInProgress</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> updateQueue </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> workInProgress</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">updateQueue</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> nextProps </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> workInProgress</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">pendingProps</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> prevState </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> workInProgress</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">memoizedState</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> prevChildren </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> prevState </span><span class="token operator" style="color:#393A34">!==</span><span class="token plain"> </span><span class="token keyword null nil" style="color:#00009f">null</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">?</span><span class="token plain"> prevState</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">element</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword null nil" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">processUpdateQueue</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">workInProgress</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> updateQueue</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> nextProps</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword null nil" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> renderExpirationTime</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> nextState </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> workInProgress</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">memoizedState</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// Caution: React DevTools currently depends on this property</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// being called &quot;element&quot;.</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> nextChildren </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> nextState</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">element</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">nextChildren </span><span class="token operator" style="color:#393A34">===</span><span class="token plain"> prevChildren</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// If the state is the same as before, that&#x27;s a bailout because we had</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// no work that expires at this time.</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">resetHydrationState</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword control-flow" style="color:#00009f">return</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">bailoutOnAlreadyFinishedWork</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">current$$</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> workInProgress</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> renderExpirationTime</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> root </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> workInProgress</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">stateNode</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">current$$</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">===</span><span class="token plain"> </span><span class="token keyword null nil" style="color:#00009f">null</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">||</span><span class="token plain"> current$$</span><span class="token number" style="color:#36acaa">1.</span><span class="token plain">child </span><span class="token operator" style="color:#393A34">===</span><span class="token plain"> </span><span class="token keyword null nil" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> root</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">hydrate</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">enterHydrationState</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">workInProgress</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// If we don&#x27;t have any current children this might be the first pass.</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// We always try to hydrate. If this isn&#x27;t a hydration pass there won&#x27;t</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// be any children to hydrate which is effectively the same thing as</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// not hydrating.</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// This is a bit of a hack. We track the host root as a placement to</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// know that we&#x27;re currently in a mounting state. That way isMounted</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// works as expected. We must reset this before committing.</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// TODO: Delete this when we delete isMounted and findDOMNode.</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    workInProgress</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">effectTag</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|=</span><span class="token plain"> </span><span class="token maybe-class-name">Placement</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Ensure that children mount into this root without tracking</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// side-effects. This ensures that we don&#x27;t store Placement effects on</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// nodes that will be hydrated.</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    workInProgress</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">child</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">mountChildFibers</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">workInProgress</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword null nil" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> nextChildren</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> renderExpirationTime</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#00009f">else</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Otherwise reset hydration state in case we aborted and resumed another</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// root.</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">reconcileChildren</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">current$$</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> workInProgress</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> nextChildren</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> renderExpirationTime</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">resetHydrationState</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">return</span><span class="token plain"> workInProgress</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">child</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="classcomponent-类型"></a><code>ClassComponent</code> 类型<a class="hash-link" href="#classcomponent-类型" title="Direct link to heading">#</a></h4><ul><li>应用程序首次渲染时解析 <code>HostRoot</code> 类型结点完成后返回的一般是 <code>ClassComponent</code> 类型的结点，这种类型的 <code>Fiber</code> 结点解析过程中是要进行组件实例化的</li><li>解析<code>ClassComponent</code>类型的结点时，先从当前 <code>Fiber</code> 结点的 <code>stateNode</code> 属性上面取组件实例<code>instance</code>，如果 <code>instance</code> 的值为 <code>null</code> 则说明是首次渲染，组件还没有被实例化。React 使用 <code>constructClassInstance</code> 函数完成组件实例化，同时为组件实例添加更新器（然后就可以调用 <code>setState</code> </li><li>组件实例生成后，它的核心作用之一就是在  <code>finishClassComponent</code>  函数内部执行 <code>instance.render() </code>获取要传入到协调算法中进行解析的 <code>nextChildren</code></li></ul><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly js"><pre tabindex="0" class="prism-code language-js codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">updateClassComponent</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">current$$</span><span class="token parameter number" style="color:#36acaa">1</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"> workInProgress</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"> Component</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"> nextProps</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"> renderExpirationTime</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// ...</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> instance </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> workInProgress</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">stateNode</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> shouldUpdate </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">instance </span><span class="token operator" style="color:#393A34">===</span><span class="token plain"> </span><span class="token keyword null nil" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">current$$</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!==</span><span class="token plain"> </span><span class="token keyword null nil" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic">// An class component without an instance only mounts if it suspended</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic">// inside a non- concurrent tree, in an inconsistent state. We want to</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic">// tree it like a new mount, even though an empty version of it already</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic">// committed. Disconnect the alternate pointers.</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      current$$</span><span class="token number" style="color:#36acaa">1.</span><span class="token plain">alternate </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword null nil" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      workInProgress</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">alternate</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword null nil" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic">// Since this is conceptually a new fiber, schedule a Placement effect</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      workInProgress</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">effectTag</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|=</span><span class="token plain"> </span><span class="token maybe-class-name">Placement</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// In the initial pass we might need to construct the instance.</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">constructClassInstance</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">workInProgress</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token maybe-class-name">Component</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> nextProps</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> renderExpirationTime</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">mountClassInstance</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">workInProgress</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token maybe-class-name">Component</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> nextProps</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> renderExpirationTime</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    shouldUpdate </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#00009f">else</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">current$$</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">===</span><span class="token plain"> </span><span class="token keyword null nil" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// In a resume, we&#x27;ll already have an instance we can reuse.</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    shouldUpdate </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">resumeMountClassInstance</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">workInProgress</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token maybe-class-name">Component</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> nextProps</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> renderExpirationTime</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#00009f">else</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    shouldUpdate </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">updateClassInstance</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">current$$</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> workInProgress</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token maybe-class-name">Component</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> nextProps</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> renderExpirationTime</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> nextUnitOfWork </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">finishClassComponent</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">current$$</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> workInProgress</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token maybe-class-name">Component</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> shouldUpdate</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> hasContext</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> renderExpirationTime</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">return</span><span class="token plain"> nextUnitOfWork</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">finishClassComponent</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">current$$</span><span class="token parameter number" style="color:#36acaa">1</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"> workInProgress</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"> Component</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"> shouldUpdate</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"> hasContext</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"> renderExpirationTime</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// ...</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">return</span><span class="token plain"> workInProgress</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">child</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="hostcomponent-类型"></a><code>HostComponent</code> 类型<a class="hash-link" href="#hostcomponent-类型" title="Direct link to heading">#</a></h4><ul><li>解析 <code>ClassComponent</code> 类型结点完成后返回的一般是 <code>HostComponent</code> 类型<code>tag</code>的结点，这种结点的具体类型 <code>elementType</code>对应的是真实的 <code>DOM</code> 标签 (如 <code>div  span ...</code> </li><li>解析 <code>HostComponent</code> 类型结点，可从当前结点对应的元素 <code>props</code> 中获取要传入到协调算法中进行解析的 <code>nextChildren</code></li><li>这里要强调一下，无论是解析 HostRoot 类型的结点，还是解析 <code>HostComponent</code> 类型的结点，这个过程中获取的 <code>nextChildren</code> 均为 <code>React 元素</code>。在执行协调算法的过程中，<code>React</code> 将该元素转换成对应的 <code>Fiber </code>结点并返回。</li></ul><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="hosttext-类型"></a><code>HostText</code> 类型<a class="hash-link" href="#hosttext-类型" title="Direct link to heading">#</a></h4><ul><li>当解析到元素的叶子元素时，此时对应的 <code>Fiber</code> 结点类型为 <code>HostText</code> 。<code>React</code> 认为文本类型的 <code>Fiber </code>结点已经是终点，不会再有孩子结点，直接返回 <code>null</code></li></ul><p><img src="https://cdn.jsdelivr.net/gh/honjaychang/bp/fe/20211001145029.png" alt="image-20211001145029076"></p><p>在工作循环的过程中，<code>React</code> 总是先从外部根节点开始解析，当解析到叶子结点时就要开始完成工作单元。完成工作单元时如果有兄弟结点时则需要继续解析兄弟结点，然后完成兄弟结点后会逐层向上完成工作单元。</p><p>工作单元解析执行到 <code>workInProgress</code> 树的叶子结点时，会完成当前工作单元。完成工作单元的主要工作是收集副作用，同时处理 <code>HostComponent</code> 类型的结点，创建对应的 <code>DOM</code> 元素并将他们 <code>append</code> 到父结点上</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="completework"></a><code>completeWork</code><a class="hash-link" href="#completework" title="Direct link to heading">#</a></h2><p>在 <code>Diff</code> 之后，<code>workInProgress</code>节点就会进入<code>complete</code>阶段</p><p>这个时候拿到的<code>workInProgress</code>节点都是经过<code>diff</code>算法调和过的，也就意味着对于某个节点来说它<code>fiber</code>的形态已经基本确定了，但除此之外还有两点：</p><ul><li>目前只有<code>fiber</code>形态变了，对于原生DOM组件 <code>HostComponent</code> 和文本节点 <code>HostText</code> 的<code>fiber</code>来说，对应的DOM节点 <code>fiber.stateNode</code> 并未变化</li><li>经过<code>Diff</code>生成的新的<code>workInProgress</code>节点持有了<code>flag</code> 即<code>effectTag</code></li></ul><p>基于这两个特点，<code>completeWork</code>的工作主要有：</p><ul><li>构建或更新DOM节点 (为 <code>HostComponent</code> 类型的结点创建 <code>DOM</code> 元素实例)<ul><li>构建过程中，会自下而上将子节点的第一层第一层插入到当前节点。</li><li>更新过程中，会计算DOM节点的属性，一旦属性需要更新，会为DOM节点对应的<code>workInProgress</code> 节点标记<code>Update</code> 的 <code>effectTag</code></li></ul></li><li>自下而上收集副作用 <code>effectList</code>，最终收集到 <code>root</code>上</li><li>错误处理</li></ul><p><img src="https://cdn.jsdelivr.net/gh/honjaychang/bp/fe/20211011102119.png" alt="image-20211011102119660"></p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="dom节点的创建插入"></a>DOM节点的创建插入<a class="hash-link" href="#dom节点的创建插入" title="Direct link to heading">#</a></h3><blockquote><p>完成DOM树的创建</p></blockquote><p><strong>DOM的插入并不是将当前DOM插入它的父节点，而是将当前这个DOM节点的第一层子节点插入到它自己的下面</strong></p><ul><li>总是优先看本身可否插入，再往下找，之后才是找<code>sibling</code>节点</li></ul><p>由于<code>fiber</code>树和<code>dom</code>树的差异，每个<code>fiber</code>节点不一定对应一个<code>dom</code>节点，但一个<code>dom</code>节点一定对应一个<code>fiber</code>节点</p><p>由于一个原生DOM组件的子组件有可能是类组件或函数组件，所以会优先检查自身，发现自己不是原生DOM组件，不能被插入到父级<code>fiber</code>节点对应的DOM中，所以要往下找，直到找到原生DOM组件，执行插入，最后再从这一层找同级的fiber节点，同级节点也会执行<code>先自检，再检查下级，再检查下级的同级</code>的操作。</p><p>节点的插入也是深度优先。值得注意的是，这一整个插入的流程并没有真的将DOM插入到真实的页面上，它只是在操作<code>fiber</code>上的<code>stateNode</code>。真实的插入DOM操作发生在<code>commit</code>阶段。</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly js"><pre tabindex="0" class="prism-code language-js codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">              </span><span class="token maybe-class-name">App</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">2</span><span class="token plain">              div</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token operator" style="color:#393A34">/</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">               </span><span class="token operator" style="color:#393A34">/</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">3</span><span class="token plain">        </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token maybe-class-name">List</span><span class="token operator" style="color:#393A34">/</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">span</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token operator" style="color:#393A34">/</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">           </span><span class="token operator" style="color:#393A34">/</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">4</span><span class="token plain">       p </span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;text node&#x27;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">         </span><span class="token operator" style="color:#393A34">/</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token operator" style="color:#393A34">/</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">5</span><span class="token plain">    h1</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">             div</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">   </span><span class="token operator" style="color:#393A34">|</span><span class="token plain">   \</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">    </span><span class="token operator" style="color:#393A34">|</span><span class="token plain">    \</span></span><span class="token-line" style="color:#393A34"><span class="token plain">       p   </span><span class="token string" style="color:#e3116c">&#x27;text&#x27;</span><span class="token plain">  span</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token operator" style="color:#393A34">/</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">     </span><span class="token operator" style="color:#393A34">/</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    h1</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p><code>HostComponent</code> 和<code>HostText</code>类型的 <code>Fiber </code>结点是有对应的真实 <code>DOM</code> 元素，因此在完成工作单元阶段 <code>React</code>要为它们创建自己的 <code>DOM</code> 实例</p><p>在完成工作单元的过程中分为了两种情况，分别是首次渲染和更新渲染。</p><ul><li>应用程序首次渲染时：<code>React</code> 为 <code>HostComponent</code> 和 <code>HostText</code> 类型的 <code>Fiber</code> 结点创建对应的 <code>DOM</code> 实例并将其赋值到结点上的 <code>stateNode</code> 属性上</li><li>应用程序更新渲染时： <code>React</code> 不需要为它们重新创建 <code>DOM</code> 实例，而是把新的值更新到 <code>DOM</code> 元素中</li></ul><p><code>updateHostComponent</code> 函数和 <code>updateHostText</code> 函数分别用于更新 DOM 元素</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="dom属性的处理"></a>DOM属性的处理<a class="hash-link" href="#dom属性的处理" title="Direct link to heading">#</a></h3><blockquote><p>属性的创建</p></blockquote><p>主要就是调用<code>setInitialDOMProperties</code>将属性直接设置进DOM节点（事件在这个阶段绑定）</p><blockquote><p>属性的更新</p></blockquote><p>以<code>HostComponent</code>为例，会调用<code>updateHostComponent</code>函数对DOM节点属性进行更新</p><ul><li>主要就是计算新的属性，并挂载到<code>workInProgress</code>节点的<code>updateQueue</code>中</li><li>会调用<code>diffProperties</code>对比<code>lastProps</code>和<code>nextProps</code>，计算出<code>updatePayload</code></li></ul><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly js"><pre tabindex="0" class="prism-code language-js codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">lastProps</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string" style="color:#e3116c">&quot;className&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;test&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string" style="color:#e3116c">&quot;title&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;更新前的标题&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string" style="color:#e3116c">&quot;style&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;color&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;red&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;fontSize&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">18</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string" style="color:#e3116c">&quot;props&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;自定义旧属性&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string" style="color:#e3116c">&quot;children&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;测试div的Props变化&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string" style="color:#e3116c">&quot;onClick&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token spread operator" style="color:#393A34">...</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">nextProps</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string" style="color:#e3116c">&quot;className&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;test&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string" style="color:#e3116c">&quot;title&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;更新后的标题&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string" style="color:#e3116c">&quot;style&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;color&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot;blue&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;fontSize&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">18</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string" style="color:#e3116c">&quot;children&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;测试div的Props变化&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string" style="color:#e3116c">&quot;onClick&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token spread operator" style="color:#393A34">...</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// index为偶数的是key，为奇数的是value</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token string" style="color:#e3116c">&quot;props&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword null nil" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token string" style="color:#e3116c">&quot;title&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;更新后的标题&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token string" style="color:#e3116c">&quot;style&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token string" style="color:#e3116c">&quot;color&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot;blue&quot;</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">]</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>DOM节点属性的<code>diff</code>为<code>workInProgress</code>节点挂载了带有新属性的<code>updateQueue</code>，一旦节点的<code>updateQueue</code>不为空，它就会被标记上<code>Update</code>的<code>effectTag</code>，<code>commit</code>阶段会处理<code>updateQueue</code>。</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="effecttag-收集"></a><code>effectTag</code> 收集<a class="hash-link" href="#effecttag-收集" title="Direct link to heading">#</a></h3><p>经过<code>beginWork</code>和上面对于DOM的操作，有变化的<code>workInProgress</code>节点已经被打上了<code>effectTag</code></p><p>在收集副作用的过程中主要有两种情况</p><ul><li>第一种情况就是将子树上面的副作用列表连到父结点上面</li><li>第二种情况就是如果当前结点也有副作用标识，则将当前结点也连接到父结点的副作用列表中</li></ul><p>事实上，应用程序首次渲染时的副作用列表就是整个 <code>workInProgress</code> 树，因为整个 <code>workInProgress</code> 树的结点中携带的内容都需要更新到屏幕，而在应用程序更新渲染时副作用列表将会是 <code>workInProgress</code> 树的子集</p><p>每个<code>workInProgress</code>节点都有一个<code>firstEffect</code>和<code>lastEffect</code>，是一个单向链表，来表示它自身以及它的子节点上所有持有<code>effectTag</code>的<code>workInProgress</code>节点。<code>completeWork</code>阶段在向上遍历的过程中也会逐层收集<code>effect</code>链，最终收集到<code>root</code>上，供接下来的<code>commit</code>阶段使用。</p><p>在收集好的副作用列表中每个 <code>HostComponent</code> 类型 <code>Fiber</code> 结点的 <code>stateNode</code> 属性中存储了当前结点对应的 <code>DOM</code> 实例。那么，<code>React</code> 下一步要做的就是将副作用列表中的所有 <code>DOM</code> 实例更新到屏幕中</p><p><code>completeWork</code>阶段处在<code>beginWork</code>之后，<code>commit</code>之前，起到的是一个承上启下的作用。它接收到的是经过<code>diff</code>后的<code>fiber</code>节点，然后他自己要将DOM节点和<code>effectList</code>都准备好。因为<code>commit</code>阶段是不能被打断的，所以充分准备有利于<code>commit</code>阶段做更少的工作。</p><p>一旦<code>workInProgress</code>树的所有节点都完成<code>complete</code>，则说明<code>workInProgress</code>树已经构建完成，所有的更新工作已经做完，接下来这棵树会进入<code>commit</code>阶段</p></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/docs/reactCore/createUpdate"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">« 更新流程</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/docs/reactCore/commit"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">commit阶段 »</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_35-E thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#概述" class="table-of-contents__link">概述</a></li><li><a href="#beginwork" class="table-of-contents__link"><code>beginWork</code></a><ul><li><a href="#构建-wip-树" class="table-of-contents__link">构建 <code>wIP</code> 树</a></li><li><a href="#工作循环" class="table-of-contents__link">工作循环</a></li><li><a href="#解析不同类型fiber结点" class="table-of-contents__link">解析不同类型<code>Fiber</code>结点</a></li></ul></li><li><a href="#completework" class="table-of-contents__link"><code>completeWork</code></a><ul><li><a href="#dom节点的创建插入" class="table-of-contents__link">DOM节点的创建插入</a></li><li><a href="#dom属性的处理" class="table-of-contents__link">DOM属性的处理</a></li><li><a href="#effecttag-收集" class="table-of-contents__link"><code>effectTag</code> 收集</a></li></ul></li></ul></div></div></div></div></main></div></div></div>
<script src="/assets/js/runtime~main.7bae2b1a.js"></script>
<script src="/assets/js/main.df3858a9.js"></script>
</body>
</html>