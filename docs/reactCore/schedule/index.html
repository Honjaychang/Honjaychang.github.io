<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.4">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="HonjayChang Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="HonjayChang Blog Atom Feed"><title data-react-helmet="true">任务调度 | HonjayChang</title><meta data-react-helmet="true" property="og:url" content="https://honjaychang.github.io//docs/reactCore/schedule"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="任务调度 | HonjayChang"><meta data-react-helmet="true" name="description" content="调度器在 React 应用程序运行中的主要工作就是负责更新任务的管理，如任务的时间分片，高优先级任务要先于低优先级任务执行等"><meta data-react-helmet="true" property="og:description" content="调度器在 React 应用程序运行中的主要工作就是负责更新任务的管理，如任务的时间分片，高优先级任务要先于低优先级任务执行等"><link data-react-helmet="true" rel="shortcut icon" href="/img/photo.ico"><link data-react-helmet="true" rel="canonical" href="https://honjaychang.github.io//docs/reactCore/schedule"><link data-react-helmet="true" rel="alternate" href="https://honjaychang.github.io//docs/reactCore/schedule" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://honjaychang.github.io//docs/reactCore/schedule" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.6b743985.css">
<link rel="preload" href="/assets/js/runtime~main.b087496d.js" as="script">
<link rel="preload" href="/assets/js/main.9cb9d5d7.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_1oUP">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a href="https://honjaychang.github.io/docs/home" target="_blank" rel="noopener noreferrer" class="navbar__brand"><img src="/img/photo.jpg" alt="My Site Logo" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/img/photo.jpg" alt="My Site Logo" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"></a><a class="navbar__item navbar__link navbar__link--active" href="/docs/Home">Docs</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/Honjaychang" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="react-toggle toggle_3Zt9 react-toggle--disabled"><div class="react-toggle-track" role="button" tabindex="-1"><div class="react-toggle-track-check"><span class="toggle_71bT">🌜</span></div><div class="react-toggle-track-x"><span class="toggle_71bT">🌞</span></div><div class="react-toggle-thumb"></div></div><input type="checkbox" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper doc-page"><div class="docPage_31aa"><button class="clean-btn backToTopButton_35hR" type="button" title="Scroll to top"><svg viewBox="0 0 24 24" width="28"><path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z" fill="currentColor"></path></svg></button><aside class="docSidebarContainer_3Kbt"><div class="sidebar_15mo"><nav class="menu thin-scrollbar menu_Bmed menuWithAnnouncementBar_2WvA"><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/docs/Home">Home</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">HC</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">JS</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Extension</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">TS</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">React</a></li><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#">ReactCore</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/reactCore/basic">一些概念</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/reactCore/ds">数据结构定义</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/reactCore/createUpdate">更新</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active active" tabindex="0" href="/docs/reactCore/schedule">任务调度</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/reactCore/render">render阶段</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/reactCore/diff">diff</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Dev</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Network</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Algo</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Interview</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Vue</a></li></ul></nav><button type="button" title="Collapse sidebar" aria-label="Collapse sidebar" class="button button--secondary button--outline collapseSidebarButton_1CGd"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_3E-R"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></aside><main class="docMainContainer_3ufF"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_3FnS"><div class="docItemContainer_33ec"><article><div class="tocCollapsible_1PrD tocMobile_3Hoh"><button type="button" class="clean-btn tocCollapsibleButton_2O1e">On this page</button></div><div class="markdown"><header><h1 class="h1Heading_27L5">任务调度</h1></header><p>调度器在 <code>React</code> 应用程序运行中的主要工作就是负责更新任务的管理，如任务的时间分片，高优先级任务要先于低优先级任务执行等</p><p><img src="https://cdn.jsdelivr.net/gh/honjaychang/bp/fe/20211002112241.png" alt="image-20211002112241751"></p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="关于更新与任务"></a>关于更新与任务<a class="hash-link" href="#关于更新与任务" title="Direct link to heading">#</a></h2><ul><li>「更新」作用于 <code>React Fiber</code> 结点，它是 <code>Fiber</code> 架构的一部分。</li><li>「任务」作用于任务调度器，是任务体系里面的一部分。</li></ul><p><code>React</code> 中的「任务」是由任务调度器 <code>scheduler </code>统一管理。任务调度器 <code>scheduler </code>是独立于 <code>react</code> 和 <code>react-dom</code> 的模块。<code>React</code> 会使用调度器 <code>scheduler </code>模块暴露出的一些方法安排任务执行。</p><blockquote><p>React 将「更新」内容映射到屏幕的过程就是执行更新任务的过程</p></blockquote><p>任务调度器的基本结构</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly js"><pre tabindex="0" class="prism-code language-js codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// firstTask是任务队列(taskQueue)的入口</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> firstTask </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword null nil" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 第一个被延期执行的任务</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> firstDelayedTask </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword null nil" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// debug时可以暂停调度器的工作</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> isSchedulerPaused </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 当前任务</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> currentTask </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword null nil" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 当前任务的优先级</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> currentPriorityLevel </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token maybe-class-name">NormalPriority</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 将任务加入到任务队列</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">insertScheduledTask</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">newTask</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"> expirationTime</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token spread operator" style="color:#393A34">...</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 从任务队列中取出任务</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">flushTask</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">task</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"> currentTime</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token spread operator" style="color:#393A34">...</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="任务调度器内部的通信原理"></a>任务调度器内部的通信原理<a class="hash-link" href="#任务调度器内部的通信原理" title="Direct link to heading">#</a></h2><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="与浏览器通信"></a>与浏览器通信<a class="hash-link" href="#与浏览器通信" title="Direct link to heading">#</a></h3><ul><li><code>window.requestAnimationFrame(callback)</code> 告诉浏览器——我们希望执行一个动画(帧)，并且要求浏览器在下次重绘之前调用指定的回调函数更新动画。</li></ul><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="调度器内部通信"></a>调度器内部通信<a class="hash-link" href="#调度器内部通信" title="Direct link to heading">#</a></h3><ul><li><code>window.MessageChannel()</code></li></ul><p>一般情况下，<code>onmessage</code> 的回调函数的调用时机是在浏览器的一帧绘制完成之后</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly js"><pre tabindex="0" class="prism-code language-js codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> channel </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">MessageChannel</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> port1 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> channel</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">port1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> port2 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> channel</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">port2</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">port1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method-variable function-variable method function property-access" style="color:#d73a49">onmessage</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">event</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token console class-name">console</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">log</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">event</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">data</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">port2</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">postMessage</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;动画帧执行完成，浏览器有空隙了&#x27;</span><span class="token punctuation" style="color:#393A34">)</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="调度任务流程"></a>调度任务流程<a class="hash-link" href="#调度任务流程" title="Direct link to heading">#</a></h2><p><img src="https://cdn.jsdelivr.net/gh/honjaychang/bp/fe/20211001102009.png" alt="image-20211001102009187"></p><ul><li>任务调度器接收任务，并根据任务的特性分别将其加入到延期队列或者正常任务队列。如果当前没有正在执行的任务，则调用 <code>requestHostCallback</code> 函数准备执行任务。</li><li>在准备执行任务时，会检测浏览器动画帧是否正在执行。如果正处于动画帧之间的时间空隙中，则使用 <code>window.rAF</code> 请求执行 <code>callback</code>。如果浏览器时机成熟，则通过<code>MessageChannel</code>发送消息<code>port.postMessage(null)</code> </li><li><code>MessageChannel</code> 的另一个端口以<code>port1.onmessage</code>的方式监听消息，当收到消息后正式执行 <code>callback</code> (即执行任务)。</li><li>执行<code>callback</code>，实际上是调用<code>flushTask</code>函数从任务队列中取出优先级最高的任务执行。</li></ul><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="执行一个更新任务的流程"></a>执行一个更新任务的流程<a class="hash-link" href="#执行一个更新任务的流程" title="Direct link to heading">#</a></h3><p><img src="https://cdn.jsdelivr.net/gh/honjaychang/bp/fe/20211001102622.png" alt="image-20211001102622629"></p><ul><li><code>Fiber</code> 结点的更新对象 <code>update</code> 中的过期时间<code>expirationTime</code>的计算是根据任务调度器返回的当前任务优先级来确定。确定好过期时间后就可以对该 <code>Fiber</code> 结点的更新任务进行调度</li></ul><ul><li>任务调度器调用 <code>getCurrentPriorityLevel</code>返回 <code>Fiber</code> 结点更新任务的优先级</li><li>当<code>Fiber</code>结点从任务调度器获取到最新的执行权就开始了更新渲染阶段 即<code>render commit</code> 阶段</li></ul><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly js"><pre tabindex="0" class="prism-code language-js codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">unstable_getCurrentPriorityLevel</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">return</span><span class="token plain"> currentPriorityLevel</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// 默认为 NormalPriority = 3 会在调度过程中动态修改</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><ul><li>执行同步任务 -&gt; 修改为 <code>ImmediatePriority</code></li><li>处理交互事件队列时 -&gt; 修改为 <code>UserBlockingPriority</code></li></ul><p>在处理交互事件队列时 <code>React</code> 会通过 <code>runWithPriority()</code> 将<code>currentPriorityLevel</code>的值修改为 <code>UserBlockingPriority</code> </p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="unstable_runwithpriority"></a><code>unstable_runWithPriority</code><a class="hash-link" href="#unstable_runwithpriority" title="Direct link to heading">#</a></h4><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly js"><pre tabindex="0" class="prism-code language-js codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">unstable_runWithPriority</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">priorityLevel</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"> eventHandler</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">switch</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">priorityLevel</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> </span><span class="token maybe-class-name">ImmediatePriority</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> </span><span class="token maybe-class-name">UserBlockingPriority</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> </span><span class="token maybe-class-name">NormalPriority</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> </span><span class="token maybe-class-name">LowPriority</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> </span><span class="token maybe-class-name">IdlePriority</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword control-flow" style="color:#00009f">break</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword module" style="color:#00009f">default</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      priorityLevel </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token maybe-class-name">NormalPriority</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> previousPriorityLevel </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> currentPriorityLevel</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// 修改任务调度器中当前任务的优先级 </span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  currentPriorityLevel </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> priorityLevel</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">try</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 执行回调(任务) </span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword control-flow" style="color:#00009f">return</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">eventHandler</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#00009f">finally</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 还原任务队列中当前任务的优先级 </span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    currentPriorityLevel </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> previousPriorityLevel</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">函数会立即执行传入的回调函数</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">任务</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">eventHandler</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><ul><li><p>更新任务以 <code>callback</code> 的形式向任务调度器申请执行</p></li><li><p>执行一个带有更新处理逻辑的 <code>callback</code>  就是执行更新任务</p></li></ul><p><code>requestWork</code> 是 <code>React</code> 更新任务调度的入口函数，在该函数内部会检查当前的更新任务属于 同步 任务 (需要立即执行)还是 非同步任务</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="总结"></a>总结<a class="hash-link" href="#总结" title="Direct link to heading">#</a></h2><ul><li>首先每个任务都会有各自的优先级，通过当前时间加上优先级所对应的常量我们可以计算出 <code>expriationTime</code>，<strong>高优先级的任务会打断低优先级任务</strong></li><li>在调度之前，判断当前任务<strong>是否过期</strong>，过期的话无须调度，直接调用 <code>port.postMessage(undefined)</code>，这样就能在渲染后马上执行过期任务了</li><li>如果任务没有过期，就通过 <code>requestAnimationFrame</code> 启动定时器，在重绘前调用回调方法</li><li>在回调方法中我们首先需要<strong>计算每一帧的时间以及下一帧的时间</strong>，然后执行 <code>port.postMessage(undefined)</code></li><li><code>channel.port1.onmessage</code> 会在渲染后被调用，在这个过程中我们首先需要去判断<strong>当前时间是否小于下一帧时间</strong>。如果小于的话就代表我们尚有空余时间去执行任务；如果大于的话就代表当前帧已经没有空闲时间了，这时候我们需要去判断是否有任务过期，<strong>过期的话不管三七二十一还是得去执行这个任务</strong>。如果没有过期的话，那就只能把这个任务丢到下一帧看能不能执行了</li></ul><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="schedulework"></a><code>scheduleWork</code><a class="hash-link" href="#schedulework" title="Direct link to heading">#</a></h4><p><code>scheduleWork</code> 主要的事情就是找到我们要处理的 <code>root</code>设置刚才获取到的执行优先级，然后调用 <code>requestWork</code></p><ul><li>调用 <code>scheduleWorkToRoot</code>找到更新对应的 <code>FiberRoot</code>节点。按照树的结构通过<code>fiber.return</code>一层层的返回，直到找到根节点。在向上找的过程中不断的更新每个节点对应的<code>fiber</code>对象的<code>childExpirationTime</code>。并且<code>alternate</code>同步更新。 PS：<code>childExpirationTime</code>子树中最高优先级的<code>expirationTime</code></li><li>存在上一个任务，并且上一个执行没有执行完，执行权交给了浏览器，发现当前更新的优先级高于上一个任务，则调用<code>resetStack</code>重置<code>stack</code></li><li>如果现在不处于<code>render</code>阶段，或者<code>nextRoot !== root</code>，则作为享受vip待遇的任务可以请求调度了：<code>requestWork</code>  PS: 如果正在处于<code>render</code>阶段，我们就不需要请求调度了，因为<code>render</code>阶段会处理掉这个<code>update</code></li></ul><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly js"><pre tabindex="0" class="prism-code language-js codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">scheduleWork</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">fiber</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"> expirationTime</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// 获取fiberRoot结点</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> root </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">scheduleWorkToRoot</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">fiber</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> expirationTime</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 存在高优先级任务打断低优先级任务</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">!</span><span class="token plain">isWorking </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> nextRenderExpirationTime </span><span class="token operator" style="color:#393A34">!==</span><span class="token plain"> </span><span class="token maybe-class-name">NoWork</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> expirationTime </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> nextRenderExpirationTime</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// This is an interruption. (Used for performance tracking.)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    interruptedBy </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> fiber</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">resetStack</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">markPendingPriorityLevel</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">root</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> expirationTime</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// If we&#x27;re in the render phase, we don&#x27;t need to schedule this root</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// for an update, because we&#x27;ll do it before we exit...</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">!</span><span class="token plain">isWorking </span><span class="token operator" style="color:#393A34">||</span><span class="token plain"> isCommitting$</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">||</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// ...unless this is a different root than the one we&#x27;re rendering.</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  nextRoot </span><span class="token operator" style="color:#393A34">!==</span><span class="token plain"> root</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> rootExpirationTime </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> root</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">expirationTime</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">requestWork</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">root</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> rootExpirationTime</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="requestwork"></a><code>requestWork</code><a class="hash-link" href="#requestwork" title="Direct link to heading">#</a></h4><ul><li><p>调用<code>addRootToSchedule</code> 将 <code>Root</code>加入到 <code>Schedule()</code></p><ul><li>如果此 <code>root</code>已经调度过（已经在<code>scheduledRoot</code>的单向链表中），则判断是否要更新<code>root.expirationTime</code></li><li>如果没有调度过则需要将它添加到维护的一条 <code>scheduledRoot</code> 单向链表中</li></ul></li><li><p>判断是否是同步任务？</p><ul><li>同步调用 <code>performSyncWork</code> </li><li>异步调用<code>scheduleCallbackWithExpirationTime</code></li></ul></li></ul><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="schedulecallbackwithexpirationtime"></a><code>scheduleCallbackWithExpirationTime</code><a class="hash-link" href="#schedulecallbackwithexpirationtime" title="Direct link to heading">#</a></h4><ul><li><code>requestIdleCallback</code> 的 <code>polyfill</code> 版本。可以让浏览器空闲时期依次调用函数，这就可以让开发者在主事件循环中执行后台或低优先级的任务，而且不会对像动画和用户交互这样延迟敏感的事件产生影响</li></ul><ul><li><p>如果有一个<code>callback</code>已经在调度<code>callbackExpirationTime !== NoWork </code>的情况下</p><ul><li>如果 <code>expirationTime &lt; callbackExpirationTime</code>，函数直接返回</li><li>如果当前<code>callback</code>时间不够，就调用<code>unstable_cancelCallback</code>取消重新调用</li></ul></li><li><p>计算出 <code>timeout</code> 然后调用 <code>unstable_scheduleCallback(performAsyncWork, {timeout})</code></p></li></ul><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="unstable_schedulecallback"></a><code>unstable_scheduleCallback</code><a class="hash-link" href="#unstable_schedulecallback" title="Direct link to heading">#</a></h4><ul><li>创建一个任务节点<code>newNode</code>，按照优先级插入<code>callback</code>链表</li><li>我们把任务按照过期时间排好顺序了，何时去执行任务呢？两种情况<ul><li>当添加第一个任务节点的时候开始启动任务执行 -&gt; 意味着任务从无到有，应该立刻启动</li><li>当新添加的任务取代之前的节点成为新的第一个节点的时候 -&gt; 意味着来了新的优先级最高的任务，应该停止掉之前要执行的任务，重新从新的任务开始执行</li></ul></li><li>上面两种情况就对应 <code>ensureHostCallbackIsScheduled</code>方法执行的两种情况</li></ul><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="ensurehostcallbackisscheduled"></a><code>ensureHostCallbackIsScheduled</code><a class="hash-link" href="#ensurehostcallbackisscheduled" title="Direct link to heading">#</a></h4><ul><li>判断是否已经存在有<code>host callback</code>，如果已经存在则调用<code>cancelHostCallback()</code>，然后开始<code>requestHostCallback(flushWork, expirationTime)</code>，传入的<code>flushWork</code>就是冲刷任务的函数和队首的任务节点的过期时间。这里我们没有立马执行<code>flushWork</code>，而是交给了<code>requestHostCallback</code>。PS：可以暂时把<code>flushWork</code>简单的想成执行链表中的任务</li></ul><p>浏览器是一帧一帧渲染的，每一帧渲染结束之后会有一些空闲时间可以执行别的任务，为了保证应用的流畅性，我们就利用这点空闲时间来执行我们的任务。<code>react</code>团队利用<code>requestAnimationFrame</code>和<code>MessageChannel</code> 实现了原生<code>api</code> <code>requestIdleCallback</code> 的<code>pollyfill</code>版本</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="requesthostcallback"></a><code>requestHostCallback</code><a class="hash-link" href="#requesthostcallback" title="Direct link to heading">#</a></h4><ul><li>这里有两个全局变量<code>scheduledHostCallback、timeoutTime</code>分别代表第一个任务的<code>callback</code>和过期时间</li><li>进入这个函数就会立马判断一下当前的任务是否过期，如果过期了，不管浏览器是否空闲都得立即执行</li><li>如果任务没有过期，等浏览器有空了再调用<code>requestAnimationFrameWithTimeout(animationTick)</code>来执行</li></ul><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="requestanimationframewithtimeout"></a><code>requestAnimationFrameWithTimeout</code><a class="hash-link" href="#requestanimationframewithtimeout" title="Direct link to heading">#</a></h4><ul><li>这个函数其实可以理解为优化后的<code>requestAnimationFrame</code></li></ul><ul><li>当我们调用<code>requestAnimationFrameWithTimeout</code>并传入一个<code>callback</code>的时候，会启动一个<code>requestAnimationFrame</code>和一个<code>setTimeout</code>，两者都会去执行<code>callback</code>。但由于<code>requestAnimationFrame</code>执行优先级相对较高，它内部会调用<code>clearTimeout</code>取消下面定时器的操作。所以在页面<code>active</code>情况下的表现跟<code>requestAnimationFrame</code>是一致的。</li><li><code>requestAnimationFrame</code>在页面切换到未激活的时候是不工作的，这时<code>requestAnimationFrameWithTimeout</code>就相当于启动了一个100ms的定时器，接管任务的执行工作。这个执行频率不高也不低，既能不影响cpu能耗，又能保证任务能有一定效率的执行。</li></ul><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="animationtick"></a><code>animationTick</code><a class="hash-link" href="#animationtick" title="Direct link to heading">#</a></h4><ul><li>有任务再进行递归请求下一帧，没任务的话可以结束了，退出递归。</li><li>在每一帧的回调函数最后，都会调用<code>port.postMessage(undefined)</code></li></ul><ul><li>在 <code>animationTick</code> 中监听动画帧执行完成，然后发送消息通知</li><li>在 <code>channel.port1.onmessage</code> 执行任务</li><li>动画帧执行完成后，浏览器会有短暂的时间空隙，这时会执行回调函数 <code>animationTick</code> ，在该回调函数内部通过 <code>MessageChannel</code> 的一个接口发送通道消息，在另一个接口处可通过 <code>onmessage</code> 事件监听到消息，然后执行下一个任务。</li></ul><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="messagechannel"></a><code>MessageChannel</code><a class="hash-link" href="#messagechannel" title="Direct link to heading">#</a></h4><ul><li><code>onmessage</code>的回调函数的调用时机是在一帧的<code>paint</code>完成之后，<code>react scheduler</code>内部正是利用了这一点来在一帧渲染结束后的剩余时间来执行任务的</li></ul><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="flushwork"></a><code>flushWork</code><a class="hash-link" href="#flushwork" title="Direct link to heading">#</a></h4><ul><li><code>flushWork</code>根据<code>didTimeout</code>参数来决定处理逻辑<ul><li>如果为<code>true</code> 就会把任务链表里的过期任务全都给执行一遍</li><li>如果为<code>false</code> 则在当前帧到期之前尽可能多的去执行任务</li></ul></li><li>最后，如果还有任务的话，再启动一轮新的任务执行调度，<code>ensureHostCallbackIsScheduled()</code>，来重置<code>callback</code>链表。重置所有的调度常量，老 <code>callback</code> 就不会被执行</li><li>这里的执行任务是调用<code>flushFirstCallback</code>，执行<code>callback</code>中优先级最高的任务</li></ul><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="flushfirstcallback"></a><code>flushFirstCallback</code><a class="hash-link" href="#flushfirstcallback" title="Direct link to heading">#</a></h4><ul><li>这里就是链表操作，执行完<code>firstCallback</code>后把这个<code>callback</code>从链表中删除</li></ul><ul><li>这里调用的是当前任务节点<code>flushedNode.callback</code>，那我们这个<code>callback</code>是啥呢？时间开始倒流，回到<code>scheduleCallbackWithExpirationTime</code>函数<code>unstable_scheduleCallback(performAsyncWork, {timeout})</code>相信大家对这个还有印象，它其实就是我们进入<code>Scheduler.js</code>的入口函数。如果它传入<code>performAsyncWork</code>作为回调函数，也就是在此函数中调用的回调函数就是这个</li></ul><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="performasyncwork"></a><code>performAsyncWork</code><a class="hash-link" href="#performasyncwork" title="Direct link to heading">#</a></h4><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="performwork"></a><code>performWork</code><a class="hash-link" href="#performwork" title="Direct link to heading">#</a></h4><ul><li>如果是同步<code>deadline == null</code>,压根不考虑帧渲染是否有空余时间，同步任务也没有过期时间之说，遍历所有的root，并且把所有root中同步的任务全部执行掉。PS: 有可能存在多个root，即有可能多次调用了ReactDOM.render。</li><li>如果是异步<code>deadline !== null</code>,遍历所有的<code>root</code>，执行完所有<code>root</code>中的过期任务，因为过期任务是必须要执行的。如果这一帧还有空闲时间，尽可能的执行更多任务。</li></ul><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="performworkonroot"></a><code>performWorkOnRoot</code><a class="hash-link" href="#performworkonroot" title="Direct link to heading">#</a></h4></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/docs/reactCore/createUpdate"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">« 更新</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/docs/reactCore/render"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">render阶段 »</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_35-E thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#关于更新与任务" class="table-of-contents__link">关于更新与任务</a></li><li><a href="#任务调度器内部的通信原理" class="table-of-contents__link">任务调度器内部的通信原理</a><ul><li><a href="#与浏览器通信" class="table-of-contents__link">与浏览器通信</a></li><li><a href="#调度器内部通信" class="table-of-contents__link">调度器内部通信</a></li></ul></li><li><a href="#调度任务流程" class="table-of-contents__link">调度任务流程</a><ul><li><a href="#执行一个更新任务的流程" class="table-of-contents__link">执行一个更新任务的流程</a></li></ul></li><li><a href="#总结" class="table-of-contents__link">总结</a></li></ul></div></div></div></div></main></div></div></div>
<script src="/assets/js/runtime~main.b087496d.js"></script>
<script src="/assets/js/main.9cb9d5d7.js"></script>
</body>
</html>