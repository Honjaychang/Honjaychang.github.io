"use strict";(self.webpackChunkmy_test=self.webpackChunkmy_test||[]).push([[8536],{3905:function(e,n,t){t.d(n,{Zo:function(){return c},kt:function(){return u}});var r=t(7294);function i(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function a(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);n&&(r=r.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,r)}return t}function o(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?a(Object(t),!0).forEach((function(n){i(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):a(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function l(e,n){if(null==e)return{};var t,r,i=function(e,n){if(null==e)return{};var t,r,i={},a=Object.keys(e);for(r=0;r<a.length;r++)t=a[r],n.indexOf(t)>=0||(i[t]=e[t]);return i}(e,n);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(r=0;r<a.length;r++)t=a[r],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(i[t]=e[t])}return i}var s=r.createContext({}),p=function(e){var n=r.useContext(s),t=n;return e&&(t="function"==typeof e?e(n):o(o({},n),e)),t},c=function(e){var n=p(e.components);return r.createElement(s.Provider,{value:n},e.children)},d={inlineCode:"code",wrapper:function(e){var n=e.children;return r.createElement(r.Fragment,{},n)}},m=r.forwardRef((function(e,n){var t=e.components,i=e.mdxType,a=e.originalType,s=e.parentName,c=l(e,["components","mdxType","originalType","parentName"]),m=p(t),u=i,k=m["".concat(s,".").concat(u)]||m[u]||d[u]||a;return t?r.createElement(k,o(o({ref:n},c),{},{components:t})):r.createElement(k,o({ref:n},c))}));function u(e,n){var t=arguments,i=n&&n.mdxType;if("string"==typeof e||i){var a=t.length,o=new Array(a);o[0]=m;var l={};for(var s in n)hasOwnProperty.call(n,s)&&(l[s]=n[s]);l.originalType=e,l.mdxType="string"==typeof e?e:i,o[1]=l;for(var p=2;p<a;p++)o[p]=t[p];return r.createElement.apply(null,o)}return r.createElement.apply(null,t)}m.displayName="MDXCreateElement"},6331:function(e,n,t){t.r(n),t.d(n,{frontMatter:function(){return l},contentTitle:function(){return s},metadata:function(){return p},toc:function(){return c},default:function(){return m}});var r=t(7462),i=t(3366),a=(t(7294),t(3905)),o=["components"],l={},s="\u4e00\u4e9b\u6982\u5ff5",p={unversionedId:"reactCore/basic",id:"reactCore/basic",isDocsHomePage:!1,title:"\u4e00\u4e9b\u6982\u5ff5",description:"\u597d\u6587\u529b\u8350",source:"@site/docs/reactCore/basic.md",sourceDirName:"reactCore",slug:"/reactCore/basic",permalink:"/docs/reactCore/basic",version:"current",frontMatter:{},sidebar:"docs",previous:{title:"Hooks",permalink:"/docs/react/hooks"},next:{title:"\u6570\u636e\u7ed3\u6784\u5b9a\u4e49",permalink:"/docs/reactCore/ds"}},c=[{value:"\u804a\u804a\u751f\u547d\u5468\u671f",id:"\u804a\u804a\u751f\u547d\u5468\u671f",children:[]},{value:"<code>setState</code> \u540c\u6b65\u5f02\u6b65?",id:"setstate-\u540c\u6b65\u5f02\u6b65",children:[]},{value:"React \u7406\u5ff5",id:"react-\u7406\u5ff5",children:[{value:"CPU\u7684\u74f6\u9888",id:"cpu\u7684\u74f6\u9888",children:[]},{value:"IO\u7684\u74f6\u9888",id:"io\u7684\u74f6\u9888",children:[]}]},{value:"React15\u67b6\u6784",id:"react15\u67b6\u6784",children:[{value:"<code>Reconciler</code>",id:"reconciler",children:[]},{value:"<code>Renderer</code>",id:"renderer",children:[]},{value:"\u7f3a\u70b9",id:"\u7f3a\u70b9",children:[]}]},{value:"React16\u67b6\u6784",id:"react16\u67b6\u6784",children:[{value:"<code>Scheduler</code>",id:"scheduler",children:[]},{value:"<code>Reconciler</code>",id:"reconciler-1",children:[]},{value:"<code>Renderer</code>",id:"renderer-1",children:[]},{value:"<code>render</code>\u548c<code>commit</code>\u9636\u6bb5",id:"render\u548ccommit\u9636\u6bb5",children:[]}]},{value:"Fiber\u67b6\u6784",id:"fiber\u67b6\u6784",children:[{value:"\u5f03\u7528<code>generate</code>\u539f\u56e0",id:"\u5f03\u7528generate\u539f\u56e0",children:[]},{value:"<code>Fiber</code>\u7684\u542b\u4e49",id:"fiber\u7684\u542b\u4e49",children:[]}]},{value:"<code>JSX Fiber</code>",id:"jsx-fiber",children:[]},{value:"<code>render</code>\u9636\u6bb5",id:"render\u9636\u6bb5",children:[{value:"\u9012 <code>beginWork</code>",id:"\u9012-beginwork",children:[]},{value:"\u5f52  <code>completeWork</code>",id:"\u5f52--completework",children:[]}]},{value:"<code>commit</code>\u9636\u6bb5",id:"commit\u9636\u6bb5",children:[]},{value:"\u6d4f\u89c8\u5668\u7684\u4e00\u5e27",id:"\u6d4f\u89c8\u5668\u7684\u4e00\u5e27",children:[]},{value:"\u8c03\u5ea6",id:"\u8c03\u5ea6",children:[]},{value:"\u5806\u780c",id:"\u5806\u780c",children:[]},{value:"commit\u9636\u6bb5",id:"commit\u9636\u6bb5-1",children:[]}],d={toc:c};function m(e){var n=e.components,t=(0,i.Z)(e,o);return(0,a.kt)("wrapper",(0,r.Z)({},d,t,{components:n,mdxType:"MDXLayout"}),(0,a.kt)("h1",{id:"\u4e00\u4e9b\u6982\u5ff5"},"\u4e00\u4e9b\u6982\u5ff5"),(0,a.kt)("div",{className:"admonition admonition-note alert alert--secondary"},(0,a.kt)("div",{parentName:"div",className:"admonition-heading"},(0,a.kt)("h5",{parentName:"div"},(0,a.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,a.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,a.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"}))),"Ref")),(0,a.kt)("div",{parentName:"div",className:"admonition-content"},(0,a.kt)("p",{parentName:"div"},"\u597d\u6587\u529b\u8350"),(0,a.kt)("ul",{parentName:"div"},(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"https://react.iamkasong.com/"},"React\u6280\u672f\u63ed\u79d8"))),(0,a.kt)("ul",{parentName:"div"},(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"https://blog.shenfq.com/2020/react-%E6%9E%B6%E6%9E%84%E7%9A%84%E6%BC%94%E5%8F%98-%E4%BB%8E%E5%90%8C%E6%AD%A5%E5%88%B0%E5%BC%82%E6%AD%A5/"},"React \u67b6\u6784\u7684\u6f14\u53d8 - \u4ece\u540c\u6b65\u5230\u5f02\u6b65")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"https://blog.shenfq.com/2020/react-%E6%9E%B6%E6%9E%84%E7%9A%84%E6%BC%94%E5%8F%98-%E4%BB%8E%E9%80%92%E5%BD%92%E5%88%B0%E5%BE%AA%E7%8E%AF/"},"React \u67b6\u6784\u7684\u6f14\u53d8 - \u4ece\u9012\u5f52\u5230\u5faa\u73af")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"https://blog.shenfq.com/2020/react-%E6%9E%B6%E6%9E%84%E7%9A%84%E6%BC%94%E5%8F%98-%E6%9B%B4%E6%96%B0%E6%9C%BA%E5%88%B6/"},"React \u67b6\u6784\u7684\u6f14\u53d8 - \u66f4\u65b0\u673a\u5236")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"https://blog.shenfq.com/posts/2020/React%20%E6%9E%B6%E6%9E%84%E7%9A%84%E6%BC%94%E5%8F%98%20-%20Hooks%20%E7%9A%84%E5%AE%9E%E7%8E%B0.html"},"React \u67b6\u6784\u7684\u6f14\u53d8 - Hooks \u7684\u5b9e\u73b0"))),(0,a.kt)("ul",{parentName:"div"},(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"https://segmentfault.com/a/1190000020736966"},"React16\u6e90\u7801\u89e3\u6790(\u4e00)- \u56fe\u89e3Fiber\u67b6\u6784")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"https://segmentfault.com/a/1190000020736982"},"React16\u6e90\u7801\u89e3\u6790(\u4e8c)-\u521b\u5efa\u66f4\u65b0")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"https://segmentfault.com/a/1190000020736992"},"React16\u6e90\u7801\u89e3\u6790(\u4e09)-ExpirationTime")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"https://segmentfault.com/a/1190000020737020"},"React16\u6e90\u7801\u89e3\u6790(\u56db)-Scheduler")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"https://segmentfault.com/a/1190000020737050"},"React16\u6e90\u7801\u89e3\u6790(\u4e94)-\u66f4\u65b0\u6d41\u7a0b\u6e32\u67d3\u9636\u6bb51")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"https://segmentfault.com/a/1190000020737054"},"React16\u6e90\u7801\u89e3\u6790(\u516d)-\u66f4\u65b0\u6d41\u7a0b\u6e32\u67d3\u9636\u6bb52")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"https://segmentfault.com/a/1190000020737059"},"React16\u6e90\u7801\u89e3\u6790(\u4e03)-\u66f4\u65b0\u6d41\u7a0b\u6e32\u67d3\u9636\u6bb53")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"https://segmentfault.com/a/1190000020737069"},"React16\u6e90\u7801\u89e3\u6790(\u516b)-\u66f4\u65b0\u6d41\u7a0b\u63d0\u4ea4\u9636\u6bb5"))),(0,a.kt)("ul",{parentName:"div"},(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"https://github.com/neroneroffy/react-source-code-debug"},"neroneroffy React\u6e90\u7801\u89e3\u6790\u7cfb\u5217\u6587\u7ae0"))),(0,a.kt)("ul",{parentName:"div"},(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"https://github.com/crazylxr/blog/issues/13"},"\u6d45\u8c08 Fiber \u67b6\u6784\u539f\u7406")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"https://github.com/crazylxr/blog/issues/14"},"\u6839\u636e React \u5386\u53f2\u6765\u804a\u5982\u4f55\u7406\u89e3\u865a\u62df DOM")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"https://github.com/crazylxr/blog/issues/15"},"\u5982\u4f55\u5bf9 React \u51fd\u6570\u5f0f\u7ec4\u4ef6\u8fdb\u884c\u4f18\u5316")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"https://github.com/crazylxr/blog/issues/16"},"\u4ece 0 \u5f00\u59cb\u5b9e\u73b0\u4e00\u4e2a fiber \u67b6\u6784\u7684 React(\u4e00)--\u521d\u6b21\u6e32\u67d3"))),(0,a.kt)("ul",{parentName:"div"},(0,a.kt)("li",{parentName:"ul"},"React\u7684\u5386\u53f2 - ",(0,a.kt)("a",{parentName:"li",href:"https://segmentfault.com/a/1190000013365426"},"React \u662f\u600e\u6837\u70bc\u6210\u7684"))))),(0,a.kt)("blockquote",null,(0,a.kt)("p",{parentName:"blockquote"}," \u5185\u5bb9\u5806\u653e\u5904  \u672a\u6574\u7406")),(0,a.kt)("blockquote",null,(0,a.kt)("p",{parentName:"blockquote"},"Children \u5148\u6b20\u7740 experationTime")),(0,a.kt)("p",null,(0,a.kt)("inlineCode",{parentName:"p"},"enableSchedulerTracing")," \u5206\u652f\u5185\u5bb9\uff0c\u6709\u5173 React DevTools"),(0,a.kt)("h2",{id:"\u804a\u804a\u751f\u547d\u5468\u671f"},"\u804a\u804a\u751f\u547d\u5468\u671f"),(0,a.kt)("p",null,(0,a.kt)("inlineCode",{parentName:"p"},"UI = fn(state)"),"  "),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"state")," \u8d1f\u8d23\u8ba1\u7b97\u51fa\u72b6\u6001\u7684\u53d8\u5316",(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"reconciler")," \u6b64\u9636\u6bb5 \u4f1a\u6267\u884c ",(0,a.kt)("inlineCode",{parentName:"li"},"reconcile")," \u7b97\u6cd5 -> ",(0,a.kt)("inlineCode",{parentName:"li"},"diff"),"\u7b97\u6cd5"))),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"fn"),"  \u8d1f\u8d23\u5c06 \u72b6\u6001\u53d8\u5316 \u6e32\u67d3\u5728 \u89c6\u56fe \u4e2d  ",(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"renderer")," \u6e32\u67d3\u5668")))),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"\u8c03\u7528\u6d41\u7a0b"),": ",(0,a.kt)("inlineCode",{parentName:"p"},"this.setState")," -> ",(0,a.kt)("inlineCode",{parentName:"p"},"render"),"\u9636\u6bb5\uff08\u8c03\u7528",(0,a.kt)("inlineCode",{parentName:"p"},"reconcile"),"\u7b97\u6cd5\u8ba1\u7b97\u51fa\u72b6\u6001\u53d8\u5316\uff09 ->  ",(0,a.kt)("inlineCode",{parentName:"p"},"commit"),"\u9636\u6bb5(\u6e32\u67d3\u5668\u9636\u6bb5)"),(0,a.kt)("blockquote",null,(0,a.kt)("p",{parentName:"blockquote"},"\u9996\u5c4f\u6e32\u67d3")),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"\u8c03\u7528",(0,a.kt)("inlineCode",{parentName:"li"},"ReactDOM.render")),(0,a.kt)("li",{parentName:"ul"},"\u8fdb\u5165",(0,a.kt)("inlineCode",{parentName:"li"},"Render"),"\u9636\u6bb5",(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},"\u91c7\u7528 ",(0,a.kt)("inlineCode",{parentName:"li"},"\u6df1\u5ea6\u4f18\u5148\u904d\u5386")," \u521b\u5efa ",(0,a.kt)("inlineCode",{parentName:"li"},"fiber")," \u6811 \u5e76\u6267\u884c\u5bf9\u5e94\u7684\u751f\u547d\u5468\u671f\u51fd\u6570"))),(0,a.kt)("li",{parentName:"ul"},"\u8fdb\u5165",(0,a.kt)("inlineCode",{parentName:"li"},"commit"),"\u9636\u6bb5\uff08\u540e\u5e8f\uff1f\uff09",(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},"\u9996\u5148\u5c06\u6574\u9897",(0,a.kt)("inlineCode",{parentName:"li"},"fiber"),"\u6811\u7684\u5bf9\u5e94\u7684DOM\u6e32\u67d3\u5230\u89c6\u56fe\u4e2d"),(0,a.kt)("li",{parentName:"ul"},"\u6e32\u67d3\u5b8c\u6210\u540e \u4f1a\u4ece\u5b50\u8282\u70b9\u5f00\u59cb\u6267\u884c\u5bf9\u5e94\u7684\u751f\u547d\u5468\u671f\u51fd\u6570")))),(0,a.kt)("blockquote",null,(0,a.kt)("p",{parentName:"blockquote"},"\u66f4\u65b0\u6e32\u67d3")),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"\u8c03\u7528 ",(0,a.kt)("inlineCode",{parentName:"li"},"this.setState")),(0,a.kt)("li",{parentName:"ul"},"\u8fdb\u5165",(0,a.kt)("inlineCode",{parentName:"li"},"Render"),"\u9636\u6bb5",(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},"\u91c7\u7528 \u6df1\u5ea6\u4f18\u5148\u904d\u5386 \u521b\u5efa ",(0,a.kt)("inlineCode",{parentName:"li"},"fiber"),"\u6811\uff08\u6240\u4ee5\u8c03\u7528",(0,a.kt)("inlineCode",{parentName:"li"},"this.setState"),"\u4f1a\u521b\u5efa\u4e00\u9897\u65b0\u7684\u5b8c\u6574\u7684",(0,a.kt)("inlineCode",{parentName:"li"},"fiber"),"\u6811\uff0c\u4f46\u662f\u8282\u70b9\u6ca1\u6709\u66f4\u65b0\u4e0d\u4f1a\u518d\u6b21\u8c03\u7528\u751f\u547d\u5468\u671f\u51fd\u6570"),(0,a.kt)("li",{parentName:"ul"},"\u904d\u5386\u521b\u5efa\u7684\u8fc7\u7a0b\u4e2d \u4f1a\u8c03\u7528",(0,a.kt)("inlineCode",{parentName:"li"},"reconcile"),"\u7b97\u6cd5\u6807\u8bb0 \u53d8\u5316 \uff08\u5e76\u8c03\u7528\u8282\u70b9\u7684\u751f\u547d\u5468\u671f\u51fd\u6570"))),(0,a.kt)("li",{parentName:"ul"},"\u8fdb\u5165",(0,a.kt)("inlineCode",{parentName:"li"},"commit")," \u9636\u6bb5\uff08\u540e\u5e8f\uff1f\uff09"),(0,a.kt)("li",{parentName:"ul"},"\u6267\u884c \u53d8\u5316 \u5bf9\u5e94\u7684\u89c6\u56fe\u64cd\u4f5c")),(0,a.kt)("h2",{id:"setstate-\u540c\u6b65\u5f02\u6b65"},(0,a.kt)("inlineCode",{parentName:"h2"},"setState")," \u540c\u6b65\u5f02\u6b65?"),(0,a.kt)("div",{className:"admonition admonition-note alert alert--secondary"},(0,a.kt)("div",{parentName:"div",className:"admonition-heading"},(0,a.kt)("h5",{parentName:"div"},(0,a.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,a.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,a.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"}))),"Ref")),(0,a.kt)("div",{parentName:"div",className:"admonition-content"},(0,a.kt)("p",{parentName:"div"},"\u4e24\u7bc7\u601d\u8def\u4e00\u81f4\uff0c\u540e\u8005\u8fd8\u5206\u6790\u4e86 ",(0,a.kt)("inlineCode",{parentName:"p"},"concurrent")," \u6a21\u5f0f"),(0,a.kt)("ul",{parentName:"div"},(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"https://jishuin.proginn.com/p/763bfbd5e4cd"},"setState \u5230\u5e95\u662f\u540c\u6b65\u7684\uff0c\u8fd8\u662f\u5f02\u6b65\u7684")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"https://blog.shenfq.com/posts/2020/React%20%E6%9E%B6%E6%9E%84%E7%9A%84%E6%BC%94%E5%8F%98%20-%20%E4%BB%8E%E5%90%8C%E6%AD%A5%E5%88%B0%E5%BC%82%E6%AD%A5.html"},"React \u67b6\u6784\u7684\u6f14\u53d8 - \u4ece\u540c\u6b65\u5230\u5f02\u6b65"))))),(0,a.kt)("p",null,"\u5728\u4e00\u6bb5\u4ee3\u7801\u4e2d\u8fde\u7eed\u4f7f\u7528\u591a\u4e2a \u540c\u6b65  ",(0,a.kt)("inlineCode",{parentName:"p"},"setState(...)")," \u64cd\u4f5c\uff0c",(0,a.kt)("inlineCode",{parentName:"p"},"React")," \u4f1a\u5c06\u5b83\u4eec\u7684\u66f4\u65b0",(0,a.kt)("inlineCode",{parentName:"p"},"update")," \u5148\u540e\u4f9d\u6b21\u52a0\u5165\u5230\u66f4\u65b0\u961f\u5217 ",(0,a.kt)("inlineCode",{parentName:"p"},"updateQueue"),"\uff0c\u5728\u5e94\u7528\u7a0b\u5e8f\u7684 ",(0,a.kt)("inlineCode",{parentName:"p"},"render")," \u9636\u6bb5\u5904\u7406\u66f4\u65b0\u961f\u5217\u65f6\u4f1a\u5c06\u961f\u5217\u4e2d\u7684\u6240\u6709\u66f4\u65b0\u5408\u5e76\u6210\u4e00\u4e2a\uff0c\u5408\u5e76\u539f\u5219\u662f\u76f8\u540c\u5c5e\u6027\u7684\u66f4\u65b0\u53d6\u6700\u540e\u4e00\u6b21\u7684\u503c\u3002"),(0,a.kt)("p",null,"\u5982\u679c\u6709\u5f02\u6b65 ",(0,a.kt)("inlineCode",{parentName:"p"},"setState(...)")," \u64cd\u4f5c\uff0c\u5219\u5148\u8fdb\u884c\u540c\u6b65\u66f4\u65b0\uff0c\u5f02\u6b65\u66f4\u65b0\u5219\u9075\u5faa",(0,a.kt)("inlineCode",{parentName:"p"},"EventLoop"),"\u539f\u7406\u540e\u7eed\u5904\u7406\u3002"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-js"},"state = { text: '', count: 0 };\n\n// \u540c\u6b65\u66f4\u65b0\nhandleClick = () => {\n  this.setState({ count: this.state.count + 1 });\n  this.setState({ text: 'Click times ' + this.state.count });\n};\n// Click times \u4f1a\u6bd4\u5c55\u793a\u7684\u4f1a\u6bd4 count \u5c111  --\x3e Click times 4 : 5\n\n// \u5f02\u6b65\u66f4\u65b0\nhandleClick = () => {\n  this.setState({ count: this.state.count + 1 });\n  setTimeout(() => {\n    this.setState({ text: 'Click times ' + this.state.count });\n  }, 500);\n};\n// \u5148count -> 1  \u518d\u5ef6\u8fdf500 Click times 1\n")),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"\u5728 ",(0,a.kt)("inlineCode",{parentName:"li"},"legacy")," \u6a21\u5f0f\u4e0b\uff0c\u6b63\u5e38\u4f1a\u89e6\u53d1 ",(0,a.kt)("inlineCode",{parentName:"li"},"batchedUpdate")," \u5448\u73b0\u5f02\u6b65\u7684\u611f\u89c9",(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"ReactDOM.render(<App />, rootNode)")),(0,a.kt)("li",{parentName:"ul"},"\u591a\u4e2a ",(0,a.kt)("inlineCode",{parentName:"li"},"setState()")," \u4f1a\u89e6\u53d1React\u7684\u6027\u80fd\u4f18\u5316 \u53ea\u8ba1\u7b97\u6700\u540e\u4e00\u6b21"),(0,a.kt)("li",{parentName:"ul"},"\u4e0d\u5728React\u4e0a\u4e0b\u6587 \u5982 ",(0,a.kt)("inlineCode",{parentName:"li"},"setTimeout")," \u5219\u8868\u73b0\u540c\u6b65",(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},"\u591a\u4e2a ",(0,a.kt)("inlineCode",{parentName:"li"},"setState()")," \u4f1a\u6309\u987a\u5e8f\u4f9d\u6b21\u6267\u884c"))))),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"concurrent")," \u6a21\u5f0f \u90fd\u5448\u73b0\u5f02\u6b65",(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"ReactDOM.createRoot(rootNode).render(<App />)")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"concurrent")," \u6a21\u5f0f\u4e0b\u5728 ",(0,a.kt)("inlineCode",{parentName:"li"},"setTimeout")," \u91cc\u9762\u7684\u591a\u4e2a ",(0,a.kt)("inlineCode",{parentName:"li"},"setState")," \u4e5f\u4f1a\u53ea\u6267\u884c\u6700\u540e\u4e00\u4e2a"),(0,a.kt)("li",{parentName:"ul"},"\u8bf4\u660e\u5728 ",(0,a.kt)("inlineCode",{parentName:"li"},"concurrent")," \u6a21\u5f0f\u4e0b\uff0c\u5373\u4f7f\u8131\u79bb\u4e86 ",(0,a.kt)("inlineCode",{parentName:"li"},"React")," \u7684\u751f\u547d\u5468\u671f\uff0c",(0,a.kt)("inlineCode",{parentName:"li"},"setState")," \u4f9d\u65e7\u80fd\u591f\u5408\u5e76\u66f4\u65b0\u3002\u4e3b\u8981\u539f\u56e0\u662f ",(0,a.kt)("inlineCode",{parentName:"li"},"concurrent")," \u6a21\u5f0f\u4e0b\uff0c\u771f\u6b63\u7684\u66f4\u65b0\u64cd\u4f5c\u88ab\u79fb\u5230\u4e86\u4e0b\u4e00\u4e2a\u4e8b\u4ef6\u961f\u5217\u4e2d\uff0c\u7c7b\u4f3c\u4e8e ",(0,a.kt)("inlineCode",{parentName:"li"},"Vue")," \u7684 ",(0,a.kt)("inlineCode",{parentName:"li"},"nextTick"),"\u3002"))),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"setState")," \u662f\u4e00\u6b21\u540c\u6b65\u64cd\u4f5c\uff0c\u53ea\u662f\u6bcf\u6b21\u64cd\u4f5c\u4e4b\u540e\u5e76\u6ca1\u6709\u7acb\u5373\u6267\u884c\uff0c\u800c\u662f\u5c06 ",(0,a.kt)("inlineCode",{parentName:"li"},"setState")," \u8fdb\u884c\u4e86\u7f13\u5b58\uff0c",(0,a.kt)("inlineCode",{parentName:"li"},"mount")," \u6d41\u7a0b\u7ed3\u675f\u6216\u4e8b\u4ef6\u64cd\u4f5c\u7ed3\u675f\uff0c\u624d\u4f1a\u62ff\u51fa\u6240\u6709\u7684 ",(0,a.kt)("inlineCode",{parentName:"li"},"state")," \u8fdb\u884c\u4e00\u6b21\u8ba1\u7b97\u3002\u5982\u679c ",(0,a.kt)("inlineCode",{parentName:"li"},"setState")," \u8131\u79bb\u4e86 ",(0,a.kt)("inlineCode",{parentName:"li"},"React")," \u7684\u751f\u547d\u5468\u671f\u6216\u8005 ",(0,a.kt)("inlineCode",{parentName:"li"},"React")," \u63d0\u4f9b\u7684\u4e8b\u4ef6\u6d41\uff0c",(0,a.kt)("inlineCode",{parentName:"li"},"setState")," \u4e4b\u540e\u5c31\u80fd\u7acb\u5373\u62ff\u5230\u7ed3\u679c\u3002"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"this.setState()"),"\u662f\u5426\u5f02\u6b65\uff0c\u770b ",(0,a.kt)("inlineCode",{parentName:"li"},"isBatchingUpdates")," \u7684\u72b6\u6001\uff0c\u4e3a ",(0,a.kt)("inlineCode",{parentName:"li"},"true")," \u5c31\u662f\u5f02\u6b65\uff0c\u4e3a ",(0,a.kt)("inlineCode",{parentName:"li"},"false")," \u5c31\u662f\u540c\u6b65")),(0,a.kt)("h2",{id:"react-\u7406\u5ff5"},"React \u7406\u5ff5"),(0,a.kt)("p",null,"React \u662f\u7528 JavaScript \u6784\u5efa",(0,a.kt)("strong",{parentName:"p"},"\u5feb\u901f\u54cd\u5e94"),"\u7684\u5927\u578b Web \u5e94\u7528\u7a0b\u5e8f\u7684\u9996\u9009\u65b9\u5f0f"),(0,a.kt)("blockquote",null,(0,a.kt)("p",{parentName:"blockquote"},"\u5feb\u901f\u54cd\u5e94")),(0,a.kt)("h3",{id:"cpu\u7684\u74f6\u9888"},"CPU\u7684\u74f6\u9888"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"\u5f53\u9047\u5230\u5927\u8ba1\u7b97\u91cf\u7684\u64cd\u4f5c\u6216\u8005\u8bbe\u5907\u6027\u80fd\u4e0d\u8db3\u4f7f\u9875\u9762\u6389\u5e27\uff0c\u5bfc\u81f4\u5361\u987f\u3002")),(0,a.kt)("p",null,"\u5f53JS\u6267\u884c\u65f6\u95f4\u8fc7\u957f\uff0c\u8d85\u51fa\u4e8616.6ms\uff0c\u8fd9\u6b21\u5237\u65b0\u5c31\u6ca1\u6709\u65f6\u95f4\u6267\u884c",(0,a.kt)("strong",{parentName:"p"},"\u6837\u5f0f\u5e03\u5c40"),"\u548c",(0,a.kt)("strong",{parentName:"p"},"\u6837\u5f0f\u7ed8\u5236"),"\u4e86\u3002"),(0,a.kt)("p",null,"\u5728\u6d4f\u89c8\u5668\u6bcf\u4e00\u5e27\u7684\u65f6\u95f4\u4e2d\uff0c\u9884\u7559\u4e00\u4e9b\u65f6\u95f4\u7ed9JS\u7ebf\u7a0b\uff0c",(0,a.kt)("inlineCode",{parentName:"p"},"React"),"\u5229\u7528\u8fd9\u90e8\u5206\u65f6\u95f4\u66f4\u65b0\u7ec4\u4ef6\u3002"),(0,a.kt)("p",null,"\u5f53\u9884\u7559\u7684\u65f6\u95f4\u4e0d\u591f\u7528\u65f6\uff0c",(0,a.kt)("inlineCode",{parentName:"p"},"React"),"\u5c06\u7ebf\u7a0b\u63a7\u5236\u6743\u4ea4\u8fd8\u7ed9\u6d4f\u89c8\u5668\u4f7f\u5176\u6709\u65f6\u95f4\u6e32\u67d3UI\uff0c",(0,a.kt)("inlineCode",{parentName:"p"},"React"),"\u5219\u7b49\u5f85\u4e0b\u4e00\u5e27\u65f6\u95f4\u5230\u6765\u7ee7\u7eed\u88ab\u4e2d\u65ad\u7684\u5de5\u4f5c\u3002\uff08\u4e00\u76f4\u5403\u4e0d\u5230 \u5219\u6709timeout\uff09"),(0,a.kt)("p",null,"\u8fd9\u79cd\u5c06\u957f\u4efb\u52a1\u5206\u62c6\u5230\u6bcf\u4e00\u5e27\u4e2d\uff0c\u50cf\u8682\u8681\u642c\u5bb6\u4e00\u6837\u4e00\u6b21\u6267\u884c\u4e00\u5c0f\u6bb5\u4efb\u52a1\u7684\u64cd\u4f5c\uff0c\u88ab\u79f0\u4e3a",(0,a.kt)("inlineCode",{parentName:"p"},"\u65f6\u95f4\u5207\u7247"),"\uff08time slice\uff09"),(0,a.kt)("p",null,"\u89e3\u51b3",(0,a.kt)("inlineCode",{parentName:"p"},"CPU\u74f6\u9888"),"\u7684\u5173\u952e\u662f\u5b9e\u73b0",(0,a.kt)("inlineCode",{parentName:"p"},"\u65f6\u95f4\u5207\u7247"),"\uff0c\u800c",(0,a.kt)("inlineCode",{parentName:"p"},"\u65f6\u95f4\u5207\u7247"),"\u7684\u5173\u952e\u662f\uff1a\u5c06",(0,a.kt)("strong",{parentName:"p"},"\u540c\u6b65\u7684\u66f4\u65b0"),"\u53d8\u4e3a",(0,a.kt)("strong",{parentName:"p"},"\u53ef\u4e2d\u65ad\u7684\u5f02\u6b65\u66f4\u65b0"),"\u3002"),(0,a.kt)("h3",{id:"io\u7684\u74f6\u9888"},"IO\u7684\u74f6\u9888"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"\u53d1\u9001\u7f51\u7edc\u8bf7\u6c42\u540e\uff0c\u7531\u4e8e\u9700\u8981\u7b49\u5f85\u6570\u636e\u8fd4\u56de\u624d\u80fd\u8fdb\u4e00\u6b65\u64cd\u4f5c\u5bfc\u81f4\u4e0d\u80fd\u5feb\u901f\u54cd\u5e94\u3002")),(0,a.kt)("p",null,(0,a.kt)("inlineCode",{parentName:"p"},"\u7f51\u7edc\u5ef6\u8fdf"),"\u662f\u524d\u7aef\u5f00\u53d1\u8005\u65e0\u6cd5\u89e3\u51b3\u7684\u3002\u5982\u4f55\u5728",(0,a.kt)("inlineCode",{parentName:"p"},"\u7f51\u7edc\u5ef6\u8fdf"),"\u5ba2\u89c2\u5b58\u5728\u7684\u60c5\u51b5\u4e0b\uff0c\u51cf\u5c11\u7528\u6237\u5bf9",(0,a.kt)("inlineCode",{parentName:"p"},"\u7f51\u7edc\u5ef6\u8fdf"),"\u7684\u611f\u77e5\uff1f"),(0,a.kt)("p",null,(0,a.kt)("inlineCode",{parentName:"p"},"React"),"\u7ed9\u51fa\u7684\u7b54\u6848\u662f",(0,a.kt)("a",{parentName:"p",href:"https://zh-hans.reactjs.org/docs/concurrent-mode-intro.html#putting-research-into-production"},"\u5c06\u4eba\u673a\u4ea4\u4e92\u7814\u7a76\u7684\u7ed3\u679c\u6574\u5408\u5230\u771f\u5b9e\u7684 UI \u4e2d")),(0,a.kt)("p",null,(0,a.kt)("inlineCode",{parentName:"p"},"React"),"\u5b9e\u73b0\u4e86",(0,a.kt)("a",{parentName:"p",href:"https://zh-hans.reactjs.org/docs/concurrent-mode-suspense.html"},"Suspense"),"\u529f\u80fd\u53ca\u914d\u5957\u7684",(0,a.kt)("inlineCode",{parentName:"p"},"hook"),"\u2014\u2014",(0,a.kt)("a",{parentName:"p",href:"https://zh-hans.reactjs.org/docs/concurrent-mode-reference.html#usedeferredvalue"},"useDeferredValue")),(0,a.kt)("p",null,(0,a.kt)("inlineCode",{parentName:"p"},"React"),"\u4e3a\u4e86\u8df5\u884c\u201c\u6784\u5efa",(0,a.kt)("strong",{parentName:"p"},"\u5feb\u901f\u54cd\u5e94"),"\u7684\u5927\u578b Web \u5e94\u7528\u7a0b\u5e8f\u201d\u7406\u5ff5\u505a\u51fa\u7684\u52aa\u529b\u3002"),(0,a.kt)("p",null,"\u5176\u4e2d\u7684\u5173\u952e\u662f\u89e3\u51b3CPU\u7684\u74f6\u9888\u4e0eIO\u7684\u74f6\u9888\u3002\u800c\u843d\u5b9e\u5230\u5b9e\u73b0\u4e0a\uff0c\u5219\u9700\u8981\u5c06",(0,a.kt)("strong",{parentName:"p"},"\u540c\u6b65\u7684\u66f4\u65b0"),"\u53d8\u4e3a",(0,a.kt)("strong",{parentName:"p"},"\u53ef\u4e2d\u65ad\u7684\u5f02\u6b65\u66f4\u65b0"),"\u3002"),(0,a.kt)("h2",{id:"react15\u67b6\u6784"},"React15\u67b6\u6784"),(0,a.kt)("p",null,"\u53ef\u4ee5\u5206\u4e3a\u4e24\u5c42\uff1a"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"Reconciler"),"\uff08\u534f\u8c03\u5668\uff09\u2014\u2014 \u8d1f\u8d23\u627e\u51fa\u53d8\u5316\u7684\u7ec4\u4ef6"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"Renderer"),"\uff08\u6e32\u67d3\u5668\uff09\u2014\u2014 \u8d1f\u8d23\u5c06\u53d8\u5316\u7684\u7ec4\u4ef6\u6e32\u67d3\u5230\u9875\u9762\u4e0a")),(0,a.kt)("h3",{id:"reconciler"},(0,a.kt)("inlineCode",{parentName:"h3"},"Reconciler")),(0,a.kt)("p",null,"\u6bcf\u5f53\u6709\u66f4\u65b0\u53d1\u751f\u65f6\uff0c",(0,a.kt)("inlineCode",{parentName:"p"},"Reconciler"),"\u4f1a\u505a\u5982\u4e0b\u5de5\u4f5c\uff1a"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"\u8c03\u7528\u51fd\u6570\u7ec4\u4ef6\u3001\u6216class\u7ec4\u4ef6\u7684",(0,a.kt)("inlineCode",{parentName:"li"},"render"),"\u65b9\u6cd5\uff0c\u5c06\u8fd4\u56de\u7684JSX\u8f6c\u5316\u4e3a\u865a\u62dfDOM"),(0,a.kt)("li",{parentName:"ul"},"\u5c06\u865a\u62dfDOM\u548c\u4e0a\u6b21\u66f4\u65b0\u65f6\u7684\u865a\u62dfDOM\u5bf9\u6bd4"),(0,a.kt)("li",{parentName:"ul"},"\u901a\u8fc7\u5bf9\u6bd4\u627e\u51fa\u672c\u6b21\u66f4\u65b0\u4e2d\u53d8\u5316\u7684\u865a\u62dfDOM"),(0,a.kt)("li",{parentName:"ul"},"\u901a\u77e5",(0,a.kt)("inlineCode",{parentName:"li"},"Renderer"),"\u5c06\u53d8\u5316\u7684\u865a\u62dfDOM\u6e32\u67d3\u5230\u9875\u9762\u4e0a")),(0,a.kt)("h3",{id:"renderer"},(0,a.kt)("inlineCode",{parentName:"h3"},"Renderer")),(0,a.kt)("p",null,"\u7531\u4e8e",(0,a.kt)("inlineCode",{parentName:"p"},"React"),"\u652f\u6301\u8de8\u5e73\u53f0\uff0c\u6240\u4ee5\u4e0d\u540c\u5e73\u53f0\u6709\u4e0d\u540c\u7684",(0,a.kt)("inlineCode",{parentName:"p"},"Renderer"),"\u3002\u6211\u4eec\u524d\u7aef\u6700\u719f\u6089\u7684\u662f\u8d1f\u8d23\u5728\u6d4f\u89c8\u5668\u73af\u5883\u6e32\u67d3\u7684",(0,a.kt)("inlineCode",{parentName:"p"},"Renderer")," \u2014\u2014 ",(0,a.kt)("inlineCode",{parentName:"p"},"ReactDOM")),(0,a.kt)("p",null,"\u5728\u6bcf\u6b21\u66f4\u65b0\u53d1\u751f\u65f6\uff0c",(0,a.kt)("inlineCode",{parentName:"p"},"Renderer"),"\u63a5\u5230",(0,a.kt)("inlineCode",{parentName:"p"},"Reconciler"),"\u901a\u77e5\uff0c\u5c06\u53d8\u5316\u7684\u7ec4\u4ef6\u6e32\u67d3\u5728\u5f53\u524d\u5bbf\u4e3b\u73af\u5883\u3002"),(0,a.kt)("h3",{id:"\u7f3a\u70b9"},"\u7f3a\u70b9"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"\u5728",(0,a.kt)("inlineCode",{parentName:"li"},"Reconciler"),"\u4e2d\uff0c",(0,a.kt)("inlineCode",{parentName:"li"},"mount"),"\u7684\u7ec4\u4ef6\u4f1a\u8c03\u7528",(0,a.kt)("inlineCode",{parentName:"li"},"mountComponent"),"\uff0c",(0,a.kt)("inlineCode",{parentName:"li"},"update"),"\u7684\u7ec4\u4ef6\u4f1a\u8c03\u7528",(0,a.kt)("inlineCode",{parentName:"li"},"updateComponent"),"\u3002\u8fd9\u4e24\u4e2a\u65b9\u6cd5\u90fd\u4f1a\u9012\u5f52\u66f4\u65b0\u5b50\u7ec4\u4ef6\u3002"),(0,a.kt)("li",{parentName:"ul"},"\u7531\u4e8e\u9012\u5f52\u6267\u884c\uff0c\u6240\u4ee5\u66f4\u65b0\u4e00\u65e6\u5f00\u59cb\uff0c\u4e2d\u9014\u5c31\u65e0\u6cd5\u4e2d\u65ad\u3002\u5f53\u5c42\u7ea7\u5f88\u6df1\u65f6\uff0c\u9012\u5f52\u66f4\u65b0\u65f6\u95f4\u8d85\u8fc7\u4e8616ms\uff0c\u7528\u6237\u4ea4\u4e92\u5c31\u4f1a\u5361\u987f\u3002"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"Reconciler"),"\u548c",(0,a.kt)("inlineCode",{parentName:"li"},"Renderer"),"\u662f\u4ea4\u66ff\u5de5\u4f5c\u7684\uff0c\u5f53\u7b2c\u4e00\u4e2a",(0,a.kt)("inlineCode",{parentName:"li"},"li"),"\u5728\u9875\u9762\u4e0a\u5df2\u7ecf\u53d8\u5316\u540e\uff0c\u7b2c\u4e8c\u4e2a",(0,a.kt)("inlineCode",{parentName:"li"},"li"),"\u518d\u8fdb\u5165",(0,a.kt)("inlineCode",{parentName:"li"},"Reconciler"),"\u3002\u6574\u4e2a\u8fc7\u7a0b\u662f\u540c\u6b65\u4e0d\u53ef\u4e2d\u65ad\u7684")),(0,a.kt)("h2",{id:"react16\u67b6\u6784"},"React16\u67b6\u6784"),(0,a.kt)("p",null,"\u53ef\u4ee5\u5206\u4e3a\u4e09\u5c42\uff1a"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"Scheduler"),"\uff08\u8c03\u5ea6\u5668\uff09\u2014\u2014 \u8c03\u5ea6\u4efb\u52a1\u7684\u4f18\u5148\u7ea7\uff0c\u9ad8\u4f18\u4efb\u52a1\u4f18\u5148\u8fdb\u5165",(0,a.kt)("strong",{parentName:"li"},"Reconciler")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"Reconciler"),"\uff08\u534f\u8c03\u5668\uff09\u2014\u2014 \u8d1f\u8d23\u627e\u51fa\u53d8\u5316\u7684\u7ec4\u4ef6"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"Renderer"),"\uff08\u6e32\u67d3\u5668\uff09\u2014\u2014 \u8d1f\u8d23\u5c06\u53d8\u5316\u7684\u7ec4\u4ef6\u6e32\u67d3\u5230\u9875\u9762\u4e0a"),(0,a.kt)("li",{parentName:"ul"}),(0,a.kt)("li",{parentName:"ul"},"\u5176\u4e2d ",(0,a.kt)("inlineCode",{parentName:"li"},"Scheduler Reconciler")," \u968f\u65f6\u53ef\u80fd\u7531\u4e8e\u4ee5\u4e0b\u539f\u56e0\u88ab\u4e2d\u65ad",(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},"\u6709\u5176\u4ed6\u66f4\u9ad8\u4f18\u4efb\u52a1\u9700\u8981\u5148\u66f4\u65b0"),(0,a.kt)("li",{parentName:"ul"},"\u5f53\u524d\u5e27\u6ca1\u6709\u5269\u4f59\u65f6\u95f4")))),(0,a.kt)("blockquote",null,(0,a.kt)("p",{parentName:"blockquote"},"\u76f8\u8f83\u4e8e15")),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"\u65b0\u589e",(0,a.kt)("inlineCode",{parentName:"li"},"Scheduler")),(0,a.kt)("li",{parentName:"ul"},"\u91c7\u7528\u65b0\u7684",(0,a.kt)("inlineCode",{parentName:"li"},"Reconciler"),"  \u4e14",(0,a.kt)("inlineCode",{parentName:"li"},"Reconciler"),"\u5185\u90e8\u91c7\u7528\u4e86",(0,a.kt)("inlineCode",{parentName:"li"},"Fiber"),"\u7684\u67b6\u6784"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"Scheduler"),"\u548c ",(0,a.kt)("inlineCode",{parentName:"li"},"Reconciler")," \u90fd\u662f\u5e73\u53f0\u65e0\u5173\u7684")),(0,a.kt)("h3",{id:"scheduler"},(0,a.kt)("inlineCode",{parentName:"h3"},"Scheduler")),(0,a.kt)("p",null,"\u65e2\u7136\u6211\u4eec\u4ee5\u6d4f\u89c8\u5668\u662f\u5426\u6709\u5269\u4f59\u65f6\u95f4\u4f5c\u4e3a\u4efb\u52a1\u4e2d\u65ad\u7684\u6807\u51c6\uff0c\u90a3\u4e48\u6211\u4eec\u9700\u8981\u4e00\u79cd\u673a\u5236\uff0c\u5f53\u6d4f\u89c8\u5668\u6709\u5269\u4f59\u65f6\u95f4\u65f6\u901a\u77e5\u6211\u4eec\u3002"),(0,a.kt)("p",null,(0,a.kt)("inlineCode",{parentName:"p"},"React"),"\u5b9e\u73b0\u4e86\u529f\u80fd\u66f4\u5b8c\u5907\u7684",(0,a.kt)("inlineCode",{parentName:"p"},"requestIdleCallback"),"polyfill\uff0c\u8fd9\u5c31\u662f",(0,a.kt)("strong",{parentName:"p"},"Scheduler"),"\u3002\u9664\u4e86\u5728\u7a7a\u95f2\u65f6\u89e6\u53d1\u56de\u8c03\u7684\u529f\u80fd\u5916\uff0c",(0,a.kt)("strong",{parentName:"p"},"Scheduler"),"\u8fd8\u63d0\u4f9b\u4e86\u591a\u79cd\u8c03\u5ea6\u4f18\u5148\u7ea7\u4f9b\u4efb\u52a1\u8bbe\u7f6e\u3002"),(0,a.kt)("p",null,"\u653e\u5f03\u4f7f\u7528",(0,a.kt)("inlineCode",{parentName:"p"},"requestIdleCallback"),"\u539f\u56e0"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"\u6d4f\u89c8\u5668\u517c\u5bb9\u6027"),(0,a.kt)("li",{parentName:"ul"},"\u89e6\u53d1\u9891\u7387\u4e0d\u7a33\u5b9a\uff0c\u53d7\u5f88\u591a\u56e0\u7d20\u5f71\u54cd\u3002\u6bd4\u5982\u5f53\u6211\u4eec\u7684\u6d4f\u89c8\u5668\u5207\u6362",(0,a.kt)("inlineCode",{parentName:"li"},"tab"),"\u540e\uff0c\u4e4b\u524d",(0,a.kt)("inlineCode",{parentName:"li"},"tab"),"\u6ce8\u518c\u7684",(0,a.kt)("inlineCode",{parentName:"li"},"requestIdleCallback"),"\u89e6\u53d1\u7684\u9891\u7387\u4f1a\u53d8\u5f97\u5f88\u4f4e")),(0,a.kt)("h3",{id:"reconciler-1"},(0,a.kt)("inlineCode",{parentName:"h3"},"Reconciler")),(0,a.kt)("blockquote",null,(0,a.kt)("p",{parentName:"blockquote"},"\u534f\u8c03\u5668\uff08",(0,a.kt)("inlineCode",{parentName:"p"},"Reconciler"),"\uff09\u91cd\u6784\u7684\u4e00\u5927\u76ee\u7684\u662f\uff1a\u5c06\u8001\u7684",(0,a.kt)("inlineCode",{parentName:"p"},"\u540c\u6b65\u66f4\u65b0"),"\u7684\u67b6\u6784\u53d8\u4e3a",(0,a.kt)("inlineCode",{parentName:"p"},"\u5f02\u6b65\u53ef\u4e2d\u65ad\u66f4\u65b0"))),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"\u66f4\u65b0\u5de5\u4f5c\u4ece\u9012\u5f52\u53d8\u6210\u4e86\u53ef\u4ee5\u4e2d\u65ad\u7684\u5faa\u73af\u8fc7\u7a0b\u3002\u6bcf\u6b21\u5faa\u73af\u90fd\u4f1a\u8c03\u7528",(0,a.kt)("inlineCode",{parentName:"li"},"shouldYield"),"\u5224\u65ad\u5f53\u524d\u662f\u5426\u6709\u5269\u4f59\u65f6\u95f4\u3002")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-js"},"function workLoopConcurrent() {\n  // Perform work until Scheduler asks us to yield\n  while (workInProgress !== null && !shouldYield()) {\n    workInProgress = performUnitOfWork(workInProgress);\n  }\n}\n")),(0,a.kt)("p",null,"\u90a3\u4e48React16\u662f\u5982\u4f55\u89e3\u51b3\u4e2d\u65ad\u66f4\u65b0\u65f6DOM\u6e32\u67d3\u4e0d\u5b8c\u5168\u7684\u95ee\u9898\u5462\uff1f"),(0,a.kt)("p",null,"\u5728React16\u4e2d\uff0c",(0,a.kt)("strong",{parentName:"p"},"Reconciler"),"\u4e0e",(0,a.kt)("strong",{parentName:"p"},"Renderer"),"\u4e0d\u518d\u662f\u4ea4\u66ff\u5de5\u4f5c\u3002\u5f53",(0,a.kt)("strong",{parentName:"p"},"Scheduler"),"\u5c06\u4efb\u52a1\u4ea4\u7ed9",(0,a.kt)("strong",{parentName:"p"},"Reconciler"),"\u540e\uff0c",(0,a.kt)("strong",{parentName:"p"},"Reconciler"),"\u4f1a\u4e3a\u53d8\u5316\u7684\u865a\u62dfDOM\u6253\u4e0a\u4ee3\u8868\u589e/\u5220/\u66f4\u65b0\u7684\u6807\u8bb0\uff0c\u7c7b\u4f3c\u8fd9\u6837\uff1a"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-js"},"export const Placement = /*             */ 0b0000000000010;\nexport const Update = /*                */ 0b0000000000100;\nexport const PlacementAndUpdate = /*    */ 0b0000000000110;\nexport const Deletion = /*              */ 0b0000000001000;\n")),(0,a.kt)("p",null,"\u6574\u4e2a",(0,a.kt)("strong",{parentName:"p"},"Scheduler"),"\u4e0e",(0,a.kt)("strong",{parentName:"p"},"Reconciler"),"\u7684\u5de5\u4f5c\u90fd\u5728\u5185\u5b58\u4e2d\u8fdb\u884c\u3002\u53ea\u6709\u5f53\u6240\u6709\u7ec4\u4ef6\u90fd\u5b8c\u6210",(0,a.kt)("strong",{parentName:"p"},"Reconciler"),"\u7684\u5de5\u4f5c\uff0c\u624d\u4f1a\u7edf\u4e00\u4ea4\u7ed9",(0,a.kt)("strong",{parentName:"p"},"Renderer"),"\u3002"),(0,a.kt)("h3",{id:"renderer-1"},(0,a.kt)("inlineCode",{parentName:"h3"},"Renderer")),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"Renderer"),"\u6839\u636e",(0,a.kt)("strong",{parentName:"p"},"Reconciler"),"\u4e3a\u865a\u62dfDOM\u6253\u7684\u6807\u8bb0\uff0c\u540c\u6b65\u6267\u884c\u5bf9\u5e94\u7684DOM\u64cd\u4f5c\u3002"),(0,a.kt)("h3",{id:"render\u548ccommit\u9636\u6bb5"},(0,a.kt)("inlineCode",{parentName:"h3"},"render"),"\u548c",(0,a.kt)("inlineCode",{parentName:"h3"},"commit"),"\u9636\u6bb5"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"Reconciler"),"\u5de5\u4f5c\u7684\u9636\u6bb5\u88ab\u79f0\u4e3a",(0,a.kt)("inlineCode",{parentName:"li"},"render"),"\u9636\u6bb5\u3002\u56e0\u4e3a\u5728\u8be5\u9636\u6bb5\u4f1a\u8c03\u7528\u7ec4\u4ef6\u7684",(0,a.kt)("inlineCode",{parentName:"li"},"render"),"\u65b9\u6cd5\u3002"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"Renderer"),"\u5de5\u4f5c\u7684\u9636\u6bb5\u88ab\u79f0\u4e3a",(0,a.kt)("inlineCode",{parentName:"li"},"commit"),"\u9636\u6bb5\u3002\u5c31\u50cf\u4f60\u5b8c\u6210\u4e00\u4e2a\u9700\u6c42\u7684\u7f16\u7801\u540e\u6267\u884c",(0,a.kt)("inlineCode",{parentName:"li"},"git commit"),"\u63d0\u4ea4\u4ee3\u7801\u3002",(0,a.kt)("inlineCode",{parentName:"li"},"commit"),"\u9636\u6bb5\u4f1a\u628a",(0,a.kt)("inlineCode",{parentName:"li"},"render"),"\u9636\u6bb5\u63d0\u4ea4\u7684\u4fe1\u606f\u6e32\u67d3\u5728\u9875\u9762\u4e0a\u3002"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"render"),"\u4e0e",(0,a.kt)("inlineCode",{parentName:"li"},"commit"),"\u9636\u6bb5\u7edf\u79f0\u4e3a",(0,a.kt)("inlineCode",{parentName:"li"},"work"),"\uff0c\u5373",(0,a.kt)("inlineCode",{parentName:"li"},"React"),"\u5728\u5de5\u4f5c\u4e2d\u3002\u76f8\u5bf9\u5e94\u7684\uff0c\u5982\u679c\u4efb\u52a1\u6b63\u5728",(0,a.kt)("inlineCode",{parentName:"li"},"Scheduler"),"\u5185\u8c03\u5ea6\uff0c\u5c31\u4e0d\u5c5e\u4e8e",(0,a.kt)("inlineCode",{parentName:"li"},"work"),"\u3002")),(0,a.kt)("h2",{id:"fiber\u67b6\u6784"},"Fiber\u67b6\u6784"),(0,a.kt)("p",null,(0,a.kt)("inlineCode",{parentName:"p"},"React Fiber"),"\u53ef\u4ee5\u7406\u89e3\u4e3a\uff1a"),(0,a.kt)("p",null,(0,a.kt)("inlineCode",{parentName:"p"},"React"),"\u5185\u90e8\u5b9e\u73b0\u7684\u4e00\u5957\u72b6\u6001\u66f4\u65b0\u673a\u5236\u3002\u652f\u6301\u4efb\u52a1\u4e0d\u540c",(0,a.kt)("inlineCode",{parentName:"p"},"\u4f18\u5148\u7ea7"),"\uff0c\u53ef\u4e2d\u65ad\u4e0e\u6062\u590d\uff0c\u5e76\u4e14\u6062\u590d\u540e\u53ef\u4ee5\u590d\u7528\u4e4b\u524d\u7684",(0,a.kt)("inlineCode",{parentName:"p"},"\u4e2d\u95f4\u72b6\u6001"),"\u3002"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"\u5176\u4e2d\u6bcf\u4e2a\u4efb\u52a1\u66f4\u65b0\u5355\u5143\u4e3a",(0,a.kt)("inlineCode",{parentName:"li"},"React Element"),"\u5bf9\u5e94\u7684",(0,a.kt)("inlineCode",{parentName:"li"},"Fiber\u8282\u70b9")),(0,a.kt)("li",{parentName:"ul"},"\u5728\u65b0\u7684\u67b6\u6784\u4e2d\uff0c\u865a\u62dfDOM\u5728",(0,a.kt)("inlineCode",{parentName:"li"},"React"),"\u4e2d\u6709\u4e2a\u6b63\u5f0f\u7684\u79f0\u547c\u2014\u2014",(0,a.kt)("inlineCode",{parentName:"li"},"Fiber"))),(0,a.kt)("h3",{id:"\u5f03\u7528generate\u539f\u56e0"},"\u5f03\u7528",(0,a.kt)("inlineCode",{parentName:"h3"},"generate"),"\u539f\u56e0"),(0,a.kt)("p",null,(0,a.kt)("inlineCode",{parentName:"p"},"generate"),"\u662f\u53ef\u4ee5\u5b9e\u73b0\u4e2d\u65ad\u7684 \u4f46\u662f\u5374\u88ab\u5f03\u7528 \u539f\u56e0\u5982\u4e0b"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"Generator"),"\u662f",(0,a.kt)("inlineCode",{parentName:"li"},"\u4f20\u67d3\u6027"),"\u7684\uff0c\u4f7f\u7528\u4e86",(0,a.kt)("inlineCode",{parentName:"li"},"Generator"),"\u5219\u4e0a\u4e0b\u6587\u7684\u5176\u4ed6\u51fd\u6570\u4e5f\u9700\u8981\u4f5c\u51fa\u6539\u53d8\u3002\u8fd9\u6837\u5fc3\u667a\u8d1f\u62c5\u6bd4\u8f83\u91cd\u3002"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"Generator"),"\u6267\u884c\u7684",(0,a.kt)("inlineCode",{parentName:"li"},"\u4e2d\u95f4\u72b6\u6001"),"\u662f\u4e0a\u4e0b\u6587\u5173\u8054\u7684\u3002"),(0,a.kt)("li",{parentName:"ul"},"\u5f53\u8003\u8651\u9ad8\u4f18\u5148\u7ea7\u4efb\u52a1\u63d2\u961f\u65f6 \u9700\u8981\u5168\u5c40\u53d8\u91cf\u4fdd\u5b58\u4e4b\u524d\u6267\u884c\u7684\u4e2d\u95f4\u72b6\u6001 \u4f1a\u5f15\u5165\u65b0\u7684\u590d\u6742\u5ea6")),(0,a.kt)("h3",{id:"fiber\u7684\u542b\u4e49"},(0,a.kt)("inlineCode",{parentName:"h3"},"Fiber"),"\u7684\u542b\u4e49"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("p",{parentName:"li"},"\u4f5c\u4e3a\u67b6\u6784\u6765\u8bf4"),(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"React15"),"\u7684",(0,a.kt)("inlineCode",{parentName:"li"},"Reconciler"),"\u91c7\u7528\u9012\u5f52\u7684\u65b9\u5f0f\u6267\u884c\uff0c\u88ab\u79f0\u4e3a",(0,a.kt)("inlineCode",{parentName:"li"},"stack Reconciler"),"\u3002"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"React16"),"\u7684",(0,a.kt)("inlineCode",{parentName:"li"},"Reconciler"),"\u57fa\u4e8e",(0,a.kt)("inlineCode",{parentName:"li"},"Fiber\u8282\u70b9"),"\u5b9e\u73b0\uff0c\u88ab\u79f0\u4e3a",(0,a.kt)("inlineCode",{parentName:"li"},"Fiber Reconciler"),"\u3002"))),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("p",{parentName:"li"},"\u4f5c\u4e3a\u9759\u6001\u7684\u6570\u636e\u7ed3\u6784\u6765\u8bf4"),(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},"\u6bcf\u4e2a",(0,a.kt)("inlineCode",{parentName:"li"},"Fiber\u8282\u70b9"),"\u5bf9\u5e94\u4e00\u4e2a",(0,a.kt)("inlineCode",{parentName:"li"},"React element"),"\uff0c\u4fdd\u5b58\u4e86\u8be5\u7ec4\u4ef6\u7684\u7c7b\u578b\uff08\u51fd\u6570\u7ec4\u4ef6/\u7c7b\u7ec4\u4ef6/\u539f\u751f\u7ec4\u4ef6...\uff09\u3001\u5bf9\u5e94\u7684DOM\u8282\u70b9\u7b49\u4fe1\u606f\u3002"))),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("p",{parentName:"li"},"\u4f5c\u4e3a\u52a8\u6001\u7684\u5de5\u4f5c\u5355\u5143\u6765\u8bf4"),(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},"\u6bcf\u4e2a",(0,a.kt)("inlineCode",{parentName:"li"},"Fiber\u8282\u70b9"),"\u4fdd\u5b58\u4e86\u672c\u6b21\u66f4\u65b0\u4e2d\u8be5\u7ec4\u4ef6\u6539\u53d8\u7684\u72b6\u6001\u3001\u8981\u6267\u884c\u7684\u5de5\u4f5c\uff08\u9700\u8981\u88ab\u5220\u9664/\u88ab\u63d2\u5165\u9875\u9762\u4e2d/\u88ab\u66f4\u65b0...\uff09\u3002")))),(0,a.kt)("h4",{id:"\u67b6\u6784"},"\u67b6\u6784"),(0,a.kt)("p",null,"\u6bcf\u4e2aFiber\u8282\u70b9\u6709\u4e2a\u5bf9\u5e94\u7684",(0,a.kt)("inlineCode",{parentName:"p"},"React element"),"\uff0c\u591a\u4e2a",(0,a.kt)("inlineCode",{parentName:"p"},"Fiber\u8282\u70b9"),"\u662f\u5982\u4f55\u8fde\u63a5\u5f62\u6210\u6811\u5462\uff1f\u9760\u5982\u4e0b\u4e09\u4e2a\u5c5e\u6027\uff1a"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-js"},"// \u6307\u5411\u7236\u7ea7Fiber\u8282\u70b9\nthis.return = null;\n// \u6307\u5411\u5b50Fiber\u8282\u70b9\nthis.child = null;\n// \u6307\u5411\u53f3\u8fb9\u7b2c\u4e00\u4e2a\u5144\u5f1fFiber\u8282\u70b9\nthis.sibling = null;\n")),(0,a.kt)("h4",{id:"\u9759\u6001\u7684\u6570\u636e\u7ed3\u6784"},"\u9759\u6001\u7684\u6570\u636e\u7ed3\u6784"),(0,a.kt)("p",null,"\u4f5c\u4e3a\u4e00\u79cd\u9759\u6001\u7684\u6570\u636e\u7ed3\u6784\uff0c\u4fdd\u5b58\u4e86\u7ec4\u4ef6\u76f8\u5173\u7684\u4fe1\u606f"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-js"},"// Fiber\u5bf9\u5e94\u7ec4\u4ef6\u7684\u7c7b\u578b Function/Class/Host...\nthis.tag = tag;\n// key\u5c5e\u6027\nthis.key = key;\n// \u5927\u90e8\u5206\u60c5\u51b5\u540ctype\uff0c\u67d0\u4e9b\u60c5\u51b5\u4e0d\u540c\uff0c\u6bd4\u5982FunctionComponent\u4f7f\u7528React.memo\u5305\u88f9\nthis.elementType = null;\n// \u5bf9\u4e8e FunctionComponent\uff0c\u6307\u51fd\u6570\u672c\u8eab\uff0c\u5bf9\u4e8eClassComponent\uff0c\u6307class\uff0c\u5bf9\u4e8eHostComponent\uff0c\u6307DOM\u8282\u70b9tagName\nthis.type = null;\n// Fiber\u5bf9\u5e94\u7684\u771f\u5b9eDOM\u8282\u70b9\nthis.stateNode = null;\n")),(0,a.kt)("h4",{id:"\u52a8\u6001\u7684\u5de5\u4f5c\u5355\u5143"},"\u52a8\u6001\u7684\u5de5\u4f5c\u5355\u5143"),(0,a.kt)("p",null,"\u4f5c\u4e3a\u52a8\u6001\u7684\u5de5\u4f5c\u5355\u5143\uff0c",(0,a.kt)("inlineCode",{parentName:"p"},"Fiber"),"\u4e2d\u5982\u4e0b\u53c2\u6570\u4fdd\u5b58\u4e86\u672c\u6b21\u66f4\u65b0\u76f8\u5173\u7684\u4fe1\u606f"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-js"},"// \u4fdd\u5b58\u672c\u6b21\u66f4\u65b0\u9020\u6210\u7684\u72b6\u6001\u6539\u53d8\u76f8\u5173\u4fe1\u606f\nthis.pendingProps = pendingProps;\nthis.memoizedProps = null;\nthis.updateQueue = null;\nthis.memoizedState = null;\nthis.dependencies = null;\n\nthis.mode = mode;\n\n// \u4fdd\u5b58\u672c\u6b21\u66f4\u65b0\u4f1a\u9020\u6210\u7684DOM\u64cd\u4f5c\nthis.effectTag = NoEffect;\nthis.nextEffect = null;\n\nthis.firstEffect = null;\nthis.lastEffect = null;\n")),(0,a.kt)("h2",{id:"jsx-fiber"},(0,a.kt)("inlineCode",{parentName:"h2"},"JSX Fiber")),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"createElement => jsx -> React element "))),(0,a.kt)("p",null,"\u5728\u7ec4\u4ef6",(0,a.kt)("inlineCode",{parentName:"p"},"mount"),"\u65f6\uff0c",(0,a.kt)("inlineCode",{parentName:"p"},"Reconciler"),"\u6839\u636e",(0,a.kt)("inlineCode",{parentName:"p"},"JSX"),"\u63cf\u8ff0\u7684\u7ec4\u4ef6\u5185\u5bb9",(0,a.kt)("inlineCode",{parentName:"p"},"(react element)"),"\u751f\u6210\u7ec4\u4ef6\u5bf9\u5e94\u7684",(0,a.kt)("inlineCode",{parentName:"p"},"Fiber\u8282\u70b9"),"\u3002"),(0,a.kt)("p",null,"\u5728",(0,a.kt)("inlineCode",{parentName:"p"},"update"),"\u65f6\uff0c",(0,a.kt)("inlineCode",{parentName:"p"},"Reconciler"),"\u5c06",(0,a.kt)("inlineCode",{parentName:"p"},"JSX"),"\u4e0e",(0,a.kt)("inlineCode",{parentName:"p"},"Fiber\u8282\u70b9"),"\u4fdd\u5b58\u7684\u6570\u636e\u5bf9\u6bd4\uff0c\u751f\u6210\u7ec4\u4ef6\u5bf9\u5e94\u7684",(0,a.kt)("inlineCode",{parentName:"p"},"Fiber\u8282\u70b9"),"\uff0c\u5e76\u6839\u636e\u5bf9\u6bd4\u7ed3\u679c\u4e3a",(0,a.kt)("inlineCode",{parentName:"p"},"Fiber\u8282\u70b9"),"\u6253\u4e0a",(0,a.kt)("inlineCode",{parentName:"p"},"\u6807\u8bb0")),(0,a.kt)("h2",{id:"render\u9636\u6bb5"},(0,a.kt)("inlineCode",{parentName:"h2"},"render"),"\u9636\u6bb5"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-js"},"\u540c\u6b65 - workLoopSync -> performUnitOfWork\n\u5f02\u6b65 - workLoopConcurrent -> performUnitOfWork\n")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-js"},"// performSyncWorkOnRoot\u4f1a\u8c03\u7528\u8be5\u65b9\u6cd5\nfunction workLoopSync() {\n  while (workInProgress !== null) {\n    performUnitOfWork(workInProgress);\n  }\n}\n\n// performConcurrentWorkOnRoot\u4f1a\u8c03\u7528\u8be5\u65b9\u6cd5\nfunction workLoopConcurrent() {\n  while (workInProgress !== null && !shouldYield()) {\n    performUnitOfWork(workInProgress);\n  }\n}\n")),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"shouldYield"),"  \u5982\u679c\u5f53\u524d\u6d4f\u89c8\u5668\u5e27\u6ca1\u6709\u5269\u4f59\u65f6\u95f4\uff0c",(0,a.kt)("inlineCode",{parentName:"li"},"shouldYield"),"\u4f1a\u4e2d\u6b62\u5faa\u73af\uff0c\u76f4\u5230\u6d4f\u89c8\u5668\u6709\u7a7a\u95f2\u65f6\u95f4\u540e\u518d\u7ee7\u7eed\u904d\u5386\u3002"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"performUnitOfWork")," \u65b9\u6cd5\u4f1a\u521b\u5efa\u4e0b\u4e00\u4e2a",(0,a.kt)("inlineCode",{parentName:"li"},"Fiber\u8282\u70b9"),"\u5e76\u8d4b\u503c\u7ed9",(0,a.kt)("inlineCode",{parentName:"li"},"workInProgress"),"\uff0c\u5e76\u5c06",(0,a.kt)("inlineCode",{parentName:"li"},"workInProgress"),"\u4e0e\u5df2\u521b\u5efa\u7684",(0,a.kt)("inlineCode",{parentName:"li"},"Fiber\u8282\u70b9"),"\u8fde\u63a5\u8d77\u6765\u6784\u6210",(0,a.kt)("inlineCode",{parentName:"li"},"Fiber\u6811"),"\u3002")),(0,a.kt)("p",null,(0,a.kt)("inlineCode",{parentName:"p"},"Fiber Reconciler"),"\u662f\u4ece",(0,a.kt)("inlineCode",{parentName:"p"},"Stack Reconciler"),"\u91cd\u6784\u800c\u6765\uff0c\u901a\u8fc7\u904d\u5386\u7684\u65b9\u5f0f\u5b9e\u73b0\u53ef\u4e2d\u65ad\u7684\u9012\u5f52\uff0c\u6240\u4ee5",(0,a.kt)("inlineCode",{parentName:"p"},"performUnitOfWork"),"\u7684\u5de5\u4f5c\u53ef\u4ee5\u5206\u4e3a\u4e24\u90e8\u5206\uff1a\u201c\u9012\u201d\u548c\u201c\u5f52\u201d\u3002"),(0,a.kt)("h3",{id:"\u9012-beginwork"},"\u9012 ",(0,a.kt)("inlineCode",{parentName:"h3"},"beginWork")),(0,a.kt)("p",null,"\u9996\u5148\u4ece",(0,a.kt)("inlineCode",{parentName:"p"},"rootFiber"),"\u5f00\u59cb\u5411\u4e0b\u6df1\u5ea6\u4f18\u5148\u904d\u5386\u3002\u4e3a\u904d\u5386\u5230\u7684\u6bcf\u4e2a ",(0,a.kt)("inlineCode",{parentName:"p"},"Fiber\u8282\u70b9")," \u8c03\u7528 ",(0,a.kt)("inlineCode",{parentName:"p"},"beginWork\u65b9\u6cd5")," "),(0,a.kt)("p",null,"\u8be5\u65b9\u6cd5\u4f1a\u6839\u636e\u4f20\u5165\u7684",(0,a.kt)("inlineCode",{parentName:"p"},"Fiber\u8282\u70b9"),"\u521b\u5efa",(0,a.kt)("inlineCode",{parentName:"p"},"\u5b50Fiber\u8282\u70b9"),"\uff0c\u5e76\u5c06\u8fd9\u4e24\u4e2a ",(0,a.kt)("inlineCode",{parentName:"p"},"Fiber\u8282\u70b9")," \u8fde\u63a5\u8d77\u6765\u3002"),(0,a.kt)("p",null,"\u5f53\u904d\u5386\u5230\u53f6\u5b50\u8282\u70b9\uff08\u5373\u6ca1\u6709\u5b50\u7ec4\u4ef6\u7684\u7ec4\u4ef6\uff09\u65f6\u5c31\u4f1a\u8fdb\u5165\u201c\u5f52\u201d\u9636\u6bb5\u3002"),(0,a.kt)("h3",{id:"\u5f52--completework"},"\u5f52  ",(0,a.kt)("inlineCode",{parentName:"h3"},"completeWork")),(0,a.kt)("p",null,"\u5728\u201c\u5f52\u201d\u9636\u6bb5\u4f1a\u8c03\u7528 ",(0,a.kt)("inlineCode",{parentName:"p"},"completeWork")," \u5904\u7406",(0,a.kt)("inlineCode",{parentName:"p"},"Fiber\u8282\u70b9"),"\u3002"),(0,a.kt)("p",null,"\u5f53\u67d0\u4e2a",(0,a.kt)("inlineCode",{parentName:"p"},"Fiber\u8282\u70b9"),"\u6267\u884c\u5b8c",(0,a.kt)("inlineCode",{parentName:"p"},"completeWork"),"\uff0c\u5982\u679c\u5176\u5b58\u5728",(0,a.kt)("inlineCode",{parentName:"p"},"\u5144\u5f1fFiber\u8282\u70b9"),"\uff08\u5373",(0,a.kt)("inlineCode",{parentName:"p"},"fiber.sibling !== null"),"\uff09\uff0c\u4f1a\u8fdb\u5165\u5176",(0,a.kt)("inlineCode",{parentName:"p"},"\u5144\u5f1fFiber"),"\u7684\u201c\u9012\u201d\u9636\u6bb5\u3002"),(0,a.kt)("p",null,"\u5982\u679c\u4e0d\u5b58\u5728",(0,a.kt)("inlineCode",{parentName:"p"},"\u5144\u5f1fFiber"),"\uff0c\u4f1a\u8fdb\u5165",(0,a.kt)("inlineCode",{parentName:"p"},"\u7236\u7ea7Fiber"),"\u7684\u201c\u5f52\u201d\u9636\u6bb5\u3002"),(0,a.kt)("p",null,"\u201c\u9012\u201d\u548c\u201c\u5f52\u201d\u9636\u6bb5\u4f1a\u4ea4\u9519\u6267\u884c\u76f4\u5230\u201c\u5f52\u201d\u5230",(0,a.kt)("inlineCode",{parentName:"p"},"rootFiber"),"\u3002\u81f3\u6b64\uff0c",(0,a.kt)("inlineCode",{parentName:"p"},"render\u9636\u6bb5"),"\u7684\u5de5\u4f5c\u5c31\u7ed3\u675f\u4e86\u3002"),(0,a.kt)("p",null,(0,a.kt)("img",{parentName:"p",src:"https://cdn.jsdelivr.net/gh/honjaychang/bp/fe/20211001145029.png",alt:"image-20211001145029076"})),(0,a.kt)("p",null,(0,a.kt)("inlineCode",{parentName:"p"},"performUnitOfWork"),"\u9012\u5f52\u7248\u672c"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-js"},"")),(0,a.kt)("h4",{id:"performunitofwork"},(0,a.kt)("inlineCode",{parentName:"h4"},"performUnitOfWork")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-js"},"")),(0,a.kt)("h4",{id:"beginwork"},(0,a.kt)("inlineCode",{parentName:"h4"},"beginWork")),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"beginWork"),"\u7684\u5de5\u4f5c\u662f\u4f20\u5165",(0,a.kt)("inlineCode",{parentName:"li"},"\u5f53\u524dFiber\u8282\u70b9"),"\uff0c\u521b\u5efa",(0,a.kt)("inlineCode",{parentName:"li"},"\u5b50Fiber\u8282\u70b9"))),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-js"},"")),(0,a.kt)("p",null,"\u5f97\u76ca\u4e8e\u53cc\u7f13\u5b58\u6811\u7684\u673a\u5236\uff0c\u5728\u7ec4\u4ef6",(0,a.kt)("inlineCode",{parentName:"p"},"mount"),"\u65f6\uff0c\u7531\u4e8e\u662f\u9996\u6b21\u6e32\u67d3\uff0c\u662f\u4e0d\u5b58\u5728\u5f53\u524d\u7ec4\u4ef6\u5bf9\u5e94\u7684",(0,a.kt)("inlineCode",{parentName:"p"},"Fiber\u8282\u70b9"),"\u5728\u4e0a\u4e00\u6b21\u66f4\u65b0\u65f6\u7684",(0,a.kt)("inlineCode",{parentName:"p"},"Fiber\u8282\u70b9"),"\uff0c\u5373",(0,a.kt)("inlineCode",{parentName:"p"},"mount"),"\u65f6",(0,a.kt)("inlineCode",{parentName:"p"},"current === null"),"\u3002\u6240\u4ee5\u53ef\u4ee5\u901a\u8fc7",(0,a.kt)("inlineCode",{parentName:"p"},"current === null ?"),"\u6765\u533a\u5206\u7ec4\u4ef6\u662f\u5904\u4e8e",(0,a.kt)("inlineCode",{parentName:"p"},"mount"),"\u8fd8\u662f",(0,a.kt)("inlineCode",{parentName:"p"},"update")),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"mount"),"\u65f6\uff1a\u9664",(0,a.kt)("inlineCode",{parentName:"li"},"fiberRootNode"),"\u4ee5\u5916\uff0c",(0,a.kt)("inlineCode",{parentName:"li"},"current === null"),"\u3002\u4f1a\u6839\u636e",(0,a.kt)("inlineCode",{parentName:"li"},"fiber.tag"),"\u4e0d\u540c\uff0c\u521b\u5efa\u4e0d\u540c\u7c7b\u578b\u7684",(0,a.kt)("inlineCode",{parentName:"li"},"\u5b50Fiber\u8282\u70b9")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"update"),"\u65f6\uff1a\u5982\u679c",(0,a.kt)("inlineCode",{parentName:"li"},"current"),"\u5b58\u5728\uff0c\u5728\u6ee1\u8db3\u4e00\u5b9a\u6761\u4ef6\u65f6\u53ef\u4ee5\u590d\u7528",(0,a.kt)("inlineCode",{parentName:"li"},"current"),"\u8282\u70b9\uff0c\u8fd9\u6837\u5c31\u80fd\u514b\u9686",(0,a.kt)("inlineCode",{parentName:"li"},"current.child"),"\u4f5c\u4e3a",(0,a.kt)("inlineCode",{parentName:"li"},"workInProgress.child"),"\uff0c\u800c\u4e0d\u9700\u8981\u65b0\u5efa",(0,a.kt)("inlineCode",{parentName:"li"},"workInProgress.child"),"\u3002")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-js"},'font-size: 0.875em;font-family: Monaco, Consolas, "Andale Mono", "DejaVu Sans Mono", monospace;git add--bg-color: #363B40;\n')),(0,a.kt)("p",null,(0,a.kt)("inlineCode",{parentName:"p"},"update")," \u65f6 ",(0,a.kt)("inlineCode",{parentName:"p"},"workInProgress")," \u4f1a\u590d\u7528 ",(0,a.kt)("inlineCode",{parentName:"p"},"current")," \u8282\u70b9"),(0,a.kt)("h2",{id:"commit\u9636\u6bb5"},(0,a.kt)("inlineCode",{parentName:"h2"},"commit"),"\u9636\u6bb5"),(0,a.kt)("p",null,(0,a.kt)("inlineCode",{parentName:"p"},"commit"),"\u9636\u6bb5\u7684\u4e3b\u8981\u5de5\u4f5c\uff08\u5373",(0,a.kt)("inlineCode",{parentName:"p"},"Renderer"),"\u7684\u5de5\u4f5c\u6d41\u7a0b\uff09\u5206\u4e3a\u4e09\u90e8\u5206\uff1a"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"before mutation\u9636\u6bb5\uff08\u6267\u884c",(0,a.kt)("inlineCode",{parentName:"li"},"DOM"),"\u64cd\u4f5c\u524d\uff09"),(0,a.kt)("li",{parentName:"ul"},"mutation\u9636\u6bb5\uff08\u6267\u884c",(0,a.kt)("inlineCode",{parentName:"li"},"DOM"),"\u64cd\u4f5c\uff09"),(0,a.kt)("li",{parentName:"ul"},"layout\u9636\u6bb5\uff08\u6267\u884c",(0,a.kt)("inlineCode",{parentName:"li"},"DOM"),"\u64cd\u4f5c\u540e\uff09")),(0,a.kt)("p",null,(0,a.kt)("inlineCode",{parentName:"p"},"concurrent\u6a21\u5f0f"),"\u76f8\u8f83\u6211\u4eec\u5f53\u524d\u4f7f\u7528\u7684",(0,a.kt)("inlineCode",{parentName:"p"},"legacy\u6a21\u5f0f"),"\u6700\u4e3b\u8981\u7684\u533a\u522b\u662f",(0,a.kt)("strong",{parentName:"p"},"\u5c06\u540c\u6b65\u7684\u66f4\u65b0\u673a\u5236\u91cd\u6784\u4e3a\u5f02\u6b65\u53ef\u4e2d\u65ad\u7684\u66f4\u65b0"),"\u3002"),(0,a.kt)("p",null,"React\u5185\u90e8\u8fd0\u884c\u673a\u5236"),(0,a.kt)("p",null,(0,a.kt)("inlineCode",{parentName:"p"},"ReactDOM.render")," \u51fd\u6570\u7684\u8fd4\u56de\u503c\u662f\u5f53\u524d\u5e94\u7528\u7a0b\u5e8f\u6839\u7ec4\u4ef6\u7684\u5b9e\u4f8b"),(0,a.kt)("p",null,(0,a.kt)("img",{parentName:"p",src:"https://cdn.jsdelivr.net/gh/honjaychang/bp/fe/20210927174634.png",alt:"image-20210927174634712"})),(0,a.kt)("p",null,"\u5f53\u7ec4\u4ef6\u5185\u90e8\u6709this.setState( ... )\u64cd\u4f5c\u65f6\uff0cReact \u9996\u5148\u6839\u636ethis\u5bf9\u8c61\u627e\u5230\u5bf9\u5e94\u7684 Fiber \u7ed3\u70b9\uff0c\u7136\u540e\u5c06\u66f4\u65b0\u52a0\u5165\u5230\u5f53\u524d Fiber \u7ed3\u70b9\u7684\u66f4\u65b0\u961f\u5217\u3002"),(0,a.kt)("p",null,"\u7ec4\u4ef6\u7684\u8bbe\u8ba1\u601d\u60f3 \u6570\u636e\u9a71\u52a8\u66f4\u65b0"),(0,a.kt)("p",null,"\u5f53\u4e00\u4e2a\u7ec4\u4ef6\u5185\u90e8\u7684\u6570\u636e\u53d1\u751f\u53d8\u5316\u65f6\uff0c\u7ec4\u4ef6\u4e2d\u8fd4\u56de\u7684 UI \u4e5f\u968f\u4e4b\u53d8\u5316\u5e76\u66f4\u65b0\u5230\u5c4f\u5e55"),(0,a.kt)("blockquote",null,(0,a.kt)("p",{parentName:"blockquote"},"\u8fd9\u6bb5\u8bdd\u6709\u70b9\u610f\u601d")),(0,a.kt)("p",null,"React \u4f7f\u7528 state \u4e3a\u7ec4\u4ef6\u7ef4\u62a4\u4e86\u81ea\u5df1\u7684\u5185\u90e8\u72b6\u6001\uff0c\u4f7f\u7528 props \u4e3a\u7ec4\u4ef6\u7ef4\u62a4\u4e86\u81ea\u5df1\u7684\u5916\u90e8\u72b6\u6001\u3002 state \u548c props \u7684\u53d8\u5316 \u610f\u5473\u7740\u7ec4\u4ef6\u7684 UI \u9700\u8981\u66f4\u65b0 \u4e8b\u5b9e\u4e0a\uff0cReact \u7ec4\u4ef6\u4e2d\u7684 UI \u5c31\u662f\u5b83\u7684\u300c\u5143\u7d20\u300d\uff0cReact \u5143\u7d20\u662f\u4e00\u79cd\u666e\u901a\u7684 JavaScript \u5bf9\u8c61\u3002\u56e0\u6b64\uff0cstate\u548cprops\u7684\u53d8\u5316\u53ea\u9700\u8981\u66f4\u65b0 JavaScript \u5bf9\u8c61\u5373\u53ef\u3002\u7531\u4e8e\u66f4\u65b0 JavaScript \u5bf9\u8c61\u8981\u8fdc\u6bd4\u76f4\u63a5 DOM \u6811\u66f4\u52a0\u8f7b\u5de7\u4fbf\u5229\u4e5f\u4f7f\u5f97 React \u7ec4\u4ef6\u7684\u66f4\u65b0\u6e32\u67d3\u6027\u80fd\u8fbe\u5230\u4e86\u5f88\u9ad8\u7684\u6807\u51c6\u3002"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-jsx"},"// \u9a8c\u8bc1\u4e00\u4e0b \u518d\u770b\u4e0b\u539f\u6587\n\nCounter.__proto__ === Component\n\nCounter.prototype.__proto__ === Component.prototype\n\nCounter\u7ec4\u4ef6\u5b9e\u4f8b\u7684__proto__ \u6307\u5411\u4e86Counter\u6784\u9020\u51fd\u6570\u7684\u539f\u578b\u5bf9\u8c61\n\n\n\u7ec4\u4ef6\u5b9e\u4f8b\u5728react\u8fd0\u884c\u65f6\n\u4f1a\u8fd4\u56de\u7ec4\u4ef6\u5143\u7d20\u4e0e\u72b6\u6001 state    var nextChildren = instance.render()\n\n\u8c03\u7528\u751f\u547d\u5468\u671f\u51fd\u6570 instance.componentDidMount()\n\n\u89e6\u53d1\u66f4\u65b0 \u6267\u884csetState\u64cd\u4f5c\n\u5e94\u7528\u7a0b\u5e8f\u5728\u9996\u6b21\u6e32\u67d3\u65f6\u4f1a\u4e3a\u7ec4\u4ef6\u5b9e\u4f8b\u7ed1\u5b9a\u5bf9\u5e94 \u7684\u66f4\u65b0\u5668\u3002\u5f53\u7ec4\u4ef6\u63a5\u6536\u5230\u4e8b\u4ef6\u89e6\u53d1\u66f4\u65b0\u7684\u65f6\u5019 \u4f1a\u901a\u8fc7\u7ec4\u4ef6\u5b9e\u4f8b\u4e0a\u7684\u66f4\u65b0\u5668\u6267\u884c\u66f4\u65b0\u6d41\u7a0b\ninstance.updater = classComponentUpdater\n\n\u7ec4\u4ef6\u5b9e\u4f8b\u662f React \u5e94\u7528\u7a0b\u5e8f\u8fd0\u884c\u65f6\u7ec4\u4ef6\u88ab\u5b9e\u4f8b\u5316\u540e\u7684\u72b6\u6001\uff0c\u6bcf\u4e00\u4e2a\u7ec4\u4ef6\u5b9e\u4f8b\u90fd\u62e5\u6709\u81ea\u8eab\u7684\u5c5e\u6027\u548c\u7ee7\u627f\u4e8e \u7684\u5c5e\u6027\u3002\u5e94\u7528\u7a0b\u5e8f\u9996\u6b21\u6e32\u67d3\u65f6\u901a\u8fc7\u8c03\u7528\u7ec4\u4ef6\u5b9e\u4f8b\u7684   \u8fd4 \u56de React \u5143\u7d20\uff0c\u7528\u4e8e\u6784\u5efa\u9875\u9762 (UI)\u3002\u5f53\u5e94\u7528\u7a0b\u5e8f\u88ab(\u4e8b\u4ef6)\u89e6\u53d1\u66f4\u65b0\u65f6\uff0c\u7ec4\u4ef6\u5b9e\u4f8b\u8c03\u7528\u81ea\u8eab\u7684\u66f4\u65b0\u5668(updater)\u8fdb\u5165\u66f4\u65b0\u6e32\u67d3\u6d41\u7a0b\u3002\u6b64\u5916\uff0c\u5728\n\u5e94\u7528\u7a0b\u5e8f\u6e32\u67d3\u7684 render \u6216\u8005 commit \u9636\u6bb5(\u524d\u540e)\u4e2d\u4f1a\u901a\u8fc7\u7ec4\u4ef6\u5b9e\u4f8b\u8c03\u7528\u5bf9\u5e94\u7684\u751f\u547d\u5468\u671f\u51fd\u6570\u3002 \u7ec4\u4ef6\u5b9e\u4f8b\u8c03\u7528\u81ea\u8eab\u7684\u51fd\u6570\u8fd4\u56de React \u5143\u7d20\n")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-jsx"},"Fiber \u67b6\u6784 \u4e3b\u8981\u76ee\u6807\u662f\u89e3\u51b3\u5e94\u7528\u7a0b\u5e8f\u7684\u66f4\u65b0\u4efb\u52a1\u4e0e(\u5916\u90e8)\u5176\u4ed6\u4efb\u52a1(\u5982\u52a8 \u753b\u6e32\u67d3)\u5728 CPU \u8d44\u6e90\u5206\u914d\u65b9\u9762\u7684\u95ee\u9898\n\n\n\u4ece\u6982\u5ff5\u4e0a\u5c06 React Fiber \u662f\u4e00\u79cd\u7a0b\u5e8f\u67b6\u6784\uff0c\u4f46\u662f\u5728 React \u5e94\u7528\u7a0b\u5e8f\u8fd0\u884c\u8fc7\u7a0b\u4e2d\u5b83\u7684\u5b9e\u9645\u4f53\u73b0\u662f\u4e00\u4e2a JavaScript\u5bf9\u8c61\uff0c\u8be5\u5bf9\u8c61\u4e3b\u8981\u662f\u7531\u4e24\u4e2a\u6784\u9020\u51fd\u6570\u7684\u5b9e\u4f8b\u5c42\u5c42\u5f15\u7528\u7ec4\u6210\u3002\u8fd9\u4e24\u4e2a\u6784\u9020\u51fd\u6570\u5206\u522b\u662f FiberRootNode\u548cFiberNode\u3002\n\n\u5728\u540e\u9762\u6587\u7ae0\u4e2d\u5c06\u7edf\u4e00\u79f0 FiberRootNode \u7684\u5b9e\u4f8b\u4e3a fiberRoot \u5bf9\u8c61\uff0c FiberNode \u7684\u5b9e\u4f8b\u4e3a Fiber \u5bf9\u8c61\u6216\u8005 Fiber \u7ed3 \u70b9\n\n\n\nReact\u5143\u7d20\u5305\u542b\u7684\u5c5e\u6027 \u4e3b\u8981\u662f\u5bf9\u5e94\u7528\u7a0b\u5e8fUI\u90e8\u5206\u90fd\u63cf\u8ff0\nReact\u5143\u7d20\u7684\u6570\u636e\u7ed3\u6784\u5e76\u4e0d\u80fd\u5b8c\u6210 \u521b\u5efa\u66f4\u65b0 \u4ee5\u53ca \u5c06\u66f4\u65b0\u6e32\u67d3\u5230\u5c4f\u5e55 \u7b49\u6e32\u67d3\u5de5\u4f5c\n\n\u6240\u4ee5\u8fd9\u4e9b\u5de5\u4f5c\u9700\u8981 \u7531Fiber\u7ed3\u70b9\uff08\u5177\u6709\u66f4\u52a0\u4e30\u5bcc\u7684\u6570\u636e\u7ed3\u6784\uff09\u6765\u5b8c\u6210\n\n\n\n\n\n\nReact v15 \u7248\u672c\u5e94\u7528\u7a0b\u5e8f\u8c03\u7528 setState() \u548c render() \u65b9\u6cd5\u8fdb\u884c\u66f4\u65b0\u548c\u6e32\u67d3\u65f6\u4e3b\u8981\u5305\u542b\u4e24\u4e2a\u9636\u6bb5:\n\u8c03\u5ea6\u9636\u6bb5(reconciler):React Fiber \u4e4b\u524d\u7684 reconciler(\u88ab\u79f0\u4e3a Stack reconciler)\u662f\u81ea\u9876\u5411\u4e0b\u7684\u9012\u5f52\u7b97 \u6cd5\uff0c\u904d\u5386\u65b0\u6570\u636e\u751f\u6210\u65b0\u7684Virtual DOM\u3002\u901a\u8fc7 diff \u7b97\u6cd5\uff0c\u627e\u51fa\u9700\u8981\u66f4\u65b0\u7684\u5143\u7d20\uff0c\u653e\u5230\u66f4\u65b0\u961f\u5217\u4e2d\u53bb\u3002 \u6e32\u67d3\u9636\u6bb5(render): \u6839\u636e\u6240\u5728\u7684\u6e32\u67d3\u73af\u5883\uff0c\u904d\u5386\u66f4\u65b0\u961f\u5217\uff0c\u8c03\u7528\u6e32\u67d3\u5bbf\u4e3b\u73af\u5883\u7684 API, \u5c06\u5bf9\u5e94\u5143\u7d20\u66f4\u65b0\u6e32 \u67d3\u3002\u5728\u6d4f\u89c8\u5668\u4e2d\uff0c\u5c31\u662f\u66f4\u65b0\u5bf9\u5e94\u7684 DOM \u5143\u7d20\uff0c\u9664\u6d4f\u89c8\u5668\u5916\uff0c\u6e32\u67d3\u73af\u5883\u8fd8\u53ef\u4ee5\u662f Native\u3001WebGL \u7b49\u7b49\u3002\nReact Fiber \u4e4b\u524d\u7684\u8c03\u5ea6\u7b56\u7565 Stack Reconciler\uff0c\u8fd9\u4e2a\u7b56\u7565\u50cf\u51fd\u6570\u8c03\u7528\u6808\u4e00\u6837\uff0c\u9012\u5f52\u904d\u5386\u6240\u6709\u7684 Virtual DOM \u7ed3\u70b9\u8fdb \u884c diff\uff0c\u4e00\u65e6\u5f00\u59cb\u65e0\u6cd5\u88ab\u4e2d\u65ad\uff0c\u8981\u7b49\u6574\u68f5 Virtual DOM \u6811\u8ba1\u7b97\u5b8c\u6210\u4e4b\u540e\uff0c\u624d\u5c06\u4efb\u52a1\u51fa\u6808\u91ca\u653e\u4e3b\u7ebf\u7a0b\u3002\u800c\u6d4f\u89c8\u5668\u4e2d\u7684 \u6e32\u67d3\u5f15\u64ce\u662f\u5355\u7ebf\u7a0b\u7684\uff0c\u9664\u4e86\u7f51\u7edc\u64cd\u4f5c\uff0c\u51e0\u4e4e\u6240\u6709\u7684\u64cd\u4f5c\u90fd\u5728\u8fd9\u4e2a\u5355\u7ebf\u7a0b\u4e2d\u6267\u884c\uff0c\u6b64\u65f6\u5982\u679c\u4e3b\u7ebf\u7a0b\u4e0a\u7684\u7528\u6237\u4ea4\u4e92\u3001\u52a8 \u753b\u7b49\u5468\u671f\u6027\u4efb\u52a1\u65e0\u6cd5\u7acb\u5373\u5f97\u5230\u5904\u7406\uff0c\u5c31\u4f1a\u5f71\u54cd\u4f53\u9a8c\u3002\n\n\n\n16\n1. \u5c06\u4efb\u52a1\u6309\u7167\u5355\u4e2a Fiber \u7ed3\u70b9\u4e3a\u5355\u4f4d\uff0c\u62c6\u5206\u6210\u7ec6\u5c0f\u7684\u5355\u5143\u3002\n2. \u91cd\u5199render\u548ccommit\u4e24\u9636\u6bb5\u7684\u903b\u8f91\uff0crender\u9636\u6bb5\u7684\u4efb\u52a1\u6bcf\u6b21\u5728\u6267\u884c\u524d\u5148\u8bf7\u6c42\u4efb\u52a1\u4f53\u7cfb\u83b7\u5f97\u6267\u884c\u6743\u3002 \n3. \u5bf9\u4efb\u52a1\u5efa\u7acb\u4f18\u5148\u7ea7\u4f53\u7cfb\uff0c\u9ad8\u4f18\u5148\u7ea7\u4efb\u52a1\u4f18\u4e8e\u4f4e\u4f18\u5148\u7ea7\u5de5\u4f5c\u6267\u884c\u3002\n\n\n\nReact \u5e94\u7528\u7a0b\u5e8f\u9996\u6b21\u6e32\u67d3\u65f6\u5728 prerender \u9636\u6bb5\u4f1a\u521d\u59cb\u5316 \u300ccurrent \u6811\u300d(\u672c\u8d28\u4e0a\u4e5f\u662f\u5bf9\u8c61\u54e6)\u3002\u6700\u5f00\u59cb\u7684 current \u6811\u53ea\u6709\u4e00\u4e2a\u6839\u7ed3\u70b9\u2014 HostRoot\u7c7b\u578b\u7684 Fiber \u7ed3\u70b9\u3002\u5728\u540e\u9762\u7684 render \u9636\u6bb5\u4f1a\u6839\u636e\u6b64\u65f6\u7684 current \u6811\u521b\u5efa \u300cworkInProgress \u6811\u300d(\u540c\u6837\u662f\u5bf9\u8c61\u54e6\uff0c\u6bcf\u4e2a\u7ed3\u70b9\u90fd\u662fFiberNode \u7684\u5b9e\u4f8b)\u3002\u5728 workInProgress \u6811\u4e0a\u9762\u8fdb\u884c\u4e00 \u7cfb\u5217\u8fd0\u7b97(\u8ba1\u7b97\u66f4\u65b0\u7b49)\uff0c\u6700\u540e\u5c06\u526f\u4f5c\u7528\u5217\u8868(Effect List)\u4f20\u5165\u5230 commit \u9636\u6bb5\u3002\u5f53 commit \u9636\u6bb5\u8fd0\u884c\u5b8c\u6210\u540e\u5c06\u5f53 \u524d\u7684 current \u6811\u66ff\u6362\u4e3a workInProgress \u6811\uff0c\u81f3\u6b64\u4e00\u4e2a\u66f4\u65b0\u6d41\u7a0b\u5c31\u5b8c\u6210\u4e86\u3002\u8fd9\u4e2a\u8fc7\u7a0b\u7b80\u5316\u63cf\u8ff0\u5c31\u662f:\n\n1. \u5728 render \u9636\u6bb5 React \u4f9d\u8d56 current \u6811\u901a\u8fc7\u5de5\u4f5c\u5faa\u73af(workLoop)\u6784\u5efa workInProgress \u6811; \n2. \u5728 workInProgress \u6811\u8fdb\u884c\u4e00\u4e9b\u66f4\u65b0\u8ba1\u7b97\uff0c\u5f97\u5230\u526f\u4f5c\u7528\u5217\u8868(Effect List);\n3. \u5728 commit \u9636\u6bb5\u5c06\u526f\u4f5c\u7528\u5217\u8868\u6e32\u67d3\u5230\u9875\u9762\u540e\uff0c\u5c06 current \u6811\u66ff\u6362\u4e3a workInProgress \u6811(\u6267\u884c current = workInprogress)\u3002\n\n\n\n\n\nFiber \u6811\n\n\n\nFiberRootNode \u6784\u9020\u51fd\u6570\u53ea\u6709\u4e00\u4e2a\u5b9e\u4f8b\u5c31\u662f fiberRoot \u5bf9\u8c61\u3002\u800c\u6bcf\u4e2a Fiber \u7ed3\u70b9\u90fd\u662f FiberNode \u6784\u9020\u51fd\u6570\u7684\u5b9e\u4f8b\uff0c \u5b83\u4eec\u901a\u8fc7 return \uff0c child \u548c sibling \u4e09\u4e2a\u5c5e\u6027\u8fde\u63a5\u8d77\u6765\uff0c\u5f62\u6210\u4e86\u4e00\u4e2a\u5de8\u5927\u94fe\u8868\u3002React \u5bf9\u6bcf\u4e2a\u7ed3\u70b9\u7684\u66f4\u65b0\u8ba1\u7b97\u90fd\u662f\u5728\u8fd9 \u4e2a\u94fe\u8868\u4e0a\u5b8c\u6210\u7684\u3002React \u5728\u5bf9 Fiber \u7ed3\u70b9\u6807\u8bb0\u66f4\u65b0\u6807\u8bc6\u7684\u65f6\u5019\u7684\u505a\u6cd5\u5c31\u662f\u4e3a\u7ed3\u70b9\u7684 effectTag \u5c5e\u6027\u8d4b\u4e0d\u540c\u7684\u503c\uff0c\u8fd9\u4e2a \u8d4b\u503c\u903b\u8f91\u7528\u4e86\u8f83\u591a\u7684\u4f4d\u8fd0\u7b97\uff0c\u4e0b\u4e00\u8282\u5c06\u4f1a\u8be6\u7ec6 Fiber \u7ed3\u70b9\u4e2d\u7684 effectTag \u4e0e\u4f4d\u8fd0\u7b97\u3002\n\n")),(0,a.kt)("p",null," JS \u548c\u6e32\u67d3\u5f15\u64ce\u662f\u4e00\u4e2a\u4e92\u65a5\u5173\u7cfb"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-text"},"Fiber \u548c fiber \u4e0d\u662f\u540c\u4e00\u4e2a\u6982\u5ff5\u3002\u524d\u8005\u4ee3\u8868\u65b0\u7684\u8c03\u548c\u5668\uff0c\u540e\u8005\u4ee3\u8868 fiber node\uff0c\u4e5f\u53ef\u4ee5\u8ba4\u4e3a\u662f\u6539\u8fdb\u540e\u7684\u865a\u62df DOM\u3002\n")),(0,a.kt)("h2",{id:"\u6d4f\u89c8\u5668\u7684\u4e00\u5e27"},"\u6d4f\u89c8\u5668\u7684\u4e00\u5e27"),(0,a.kt)("p",null,(0,a.kt)("img",{parentName:"p",src:"https://cdn.jsdelivr.net/gh/honjaychang/bp/fe/Life-Of-A-Frame.png",alt:"life of a frame"})),(0,a.kt)("p",null,"\u4e3b\u6d41\u6d4f\u89c8\u5668\u5237\u65b0\u9891\u7387\u4e3a60Hz\uff0c\u5373\u6bcf\uff081000ms / 60Hz\uff0916.6ms\u6d4f\u89c8\u5668\u5237\u65b0\u4e00\u6b21\u3002"),(0,a.kt)("p",null,"\u6d4f\u89c8\u5668\u6bcf\u4e00\u5e27\u90fd\u9700\u8981\u5b8c\u6210\u8fd9\u4e9b\u4efb\u52a1\uff1a"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"\u5904\u7406\u7528\u6237\u4ea4\u4e92"),(0,a.kt)("li",{parentName:"ul"},"JS \u89e3\u6790\u6267\u884c"),(0,a.kt)("li",{parentName:"ul"},"\u4e00\u5e27\u7684\u5f00\u59cb\uff0c\u5904\u7406\u89c6\u7a97\u53d8\u5316\u3001\u9875\u9762\u6eda\u52a8\u7b49"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"requestAnimationFrame(rAF)")),(0,a.kt)("li",{parentName:"ul"},"\u5e03\u5c40 ",(0,a.kt)("inlineCode",{parentName:"li"},"layout")),(0,a.kt)("li",{parentName:"ul"},"\u7ed8\u5236 ",(0,a.kt)("inlineCode",{parentName:"li"},"paint"))),(0,a.kt)("p",null,"\u4e00\u5e27\u7684\u7a7a\u95f2\u65f6\u95f4\u4f1a\u6267\u884c ",(0,a.kt)("inlineCode",{parentName:"p"},"RequestIdelCallback")),(0,a.kt)("p",null,"\u5982\u679c\u8fd9\u516d\u4e2a\u6b65\u9aa4\u4e2d\uff0c\u4efb\u610f\u4e00\u4e2a\u6b65\u9aa4\u6240\u5360\u7528\u7684\u65f6\u95f4\u8fc7\u957f\uff0c\u603b\u65f6\u95f4\u8d85\u8fc7 16ms \u4e86\u4e4b\u540e\uff0c\u7528\u6237\u5c31\u4f1a\u611f\u5230\u5361\u987f\u3002"),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"\u628a\u6e32\u67d3\u66f4\u65b0\u8fc7\u7a0b\u62c6\u5206\u6210\u591a\u4e2a\u5b50\u4efb\u52a1\uff0c\u6bcf\u6b21\u53ea\u505a\u4e00\u5c0f\u90e8\u5206\uff0c\u505a\u5b8c\u770b\u662f\u5426\u8fd8\u6709\u5269\u4f59\u65f6\u95f4\uff0c\u5982\u679c\u6709\u7ee7\u7eed\u4e0b\u4e00\u4e2a\u4efb\u52a1\uff1b\u5982\u679c\u6ca1\u6709\uff0c\u6302\u8d77\u5f53\u524d\u4efb\u52a1\uff0c\u5c06\u65f6\u95f4\u63a7\u5236\u6743\u4ea4\u7ed9\u4e3b\u7ebf\u7a0b\uff0c\u7b49\u4e3b\u7ebf\u7a0b\u4e0d\u5fd9\u7684\u65f6\u5019\u5728\u7ee7\u7eed\u6267\u884c\u3002"),"\u8fd9\u79cd\u7b56\u7565\u53eb\u505a Cooperative Scheduling\uff08\u5408\u4f5c\u5f0f\u8c03\u5ea6\uff09\uff0c\u64cd\u4f5c\u7cfb\u7edf\u5e38\u7528\u4efb\u52a1\u8c03\u5ea6\u7b56\u7565\u4e4b\u4e00\u3002"),(0,a.kt)("p",null,"\u5408\u4f5c\u5f0f\u8c03\u5ea6\u4e3b\u8981\u5c31\u662f\u7528\u6765\u5206\u914d\u4efb\u52a1\u7684\uff0c\u5f53\u6709\u66f4\u65b0\u4efb\u52a1\u6765\u7684\u65f6\u5019\uff0c\u4e0d\u4f1a\u9a6c\u4e0a\u53bb\u505a Diff \u64cd\u4f5c\uff0c\u800c\u662f\u5148\u628a\u5f53\u524d\u7684\u66f4\u65b0\u9001\u5165\u4e00\u4e2a ",(0,a.kt)("inlineCode",{parentName:"p"},"Update Queue")," \u4e2d\uff0c\u7136\u540e\u4ea4\u7ed9 ",(0,a.kt)("strong",{parentName:"p"},"Scheduler")," \u53bb\u5904\u7406\uff0c",(0,a.kt)("inlineCode",{parentName:"p"},"Scheduler")," \u4f1a\u6839\u636e\u5f53\u524d\u4e3b\u7ebf\u7a0b\u7684\u4f7f\u7528\u60c5\u51b5\u53bb\u5904\u7406\u8fd9\u6b21 ",(0,a.kt)("inlineCode",{parentName:"p"},"Update"),"\u3002\u4e3a\u4e86\u5b9e\u73b0\u8fd9\u79cd\u7279\u6027\uff0c\u4f7f\u7528\u4e86",(0,a.kt)("inlineCode",{parentName:"p"},"requestIdelCallback"),"API\u3002\u5bf9\u4e8e\u4e0d\u652f\u6301\u8fd9\u4e2aAPI \u7684\u6d4f\u89c8\u5668\uff0cReact \u4f1a\u52a0\u4e0a pollyfill\u3002"),(0,a.kt)("h2",{id:"\u8c03\u5ea6"},"\u8c03\u5ea6"),(0,a.kt)("p",null,(0,a.kt)("img",{parentName:"p",src:"https://cdn.jsdelivr.net/gh/honjaychang/bp/fe/20211002112241.png",alt:"image-20211002112241751"})),(0,a.kt)("h4",{id:"schedulework"},(0,a.kt)("inlineCode",{parentName:"h4"},"scheduleWork")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-jsx"},"// \u4e3b\u8981\u7684\u4e8b\u60c5\u5c31\u662f\u627e\u5230\u6211\u4eec\u8981\u5904\u7406\u7684root,\u8bbe\u7f6e\u521a\u624d\u83b7\u53d6\u5230\u7684\u6267\u884c\u4f18\u5148\u7ea7\uff0c\u7136\u540e\u8c03\u7528 requestWork\nfunction scheduleWork(fiber, expirationTime) {\n  var root = scheduleWorkToRoot(fiber, expirationTime);\n  if (root === null) {\n    return;\n  }\n  \n  // \u5b58\u5728\u4e0a\u4e00\u4e2a\u4efb\u52a1 \u4e14 \u4e0a\u4e00\u4e2a\u4efb\u52a1\u672a\u6267\u884c\u5b8c\uff0c\u4f46\u6267\u884c\u6743\u4ea4\u7ed9\u4e86\u6d4f\u89c8\u5668 \u4e14 \u53d1\u73b0\u5f53\u524d\u66f4\u65b0\u7684\u4f18\u5148\u7ea7\u9ad8\u4e8e\u4e0a\u4e00\u4e2a\u4efb\u52a1 \u8c03\u7528resetStack \u91cd\u7f6e stack\n  // resetStack\u4f1a\u4ecenextUnitOfWork\u5f00\u59cb\u4e00\u6b65\u4e00\u6b65\u5f80\u4e0a\u6062\u590d\uff0c\u524d\u4e00\u4e2a\u4efb\u52a1\u6267\u884c\u7684\u90a3\u4e00\u534a\u767d\u505a\u4e86\n  if (!isWorking && nextRenderExpirationTime !== NoWork && expirationTime > nextRenderExpirationTime) {\n    // This is an interruption. (Used for performance tracking.)\n    interruptedBy = fiber;\n    resetStack();\n  }\n  markPendingPriorityLevel(root, expirationTime);\n  // If we're in the render phase, we don't need to schedule this root for an update, because we'll do it before we exit...unless this is a different root than the one we're rendering.\n  if (!isWorking || isCommitting$1 || nextRoot !== root) {\n    var rootExpirationTime = root.expirationTime;\n    requestWork(root, rootExpirationTime);\n  }\n  // \u544a\u77e5\u4f60\u7684\u4ee3\u7801\u89e6\u53d1\u65e0\u9650\u5faa\u73af\u4e86\n  if (nestedUpdateCount > NESTED_UPDATE_LIMIT) {\n    // Reset this back to zero so subsequent updates don't throw.\n    nestedUpdateCount = 0;\n    invariant(false, 'Maximum update depth exceeded. This can happen when a component repeatedly calls setState inside componentWillUpdate or componentDidUpdate. React limits the number of nested updates to prevent infinite loops.');\n  }\n}\n")),(0,a.kt)("h4",{id:"scheduleworktoroot"},(0,a.kt)("inlineCode",{parentName:"h4"},"scheduleWorkToRoot")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-js"},"function scheduleWorkToRoot(fiber, expirationTime) {\n\n  // Update the source fiber's expiration time\n  if (fiber.expirationTime < expirationTime) {\n    fiber.expirationTime = expirationTime;\n  }\n  var alternate = fiber.alternate;\n  if (alternate !== null && alternate.expirationTime < expirationTime) {\n    alternate.expirationTime = expirationTime;\n  }\n  // Walk the parent path to the root and update the child expiration time.\n  var node = fiber.return;\n  var root = null;\n  if (node === null && fiber.tag === HostRoot) {\n    root = fiber.stateNode;\n  } else {\n    while (node !== null) {\n      alternate = node.alternate;\n      if (node.childExpirationTime < expirationTime) {\n        node.childExpirationTime = expirationTime;\n        if (alternate !== null && alternate.childExpirationTime < expirationTime) {\n          alternate.childExpirationTime = expirationTime;\n        }\n      } else if (alternate !== null && alternate.childExpirationTime < expirationTime) {\n        alternate.childExpirationTime = expirationTime;\n      }\n      if (node.return === null && node.tag === HostRoot) {\n        root = node.stateNode;\n        break;\n      }\n      node = node.return;\n    }\n  }\n  return root;\n}\n")),(0,a.kt)("h4",{id:"requestwork"},(0,a.kt)("inlineCode",{parentName:"h4"},"requestWork")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-js"},"function requestWork(root, expirationTime) {\n  // \u5c06Root\u52a0\u5165\u5230Schedule\uff0c\u66f4\u65b0root.expirationTime\n  addRootToSchedule(root, expirationTime);\n  if (isRendering) {\n    // Prevent reentrancy. Remaining work will be scheduled at the end of the currently rendering batch.\n    return;\n  }\n\n  if (isBatchingUpdates) {\n    // Flush work at the end of the batch.\n    if (isUnbatchingUpdates) {\n      // ...unless we're inside unbatchedUpdates, in which case we should flush it now.\n      nextFlushedRoot = root;\n      nextFlushedExpirationTime = Sync;\n      performWorkOnRoot(root, Sync, false);\n    }\n    return;\n  }\n\n  // TODO: Get rid of Sync and use current time?\n  if (expirationTime === Sync) {\n    performSyncWork();\n  } else {\n    // \u51fd\u6570\u6838\u5fc3\u662f\u5b9e\u73b0\u4e86 requestIdleCallback \u7684 polyfill \u7248\u672c\n    scheduleCallbackWithExpirationTime(root, expirationTime);\n  }\n}\n")),(0,a.kt)("h4",{id:"addroottoschedule"},(0,a.kt)("inlineCode",{parentName:"h4"},"addRootToSchedule")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-js"},"function addRootToSchedule(root, expirationTime) {\n  // Add the root to the schedule.\n  // Check if this root is already part of the schedule.\n  // \u5224\u65ad root \u662f\u5426\u8c03\u5ea6\u8fc7\n  if (root.nextScheduledRoot === null) {\n    // This root is not already scheduled. Add it.\n    root.expirationTime = expirationTime;\n    if (lastScheduledRoot === null) {\n      firstScheduledRoot = lastScheduledRoot = root;\n      root.nextScheduledRoot = root;\n    } else {\n      lastScheduledRoot.nextScheduledRoot = root;\n      lastScheduledRoot = root;\n      lastScheduledRoot.nextScheduledRoot = firstScheduledRoot;\n    }\n  } else {\n    // This root is already scheduled, but its priority may have increased.\n    // root \u5df2\u7ecf\u8c03\u5ea6\u8fc7\uff0c\u5224\u65ad\u662f\u5426\u9700\u8981\u66f4\u65b0\u4f18\u5148\u7ea7\n    var remainingExpirationTime = root.expirationTime;\n    if (expirationTime > remainingExpirationTime) {\n      // Update the priority.\n      root.expirationTime = expirationTime;\n    }\n  }\n")),(0,a.kt)("h4",{id:"performsyncwork"},(0,a.kt)("inlineCode",{parentName:"h4"},"performSyncWork")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-js"},"function performSyncWork() {\n  performWork(Sync, false);\n}\n")),(0,a.kt)("h4",{id:"performwork"},(0,a.kt)("inlineCode",{parentName:"h4"},"performWork")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-js"},"function performWork(minExpirationTime, isYieldy) {\n  // Keep working on roots until there's no more work, or until there's a higher\n  // priority event.\n  findHighestPriorityRoot();\n\n  if (isYieldy) {\n    recomputeCurrentRendererTime();\n    currentSchedulerTime = currentRendererTime;\n\n    if (enableUserTimingAPI) {\n      var didExpire = nextFlushedExpirationTime > currentRendererTime;\n      var timeout = expirationTimeToMs(nextFlushedExpirationTime);\n      stopRequestCallbackTimer(didExpire, timeout);\n    }\n\n    while (nextFlushedRoot !== null && nextFlushedExpirationTime !== NoWork && minExpirationTime <= nextFlushedExpirationTime && !(didYield && currentRendererTime > nextFlushedExpirationTime)) {\n      performWorkOnRoot(nextFlushedRoot, nextFlushedExpirationTime, currentRendererTime > nextFlushedExpirationTime);\n      findHighestPriorityRoot();\n      recomputeCurrentRendererTime();\n      currentSchedulerTime = currentRendererTime;\n    }\n  } else {\n    while (nextFlushedRoot !== null && nextFlushedExpirationTime !== NoWork && minExpirationTime <= nextFlushedExpirationTime) {\n      performWorkOnRoot(nextFlushedRoot, nextFlushedExpirationTime, false);\n      findHighestPriorityRoot();\n    }\n  }\n\n  // We're done flushing work. Either we ran out of time in this callback,\n  // or there's no more work left with sufficient priority.\n\n  // If we're inside a callback, set this to false since we just completed it.\n  if (isYieldy) {\n    callbackExpirationTime = NoWork;\n    callbackID = null;\n  }\n  // If there's work left over, schedule a new callback.\n  if (nextFlushedExpirationTime !== NoWork) {\n    scheduleCallbackWithExpirationTime(nextFlushedRoot, nextFlushedExpirationTime);\n  }\n\n  // Clean-up.\n  finishRendering();\n}\n")),(0,a.kt)("h4",{id:"schedulecallbackwithexpirationtime"},(0,a.kt)("inlineCode",{parentName:"h4"},"scheduleCallbackWithExpirationTime")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-js"},"// requestIdleCallback \u7684 polyfill \u7248\u672c\nfunction scheduleCallbackWithExpirationTime(root, expirationTime) {\n  if (callbackExpirationTime !== NoWork) {\n    // A callback is already scheduled. Check its expiration time (timeout).\n    if (expirationTime < callbackExpirationTime) {\n      // Existing callback has sufficient timeout. Exit.\n      return;\n    } else {\n      if (callbackID !== null) {\n        // Existing callback has insufficient timeout. Cancel and schedule a new one.\n        unstable_cancelCallback(callbackID);\n      }\n    }\n    // The request callback timer is already running. Don't start a new one.\n  } else {\n    startRequestCallbackTimer();\n  }\n\n  callbackExpirationTime = expirationTime;\n  var currentMs = unstable_now() - originalStartTimeMs;\n  var expirationTimeMs = expirationTimeToMs(expirationTime);\n  var timeout = expirationTimeMs - currentMs;\n  callbackID = unstable_scheduleCallback(performAsyncWork, { timeout: timeout });\n}\n")),(0,a.kt)("h4",{id:"unstable_schedulecallback"},(0,a.kt)("inlineCode",{parentName:"h4"},"unstable_scheduleCallback")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-js"},"function unstable_scheduleCallback(callback, deprecated_options) {\n  var startTime = currentEventStartTime !== -1 ? currentEventStartTime : getCurrentTime();\n\n  var expirationTime;\n  if (typeof deprecated_options === 'object' && deprecated_options !== null && typeof deprecated_options.timeout === 'number') {\n    // FIXME: Remove this branch once we lift expiration times out of React.\n    expirationTime = startTime + deprecated_options.timeout;\n  } else {\n    switch (currentPriorityLevel) {\n      case ImmediatePriority:\n        expirationTime = startTime + IMMEDIATE_PRIORITY_TIMEOUT;\n        break;\n      case UserBlockingPriority:\n        expirationTime = startTime + USER_BLOCKING_PRIORITY;\n        break;\n      case IdlePriority:\n        expirationTime = startTime + IDLE_PRIORITY;\n        break;\n      case LowPriority:\n        expirationTime = startTime + LOW_PRIORITY_TIMEOUT;\n        break;\n      case NormalPriority:\n      default:\n        expirationTime = startTime + NORMAL_PRIORITY_TIMEOUT;\n    }\n  }\n\n  var newNode = {\n    callback: callback,\n    priorityLevel: currentPriorityLevel,\n    expirationTime: expirationTime,\n    next: null,\n    previous: null\n  };\n\n  // Insert the new callback into the list, ordered first by expiration, then\n  // by insertion. So the new callback is inserted any other callback with\n  // equal expiration.\n  if (firstCallbackNode === null) {\n    // This is the first callback in the list.\n    firstCallbackNode = newNode.next = newNode.previous = newNode;\n    ensureHostCallbackIsScheduled();\n  } else {\n    var next = null;\n    var node = firstCallbackNode;\n    do {\n      if (node.expirationTime > expirationTime) {\n        // The new callback expires before this one.\n        next = node;\n        break;\n      }\n      node = node.next;\n    } while (node !== firstCallbackNode);\n\n    if (next === null) {\n      // No callback with a later expiration was found, which means the new\n      // callback has the latest expiration in the list.\n      next = firstCallbackNode;\n    } else if (next === firstCallbackNode) {\n      // The new callback has the earliest expiration in the entire list.\n      firstCallbackNode = newNode;\n      ensureHostCallbackIsScheduled();\n    }\n\n    var previous = next.previous;\n    previous.next = next.previous = newNode;\n    newNode.next = next;\n    newNode.previous = previous;\n  }\n\n  return newNode;\n}\n")),(0,a.kt)("h4",{id:"ensurehostcallbackisscheduled"},(0,a.kt)("inlineCode",{parentName:"h4"},"ensureHostCallbackIsScheduled")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-js"},"function ensureHostCallbackIsScheduled() {\n  if (isExecutingCallback) {\n    // Don't schedule work yet; wait until the next time we yield. // \u8c03\u5ea6\u6b63\u5728\u6267\u884c \u8fd4\u56de \u4e5f\u5c31\u662f\u4e0d\u80fd\u6253\u65ad\u5df2\u7ecf\u5728\u6267\u884c\u7684\n    return;\n  }\n  // Schedule the host callback using the earliest expiration in the list. \u8ba9\u4f18\u5148\u7ea7\u6700\u9ad8\u7684 \u8fdb\u884c\u8c03\u5ea6 \u5982\u679c\u5b58\u5728\u5df2\u7ecf\u5728\u8c03\u5ea6\u7684 \u76f4\u63a5\u53d6\u6d88\n  var expirationTime = firstCallbackNode.expirationTime;\n  if (!isHostCallbackScheduled) {\n    isHostCallbackScheduled = true;\n  } else {\n    // Cancel the existing host callback.\n    cancelHostCallback();\n  }\n  requestHostCallback(flushWork, expirationTime);\n}\n")),(0,a.kt)("h4",{id:"requesthostcallback"},(0,a.kt)("inlineCode",{parentName:"h4"},"requestHostCallback")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-js"},"requestHostCallback = function (callback, absoluteTimeout) {\n  scheduledHostCallback = callback;\n  timeoutTime = absoluteTimeout;\n  if (isFlushingHostCallback || absoluteTimeout < 0) {\n    // Don't wait for the next frame. Continue working ASAP, in a new event.\n    port.postMessage(undefined);\n  } else if (!isAnimationFrameScheduled) {\n    // If rAF didn't already schedule one, we need to schedule a frame.\n    // TODO: If this rAF doesn't materialize because the browser throttles, we\n    // might want to still have setTimeout trigger rIC as a backup to ensure\n    // that we keep performing work.\n    isAnimationFrameScheduled = true;\n    requestAnimationFrameWithTimeout(animationTick);\n  }\n};\n")),(0,a.kt)("h4",{id:"requestanimationframewithtimeout"},(0,a.kt)("inlineCode",{parentName:"h4"},"requestAnimationFrameWithTimeout")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-js"},"var ANIMATION_FRAME_TIMEOUT = 100;\nvar rAFID;\nvar rAFTimeoutID;\nvar requestAnimationFrameWithTimeout = function (callback) {\n  // schedule rAF and also a setTimeout\n  // \u8fd9\u91cc\u7684 local \u5f00\u5934\u7684\u51fd\u6570\u6307\u7684\u662f requestAnimationFrame \u53ca setTimeout\n  // requestAnimationFrame \u53ea\u6709\u9875\u9762\u5728\u524d\u53f0\u65f6\u624d\u4f1a\u6267\u884c\u56de\u8c03\n  // \u5982\u679c\u9875\u9762\u5728\u540e\u53f0\u65f6\u5c31\u4e0d\u4f1a\u6267\u884c\u56de\u8c03\uff0c\u8fd9\u65f6\u5019\u4f1a\u901a\u8fc7 setTimeout \u6765\u4fdd\u8bc1\u6267\u884c callback\n  // \u4e24\u4e2a\u56de\u8c03\u4e2d\u90fd\u53ef\u4ee5\u4e92\u76f8 cancel \u5b9a\u65f6\u5668\n  // callback \u6307\u7684\u662f animationTick\n  rAFID = localRequestAnimationFrame(function (timestamp) {\n    // cancel the setTimeout\n    localClearTimeout(rAFTimeoutID);\n    callback(timestamp);\n  });\n  rAFTimeoutID = localSetTimeout(function () {\n    // cancel the requestAnimationFrame\n    localCancelAnimationFrame(rAFID);\n    callback(getCurrentTime());\n  }, ANIMATION_FRAME_TIMEOUT);\n};\n")),(0,a.kt)("h4",{id:"animationtick"},(0,a.kt)("inlineCode",{parentName:"h4"},"animationTick")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-js"},"var animationTick = function (rafTime) {\n    if (scheduledHostCallback !== null) {\n      // scheduledHostCallback \u4e0d\u4e3a\u7a7a\u7684\u8bdd\u5c31\u7ee7\u7eed\u9012\u5f52\n      // \u4f46\u662f\u6ce8\u610f\u8fd9\u91cc\u7684\u9012\u5f52\u5e76\u4e0d\u662f\u540c\u6b65\u7684\uff0c\u4e0b\u4e00\u5e27\u7684\u65f6\u5019\u624d\u4f1a\u518d\u6267\u884c animationTick\n      requestAnimationFrameWithTimeout(animationTick);\n    } else {\n      // No pending work. Exit.\n      isAnimationFrameScheduled = false;\n      return;\n    }\n    \n        // frameDeadline \u521d\u59cb\u503c\u4e3a0\uff0c\u8ba1\u7b97\u5f53\u524d\u5e27\u7684\u622a\u6b62\u65f6\u95f4\n        // activeFrameTime \u521d\u59cb\u503c\u4e3a33 \uff0c\u4e00\u5e27\u7684\u6e32\u67d3\u65f6\u95f433ms\n    var nextFrameTime = rafTime - frameDeadline + activeFrameTime;\n    if (nextFrameTime < activeFrameTime && previousFrameTime < activeFrameTime) {\n      if (nextFrameTime < 8) {\n        // Defensive coding. We don't support higher frame rates than 120hz.\n        // If the calculated frame time gets lower than 8, it is probably a bug.\n        nextFrameTime = 8;\n      }\n      // If one frame goes long, then the next one can be short to catch up.\n      // If two frames are short in a row, then that's an indication that we\n      // actually have a higher frame rate than what we're currently optimizing.\n      // We adjust our heuristic dynamically accordingly. For example, if we're\n      // running on 120hz display or 90hz VR display.\n      // Take the max of the two in case one of them was an anomaly due to\n      // missed frame deadlines.\n      activeFrameTime = nextFrameTime < previousFrameTime ? previousFrameTime : nextFrameTime;\n    } else {\n      previousFrameTime = nextFrameTime;\n    }\n    frameDeadline = rafTime + activeFrameTime;\n    if (!isMessageEventScheduled) {\n      isMessageEventScheduled = true;\n      port.postMessage(undefined);\n    }\n  };\n")),(0,a.kt)("h4",{id:"messagechannel"},(0,a.kt)("inlineCode",{parentName:"h4"},"MessageChannel")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-js"},"// We use the postMessage trick to defer idle work until after the repaint.\n  var channel = new MessageChannel();\n  var port = channel.port2;\n  channel.port1.onmessage = function (event) {\n    isMessageEventScheduled = false;\n\n    var prevScheduledCallback = scheduledHostCallback;\n    var prevTimeoutTime = timeoutTime;\n    scheduledHostCallback = null;\n    timeoutTime = -1;\n\n    var currentTime = getCurrentTime();\n\n    var didTimeout = false;\n    if (frameDeadline - currentTime <= 0) {\n      // There's no time left in this idle period. Check if the callback has\n      // a timeout and whether it's been exceeded.\n      if (prevTimeoutTime !== -1 && prevTimeoutTime <= currentTime) {\n        // Exceeded the timeout. Invoke the callback even though there's no\n        // time left.\n        didTimeout = true;\n      } else {\n        // No timeout.\n        if (!isAnimationFrameScheduled) {\n          // Schedule another animation callback so we retry later.\n          isAnimationFrameScheduled = true;\n          requestAnimationFrameWithTimeout(animationTick);\n        }\n        // Exit without invoking the callback.\n        scheduledHostCallback = prevScheduledCallback;\n        timeoutTime = prevTimeoutTime;\n        return;\n      }\n    }\n\n    if (prevScheduledCallback !== null) {\n      isFlushingHostCallback = true;\n      try {\n        prevScheduledCallback(didTimeout);\n      } finally {\n        isFlushingHostCallback = false;\n      }\n    }\n  };\n")),(0,a.kt)("h4",{id:"flushwork"},(0,a.kt)("inlineCode",{parentName:"h4"},"flushWork")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-js"},"function flushWork(didTimeout) {\n  // Exit right away if we're currently paused\n\n  if (enableSchedulerDebugging && isSchedulerPaused) {\n    return;\n  }\n\n  isExecutingCallback = true;\n  var previousDidTimeout = currentDidTimeout;\n  currentDidTimeout = didTimeout;\n  try {\n    if (didTimeout) {\n      // Flush all the expired callbacks without yielding.\n      while (firstCallbackNode !== null && !(enableSchedulerDebugging && isSchedulerPaused)) {\n        // TODO Wrap in feature flag\n        // Read the current time. Flush all the callbacks that expire at or\n        // earlier than that time. Then read the current time again and repeat.\n        // This optimizes for as few performance.now calls as possible.\n        var currentTime = getCurrentTime();\n        if (firstCallbackNode.expirationTime <= currentTime) {\n          do {\n            flushFirstCallback();\n          } while (firstCallbackNode !== null && firstCallbackNode.expirationTime <= currentTime && !(enableSchedulerDebugging && isSchedulerPaused));\n          continue;\n        }\n        break;\n      }\n    } else {\n      // Keep flushing callbacks until we run out of time in the frame.\n      if (firstCallbackNode !== null) {\n        do {\n          if (enableSchedulerDebugging && isSchedulerPaused) {\n            break;\n          }\n          flushFirstCallback();\n        } while (firstCallbackNode !== null && !shouldYieldToHost());\n      }\n    }\n  } finally {\n    isExecutingCallback = false;\n    currentDidTimeout = previousDidTimeout;\n    if (firstCallbackNode !== null) {\n      // There's still work remaining. Request another callback.\n      ensureHostCallbackIsScheduled();\n    } else {\n      isHostCallbackScheduled = false;\n    }\n    // Before exiting, flush all the immediate work that was scheduled.\n    flushImmediateWork();\n  }\n}\n")),(0,a.kt)("h4",{id:"flushfirstcallback"},(0,a.kt)("inlineCode",{parentName:"h4"},"flushFirstCallback")),(0,a.kt)("h4",{id:"performasyncwork"},(0,a.kt)("inlineCode",{parentName:"h4"},"performAsyncWork")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-js"},"function performAsyncWork() {\n  try {\n    if (!shouldYieldToRenderer()) {\n      // The callback timed out. That means at least one update has expired.\n      // Iterate through the root schedule. If they contain expired work, set\n      // the next render expiration time to the current time. This has the effect\n      // of flushing all expired work in a single batch, instead of flushing each\n      // level one at a time.\n      if (firstScheduledRoot !== null) {\n        recomputeCurrentRendererTime();\n        var root = firstScheduledRoot;\n        do {\n          didExpireAtExpirationTime(root, currentRendererTime);\n          // The root schedule is circular, so this is never null.\n          root = root.nextScheduledRoot;\n        } while (root !== firstScheduledRoot);\n      }\n    }\n    performWork(NoWork, true);\n  } finally {\n    didYield = false;\n  }\n}\n")),(0,a.kt)("h4",{id:"performwork-1"},(0,a.kt)("inlineCode",{parentName:"h4"},"performWork")),(0,a.kt)("h4",{id:"performworkonroot"},(0,a.kt)("inlineCode",{parentName:"h4"},"performWorkOnRoot")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-js"},"function performWorkOnRoot(root, expirationTime, isYieldy) {\n\n  isRendering = true;\n\n  // Check if this is async work or sync/expired work.\n  if (!isYieldy) {\n    // Flush work without yielding.\n    // TODO: Non-yieldy work does not necessarily imply expired work. A renderer\n    // may want to perform some work without yielding, but also without\n    // requiring the root to complete (by triggering placeholders).\n\n    var finishedWork = root.finishedWork;\n    if (finishedWork !== null) {\n      // This root is already complete. We can commit it.\n      completeRoot(root, finishedWork, expirationTime);\n    } else {\n      root.finishedWork = null;\n      // If this root previously suspended, clear its existing timeout, since\n      // we're about to try rendering again.\n      var timeoutHandle = root.timeoutHandle;\n      if (timeoutHandle !== noTimeout) {\n        root.timeoutHandle = noTimeout;\n        // $FlowFixMe Complains noTimeout is not a TimeoutID, despite the check above\n        cancelTimeout(timeoutHandle);\n      }\n      renderRoot(root, isYieldy);\n      finishedWork = root.finishedWork;\n      if (finishedWork !== null) {\n        // We've completed the root. Commit it.\n        completeRoot(root, finishedWork, expirationTime);\n      }\n    }\n  } else {\n    // Flush async work.\n    var _finishedWork = root.finishedWork;\n    if (_finishedWork !== null) {\n      // This root is already complete. We can commit it.\n      completeRoot(root, _finishedWork, expirationTime);\n    } else {\n      root.finishedWork = null;\n      // If this root previously suspended, clear its existing timeout, since\n      // we're about to try rendering again.\n      var _timeoutHandle = root.timeoutHandle;\n      if (_timeoutHandle !== noTimeout) {\n        root.timeoutHandle = noTimeout;\n        // $FlowFixMe Complains noTimeout is not a TimeoutID, despite the check above\n        cancelTimeout(_timeoutHandle);\n      }\n      renderRoot(root, isYieldy);\n      _finishedWork = root.finishedWork;\n      if (_finishedWork !== null) {\n        // We've completed the root. Check the if we should yield one more time\n        // before committing.\n        if (!shouldYieldToRenderer()) {\n          // Still time left. Commit the root.\n          completeRoot(root, _finishedWork, expirationTime);\n        } else {\n          // There's no time left. Mark this root as complete. We'll come\n          // back and commit it later.\n          root.finishedWork = _finishedWork;\n        }\n      }\n    }\n  }\n\n  isRendering = false;\n}\n")),(0,a.kt)("h2",{id:"\u5806\u780c"},"\u5806\u780c"),(0,a.kt)("h4",{id:"renderroot"},(0,a.kt)("inlineCode",{parentName:"h4"},"renderRoot")),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"nextUnitOfWork = createWorkInProgress()")," \u62f7\u8d1d\u4e00\u4efd ",(0,a.kt)("inlineCode",{parentName:"li"},"fiber")," \u8282\u70b9\uff0c\u5728 ",(0,a.kt)("inlineCode",{parentName:"li"},"nextUnitOfWork")," \u4e2d\u4fee\u6539\uff0c\u9632\u6b62\u6539\u53d8\u5f53\u524d ",(0,a.kt)("inlineCode",{parentName:"li"},"fiberTree"),"\u3002",(0,a.kt)("inlineCode",{parentName:"li"},"nextUnitOfWork")," \u662f\u4e0b\u4e00\u4e2a\u8981\u66f4\u65b0\u7684\u8282\u70b9   \u51fd\u6570\u4e3b\u8981\u662f\u7528\u6765\u521b\u5efawIP\u6811\uff1f"),(0,a.kt)("li",{parentName:"ul"},"\u8fdb\u5165",(0,a.kt)("inlineCode",{parentName:"li"},"workLoop")," \u5faa\u73af\u89e3\u6790\u5de5\u4f5c\u5355\u5143 \u6807\u8bb0effectTag")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-js"},"function renderRoot(root, isYieldy) {\n\n  flushPassiveEffects();\n\n  isWorking = true;\n  var previousDispatcher = ReactCurrentDispatcher.current;\n  ReactCurrentDispatcher.current = ContextOnlyDispatcher;\n\n  var expirationTime = root.nextExpirationTimeToWorkOn;\n\n  // Check if we're starting from a fresh stack, or if we're resuming from previously yielded work.\n  if (expirationTime !== nextRenderExpirationTime || root !== nextRoot || nextUnitOfWork === null) {\n    // Reset the stack and start working from the root.\n    resetStack();\n    nextRoot = root;\n    nextRenderExpirationTime = expirationTime;\n    // \u521b\u5efaworkInProgress\u6811\n    nextUnitOfWork = createWorkInProgress(nextRoot.current, null, nextRenderExpirationTime);\n    root.pendingCommitExpirationTime = NoWork;\n    }\n  }\n  startWorkLoopTimer(nextUnitOfWork);\n  do {\n    try {\n      // \u5faa\u73af\u66f4\u65b0\u8282\u70b9\n      workLoop(isYieldy);\n    } catch (thrownValue) {}\n    break;\n  } while (true);\n  // \u7701\u7565\u4e00\u957f\u4e32\u4ee3\u7801\n\n  // Ready to commit.\n  onComplete(root, rootWorkInProgress, expirationTime);\n}\n\n\nfunction workLoop(isYieldy) {\n  if (!isYieldy) {\n    // Flush work without yielding\n    while (nextUnitOfWork !== null) {\n      nextUnitOfWork = performUnitOfWork(nextUnitOfWork);\n    }\n  } else {\n    // Flush asynchronous work until there's a higher priority event\n    while (nextUnitOfWork !== null && !shouldYieldToRenderer()) {\n      nextUnitOfWork = performUnitOfWork(nextUnitOfWork);\n    }\n  }\n}\n\nfunction onComplete(root, finishedWork, expirationTime) {\n  root.pendingCommitExpirationTime = expirationTime;\n  root.finishedWork = finishedWork;\n}\n")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-jsx"},"// \u4e0ehooks\u6709\u5173\nfunction flushPassiveEffects() {\n  if (passiveEffectCallbackHandle !== null) {\n    cancelPassiveEffects(passiveEffectCallbackHandle);\n  }\n  if (passiveEffectCallback !== null) {\n    // We call the scheduled callback instead of commitPassiveEffects directly\n    // to ensure tracing works correctly.\n    passiveEffectCallback();\n  }\n}\n  \n// \u9996\u6b21\u6e32\u67d3 \u521d\u59cb\u5316\u5e76\u5b8c\u5584wIP\u6811\n// \u66f4\u65b0\u6e32\u67d3 \u590d\u7528\u5e76\u5b8c\u5584\n// This is used to create an alternate fiber to do work on.\nfunction createWorkInProgress(current, pendingProps, expirationTime) {\n  var workInProgress = current.alternate;\n  if (workInProgress === null) {\n    // \u53cc\u7f13\u5b58\u6811\n    workInProgress = createFiber(current.tag, pendingProps, current.key, current.mode);\n    workInProgress.elementType = current.elementType;\n    workInProgress.type = current.type;\n    workInProgress.stateNode = current.stateNode;\n\n\n    workInProgress.alternate = current;\n    current.alternate = workInProgress;\n  } else {\n    workInProgress.pendingProps = pendingProps;\n\n    // We already have an alternate.\n    // Reset the effect tag.\n    workInProgress.effectTag = NoEffect;\n\n    // The effect list is no longer valid.\n    workInProgress.nextEffect = null;\n    workInProgress.firstEffect = null;\n    workInProgress.lastEffect = null;\n\n  }\n\n  workInProgress.childExpirationTime = current.childExpirationTime;\n  workInProgress.expirationTime = current.expirationTime;\n\n  workInProgress.child = current.child;\n  workInProgress.memoizedProps = current.memoizedProps;\n  workInProgress.memoizedState = current.memoizedState;\n  workInProgress.updateQueue = current.updateQueue;\n  workInProgress.contextDependencies = current.contextDependencies;\n\n  // These will be overridden during the parent's reconciliation\n  workInProgress.sibling = current.sibling;\n  workInProgress.index = current.index;\n  workInProgress.ref = current.ref;\n\n\n  return workInProgress;\n}\n\n// \u5faa\u73af\u5355\u5143\u66f4\u65b0\uff0c\u5bf9\u6574\u9897 fiberTree \u90fd\u904d\u5386\u4e00\u904d  \n// \u5728React 17\u7684\u65f6\u5019 \u53d8\u6210\u4e86 workLoopSync() || workLoopConcurrent()\n// nextUnitOfWork -> workInProgress\n// shouldYieldToRenderer -> shouldYield\nfunction workLoop(isYieldy) {\n  if (!isYieldy) {\n    // Flush work without yielding\n    while (nextUnitOfWork !== null) {\n      nextUnitOfWork = performUnitOfWork(nextUnitOfWork);\n    }\n  } else {\n    // Flush asynchronous work until there's a higher priority event \u9047\u5230\u9ad8\u4f18\u5148\u7ea7\u53ef\u4e2d\u65ad\n    while (nextUnitOfWork !== null && !shouldYieldToRenderer()) {\n      nextUnitOfWork = performUnitOfWork(nextUnitOfWork);\n    }\n  }\n}\n\nvar didYield = false;\nfunction shouldYieldToRenderer() {\n  if (didYield) {\n    return true;\n  }\n  if (unstable_shouldYield()) {\n    didYield = true;\n    return true;\n  }\n  return false;\n}\n  \nfunction performUnitOfWork(workInProgress) {\n  // The current, flushed, state of this fiber is the alternate.\n  // Ideally nothing should rely on this, but relying on it here\n  // means that we don't need an additional field on the work in progress.\n  var current$$1 = workInProgress.alternate;\n\n  var next = void 0;\n\n  next = beginWork(current$$1, workInProgress, nextRenderExpirationTime);\n  workInProgress.memoizedProps = workInProgress.pendingProps;\n\n\n  if (next === null) {\n    // \u5982\u679cnext\u503c\u4e3anull\uff0c\u8bf4\u660e\u5f53\u524d\u7684Fiber\u7ed3\u70b9\u5df2\u7ecf\u662f\u53f6\u5b50\u7ed3\u70b9\uff0c\u63a5\u4e0b\u6765\u8981\u6267\u884c\u5b8c\u6210\u5de5\u4f5c\u5355\u5143\u89e3\u6790\u5de5\u4f5c\n    next = completeUnitOfWork(workInProgress);\n  }\n\n  ReactCurrentOwner$2.current = null;\n\n  return next;\n}\n")),(0,a.kt)("h4",{id:"beginwork-1"},(0,a.kt)("inlineCode",{parentName:"h4"},"beginWork")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-jsx"},"// renderExpirationTime -> renderLanes\nfunction beginWork(current$$1, workInProgress, renderExpirationTime) {\n  var updateExpirationTime = workInProgress.expirationTime;\n\n  // update\u65f6\uff1a\u5982\u679ccurrent\u5b58\u5728\u53ef\u80fd\u5b58\u5728\u4f18\u5316\u8def\u5f84\uff0c\u53ef\u4ee5\u590d\u7528current\uff08\u5373\u4e0a\u4e00\u6b21\u66f4\u65b0\u7684Fiber\u8282\u70b9\uff09\n  if (current$$1 !== null) {\n    var oldProps = current$$1.memoizedProps;\n    var newProps = workInProgress.pendingProps;\n\n    if (oldProps !== newProps || hasContextChanged()) \n      // \u5224\u65ad props \u548c context \u662f\u5426\u6539\u53d8\n      // If props or context changed, mark the fiber as having performed work.\n      // This may be unset if the props are determined to be equal later (memo).\n      didReceiveUpdate = true;\n    } else if (updateExpirationTime < renderExpirationTime) {\n      // \u5224\u65ad\u5f53\u524d fiber \u7684\u4f18\u5148\u7ea7\u662f\u5426\u5c0f\u4e8e\u672c\u6b21\u6e32\u67d3\u7684\u4f18\u5148\u7ea7\uff0c\u5c0f\u4e8e\u7684\u8bdd\u53ef\u4ee5\u8df3\u8fc7\n      didReceiveUpdate = false;\n      // This fiber does not have any pending work. Bailout without entering\n      // the begin phase. There's still some bookkeeping we that needs to be done\n      // in this optimized path, mostly pushing stuff onto the stack.\n      \n      // \u4f1a\u5224\u65ad\u8fd9\u4e2a fiber \u7684\u5b50\u6811\u662f\u5426\u9700\u8981\u66f4\u65b0\uff0c\u5982\u679c\u6709\u9700\u8981\u66f4\u65b0\u4f1a clone \u4e00\u4efd\u5230 workInProgress.child \u8fd4\u56de\u5230 workLoop \u7684 nextUnitOfWork, \u5426\u5219\u4e3a null\n      return bailoutOnAlreadyFinishedWork(current$$1, workInProgress, renderExpirationTime);\n    }\n  } else {\n    didReceiveUpdate = false;\n  }\n\n  // Before entering the begin phase, clear the expiration time.\n  // \u8fdb\u884c\u66f4\u65b0\u5148\u628a\u5f53\u524d fiber \u7684 expirationTime \u8bbe\u7f6e\u4e3a NoWork\n  workInProgress.expirationTime = NoWork;\n    // \u6839\u636e fiber \u7684 tag \u7c7b\u578b\u8fdb\u884c\u66f4\u65b0\n  switch (workInProgress.tag) {\n    case IndeterminateComponent:\n    case LazyComponent:\n    case FunctionComponent:\n    case ClassComponent:\n    case HostRoot:\n    case HostComponent:\n    case HostText:\n    case SuspenseComponent:\n    case HostPortal:\n    case ForwardRef:\n    case Fragment:\n    case Mode:\n    case Profiler:\n    case ContextProvider:\n    case ContextConsumer:\n    case MemoComponent:\n    case SimpleMemoComponent:\n    case DehydratedSuspenseComponent:\n    default:\n  }\n}\n\n- \u8c03\u7528 `renderWithHooks` \u5f97\u5230 `ReactElement` -> `nextChildren`\n- \u8c03\u7528 `reconcileChildren`\n    - `current`: \u5f53\u524d `fiber` \u8282\u70b9\n  - `workInProgress` \u9700\u8981\u66f4\u65b0\u7684\u8282\u70b9\n    - `nextChildren` \u51fd\u6570\u7684\u8fd4\u56de\u503c\n    - \u6539\u53d8\u4e86 `workInProgress.child` \u5e76\u8fd4\u56de\n\n// \u5728beginWork\u4e2d\uff0c\u901a\u8fc7workInProgress.tag\u5224\u65ad\u5f53\u524d\u662f\u4ec0\u4e48\u7c7b\u578b\u7684\u8282\u70b9\u800c\u8c03\u7528\u4e0d\u540c\u7684\u66f4\u65b0\u51fd\u6570\u3002\n\n")),(0,a.kt)("h2",{id:"commit\u9636\u6bb5-1"},"commit\u9636\u6bb5"),(0,a.kt)("h4",{id:"completeunitofwork"},(0,a.kt)("inlineCode",{parentName:"h4"},"completeUnitOfWork")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-js"},"function completeUnitOfWork(workInProgress) {\n  // Attempt to complete the current unit of work, then move to the\n  // next sibling. If there are no more siblings, return to the\n  // parent fiber.\n  while (true) {\n    // The current, flushed, state of this fiber is the alternate.\n    // Ideally nothing should rely on this, but relying on it here\n    // means that we don't need an additional field on the work in\n    // progress.\n    var current$$1 = workInProgress.alternate;\n    {\n      setCurrentFiber(workInProgress);\n    }\n\n    var returnFiber = workInProgress.return;\n    var siblingFiber = workInProgress.sibling;\n\n    if ((workInProgress.effectTag & Incomplete) === NoEffect) {\n      if (true && replayFailedUnitOfWorkWithInvokeGuardedCallback) {\n        // Don't replay if it fails during completion phase.\n        mayReplayFailedUnitOfWork = false;\n      }\n      // This fiber completed.\n      // Remember we're completing this unit so we can find a boundary if it fails.\n      nextUnitOfWork = workInProgress;\n      if (enableProfilerTimer) {\n        if (workInProgress.mode & ProfileMode) {\n          startProfilerTimer(workInProgress);\n        }\n        nextUnitOfWork = completeWork(current$$1, workInProgress, nextRenderExpirationTime);\n        if (workInProgress.mode & ProfileMode) {\n          // Update render duration assuming we didn't error.\n          stopProfilerTimerIfRunningAndRecordDelta(workInProgress, false);\n        }\n      } else {\n        nextUnitOfWork = completeWork(current$$1, workInProgress, nextRenderExpirationTime);\n      }\n      if (true && replayFailedUnitOfWorkWithInvokeGuardedCallback) {\n        // We're out of completion phase so replaying is fine now.\n        mayReplayFailedUnitOfWork = true;\n      }\n      stopWorkTimer(workInProgress);\n      resetChildExpirationTime(workInProgress, nextRenderExpirationTime);\n      {\n        resetCurrentFiber();\n      }\n\n      if (nextUnitOfWork !== null) {\n        // Completing this fiber spawned new work. Work on that next.\n        return nextUnitOfWork;\n      }\n\n      if (returnFiber !== null &&\n      // Do not append effects to parents if a sibling failed to complete\n      (returnFiber.effectTag & Incomplete) === NoEffect) {\n        // Append all the effects of the subtree and this fiber onto the effect\n        // list of the parent. The completion order of the children affects the\n        // side-effect order.\n        if (returnFiber.firstEffect === null) {\n          returnFiber.firstEffect = workInProgress.firstEffect;\n        }\n        if (workInProgress.lastEffect !== null) {\n          if (returnFiber.lastEffect !== null) {\n            returnFiber.lastEffect.nextEffect = workInProgress.firstEffect;\n          }\n          returnFiber.lastEffect = workInProgress.lastEffect;\n        }\n\n        // If this fiber had side-effects, we append it AFTER the children's\n        // side-effects. We can perform certain side-effects earlier if\n        // needed, by doing multiple passes over the effect list. We don't want\n        // to schedule our own side-effect on our own list because if end up\n        // reusing children we'll schedule this effect onto itself since we're\n        // at the end.\n        var effectTag = workInProgress.effectTag;\n        // Skip both NoWork and PerformedWork tags when creating the effect list.\n        // PerformedWork effect is read by React DevTools but shouldn't be committed.\n        if (effectTag > PerformedWork) {\n          if (returnFiber.lastEffect !== null) {\n            returnFiber.lastEffect.nextEffect = workInProgress;\n          } else {\n            returnFiber.firstEffect = workInProgress;\n          }\n          returnFiber.lastEffect = workInProgress;\n        }\n      }\n\n      if (true && ReactFiberInstrumentation_1.debugTool) {\n        ReactFiberInstrumentation_1.debugTool.onCompleteWork(workInProgress);\n      }\n\n      if (siblingFiber !== null) {\n        // If there is more work to do in this returnFiber, do that next.\n        return siblingFiber;\n      } else if (returnFiber !== null) {\n        // If there's no more work in this returnFiber. Complete the returnFiber.\n        workInProgress = returnFiber;\n        continue;\n      } else {\n        // We've reached the root.\n        return null;\n      }\n    } else {\n      if (enableProfilerTimer && workInProgress.mode & ProfileMode) {\n        // Record the render duration for the fiber that errored.\n        stopProfilerTimerIfRunningAndRecordDelta(workInProgress, false);\n\n        // Include the time spent working on failed children before continuing.\n        var actualDuration = workInProgress.actualDuration;\n        var child = workInProgress.child;\n        while (child !== null) {\n          actualDuration += child.actualDuration;\n          child = child.sibling;\n        }\n        workInProgress.actualDuration = actualDuration;\n      }\n\n      // This fiber did not complete because something threw. Pop values off\n      // the stack without entering the complete phase. If this is a boundary,\n      // capture values if possible.\n      var next = unwindWork(workInProgress, nextRenderExpirationTime);\n      // Because this fiber did not complete, don't reset its expiration time.\n      if (workInProgress.effectTag & DidCapture) {\n        // Restarting an error boundary\n        stopFailedWorkTimer(workInProgress);\n      } else {\n        stopWorkTimer(workInProgress);\n      }\n\n      {\n        resetCurrentFiber();\n      }\n\n      if (next !== null) {\n        stopWorkTimer(workInProgress);\n        if (true && ReactFiberInstrumentation_1.debugTool) {\n          ReactFiberInstrumentation_1.debugTool.onCompleteWork(workInProgress);\n        }\n\n        // If completing this work spawned new work, do that next. We'll come\n        // back here again.\n        // Since we're restarting, remove anything that is not a host effect\n        // from the effect tag.\n        next.effectTag &= HostEffectMask;\n        return next;\n      }\n\n      if (returnFiber !== null) {\n        // Mark the parent fiber as incomplete and clear its effect list.\n        returnFiber.firstEffect = returnFiber.lastEffect = null;\n        returnFiber.effectTag |= Incomplete;\n      }\n\n      if (true && ReactFiberInstrumentation_1.debugTool) {\n        ReactFiberInstrumentation_1.debugTool.onCompleteWork(workInProgress);\n      }\n\n      if (siblingFiber !== null) {\n        // If there is more work to do in this returnFiber, do that next.\n        return siblingFiber;\n      } else if (returnFiber !== null) {\n        // If there's no more work in this returnFiber. Complete the returnFiber.\n        workInProgress = returnFiber;\n        continue;\n      } else {\n        return null;\n      }\n    }\n  }\n\n  // Without this explicit null return Flow complains of invalid return type\n  // TODO Remove the above while(true) loop\n  // eslint-disable-next-line no-unreachable\n  return null;\n}\n")),(0,a.kt)("h4",{id:"completework"},(0,a.kt)("inlineCode",{parentName:"h4"},"completeWork")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-jsx"},"function completeWork(current, workInProgress, renderExpirationTime) {\n  var newProps = workInProgress.pendingProps;\n\n  switch (workInProgress.tag) {\n    case IndeterminateComponent:\n    case LazyComponent:\n    case SimpleMemoComponent:\n    case FunctionComponent:\n    case ClassComponent:\n      {\n        var Component = workInProgress.type;\n        if (isContextProvider(Component)) {\n          popContext(workInProgress);\n        }\n        break;\n      }\n    case HostRoot:\n      {\n        popHostContainer(workInProgress);\n        popTopLevelContextObject(workInProgress);\n        var fiberRoot = workInProgress.stateNode;\n        if (fiberRoot.pendingContext) {\n          fiberRoot.context = fiberRoot.pendingContext;\n          fiberRoot.pendingContext = null;\n        }\n        if (current === null || current.child === null) {\n          // If we hydrated, pop so that we can delete any remaining children\n          // that weren't hydrated.\n          popHydrationState(workInProgress);\n          // This resets the hacky state to fix isMounted before committing.\n          // TODO: Delete this when we delete isMounted and findDOMNode.\n          workInProgress.effectTag &= ~Placement;\n        }\n        updateHostContainer(workInProgress);\n        break;\n      }\n    case HostComponent:\n\n    case HostText:\n    case ForwardRef:\n    case SuspenseComponent:\n    case Fragment:\n    case Mode:\n    case Profiler:\n    case HostPortal:\n    case ContextProvider:\n    case ContextConsumer:\n    case MemoComponent:\n    case IncompleteClassComponent:\n    case DehydratedSuspenseComponent:\n    default:\n\n  return null;\n}\n")),(0,a.kt)("h4",{id:"hostcomponent"},(0,a.kt)("inlineCode",{parentName:"h4"},"HostComponent")),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"\u9875\u9762\u6e32\u67d3\u6240\u5fc5\u987b\u7684",(0,a.kt)("inlineCode",{parentName:"li"},"HostComponent"),"\uff08\u5373\u539f\u751f",(0,a.kt)("inlineCode",{parentName:"li"},"DOM\u7ec4\u4ef6"),"\u5bf9\u5e94\u7684",(0,a.kt)("inlineCode",{parentName:"li"},"Fiber\u8282\u70b9"))),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-jsx"},"case HostComponent: {\n  popHostContext(workInProgress);\n  var rootContainerInstance = getRootHostContainer();\n  var type = workInProgress.type;\n  \n  // update\n  if (current !== null && workInProgress.stateNode != null) {\n    updateHostComponent$1(current, workInProgress, type, newProps, rootContainerInstance);\n\n    if (current.ref !== workInProgress.ref) {\n      markRef$1(workInProgress);\n    }\n  } else {\n    if (!newProps) {\n      !(workInProgress.stateNode !== null) ? invariant(false, 'We must have new props for new mounts. This error is likely caused by a bug in React. Please file an issue.') : void 0;\n      // This can happen when we abort work.\n      break;\n    }\n\n    var currentHostContext = getHostContext();\n    // TODO: Move createInstance to beginWork and keep it on a context\n    // \"stack\" as the parent. Then append children as we go in beginWork\n    // or completeWork depending on we want to add then top->down or\n    // bottom->up. Top->down is faster in IE11.\n    var wasHydrated = popHydrationState(workInProgress);\n    if (wasHydrated) {\n      // TODO: Move this and createInstance step into the beginPhase\n      // to consolidate.\n      if (prepareToHydrateHostInstance(workInProgress, rootContainerInstance, currentHostContext)) {\n        // If changes to the hydrated node needs to be applied at the\n        // commit-phase we mark this as such.\n        markUpdate(workInProgress);\n      }\n    } else {\n      // mount\n      var instance = createInstance(type, newProps, rootContainerInstance, currentHostContext, workInProgress);\n\n      appendAllChildren(instance, workInProgress, false, false);\n\n      // Certain renderers require commit-time effects for initial mount.\n      // (eg DOM renderer supports auto-focus for certain elements).\n      // Make sure such renderers get scheduled for later work.\n      if (finalizeInitialChildren(instance, type, newProps, rootContainerInstance, currentHostContext)) {\n        markUpdate(workInProgress);\n      }\n      workInProgress.stateNode = instance;\n    }\n\n    if (workInProgress.ref !== null) {\n      // If there is a ref on a host node we need to schedule a callback\n      markRef$1(workInProgress);\n    }\n  }\n  break;\n}\n")),(0,a.kt)("h4",{id:"commitpassiveeffects"},(0,a.kt)("inlineCode",{parentName:"h4"},"commitPassiveEffects")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-js"},"function commitPassiveEffects(root, firstEffect) {\n  rootWithPendingPassiveEffects = null;\n  passiveEffectCallbackHandle = null;\n  passiveEffectCallback = null;\n\n  // Set this to true to prevent re-entrancy\n  var previousIsRendering = isRendering;\n  isRendering = true;\n\n  var effect = firstEffect;\n  do {\n    {\n      setCurrentFiber(effect);\n    }\n\n    if (effect.effectTag & Passive) {\n      var didError = false;\n      var error = void 0;\n      {\n        invokeGuardedCallback(null, commitPassiveHookEffects, null, effect);\n        if (hasCaughtError()) {\n          didError = true;\n          error = clearCaughtError();\n        }\n      }\n      if (didError) {\n        captureCommitPhaseError(effect, error);\n      }\n    }\n    effect = effect.nextEffect;\n  } while (effect !== null);\n  {\n    resetCurrentFiber();\n  }\n\n  isRendering = previousIsRendering;\n\n  // Check if work was scheduled by one of the effects\n  var rootExpirationTime = root.expirationTime;\n  if (rootExpirationTime !== NoWork) {\n    requestWork(root, rootExpirationTime);\n  }\n  // Flush any sync work that was scheduled by effects\n  if (!isBatchingUpdates && !isRendering) {\n    performSyncWork();\n  }\n}\n")),(0,a.kt)("h4",{id:"react-15-\u6e90\u7801"},"React 15 \u6e90\u7801"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"\u6e90\u7801\u6709\u5220\u51cf\u4f5c\u7b80\u5316\u5904\u7406 \u4e14 \u672a\u6838\u9a8c orz")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-js"},"setState -> enqueueSetState -> enqueueUpdate -> isBatchingUpdates\n\n\u7ec4\u4ef6\u5165\u961fdirtyComponents \n\u5faa\u73af\u66f4\u65b0dirtyComponents\u91cc\u7684\u6240\u6709\u7ec4\u4ef6\n")),(0,a.kt)("blockquote",null,(0,a.kt)("p",{parentName:"blockquote"},"setState \u65b9\u6cd5\u6302\u8f7d\u5728\u539f\u578b\u94fe\u4e0a")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-js"},"ReactComponent.prototype.setState = function (partialState, callback) {\n  // \u8c03\u7528 setState \u540e\uff0c\u4f1a\u8c03\u7528\u5185\u90e8\u7684 updater.enqueueSetState\n  this.updater.enqueueSetState(this, partialState);\n  if (callback) {\n    this.updater.enqueueCallback(this, callback, 'setState');\n  }\n};\n")),(0,a.kt)("blockquote",null,(0,a.kt)("p",{parentName:"blockquote"},"enqueueSetState")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-js"},"enqueueSetState(component, partialState) {\n  // \u5728\u7ec4\u4ef6\u7684 _pendingStateQueue \u4e0a\u6682\u5b58\u65b0\u7684 state\n  if (!component._pendingStateQueue) {\n    component._pendingStateQueue = [];\n  }\n  var queue = component._pendingStateQueue;\n  queue.push(partialState);\n  enqueueUpdate(component);\n}\n")),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"\u5c06\u65b0\u7684 ",(0,a.kt)("inlineCode",{parentName:"li"},"state")," \u653e\u8fdb\u7ec4\u4ef6\u7684\u72b6\u6001\u961f\u5217\u91cc"),(0,a.kt)("li",{parentName:"ul"},"\u7528 ",(0,a.kt)("inlineCode",{parentName:"li"},"enqueueUpdate")," \u6765\u5904\u7406\u5c06\u8981\u66f4\u65b0\u7684\u5b9e\u4f8b\u5bf9\u8c61")),(0,a.kt)("blockquote",null,(0,a.kt)("p",{parentName:"blockquote"},"enqueueUpdate")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-js"},"function enqueueUpdate(component) {\n  // \u6ce8\u610f\u8fd9\u4e00\u53e5\u662f\u95ee\u9898\u7684\u5173\u952e\uff0cisBatchingUpdates\u6807\u8bc6\u7740\u5f53\u524d\u662f\u5426\u5904\u4e8e\u6279\u91cf\u521b\u5efa/\u66f4\u65b0\u7ec4\u4ef6\u7684\u9636\u6bb5\n  if (!batchingStrategy.isBatchingUpdates) {\n    // \u82e5\u5f53\u524d\u6ca1\u6709\u5904\u4e8e\u6279\u91cf\u521b\u5efa/\u66f4\u65b0\u7ec4\u4ef6\u7684\u9636\u6bb5\uff0c\u5219\u7acb\u5373\u66f4\u65b0\u7ec4\u4ef6\n    batchingStrategy.batchedUpdates(enqueueUpdate, component);\n    return;\n  }\n  // \u5426\u5219\uff0c\u5148\u628a\u7ec4\u4ef6\u585e\u5165 dirtyComponents \u961f\u5217\u91cc\uff0c\u8ba9\u5b83\u201c\u518d\u7b49\u7b49\u201d\n  dirtyComponents.push(component);\n}\n")),(0,a.kt)("blockquote",null,(0,a.kt)("p",{parentName:"blockquote"},"batchingStrategy")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-js"},"var batchingStrategy = {\n  // \u5168\u5c40\u552f\u4e00\u7684\u9501\u6807\u8bc6 \u5224\u65ad\u662f\u5426\u5728\u66f4\u65b0\u6d41\u7a0b\u4e2d\n  isBatchingUpdates: false,\n \n  // \u53d1\u8d77\u66f4\u65b0\u52a8\u4f5c\u7684\u65b9\u6cd5\n  batchedUpdates: function(callback, a, b, c, d, e) {\n    // \u7f13\u5b58\u9501\u53d8\u91cf\n    var alreadyBatchingStrategy = ReactDefaultBatchingStrategy.isBatchingUpdates\n    // \u628a\u9501\u201c\u9501\u4e0a\u201d\n    ReactDefaultBatchingStrategy.isBatchingUpdates = true\n\n    if (alreadyBatchingStrategy) {\n      // \u5982\u679c\u5df2\u7ecf\u5728\u66f4\u65b0\u72b6\u6001\u4e2d\uff0c\u91cd\u65b0\u8c03\u7528 enqueueUpdate\uff0c\u5c06 component \u653e\u5165 dirtyComponents\n      // callback -> enqueueUpdate\n      callback(a, b, c, d, e)\n    } else {\n      // \u542f\u52a8\u4e8b\u52a1\uff0c\u5c06 callback \u653e\u8fdb\u4e8b\u52a1\u91cc\u6267\u884c\n      transaction.perform(callback, null, a, b, c, d, e)\n    }\n  }\n}\n")),(0,a.kt)("blockquote",null,(0,a.kt)("p",{parentName:"blockquote"},"Transaction")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-js"},"var RESET_BATCHED_UPDATES = {\n  initialize: emptyFunction,\n  close: function () {\n    ReactDefaultBatchingStrategy.isBatchingUpdates = false;\n  }\n};\nvar FLUSH_BATCHED_UPDATES = {\n  initialize: emptyFunction,\n  close: ReactUpdates.flushBatchedUpdates.bind(ReactUpdates)\n};\nvar TRANSACTION_WRAPPERS = [FLUSH_BATCHED_UPDATES, RESET_BATCHED_UPDATES];\n")),(0,a.kt)("p",null,(0,a.kt)("inlineCode",{parentName:"p"},"Transaction")," \u662f\u521b\u5efa\u4e00\u4e2a\u9ed1\u76d2\uff0c\u8be5\u9ed1\u76d2\u80fd\u591f\u5c01\u88c5\u4efb\u4f55\u7684\u65b9\u6cd5"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-js"},"/*\n*                       wrappers (injected at creation time)\n*                                      +        +\n*                                      |        |\n*                    +-----------------|--------|--------------+\n*                    |                 v        |              |\n*                    |      +---------------+   |              |\n*                    |   +--|    wrapper1   |---|----+         |\n*                    |   |  +---------------+   v    |         |\n*                    |   |          +-------------+  |         |\n*                    |   |     +----|   wrapper2  |--------+   |\n*                    |   |     |    +-------------+  |     |   |\n*                    |   |     |                     |     |   |\n*                    |   v     v                     v     v   | wrapper\n*                    | +---+ +---+   +---------+   +---+ +---+ | invariants\n* perform(anyMethod) | |   | |   |   |         |   |   | |   | | maintained\n* +-----------------\x3e|-|---|-|---|--\x3e|anyMethod|---|---|-|---|-|--------\x3e\n*                    | |   | |   |   |         |   |   | |   | |\n*                    | |   | |   |   |         |   |   | |   | |\n*                    | |   | |   |   |         |   |   | |   | |\n*                    | +---+ +---+   +---------+   +---+ +---+ |\n*                    |  initialize                    close    |\n*                    +-----------------------------------------+\n*/\n")),(0,a.kt)("p",null,"\u8bf4\u767d\u4e86\uff0c",(0,a.kt)("inlineCode",{parentName:"p"},"Transaction")," \u5c31\u50cf\u662f\u4e00\u4e2a\u201c\u58f3\u5b50\u201d\uff0c\u5b83\u9996\u5148\u4f1a\u5c06\u76ee\u6807\u51fd\u6570\u7528 ",(0,a.kt)("inlineCode",{parentName:"p"},"wrapper"),"\uff08\u4e00\u7ec4 ",(0,a.kt)("inlineCode",{parentName:"p"},"initialize")," \u53ca ",(0,a.kt)("inlineCode",{parentName:"p"},"close")," \u65b9\u6cd5\u79f0\u4e3a\u4e00\u4e2a ",(0,a.kt)("inlineCode",{parentName:"p"},"wrapper"),"\uff09 \u5c01\u88c5\u8d77\u6765\uff0c\u540c\u65f6\u9700\u8981\u4f7f\u7528 ",(0,a.kt)("inlineCode",{parentName:"p"},"Transaction")," \u7c7b\u66b4\u9732\u7684 ",(0,a.kt)("inlineCode",{parentName:"p"},"perform")," \u65b9\u6cd5\u53bb\u6267\u884c\u5b83\u3002"),(0,a.kt)("p",null,"\u5982\u4e0a\u9762\u7684\u6ce8\u91ca\u6240\u793a\uff0c\u5728 ",(0,a.kt)("inlineCode",{parentName:"p"},"anyMethod")," \u6267\u884c\u4e4b\u524d\uff0c",(0,a.kt)("inlineCode",{parentName:"p"},"perform")," \u4f1a\u5148\u6267\u884c\u6240\u6709 ",(0,a.kt)("inlineCode",{parentName:"p"},"wrapper")," \u7684 ",(0,a.kt)("inlineCode",{parentName:"p"},"initialize")," \u65b9\u6cd5\uff0c\u6267\u884c\u5b8c\u540e\uff0c\u518d\u6267\u884c\u6240\u6709 ",(0,a.kt)("inlineCode",{parentName:"p"},"wrapper")," \u7684 ",(0,a.kt)("inlineCode",{parentName:"p"},"close")," \u65b9\u6cd5\u3002\u8fd9\u5c31\u662f ",(0,a.kt)("inlineCode",{parentName:"p"},"React")," \u4e2d\u7684\u4e8b\u52a1\u673a\u5236\u3002"),(0,a.kt)("p",null,"\u5728 ",(0,a.kt)("inlineCode",{parentName:"p"},"callback")," \u6267\u884c\u4e4b\u540e\uff0c",(0,a.kt)("inlineCode",{parentName:"p"},"RESET_BATCHED_UPDATES")," \u5c06 ",(0,a.kt)("inlineCode",{parentName:"p"},"isBatchingUpdates")," \u7f6e\u4e3a",(0,a.kt)("inlineCode",{parentName:"p"},"false"),"\uff0c",(0,a.kt)("inlineCode",{parentName:"p"},"FLUSH_BATCHED_UPDATES")," \u6267\u884c ",(0,a.kt)("inlineCode",{parentName:"p"},"flushBatchedUpdates")," \uff0c\u7136\u540e\u91cc\u9762\u4f1a\u5faa\u73af\u6240\u6709 ",(0,a.kt)("inlineCode",{parentName:"p"},"dirtyComponent"),"\uff0c\u8c03\u7528",(0,a.kt)("inlineCode",{parentName:"p"},"updateComponent"),"\u6765\u6267\u884c\u6240\u6709\u7684\u751f\u547d\u5468\u671f\u65b9\u6cd5\n",(0,a.kt)("inlineCode",{parentName:"p"},"(componentWillReceiveProps \u2192 shouldComponentUpdate \u2192 componentWillUpdate \u2192 render \u2192 componentDidUpdate)"),"\uff0c\u6700\u540e\u5b9e\u73b0\u7ec4\u4ef6\u7684\u66f4\u65b0\u3002"),(0,a.kt)("blockquote",null,(0,a.kt)("p",{parentName:"blockquote"},"ReactMount.js")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-js"},"_renderNewRootComponent: function( nextElement, container, shouldReuseMarkup, context ) {\n  // \u5b9e\u4f8b\u5316\u7ec4\u4ef6\n  var componentInstance = instantiateReactComponent(nextElement);\n  // \u521d\u59cb\u6e32\u67d3\u76f4\u63a5\u8c03\u7528 batchedUpdates \u8fdb\u884c\u540c\u6b65\u6e32\u67d3\n  ReactUpdates.batchedUpdates(\n    batchedMountComponentIntoNode,\n    componentInstance,\n    container,\n    shouldReuseMarkup,\n    context\n  );\n  ...\n}\n")),(0,a.kt)("p",null,"\u8fd9\u6bb5\u4ee3\u7801\u662f\u5728\u9996\u6b21\u6e32\u67d3\u7ec4\u4ef6\u65f6\u4f1a\u6267\u884c\u7684\u4e00\u4e2a\u65b9\u6cd5\uff0c\u6211\u4eec\u770b\u5230\u5b83\u5185\u90e8\u8c03\u7528\u4e86\u4e00\u6b21 ",(0,a.kt)("inlineCode",{parentName:"p"},"batchedUpdates"),"\uff0c\u8fd9\u662f\u56e0\u4e3a\u5728\u7ec4\u4ef6\u7684\u6e32\u67d3\u8fc7\u7a0b\u4e2d\uff0c\u4f1a\u6309\u7167\u987a\u5e8f\u8c03\u7528\u5404\u4e2a\u751f\u547d\u5468\u671f\u51fd\u6570\u3002\u5f00\u53d1\u8005\u5f88\u6709\u53ef\u80fd\u5728\u58f0\u660e\u5468\u671f\u51fd\u6570\u4e2d\u8c03\u7528 ",(0,a.kt)("inlineCode",{parentName:"p"},"setState"),"\u3002\u56e0\u6b64\uff0c\u6211\u4eec\u9700\u8981\u901a\u8fc7\u5f00\u542f ",(0,a.kt)("inlineCode",{parentName:"p"},"batch")," \u6765\u786e\u4fdd\u6240\u6709\u7684\u66f4\u65b0\u90fd\u80fd\u591f\u8fdb\u5165 ",(0,a.kt)("inlineCode",{parentName:"p"},"dirtyComponents")," \u91cc\u53bb\uff0c\u8fdb\u800c\u786e\u4fdd\u521d\u59cb\u6e32\u67d3\u6d41\u7a0b\u4e2d\u6240\u6709\u7684 ",(0,a.kt)("inlineCode",{parentName:"p"},"setState")," \u90fd\u662f\u751f\u6548\u7684\u3002"),(0,a.kt)("p",null,"\u4e0b\u9762\u4ee3\u7801\u662f ",(0,a.kt)("inlineCode",{parentName:"p"},"React")," \u4e8b\u4ef6\u7cfb\u7edf\u7684\u4e00\u90e8\u5206\u3002\u5f53\u6211\u4eec\u5728\u7ec4\u4ef6\u4e0a\u7ed1\u5b9a\u4e86\u4e8b\u4ef6\u4e4b\u540e\uff0c\u4e8b\u4ef6\u4e2d\u4e5f\u6709\u53ef\u80fd\u4f1a\u89e6\u53d1 ",(0,a.kt)("inlineCode",{parentName:"p"},"setState"),"\u3002\u4e3a\u4e86\u786e\u4fdd\u6bcf\u4e00\u6b21 ",(0,a.kt)("inlineCode",{parentName:"p"},"setState")," \u90fd\u6709\u6548\uff0c",(0,a.kt)("inlineCode",{parentName:"p"},"React")," \u540c\u6837\u4f1a\u5728\u6b64\u5904\u624b\u52a8\u5f00\u542f\u6279\u91cf\u66f4\u65b0\u3002"),(0,a.kt)("blockquote",null,(0,a.kt)("p",{parentName:"blockquote"},"ReactEventListener.js")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-js"},"dispatchEvent: function (topLevelType, nativeEvent) {\n  ...\n  try {\n    // \u5904\u7406\u4e8b\u4ef6\n    ReactUpdates.batchedUpdates(handleTopLevelImpl, bookKeeping);\n  } finally {\n    TopLevelCallbackBookKeeping.release(bookKeeping);\n  }\n}\n")),(0,a.kt)("p",null,"\u6240\u4ee5\uff0c",(0,a.kt)("inlineCode",{parentName:"p"},"isBatchingUpdates")," \u8fd9\u4e2a\u53d8\u91cf\uff0c\u5728 ",(0,a.kt)("inlineCode",{parentName:"p"},"React")," \u7684\u751f\u547d\u5468\u671f\u51fd\u6570\u4ee5\u53ca\u5408\u6210\u4e8b\u4ef6\u6267\u884c\u524d\uff0c\u5df2\u7ecf\u88ab ",(0,a.kt)("inlineCode",{parentName:"p"},"React")," \u6084\u6084\u4fee\u6539\u4e3a\u4e86 ",(0,a.kt)("inlineCode",{parentName:"p"},"true"),"\uff0c\u8fd9\u4e2a\u65f6\u5019\u5df2\u7ecf\u5f00\u59cb\u4e86\u4e8b\u52a1\uff0c\u6240\u4ee5\u53ea\u8981\u4e0d\u8131\u79bb ",(0,a.kt)("inlineCode",{parentName:"p"},"React"),"\uff0c\u4e0d\u7ba1\u591a\u5c11\u6b21 ",(0,a.kt)("inlineCode",{parentName:"p"},"setState")," \u90fd\u4f1a\u628a\u5176\u7ec4\u4ef6\u653e\u5165\u810f\u7ec4\u4ef6\u961f\u5217\u7b49\u5f85\u66f4\u65b0\u3002\u5f53\u51fd\u6570\u6267\u884c\u5b8c\u6bd5\u540e\uff0c\u4e8b\u52a1\u7684 ",(0,a.kt)("inlineCode",{parentName:"p"},"close")," \u65b9\u6cd5\u4f1a\u518d\u628a ",(0,a.kt)("inlineCode",{parentName:"p"},"isBatchingUpdates")," \u6539\u4e3a ",(0,a.kt)("inlineCode",{parentName:"p"},"false"),"\u3002"),(0,a.kt)("h4",{id:"react-16-\u6e90\u7801"},"React 16 \u6e90\u7801"),(0,a.kt)("p",null,"\u56e0\u4e3a React 16 \u4e2d\u5df2\u7ecf\u6ca1\u6709\u4e86\u4e8b\u52a1\u4e00\u8bf4\u3002"))}m.isMDXComponent=!0}}]);