"use strict";(self.webpackChunkmy_test=self.webpackChunkmy_test||[]).push([[7663],{3905:function(e,n,t){t.d(n,{Zo:function(){return c},kt:function(){return k}});var a=t(7294);function r(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function i(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);n&&(a=a.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,a)}return t}function l(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?i(Object(t),!0).forEach((function(n){r(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):i(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function o(e,n){if(null==e)return{};var t,a,r=function(e,n){if(null==e)return{};var t,a,r={},i=Object.keys(e);for(a=0;a<i.length;a++)t=i[a],n.indexOf(t)>=0||(r[t]=e[t]);return r}(e,n);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(a=0;a<i.length;a++)t=i[a],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(r[t]=e[t])}return r}var p=a.createContext({}),u=function(e){var n=a.useContext(p),t=n;return e&&(t="function"==typeof e?e(n):l(l({},n),e)),t},c=function(e){var n=u(e.components);return a.createElement(p.Provider,{value:n},e.children)},d={inlineCode:"code",wrapper:function(e){var n=e.children;return a.createElement(a.Fragment,{},n)}},m=a.forwardRef((function(e,n){var t=e.components,r=e.mdxType,i=e.originalType,p=e.parentName,c=o(e,["components","mdxType","originalType","parentName"]),m=u(t),k=r,s=m["".concat(p,".").concat(k)]||m[k]||d[k]||i;return t?a.createElement(s,l(l({ref:n},c),{},{components:t})):a.createElement(s,l({ref:n},c))}));function k(e,n){var t=arguments,r=n&&n.mdxType;if("string"==typeof e||r){var i=t.length,l=new Array(i);l[0]=m;var o={};for(var p in n)hasOwnProperty.call(n,p)&&(o[p]=n[p]);o.originalType=e,o.mdxType="string"==typeof e?e:r,l[1]=o;for(var u=2;u<i;u++)l[u]=t[u];return a.createElement.apply(null,l)}return a.createElement.apply(null,t)}m.displayName="MDXCreateElement"},1844:function(e,n,t){t.r(n),t.d(n,{frontMatter:function(){return o},contentTitle:function(){return p},metadata:function(){return u},toc:function(){return c},default:function(){return m}});var a=t(7462),r=t(3366),i=(t(7294),t(3905)),l=["components"],o={},p="\u66f4\u65b0\u6d41\u7a0b",u={unversionedId:"reactCore/createUpdate",id:"reactCore/createUpdate",isDocsHomePage:!1,title:"\u66f4\u65b0\u6d41\u7a0b",description:"\u57fa\u4e8e React v16.8.4 \u6e90\u7801\u5728\u6d4f\u89c8\u5668\u8fdb\u884c\u8c03\u8bd5",source:"@site/docs/reactCore/createUpdate.md",sourceDirName:"reactCore",slug:"/reactCore/createUpdate",permalink:"/docs/reactCore/createUpdate",version:"current",frontMatter:{},sidebar:"docs",previous:{title:"\u6570\u636e\u7ed3\u6784\u5b9a\u4e49",permalink:"/docs/reactCore/ds"},next:{title:"\u4efb\u52a1\u8c03\u5ea6",permalink:"/docs/reactCore/schedule"}},c=[{value:"\u603b\u4f53\u6d41\u7a0b\u6982\u8ff0",id:"\u603b\u4f53\u6d41\u7a0b\u6982\u8ff0",children:[{value:"\u9996\u6b21\u6e32\u67d3",id:"\u9996\u6b21\u6e32\u67d3",children:[]},{value:"\u66f4\u65b0\u6e32\u67d3",id:"\u66f4\u65b0\u6e32\u67d3",children:[]}]},{value:"\u521b\u5efa\u66f4\u65b0",id:"\u521b\u5efa\u66f4\u65b0",children:[{value:"<code>RecatDOM.render</code>",id:"recatdomrender",children:[]},{value:"<code>setState</code>",id:"setstate",children:[]}]},{value:"\u52a0\u5165\u961f\u5217",id:"\u52a0\u5165\u961f\u5217",children:[{value:"<code>enqueueUpdate</code>",id:"enqueueupdate",children:[]},{value:"<code>processUpdateQueue</code>",id:"processupdatequeue",children:[]}]},{value:"\u4efb\u52a1\u8c03\u5ea6",id:"\u4efb\u52a1\u8c03\u5ea6",children:[]}],d={toc:c};function m(e){var n=e.components,t=(0,r.Z)(e,l);return(0,i.kt)("wrapper",(0,a.Z)({},d,t,{components:n,mdxType:"MDXLayout"}),(0,i.kt)("h1",{id:"\u66f4\u65b0\u6d41\u7a0b"},"\u66f4\u65b0\u6d41\u7a0b"),(0,i.kt)("p",null,"\u57fa\u4e8e ",(0,i.kt)("inlineCode",{parentName:"p"},"React v16.8.4")," \u6e90\u7801\u5728\u6d4f\u89c8\u5668\u8fdb\u884c\u8c03\u8bd5"),(0,i.kt)("p",null,"\u8c03\u8bd5\u65b9\u6cd5\u501f\u9274: ",(0,i.kt)("a",{parentName:"p",href:"https://juejin.cn/post/6903335881227108366"},"\u6211\u662f\u5982\u4f55\u9605\u8bfb\u6e90\u7801\u7684")),(0,i.kt)("h2",{id:"\u603b\u4f53\u6d41\u7a0b\u6982\u8ff0"},"\u603b\u4f53\u6d41\u7a0b\u6982\u8ff0"),(0,i.kt)("p",null,(0,i.kt)("img",{parentName:"p",src:"https://cdn.jsdelivr.net/gh/honjaychang/bp/fe/20211001223841.png",alt:"image-20211001223841032"})),(0,i.kt)("h3",{id:"\u9996\u6b21\u6e32\u67d3"},"\u9996\u6b21\u6e32\u67d3"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},"\u68c0\u67e5\u5bb9\u5668\u662f\u5426\u5408\u6cd5\uff0c\u6784\u5efa ",(0,i.kt)("inlineCode",{parentName:"p"},"fiberRoot")," \u5bf9\u8c61\uff0c",(0,i.kt)("inlineCode",{parentName:"p"},"fiberRoot")," \u5bf9\u8c61\u662f\u6574\u4e2a",(0,i.kt)("inlineCode",{parentName:"p"},"Fiber")," \u67b6\u6784\u7684\u6839\u8282\u70b9\u5bf9\u8c61")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},"\u521b\u5efa\u66f4\u65b0\u5bf9\u8c61\uff08\u66f4\u65b0\u5185\u5bb9\u4e3a\u5e94\u7528\u7a0b\u5e8f\u7684\u6839\u7ec4\u4ef6\uff09\u5e76\u5c06\u66f4\u65b0\u52a0\u5165\u5230\u66f4\u65b0\u961f\u5217")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},(0,i.kt)("inlineCode",{parentName:"p"},"React")," \u5411\u4efb\u52a1\u8c03\u5ea6\u5668\u7533\u8bf7\u7acb\u5373\u6267\u884c\uff0c\u4efb\u52a1\u8c03\u5ea6\u5668\u5b89\u6392\u8be5\u4efb\u52a1\u7acb\u5373\u6267\u884c (\u83b7\u53d6\u5230\u6267\u884c\u6743\u5219\u8fdb\u5165",(0,i.kt)("inlineCode",{parentName:"p"},"render"),"\u9636\u6bb5")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},"\u8fdb\u5165",(0,i.kt)("inlineCode",{parentName:"p"},"render")," \u9636\u6bb5\uff0c\u6b64\u65f6\u4e3b\u8981\u5de5\u4f5c\u4e3a\u6784\u5efa ",(0,i.kt)("inlineCode",{parentName:"p"},"workInProgress")," \u6811")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},"\u6784\u5efa\u8fc7\u7a0b\u4e2d\u4f1a\u505a\u4e00\u4e9b\u91cd\u8981\u7684\u5de5\u4f5c\uff0c\u5982\u4e3a\u7ed3\u70b9\u6807\u8bb0 ",(0,i.kt)("inlineCode",{parentName:"p"},"effectTag"),"\u3001\u5bf9\u7ed3\u70b9\u8fdb\u884c",(0,i.kt)("inlineCode",{parentName:"p"},"diff"),"\u5904\u7406\uff0c\u6536\u96c6",(0,i.kt)("inlineCode",{parentName:"p"},"Effect List")," \u8c03\u7528\u751f\u547d\u5468\u671f\u51fd\u6570\u7b49")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},"\u6536\u96c6\u597d ",(0,i.kt)("inlineCode",{parentName:"p"},"Effect List")," \u540e\u4f1a\u8fdb\u5165 ",(0,i.kt)("inlineCode",{parentName:"p"},"commit")," \u9636\u6bb5\uff0c\u6b64\u9636\u6bb5\u4e3b\u8981\u662f\u5c06",(0,i.kt)("inlineCode",{parentName:"p"},"Effect List"),"\u66f4\u65b0\u5230\u5c4f\u5e55\uff0c\u7136\u540e\u6e32\u67d3\u7ed3\u675f"))),(0,i.kt)("h3",{id:"\u66f4\u65b0\u6e32\u67d3"},"\u66f4\u65b0\u6e32\u67d3"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},"\u4e0d\u518d\u91cd\u590d\u6784\u5efa ",(0,i.kt)("inlineCode",{parentName:"p"},"fiberRoot"),"\u5bf9\u8c61\uff0c\u5728\u66f4\u65b0\u9636\u6bb5\u5df2\u7ecf\u5b58\u5728\u4e8e\u7cfb\u7edf\u5185\u5b58\u4e4b\u4e2d")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},"\u6b64\u65f6\u7684\u66f4\u65b0\u5185\u5bb9\u4e00\u822c\u4e3a\u7ec4\u4ef6\u5185\u90e8\u53d1\u751f\u53d8\u5316\u7684 ",(0,i.kt)("inlineCode",{parentName:"p"},"state props"))),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},"\u5728\u8fdb\u5165",(0,i.kt)("inlineCode",{parentName:"p"},"render"),"\u9636\u6bb5\u524d\u8981\u8fdb\u884c\u4efb\u52a1\u8c03\u5ea6 \u53ea\u6709\u7533\u8bf7\u5230\u66f4\u65b0\u6267\u884c\u6743\u6216\u8005\u4efb\u52a1\u5230\u671f\u624d\u80fd\u8fdb\u884c\u540e\u7eed\u6e32\u67d3\u5de5\u4f5c")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},"\u6b64\u65f6\u6784\u5efa ",(0,i.kt)("inlineCode",{parentName:"p"},"wIP")," \u6811\u4f1a\u5c3d\u91cf\u590d\u7528\u4e0a\u4e00\u6b21\u521b\u5efa\u7684 ",(0,i.kt)("inlineCode",{parentName:"p"},"Fiber")," \u7ed3\u70b9 \u540c\u65f6\u5bf9\u9700\u8981\u66f4\u65b0\u7684\u7ed3\u70b9\u6807\u8bb0\u5bf9\u5e94\u7684",(0,i.kt)("inlineCode",{parentName:"p"},"effectTag"))),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},"\u5728",(0,i.kt)("inlineCode",{parentName:"p"},"commit")," \u9636\u6bb5 \u5f97\u5230\u7684",(0,i.kt)("inlineCode",{parentName:"p"},"Effect List")," \u662f\u88ab\u6807\u8bb0\u4e86 ",(0,i.kt)("inlineCode",{parentName:"p"},"effect tag")," \u7684 ",(0,i.kt)("inlineCode",{parentName:"p"},"Fiber"),"\u7ed3\u70b9\u96c6\u5408\uff08\u4e00\u4e2a\u94fe\u8868\uff09 \u4e00\u822c\u662f ",(0,i.kt)("inlineCode",{parentName:"p"},"wIP")," \u6811\u7684\u5b50\u96c6"))),(0,i.kt)("p",null,(0,i.kt)("img",{parentName:"p",src:"https://cdn.jsdelivr.net/gh/honjaychang/bp/fe/20210923170958.png",alt:"Pasted Graphic"})),(0,i.kt)("h2",{id:"\u521b\u5efa\u66f4\u65b0"},"\u521b\u5efa\u66f4\u65b0"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"ReactDOM.render()")," ",(0,i.kt)("inlineCode",{parentName:"li"},"this.setState()"),"  ",(0,i.kt)("inlineCode",{parentName:"li"},"this.forceUpdate()")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"hydrate")," \u662f\u670d\u52a1\u7aef\u6e32\u67d3\u76f8\u5173 ",(0,i.kt)("inlineCode",{parentName:"li"},"useState()"))),(0,i.kt)("p",null,(0,i.kt)("img",{parentName:"p",src:"https://cdn.jsdelivr.net/gh/honjaychang/bp/fe/20211001224800.png",alt:"image-20211001224800453"})),(0,i.kt)("h3",{id:"recatdomrender"},(0,i.kt)("inlineCode",{parentName:"h3"},"RecatDOM.render")),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"\u68c0\u9a8c ",(0,i.kt)("inlineCode",{parentName:"li"},"container")," \u662f\u5426\u6709\u6548"),(0,i.kt)("li",{parentName:"ul"},"\u521d\u59cb\u5316 ",(0,i.kt)("inlineCode",{parentName:"li"},"fiberRoot")," \u5bf9\u8c61"),(0,i.kt)("li",{parentName:"ul"},"\u4e3a\u5e94\u7528\u7a0b\u5e8f\u7684\u9996\u6b21\u6e32\u67d3\u521b\u5efa\u66f4\u65b0\u5bf9\u8c61 ",(0,i.kt)("inlineCode",{parentName:"li"},"update"))),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-jsx",metastring:"{5}","{5}":!0},"ReactDOM.render(element, document.getElementById('root'));\n\nconst ReactDOM = {\n  render: function (element, container, callback) {\n    // \u4f1a\u5148\u68c0\u9a8ccontainer\u662f\u5426\u6709\u6548\uff0c\u65e0\u6548\u5219\u505c\u6b62\u6267\u884c\u4e14\u629b\u51fa\u9519\u8bef\n    return legacyRenderSubtreeIntoContainer(null, element, container, false, callback);\n  }\n}\n")),(0,i.kt)("p",null,(0,i.kt)("img",{parentName:"p",src:"https://cdn.jsdelivr.net/gh/honjaychang/bp/fe/20210923153945.png",alt:"render"})),(0,i.kt)("p",null,(0,i.kt)("inlineCode",{parentName:"p"},"legacyRenderSubtreeIntoContainer")),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"\u8c03\u7528",(0,i.kt)("inlineCode",{parentName:"li"},"legacyCreateRootFromDOMContainer")," \u521b\u5efa ",(0,i.kt)("inlineCode",{parentName:"li"},"ReactRoot")," \u5bf9\u8c61"),(0,i.kt)("li",{parentName:"ul"},"\u8c03\u7528 ",(0,i.kt)("inlineCode",{parentName:"li"},"root.render()")," \u8fdb\u884c\u66f4\u65b0")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-jsx",metastring:"{8}","{8}":!0},"// \u672a\u5206\u6790forceHydrate\u3001callback\nfunction legacyRenderSubtreeIntoContainer(parentComponent, children, container, forceHydrate, callback) {\n\n  // \u662f\u5426\u5b58\u5728\u6839\u8282\u70b9   \u521d\u6b21\u6e32\u67d3\u662f\u4e0d\u5b58\u5728\u6839\u8282\u70b9\u7684\n  var root = container._reactRootContainer;\n  if (!root) {\n    // Initial mount\n    root = container._reactRootContainer = legacyCreateRootFromDOMContainer(container, forceHydrate);\n\n    // Initial mount should not be batched.\n    unbatchedUpdates(function () {\n      if (parentComponent != null) {\n        root.legacy_renderSubtreeIntoContainer(parentComponent, children, callback);\n      } else {\n        root.render(children, callback);\n      }\n    });\n  } else {\n    // Update\n    if (parentComponent != null) {\n      root.legacy_renderSubtreeIntoContainer(parentComponent, children, callback);\n    } else {\n      root.render(children, callback);\n    }\n  }\n  // \u8fd8\u662f\u8fd4\u56de\u4e86\u521b\u5efa\u7684FiberRoot\u5bf9\u8c61\uff1f\n  return getPublicRootInstance(root._internalRoot);\n}\n")),(0,i.kt)("p",null,(0,i.kt)("inlineCode",{parentName:"p"},"legacyCreateRootFromDOMContainer")," ",(0,i.kt)("inlineCode",{parentName:"p"},"ReactRoot")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-jsx"},"function legacyCreateRootFromDOMContainer(container, forceHydrate) {\n\n  // Legacy roots are not async by default.\n  var isConcurrent = false;\n  return new ReactRoot(container, isConcurrent, shouldHydrate);\n}\n\n// ReactRoot\u6784\u9020\u51fd\u6570\nfunction ReactRoot(container, isConcurrent, hydrate) {\n  // \u521b\u5efa\u4e00\u4e2aFiberRoot \u5e76\u8d4b\u503c\u7ed9 \u5b9e\u4f8b\u7684 _internalRoot\n  var root = createContainer(container, isConcurrent, hydrate);\n  this._internalRoot = root;\n}\n")),(0,i.kt)("p",null,(0,i.kt)("inlineCode",{parentName:"p"},"createContainer")," ",(0,i.kt)("inlineCode",{parentName:"p"},"createFiberRoot")),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"createContainer -> createFiberRoot -> createHostRootFiber -> createFiber -> new FiberNode()")," ")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-jsx"},"function createContainer(containerInfo, isConcurrent, hydrate) {\n  return createFiberRoot(containerInfo, isConcurrent, hydrate);\n}\n\nfunction createFiberRoot(containerInfo, isConcurrent, hydrate) {\n  // Cyclic construction. This cheats the type system right now because stateNode is any.\n  // \u521b\u5efa\u4e00\u4e2aRootFiber\n  var uninitializedFiber = createHostRootFiber(isConcurrent);\n  // \u4e92\u76f8\u5f15\u7528 \u5f62\u6210\u95ed\u73af\n\n  // FiberRoot.current -> RootFIber \n  // \u6307\u5411\u4e86 Fiber \u6811\u7684\u7b2c\u4e00\u4e2a Fiber \u7ed3\u70b9\n  // RootFiber.stateNode -> FiberRoot\n  var root = void 0;\n  root = {\n    current: uninitializedFiber,\n    containerInfo: containerInfo,\n    // ......\n  }\n  \n  uninitializedFiber.stateNode = root;\n\n  return root: FiberRoot;\n}\n\n\nfunction createHostRootFiber(isConcurrent) {\n  var mode = isConcurrent ? ConcurrentMode | StrictMode : NoContext;\n  if (enableProfilerTimer && isDevToolsPresent) {\n    mode |= ProfileMode;\n  }\n  return createFiber(HostRoot, null, null, mode);\n}\n\nvar createFiber = function (tag, pendingProps, key, mode) {\n  return new FiberNode(tag, pendingProps, key, mode);\n};\n")),(0,i.kt)("p",null,"\u5f00\u59cb\u8c03\u7528",(0,i.kt)("inlineCode",{parentName:"p"},"root.render()")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-jsx"},"function unbatchedUpdates(fn, a) {\n  if (isBatchingUpdates && !isUnbatchingUpdates) {\n    isUnbatchingUpdates = true;\n    try {\n      return fn(a);\n    } finally {\n      isUnbatchingUpdates = false;\n    }\n  }\n  return fn(a);\n}\n\n\n// \u539f\u578b\u94fe\u4e0a\u6dfb\u52a0 \u5b9e\u4f8broot\u76f4\u63a5\u8c03\u7528\nReactRoot.prototype.render = function (children, callback) {\n  var root = this._internalRoot;\n  var work = new ReactWork();\n  callback = callback === undefined ? null : callback;\n\n  if (callback !== null) {\n    work.then(callback);\n  }\n  updateContainer(children, root, null, work._onCommit);\n  return work;\n};\n\n// \u5728\u8fd9\u91cc\u8ba1\u7b97\u4e86 expirationTime\nfunction updateContainer(element, container, parentComponent, callback) {\n  // \u8fd9\u4e2acurrent\u5c31\u662fFiberRoot\u5bf9\u5e94\u7684RootFiber\uff1f\uff1f\u7ed5\u53e3\n  var current$$1 = container.current;\n  var currentTime = requestCurrentTime();\n  var expirationTime = computeExpirationForFiber(currentTime, current$$1);\n  return updateContainerAtExpirationTime(element, container, parentComponent, expirationTime, callback);\n}\n  \n// \u5c06current\uff08\u5373Fiber\u5b9e\u4f8b\uff09\u63d0\u53d6\u51fa\u6765\uff0c\u5e76\u4f5c\u4e3a\u53c2\u6570\u4f20\u5165\u8c03\u7528scheduleRootUpdate\nfunction updateContainerAtExpirationTime(element, container, parentComponent, expirationTime, callback) {\n  // TODO: If this is a nested container, this won't be the root.\n  var current$$1 = container.current;\n  \n    // ...\n  return scheduleRootUpdate(current$$1, element, expirationTime, callback);\n}\n")),(0,i.kt)("p",null,(0,i.kt)("inlineCode",{parentName:"p"},"scheduleRootUpdate")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-js"},'// key\nfunction scheduleRootUpdate(current$$1, element, expirationTime, callback) {\n\n  var update = createUpdate(expirationTime);\n  // Caution: React DevTools currently depends on this property\n  // being called "element".\n  update.payload = { element: element };\n\n  callback = callback === undefined ? null : callback;\n  if (callback !== null) {\n    update.callback = callback;\n  }\n\n  flushPassiveEffects();\n  enqueueUpdate(current$$1, update);\n  scheduleWork(current$$1, expirationTime);\n\n  return expirationTime;\n}\n')),(0,i.kt)("h3",{id:"setstate"},(0,i.kt)("inlineCode",{parentName:"h3"},"setState")),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"setState")," \u548c ",(0,i.kt)("inlineCode",{parentName:"li"},"forceUpdate")," \u7684\u4ee3\u7801\u51e0\u4e4e\u4e00\u6a21\u4e00\u6837\uff0c\u552f\u4e00\u7684\u533a\u522b\u662f",(0,i.kt)("inlineCode",{parentName:"li"},"Update.tag")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"setState -> enqueueSetState -> enqueueUpdate"))),(0,i.kt)("p",null,"\u5f53\u6211\u4eec\u4f7f\u7528",(0,i.kt)("inlineCode",{parentName:"p"},"setState(...)"),"\u65f6\uff0c",(0,i.kt)("inlineCode",{parentName:"p"},"React")," \u4f1a\u521b\u5efa\u4e00\u4e2a\u66f4\u65b0",(0,i.kt)("inlineCode",{parentName:"p"},"update"),"\u5bf9\u8c61\uff0c\u7136\u540e\u901a\u8fc7\u8c03\u7528",(0,i.kt)("inlineCode",{parentName:"p"},"enqueueUpdate"),"\u51fd\u6570\u5c06\u5176\u52a0\u5165\u5230\u66f4\u65b0\u961f\u5217",(0,i.kt)("inlineCode",{parentName:"p"},"updateQueue")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-jsx",metastring:"{2}","{2}":!0},"Component.prototype.setState = function (partialState, callback) {\n  this.updater.enqueueSetState(this, partialState, callback, 'setState');\n};\n")),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"enqueueSetState enqueueForceUpdate"))),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-jsx",metastring:"{2,8,20,26}","{2,8,20,26}":!0},"var classComponentUpdater = {\n  enqueueSetState: function (inst, payload, callback) {\n    // inst \u5f53\u524d\u5b9e\u4f8b  \u83b7\u53d6\u5230\u5f53\u524d\u5b9e\u4f8b\u4e0a\u7684fiber\n    var fiber = get(inst);\n    var currentTime = requestCurrentTime();\n    // \u8ba1\u7b97\u5f53\u524dfiber\u7684\u5230\u671f\u65f6\u95f4\uff08\u4f18\u5148\u7ea7\uff09\n    var expirationTime = computeExpirationForFiber(currentTime, fiber);\n        // \u521b\u5efa\u66f4\u65b0\u4e00\u4e2a\u66f4\u65b0update\n    var update = createUpdate(expirationTime);\n    // payload\u662fsetState\u4f20\u8fdb\u6765\u7684\u8981\u66f4\u65b0\u7684\u5bf9\u8c61\n    update.payload = payload;\n    // callback\u5c31\u662fsetState({},()=>{})\u7684\u56de\u8c03\u51fd\u6570\n    if (callback !== undefined && callback !== null) {\n      update.callback = callback;\n    }\n\n    flushPassiveEffects();\n    // \u628a\u66f4\u65b0\u653e\u5230\u961f\u5217UpdateQueue\n    enqueueUpdate(fiber, update);\n    // \u5f00\u59cb\u8fdb\u5165React\u5f02\u6b65\u6e32\u67d3\u7684\u6838\u5fc3\uff1aReact Scheduler\n    scheduleWork(fiber, expirationTime);\n  },\n  \n  enqueueForceUpdate: function (inst, callback) {\n    var fiber = get(inst);\n    var currentTime = requestCurrentTime();\n    var expirationTime = computeExpirationForFiber(currentTime, fiber);\n\n    var update = createUpdate(expirationTime);\n    update.tag = ForceUpdate;\n\n    if (callback !== undefined && callback !== null) {\n      update.callback = callback;\n    }\n\n    flushPassiveEffects();\n    enqueueUpdate(fiber, update);\n    scheduleWork(fiber, expirationTime);\n  }\n}\n")),(0,i.kt)("p",null,"\u603b\u7ed3\u4e09\u79cd\u66f4\u65b0\u6d41\u7a0b"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"\u83b7\u53d6\u8282\u70b9\u5bf9\u5e94\u7684 ",(0,i.kt)("inlineCode",{parentName:"li"},"fiber")," \u5bf9\u8c61"),(0,i.kt)("li",{parentName:"ul"},"\u8ba1\u7b97 ",(0,i.kt)("inlineCode",{parentName:"li"},"currentTime")),(0,i.kt)("li",{parentName:"ul"},"\u6839\u636e ",(0,i.kt)("inlineCode",{parentName:"li"},"fiber  currentTime"),"  \u8ba1\u7b97\u51fa ",(0,i.kt)("inlineCode",{parentName:"li"},"fiber")," \u5bf9\u8c61\u7684 ",(0,i.kt)("inlineCode",{parentName:"li"},"expirationTime")," "),(0,i.kt)("li",{parentName:"ul"},"\u6839\u636e",(0,i.kt)("inlineCode",{parentName:"li"},"expirationTime")," \u521b\u5efa",(0,i.kt)("inlineCode",{parentName:"li"},"update")," \u5bf9\u8c61"),(0,i.kt)("li",{parentName:"ul"},"\u5c06 ",(0,i.kt)("inlineCode",{parentName:"li"},"setState")," \u4e2d\u8981\u66f4\u65b0\u7684\u5bf9\u8c61\u8d4b\u503c\u5230 ",(0,i.kt)("inlineCode",{parentName:"li"},"update.payload")),(0,i.kt)("li",{parentName:"ul"},"\u5982\u679c\u6709 ",(0,i.kt)("inlineCode",{parentName:"li"},"callback")," \u5c06\u5176\u8d4b\u503c\u5230 ",(0,i.kt)("inlineCode",{parentName:"li"},"update.callback = callback")),(0,i.kt)("li",{parentName:"ul"},"\u5c06 ",(0,i.kt)("inlineCode",{parentName:"li"},"update")," \u5bf9\u8c61\u52a0\u5165\u5230 ",(0,i.kt)("inlineCode",{parentName:"li"},"updateQueue")),(0,i.kt)("li",{parentName:"ul"},"\u8fdb\u884c\u4efb\u52a1\u8c03\u5ea6")),(0,i.kt)("h2",{id:"\u52a0\u5165\u961f\u5217"},"\u52a0\u5165\u961f\u5217"),(0,i.kt)("p",null,"\u6211\u4eec\u53ef\u4ee5\u53d1\u73b0\u4e0d\u7ba1\u662f",(0,i.kt)("inlineCode",{parentName:"p"},"ReactDOM.render() -> scheduleRootUpdate")," \u8fd8\u662f ",(0,i.kt)("inlineCode",{parentName:"p"},"this.setState() -> enqueueSetState")," \u521b\u5efa\u66f4\u65b0\u540e\u7684\u6d41\u7a0b\u90fd\u662f"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"\u8c03\u7528 ",(0,i.kt)("inlineCode",{parentName:"li"},"createUpdate")," \u521b\u5efa\u4e00\u4e2a\u66f4\u65b0\u5bf9\u8c61 ",(0,i.kt)("inlineCode",{parentName:"li"},"update")),(0,i.kt)("li",{parentName:"ul"},"\u8c03\u7528 ",(0,i.kt)("inlineCode",{parentName:"li"},"enqueueUpdate")," \u5c06 ",(0,i.kt)("inlineCode",{parentName:"li"},"update")," \u5bf9\u8c61\u52a0\u5165\u5230 ",(0,i.kt)("inlineCode",{parentName:"li"},"updateQueue")),(0,i.kt)("li",{parentName:"ul"},"\u8c03\u7528 ",(0,i.kt)("inlineCode",{parentName:"li"},"scheduleWork")," \u8fdb\u5165\u5f02\u6b65\u6e32\u67d3\u5230\u6838\u5fc3\uff1a",(0,i.kt)("inlineCode",{parentName:"li"},"React Scheduler"))),(0,i.kt)("p",null,(0,i.kt)("img",{parentName:"p",src:"https://cdn.jsdelivr.net/gh/honjaychang/bp/fe/20211001224734.png",alt:"image-20211001224734809"})),(0,i.kt)("h3",{id:"enqueueupdate"},(0,i.kt)("inlineCode",{parentName:"h3"},"enqueueUpdate")),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"\u4fdd\u8bc1 ",(0,i.kt)("inlineCode",{parentName:"li"},"current"),"\u6811 \u548c ",(0,i.kt)("inlineCode",{parentName:"li"},"wIP"),"\u6811\u7684",(0,i.kt)("inlineCode",{parentName:"li"},"updateQueue")," \u662f\u4e00\u81f4\u7684")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-jsx"},"function enqueueUpdate(fiber, update) {\n  // Update queues are created lazily.\n  var alternate = fiber.alternate;\n  var queue1 = void 0; // current\u7684\u961f\u5217\n  var queue2 = void 0; // alternate\u7684\u961f\u5217\n  if (alternate === null) {\n    // There's only one fiber.\n    queue1 = fiber.updateQueue;\n    queue2 = null;\n    // alternate & current \u90fd\u4e3a\u7a7a \u5219\u521d\u59cb\u5316\u66f4\u65b0\u961f\u5217\n    if (queue1 === null) {\n      queue1 = fiber.updateQueue = createUpdateQueue(fiber.memoizedState);\n    }\n  } else {\n    // There are two owners.\n    queue1 = fiber.updateQueue;\n    queue2 = alternate.updateQueue;\n    if (queue1 === null) {\n      if (queue2 === null) {\n        // Neither fiber has an update queue. Create new ones.\n        queue1 = fiber.updateQueue = createUpdateQueue(fiber.memoizedState);\n        queue2 = alternate.updateQueue = createUpdateQueue(alternate.memoizedState);\n      } else {\n        // Only one fiber has an update queue. Clone to create a new one.\n        queue1 = fiber.updateQueue = cloneUpdateQueue(queue2);\n      }\n    } else {\n      if (queue2 === null) {\n        // Only one fiber has an update queue. Clone to create a new one.\n        queue2 = alternate.updateQueue = cloneUpdateQueue(queue1);\n      } else {\n        // Both owners have an update queue.\n      }\n    }\n  }\n  if (queue2 === null || queue1 === queue2) {\n    // There's only a single queue.\n    appendUpdateToQueue(queue1, update);\n  } else {\n    // There are two queues. We need to append the update to both queues,\n    // while accounting for the persistent structure of the list \u2014 we don't\n    // want the same update to be added multiple times.\n    if (queue1.lastUpdate === null || queue2.lastUpdate === null) {\n      // One of the queues is not empty. We must add the update to both queues.\n      appendUpdateToQueue(queue1, update);\n      appendUpdateToQueue(queue2, update);\n    } else {\n      // Both queues are non-empty. The last update is the same in both lists, because of structural sharing. So, only append to one of the lists.\n      appendUpdateToQueue(queue1, update);\n      // But we still need to update the `lastUpdate` pointer of queue2.\n      queue2.lastUpdate = update;\n    }\n  }\n}\n")),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"queue1")," \u662f\u5e94\u7528\u7a0b\u5e8f\u8fd0\u884c\u8fc7\u7a0b\u4e2d ",(0,i.kt)("inlineCode",{parentName:"li"},"current")," \u6811\u4e0a\u5f53\u524d ",(0,i.kt)("inlineCode",{parentName:"li"},"Fiber")," \u7ed3\u70b9\u6700\u65b0\u961f\u5217 ",(0,i.kt)("inlineCode",{parentName:"li"},"fiber.updateQueue")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"queue2")," \u662f\u5e94\u7528\u7a0b\u5e8f\u4e0a\u4e00\u6b21\u66f4\u65b0\u65f6 ",(0,i.kt)("inlineCode",{parentName:"li"},"workInProgress")," \u6811",(0,i.kt)("inlineCode",{parentName:"li"},"Fiber")," \u7ed3\u70b9\u7684\u66f4\u65b0\u961f\u5217 ",(0,i.kt)("inlineCode",{parentName:"li"},"fiber.alternate.updateQueue")),(0,i.kt)("li",{parentName:"ul"},"\u5982\u679c\u4e24\u8005\u5747\u4e3a ",(0,i.kt)("inlineCode",{parentName:"li"},"null"),"\uff0c\u5219\u8c03\u7528 ",(0,i.kt)("inlineCode",{parentName:"li"},"createUpdateQueue()")," \u83b7\u53d6\u521d\u59cb\u961f\u5217"),(0,i.kt)("li",{parentName:"ul"},"\u5982\u679c\u4e24\u8005\u4e4b\u4e00\u4e3a ",(0,i.kt)("inlineCode",{parentName:"li"},"null"),"\uff0c\u5219\u8c03\u7528 ",(0,i.kt)("inlineCode",{parentName:"li"},"cloneUpdateQueue()")," \u4ece\u5bf9\u65b9\u4e2d\u83b7\u53d6\u961f\u5217"),(0,i.kt)("li",{parentName:"ul"},"\u5982\u679c\u4e24\u8005\u5747\u4e0d\u4e3a ",(0,i.kt)("inlineCode",{parentName:"li"},"null"),"\uff0c\u5219\u5c06 ",(0,i.kt)("inlineCode",{parentName:"li"},"update")," \u4f5c\u4e3a ",(0,i.kt)("inlineCode",{parentName:"li"},"queue2")," \u7684 ",(0,i.kt)("inlineCode",{parentName:"li"},"lastUpdate"))),(0,i.kt)("p",null,(0,i.kt)("img",{parentName:"p",src:"https://cdn.jsdelivr.net/gh/honjaychang/bp/fe/20211001131544.png",alt:"image-20211001131543806"})),(0,i.kt)("p",null,"\u6574\u4e2a\u66f4\u65b0\u961f\u5217\u5bf9\u8c61\u901a\u8fc7 ",(0,i.kt)("inlineCode",{parentName:"p"},"firstUpdate")," \u5c5e\u6027\u548c\u66f4\u65b0\u5bf9\u8c61\u7684 ",(0,i.kt)("inlineCode",{parentName:"p"},"next")," \u5c5e\u6027\u5c42\u5c42\u5f15\u7528\u5f62\u6210\u4e86\u94fe\u8868\u7ed3\u6784\u3002\u540c\u65f6\u66f4\u65b0\u961f\u5217\u5bf9\u8c61\u4e2d\u4e5f\u53ef\u4ee5\u901a\u8fc7 ",(0,i.kt)("inlineCode",{parentName:"p"},"lastUpdate")," \u5c5e\u6027\u76f4\u63a5\u8fde\u63a5\u5230\u6700\u540e\u4e00\u4e2a\u66f4\u65b0\u5bf9\u8c61"),(0,i.kt)("h3",{id:"processupdatequeue"},(0,i.kt)("inlineCode",{parentName:"h3"},"processUpdateQueue")),(0,i.kt)("p",null,(0,i.kt)("inlineCode",{parentName:"p"},"React")," \u5728 ",(0,i.kt)("inlineCode",{parentName:"p"},"render"),"\u9636\u6bb5\u4f1a\u5904\u7406\u66f4\u65b0\u961f\u5217\uff0c\u4f1a\u8c03\u7528",(0,i.kt)("inlineCode",{parentName:"p"},"processUpdateQueue"),"\u51fd\u6570"),(0,i.kt)("p",null,(0,i.kt)("inlineCode",{parentName:"p"},"processUpdateQueue"),"\u51fd\u6570\u7528\u4e8e\u5904\u7406\u66f4\u65b0\u961f\u5217\uff0c\u5728\u8be5\u51fd\u6570\u5185\u90e8\u4f7f\u7528\u5faa\u73af\u7684\u65b9\u5f0f\u6765\u904d\u5386\u961f\u5217\uff0c\u901a\u8fc7 ",(0,i.kt)("inlineCode",{parentName:"p"},"update.next")," \u4f9d\u6b21\u53d6\u51fa\u66f4\u65b0\u5bf9\u8c61\u8fdb\u884c\u5408\u5e76\uff0c\u5408\u5e76\u66f4\u65b0\u5bf9\u8c61\u7684\u65b9\u5f0f\u662f:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"\u5982\u679c ",(0,i.kt)("inlineCode",{parentName:"li"},"setState")," \u4f20\u5165\u7684\u53c2\u6570\u7c7b\u578b\u662f ",(0,i.kt)("inlineCode",{parentName:"li"},"function")," \uff0c\u5219\u901a\u8fc7 ",(0,i.kt)("inlineCode",{parentName:"li"},"payload2.call(instance, prevState, nextProps)")," \u83b7\u53d6\u66f4\u65b0\u5bf9\u8c61;"),(0,i.kt)("li",{parentName:"ul"},"\u5982\u679c ",(0,i.kt)("inlineCode",{parentName:"li"},"setState")," \u4f20\u5165\u7684\u53c2\u6570\u7c7b\u578b\u662f ",(0,i.kt)("inlineCode",{parentName:"li"},"object"),"\uff0c\u5219\u53ef\u76f4\u63a5\u83b7\u53d6\u66f4\u65b0\u5bf9\u8c61"),(0,i.kt)("li",{parentName:"ul"},"\u6700\u540e\u901a\u8fc7\u4f7f\u7528 ",(0,i.kt)("inlineCode",{parentName:"li"},"Object.assign()")," \u5408\u5e76\u4e24\u4e2a\u66f4\u65b0\u5bf9\u8c61\u5e76\u8fd4\u56de\uff0c\u5982\u679c\u5c5e\u6027\u76f8\u540c\u7684\u60c5\u51b5\u4e0b\u5219\u53d6\u6700\u540e\u4e00\u6b21\u503c")),(0,i.kt)("p",null,"\u5728\u5904\u7406\u66f4\u65b0\u961f\u5217\u65f6\uff0c",(0,i.kt)("inlineCode",{parentName:"p"},"React")," \u4f1a\u6839\u636e\u66f4\u65b0\u5bf9\u8c61\u4e2d\u643a\u5e26\u7684 ",(0,i.kt)("inlineCode",{parentName:"p"},"state")," \u76f8\u540c\u5c5e\u6027\u8fdb\u884c\u5408\u5e76\uff0c\u4fdd\u7559\u961f\u5217\u4e2d\u6700\u540e\u4e00\u6b21\u5c5e\u6027\u503c\uff0c\u4ee5\u6b64\u4f5c\u4e3a\u524d\u540e\u7ed3\u70b9 ",(0,i.kt)("inlineCode",{parentName:"p"},"diff")," \u7684\u6570\u636e"),(0,i.kt)("h2",{id:"\u4efb\u52a1\u8c03\u5ea6"},"\u4efb\u52a1\u8c03\u5ea6"))}m.isMDXComponent=!0}}]);